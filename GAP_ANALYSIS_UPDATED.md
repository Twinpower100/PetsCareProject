# АНАЛИЗ ГЭПОВ СИСТЕМЫ PETCARE

## ОБЗОР

Данный документ содержит анализ текущего состояния системы PetCare и выявленные ГЭПы (пробелы) между требованиями и реализацией.

## ПРИОРИТЕТЫ РАЗРАБОТКИ

### Критический приоритет
# Пустой раздел - все критические ГЭПы реализованы

### Высокий приоритет
1. **Отсутствует фильтрация и сортировка по цене и доступности услуги для учреждений**
2. **Отсутствует поиск и отображение доступности услуги в выбранное пользователем время для учреждений**
3. **Нет отображения на карте учреждений с ближайшими свободными окнами для выбранной услуги и времени**
4. **Нет атомарной транзакции бронирования с обработкой гонок**
5. **Нет защиты от злоупотреблений при попытках бронирования**
6. **Не реализована интеграция с Google Perspective API для модерации отзывов**
7. **Необходимо полностью удалить текущую реализацию модерации отзывов и перейти на модерацию через Perspective API**
8. **Требуется реализовать отправку email-уведомлений через Gmail API (Google API) с использованием OAuth2 вместо SMTP (smtp.gmail.com)**
9. **Отсутствует автоматическая сверка условий контракта с эталоном типа и автоматическая активация менеджером при полном соответствии стандарту**
10. **Нет явного workflow согласования/утверждения админом для нестандартных условий (approve endpoint, уведомления, история согласований)**
11. **Необходимо убрать автоматическую разблокировку по прошествии времени - разблокировка может быть только ручная или при погашении задолженности**
12. **Отсутствует логика наследования и проверки порогов блокировки в контрактах**
13. **Отсутствует назначение ситтера владельцем питомца на время передержки**
14. **Отсутствует чат между владельцем питомца и пет-ситтером**
15. **Отсутствует самостоятельное снятие обязанностей совладельца**
16. **Отсутствует система обработки недееспособности владельцев**
17. **Отсутствует расширенная фильтрация питомцев**
18. **Отсутствует фильтрация питомцев при поиске на передержку**
19. **Отсутствует поиск и отображение доступности услуги в выбранное пользователем время для учреждений**
20. **Нет отображения на карте учреждений с ближайшими свободными окнами для выбранной услуги и времени**
21. **Нет атомарной транзакции бронирования с обработкой гонок**
22. **Нет защиты от злоупотреблений при попытках бронирования**
23. **Не реализована интеграция с Google Perspective API для модерации отзывов**
24. **Необходимо полностью удалить текущую реализацию модерации отзывов и перейти на модерацию через Perspective API**

### Средний приоритет
1. **Отсутствует система настроек безопасности**
2. **Отсутствует админский интерфейс для настроек безопасности**
3. **Неправильная логика обязательности документов при регистрации учреждений**
4. **Отсутствуют пространственные индексы для геопоиска**
5. **Не реализовано экспоненциальное затухание веса отзывов при расчёте рейтинга**
6. **Отсутствует система обнаружения попыток взлома**
7. **Отсутствует система политик безопасности и их мониторинга**

### Низкий приоритет
1. **Отсутствуют базовые модели для аналитики пользователей (рост, активность, конверсия)**
2. **Отсутствует интеграция с Google Analytics для маркетинговой аналитики**
3. **Отсутствует ограничение частоты запросов (rate limiting) для API**
4. **Неправильная частота проверки блокировок учреждений (каждый час вместо ежедневно)**
5. **Ненужный функционал уведомлений об изменении цен услуг. УДАЛИТЬ**
6. **Неправильная логика напоминаний о бронированиях (фиксированное время вместо индивидуального)**
7. **Ненужный функционал уведомлений о завершенных услугах. УДАЛИТЬ**
8. **Ненужный функционал еженедельной сводки новых отзывов. УДАЛИТЬ**
9. **Ненужный функционал ежемесячной аналитики уведомлений. УДАЛИТЬ**

### Реализовано (ГЭПы закрыты)
1. **Жестко заданный русский язык в геолокации**
2. **Автоматическая блокировка учреждений**
3. **Система отчетов по доходам**
4. **Система отчетов по загруженности сотрудников**
5. **Система отчетов по дебиторской задолженности**
6. **Система отчетов по активности учреждений**
7. **Система отчетов по платежам**
8. **Система отчетов по отменам бронирований**
9. **Админский интерфейс для отчетов**
10. **Полная система уведомлений**
11. **Email уведомления для инвайтов**
12. **Массовое применение шаблонов**
13. **Система транзакций и конкурентного доступа**
14. **Автоматическое завершение бронирований**
15. **Система рейтингов и жалоб**
16. **Поиск ситтеров по геолокации**
17. **Проверка пересечений**
18. **Централизованное логирование**
19. **Система аудита безопасности**
20. **Документы питомцев**
21. **Полный REST API**
22. **Документация API**
23. **Гибкая система правил уведомлений**

---

#### 7.3 Отсутствуют настоящие пространственные индексы для геопоиска
**Требование**: Для быстрого и масштабируемого поиска учреждений по радиусу должны использоваться пространственные индексы (PostGIS/GiST)
**Реализация**: Используются обычные индексы по полям latitude/longitude, что приемлемо для MVP, но не масштабируется на больших объёмах данных
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Средний

**Описание**: В модели Provider координаты хранятся как DecimalField, индексы создаются обычные. Для масштабирования и быстрого поиска по радиусу потребуется миграция на PostGIS и spatial index.

**Решение**: 
- Перевести координаты на тип PointField (Django, PostGIS)
- Создать spatial index (GiST)
- Обновить запросы поиска по радиусу на использование геооператоров
- Провести миграцию данных

#### 7.4 Отсутствует фильтрация и сортировка по цене и доступности услуги для учреждений
**Требование**: В поиске учреждений должна быть возможность фильтровать и сортировать по цене услуги и по доступности записи (наличию свободных слотов)
**Реализация**: В текущем API поиска учреждений фильтрация и сортировка реализованы только по радиусу, рейтингу и услуге. По цене и доступности — отсутствуют.
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Высокий

**Описание**: Пользователь не может найти учреждения с нужной ценой или только с доступными для записи услугами. Это снижает удобство поиска и конкурентоспособность платформы.

**Решение**:
- Добавить параметры price_min, price_max в API поиска учреждений
- Добавить параметр available (или по дате/времени) для фильтрации по доступности
- Добавить сортировку по цене и доступности
- Обновить документацию и тесты

## ОТЧЕТЫ И АНАЛИТИКА

### ✅ Реализовано
- **Полная система отчетности** с сервисами для всех типов отчетов
- Модели отчетов (Report, ReportTemplate, ReportSchedule)
- Админский интерфейс с дашбордом отчетов
- API endpoints для всех отчетов (готовы для будущего UI)
- Экспорт в Excel формат
- Ролевая система доступа к отчетам
- Фильтрация по провайдерам и датам

**Доступные отчеты:**
- **Отчет по доходам** - суммы через систему бронирования, комиссии
- **Отчет по загруженности сотрудников** - часы работы, эффективность
- **Отчет по дебиторской задолженности** - задолженность учреждений
- **Отчет по активности учреждений** - статистика бронирований
- **Отчет по платежам** - полученные и просроченные платежи
- **Отчет по отменам бронирований** - статистика отмен

### ❌ ГЭПы

#### О.1 Система отчетов по доходам
**Требование**: Готовые отчеты для анализа доходов учреждений
**Реализация**: Полностью реализовано - отчеты по доходам доступны в админке
**Статус**: ✅ **ГЭП ЗАКРЫТ**

#### О.2 Система отчетов по загруженности сотрудников
**Требование**: Готовые отчеты для анализа загруженности сотрудников
**Реализация**: Полностью реализовано - отчеты по загруженности доступны в админке
**Статус**: ✅ **ГЭП ЗАКРЫТ**

#### О.3 Система отчетов по дебиторской задолженности
**Требование**: Готовые отчеты для анализа дебиторской задолженности
**Реализация**: Полностью реализовано - отчеты по дебиторской задолженности доступны в админке
**Статус**: ✅ **ГЭП ЗАКРЫТ**

#### О.4 Система отчетов по активности учреждений
**Требование**: Готовые отчеты для анализа активности учреждений
**Реализация**: Полностью реализовано - отчеты по активности доступны в админке
**Статус**: ✅ **ГЭП ЗАКРЫТ**

#### О.5 Система отчетов по платежам
**Требование**: Готовые отчеты для анализа платежей
**Реализация**: Полностью реализовано - отчеты по платежам доступны в админке
**Статус**: ✅ **ГЭП ЗАКРЫТ**

#### О.6 Система отчетов по отменам бронирований
**Требование**: Готовые отчеты для анализа отмен бронирований
**Реализация**: Полностью реализовано - отчеты по отменам доступны в админке
**Статус**: ✅ **ГЭП ЗАКРЫТ**

#### О.7 Система экспорта отчетов
**Требование**: Выгрузка отчетов в Excel
**Реализация**: Полностью реализовано - экспорт в Excel с форматированием
**Статус**: ✅ **ГЭП ЗАКРЫТ**

#### О.8 Админский интерфейс для отчетов
**Требование**: Удобный интерфейс для просмотра и управления отчетами
**Реализация**: Полностью реализовано - админский дашборд с фильтрами и экспортом
**Статус**: ✅ **ГЭП ЗАКРЫТ**

## 1. СИСТЕМА ПОЛЬЗОВАТЕЛЕЙ И РОЛЕЙ

## Обновленный анализ ГЭПов (разрывов) системы PetCare

## Обзор

Данный документ содержит актуальный анализ разрывов (ГЭПов) между требованиями, описанными в документации, и текущей реализацией системы PetCare. Анализ основан на тщательном изучении моделей данных, API и функциональности.

## 1. РОЛЕВАЯ МОДЕЛЬ И УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ

### ✅ Реализовано
- Кастомная модель User с поддержкой множественных ролей
- Система инвайтов для назначения ролей (RoleInvite) с токенами и QR-кодами
- Модель UserType для определения ролей
- Подтверждение ролей пользователями
- Автоматическая очистка истекших инвайтов
- **Полная валидация удаления профилей** (включая основных владельцев питомцев)
- API для управления инвайтами ролей
- Система увольнения с ролей
- **Полная система уведомлений** через приложение/веб-интерфейс

### ❌ ГЭПы

**Отсутствуют** - все ГЭПы ролевой модели закрыты.

**Статус**: ✅ **ВСЕ ГЭПЫ ЗАКРЫТЫ**

## 2. УПРАВЛЕНИЕ ПИТОМЦАМИ

### ✅ Реализовано
- Модель Pet с поддержкой множественных владельцев
- Система основного владельца с валидацией
- Медицинские записи (MedicalRecord)
- Записи о процедурах (PetRecord)
- Система доступа к карте питомца (PetAccess)
- Инвайты для добавления совладельцев (PetOwnershipInvite)
- **Полная система передачи прав основного владельца** через инвайты
- **Полная валидация удаления профилей для основных владельцев**

### ❌ ГЭПы

#### 2.1 Система документов для питомцев
**Требование**: Загрузка и скачивание документов, связанных с питомцем
**Реализация**: Реализовано — отдельная модель документов, API для загрузки, скачивания и предпросмотра, права доступа, админка, документация
**Статус**: *ГЭП закрыт*

#### 2.2 Отсутствует расширенная фильтрация питомцев
**Требование**: Фильтрация питомцев по типу, породе, возрасту, медицинским условиям, геолокации и другим критериям
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Высокий
**Описание**: В системе есть только базовая фильтрация питомцев по владельцам, но отсутствует расширенная фильтрация по различным критериям
**Решение**: 
- API эндпоинт для расширенного поиска питомцев
- Фильтрация по типу питомца (кошки, собаки, птицы и т.д.)
- Фильтрация по породе питомца
- Фильтрация по возрасту/периоду жизни питомца
- Фильтрация по геолокации (близость к определенной точке)
- Фильтрация по медицинским условиям и особым потребностям
- Фильтрация по статусу питомца (активные, архивные)
- Расширенный поиск с множественными критериями
- Сортировка по различным параметрам (возраст, вес, дата последнего посещения)
- Пагинация результатов поиска
- Интеграция с профилями питомцев пользователя
- Персонализированные рекомендации на основе истории питомца

## 3. СИСТЕМА БРОНИРОВАНИЙ

### ✅ Реализовано
- Модель Booking с полным жизненным циклом
- Система статусов бронирований (включая 'pending_confirmation')
- Временные слоты (TimeSlot)
- Платежи (BookingPayment)
- Отзывы (BookingReview)
- Система отмен с отслеживанием злоупотреблений (BookingCancellation, AbuseRule)

### ❌ ГЭПы

#### 3.1 Система транзакций и конкурентного доступа
**Требование**: Защита от конфликтов при одновременном бронировании слотов и изменении данных
**Реализация**: Полностью реализовано - транзакционные блоки (@transaction.atomic), select_for_update() для критических операций
**Статус**: ✅ **ГЭП ЗАКРЫТ**

**Реализованный функционал:**
- BookingTransactionService для безопасных операций с бронированиями
- ScheduleTransactionService для безопасных операций с расписанием сотрудников
- ProviderTransactionService для безопасных операций с учреждениями
- Транзакционная защита планирования расписания
- Обработка исключений при конкурентном доступе
- Интеграция в админские формы с понятными сообщениями об ошибках

#### 3.2 Система рейтингов и жалоб
**Требование**: Отдельная статистика и рейтинг для провайдера, работника и клиента, возможность оставления жалоб на качество услуг
**Реализация**: Полностью реализовано - универсальная система рейтингов с поддержкой учреждений, сотрудников и пэт-ситтеров, система жалоб с процессом обработки, защита от манипуляций
**Статус**: ✅ **ГЭП ЗАКРЫТ**

**Реализованный функционал:**
- **Универсальная модель рейтингов** (Rating) с поддержкой любых объектов через ContentType
- **Система отзывов** (Review) с модерацией и проверкой подозрительности
- **Система жалоб** (Complaint) с типами, статусами и процессом обработки
- **Ответы на жалобы** (ComplaintResponse) с временными ограничениями
- **История изменений рейтингов** (RatingHistory) для аудита
- **Обнаружение подозрительной активности** (SuspiciousActivity) с автоматическим анализом
- **Взвешенный алгоритм расчета рейтингов** с учетом отзывов, жалоб, отмен и no-show
- **Проверка доступа к объектам** с учетом владельцев питомцев и истории услуг
- **Транзакционная защита** всех операций с рейтингами (@atomic)
- **Автоматическая модерация отзывов** с проверкой подозрительных паттернов
- **API для всех операций** с рейтингами, отзывами и жалобами
- **Админка с действиями** для управления рейтингами, модерации и расследования
- **Команды Django** для пересчета рейтингов и обнаружения подозрительной активности
- **Сигналы для автоматического создания рейтингов** при создании объектов
- **Интеграция с существующей системой** бронирований и передержек
- **Полная интернационализация** всех пользовательских сообщений

#### 3.4 Автоматическое завершение бронирований
**Требование**: Автоматическое завершение бронирований со статусом 'pending_confirmation'
**Реализация**: Полностью реализовано - система автоматического завершения с настройками, командой Django, уведомлениями и отчетностью
**Статус**: ✅ **ГЭП ЗАКРЫТ**

**Реализованный функционал:**
- Модель `BookingAutoCompleteSettings` с глобальными параметрами автозавершения
- Сервис `BookingCompletionService` для ручного и автоматического завершения
- Команда Django `auto_complete_bookings` для автоматического завершения
- Интеграция с системой уведомлений (email, push, in-app)
- Отчетность по отменам с детализацией по инициатору, клиенту, учреждению
- API для статистики отмен с ограничением доступа по учреждениям
- Транзакционная защита операций завершения
- Системный пользователь для автоматических операций

## 4. СИСТЕМА ПЕРЕДЕРЖКИ ПИТОМЦЕВ

### ✅ Реализовано
- Профили ситтеров (SitterProfile)
- Объявления о передержке (PetSittingAd)
- Отклики на объявления (PetSittingResponse)
- История передержек (PetSitting)
- Система отзывов (Review)

### ❌ ГЭПы

#### 4.1 Отсутствует поиск ситтеров по геолокации
**Требование**: Поиск ситтеров по координатам и радиусу для удобства владельцев питомцев
**Реализация**: Полностью реализовано - API для поиска ситтеров по геолокации с расширенной фильтрацией, интеграция с модулем геолокации, автоматическое геокодирование адресов ситтеров
**Статус**: ✅ **ГЭП ЗАКРЫТ**

**Реализованный функционал:**
- API для поиска ситтеров по координатам и радиусу (`GET /api/sitters/search/`)
- Расширенный поиск ситтеров с фильтрами по услугам, расписанию, цене и доступности
- Интеграция SitterProfile с модулем геолокации
- Автоматическое геокодирование адресов ситтеров
- Фильтрация по расстоянию в API ситтеров
- Сериализаторы с поддержкой расстояния
- Геопространственные индексы для оптимизации производительности

#### 4.2 Отсутствует полноценная система чата между владельцами и ситтерами
**Требование**: Система обмена сообщениями между владельцами и ситтерами для координации передержки
**Реализация**: Частично реализовано - только поле `message` в `PetSittingResponse` для краткого сообщения при отклике
**Статус**: ❌ **ГЭП ОТКРЫТ**

**Текущее состояние:**
- Поле `message` в `PetSittingResponse` - ситтер может оставить краткое сообщение при отклике
- НЕТ моделей `Message`, `Conversation` для полноценного чата
- НЕТ WebSocket/REST API для обмена сообщениями
- НЕТ UI чата в веб-приложении
- НЕТ уведомлений о новых сообщениях

**Планируемая реализация (из ТЗ):**
- Chat Module с WebSocket/REST API
- Модели Message и Conversation
- API для чата между владельцем и передержчиком
- Уведомления о новых сообщениях
- UI чата в веб-приложении

#### 4.3 Отсутствует опциональная система передачи ролей во время передержки
**Требование**: Ситтер должен иметь возможность получить роль владельца питомца на время передержки для записи на услуги (опционально)
**Реализация**: НЕ реализовано - есть критические ошибки в коде
**Статус**: ❌ **ГЭП ОТКРЫТ**

**Критические проблемы:**
- В коде есть ошибка: создается несуществующая модель `PetSittingHistory` в методе `accept`
- Ситтер не может получить опциональный доступ к питомцу для записи на услуги
- НЕТ создания `PetAccess` для временного доступа ситтера к питомцу
- НЕТ опциональной передачи ролей при начале передержки
- НЕТ отзыва ролей при завершении передержки

**Требуемая реализация:**
- Исправить ошибку с `PetSittingHistory` → использовать `PetSitting`
- Опциональное создание `PetAccess` при подтверждении передачи питомца (по согласию владельца)
- Предоставление ситтеру роли владельца питомца на время передержки (опционально)
- Автоматический отзыв доступа при завершении передержки
- Интеграция с системой бронирования услуг
- UI для управления опциональными правами доступа

#### 4.4 Проблемы в системе оценки ситтеров
**Требование**: Оценка ситтера должна быть опциональной, только владелец может оценивать, ситтер не может оценить себя
**Реализация**: Частично реализовано с критическими проблемами
**Статус**: ❌ **ГЭП ОТКРЫТ**

**Критические проблемы:**
- **Оценка обязательна** - система требует обязательной оценки (`Rating is required`)
- **НЕТ защиты от самооценки** - ситтер может оценить себя сам
- **НЕТ опциональности** - владелец обязан оставить отзыв для завершения передержки
- **НЕТ проверки автора отзыва** - любой участник может создать отзыв

**Требуемая реализация:**
- Сделать оценку опциональной (убрать обязательную проверку `rating`)
- Добавить проверку: только владелец питомца может оставить отзыв
- Добавить защиту от самооценки: ситтер не может оценить себя
- Позволить завершить передержку без отзыва
- Обновлять рейтинг ситтера только при наличии оценки
- Добавить валидацию в модель `Review`

#### 4.15 Отсутствует система сообщений между владельцами и ситтерами
**Требование**: Полноценная система чата для общения между владельцами и ситтерами
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Средний
**Описание**: В системе есть только поле message в PetSittingResponse для кратких сообщений, но нет полноценного чата
**Решение**: 
- Создать Chat Module с WebSocket/REST API
- Модели Message и Conversation
- Реальное время общения между пользователями
- Уведомления о новых сообщениях

#### 4.16 Отсутствует самостоятельное снятие обязанностей совладельца
**Требование**: Возможность для совладельца самостоятельно снять с себя обязанности владельца питомца
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Средний
**Описание**: Совладелец не может сам покинуть питомца, только основной владелец может его удалить. В документации описана функциональность самостоятельного удаления совладельца, но она не реализована в коде.
**Решение**: 
- API эндпоинт `/api/pets/{id}/leave/` для самостоятельного снятия обязанностей
- Логика проверки единственного владельца (нельзя снять себя, если ты единственный)
- Уведомления основному владельцу и другим совладельцам
- История изменений владельцев для аудита
- Интеграция с системой передачи прав (если единственный владелец хочет снять себя)
- Возможность удаления питомца при снятии единственного владельца (с указанием причины)
- Система обработки недееспособности владельцев с автоматическим созданием тикетов поддержки

#### 4.17 Отсутствует система обработки недееспособности владельцев
**Требование**: Обработка ситуаций с неактивными владельцами питомцев через службу поддержки
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Средний
**Описание**: Нет механизма для обработки случаев неактивности основного владельца через официальные обращения в поддержку
**Решение**: 
- Система показывает сообщение "Обратитесь к основному владельцу или в службу поддержки" при неактивном владельце
- Обработка официальных обращений в поддержку о недееспособности владельцев
- API для администраторов по созданию совладельца и передаче прав основного владельца
- API для назначения нового основного владельца из списка совладельцев
- Система уведомлений совладельцев о необходимости обращения в поддержку
- Интеграция с системой тикетов поддержки
- Возможность удаления питомца при подтверждении смерти/потери

#### 4.18 Отсутствует фильтрация питомцев при поиске на передержку
**Требование**: Фильтрация возможных питомцев по типу, породе, возрасту, медицинским условиям при создании объявления о передержке
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Высокий
**Описание**: При создании объявления о передержке владелец не может фильтровать своих питомцев по различным критериям для выбора наиболее подходящего питомца для передержки
**Решение**: 
- API эндпоинт для фильтрации питомцев пользователя по типу (кошки, собаки, птицы и т.д.)
- Фильтрация по породе питомца
- Фильтрация по возрасту/периоду жизни питомца
- Фильтрация по медицинским условиям и особым потребностям
- Фильтрация по весу питомца (для услуг, где это важно)
- Фильтрация по статусу питомца (активные, архивные)
- Расширенный поиск с множественными критериями
- Сортировка по различным параметрам (возраст, вес, дата последнего посещения)
- Интеграция с профилями питомцев пользователя
- Персонализированные рекомендации на основе истории питомца
- Фильтрация по совместимости с конкретным ситтером
- Учет медицинских противопоказаний
- Рекомендации по периодическим процедурам 

## 5. СИСТЕМА УВЕДОМЛЕНИЙ

### ✅ Реализовано
- Полная система уведомлений с поддержкой email, push и in-app уведомлений
- Настраиваемые шаблоны уведомлений (NotificationTemplate)
- Система предпочтений пользователей (NotificationPreference)
- Интеграция с Django сигналами для автоматических уведомлений
- API для управления уведомлениями

### ❌ ГЭПы

#### 5.1 Жестко заданные связи событий с уведомлениями
**Требование**: Гибкая система связей между событиями и шаблонами уведомлений, управляемая администратором
**Реализация**: ✅ **РЕАЛИЗОВАНО** - создана гибкая система правил уведомлений
**Статус**: ✅ **ГЭП ЗАКРЫТ**
**Приоритет**: Критический

**Описание**: Связи между событиями (создание бронирования, отмена, изменение цены) и шаблонами уведомлений жестко прописаны в коде через Django сигналы в файле `notifications/signals.py`. Администратор не может создавать новые правила уведомлений или изменять существующие связи без изменения кода.

**Проблема**: Отсутствует гибкость в настройке правил уведомлений. Администратор не может:
- Создавать новые связи событий с шаблонами
- Изменять существующие связи без изменения кода
- Настраивать условия срабатывания уведомлений
- Управлять приоритетами уведомлений
- Включать/выключать отдельные правила

**Местоположение**: `notifications/signals.py` - все сигналы уведомлений

**Решение**: ✅ **РЕАЛИЗОВАНО**
- ✅ Создана модель `NotificationRule` для гибких связей событий с шаблонами
- ✅ Обновлены сигналы для использования правил из базы данных
- ✅ Добавлен админский интерфейс для управления правилами уведомлений
- ✅ Создан сервис `NotificationRuleService` для обработки правил с условиями
- ✅ Поддержка приоритетов и условий срабатывания
- ✅ Возможность включения/выключения правил администратором
- ✅ Система наследования правил (глобальные → пользовательские)
- ✅ Валидация правил при создании/изменении
- ✅ Логирование срабатывания правил для аудита
- ✅ API для управления правилами уведомлений
- ✅ Интеграция с существующей системой уведомлений

## 6. СИСТЕМА НАСТРОЕК БЕЗОПАСНОСТИ

### ✅ Реализовано
- API для получения настроек безопасности (SecuritySettingsAPIView)
- Модель настроек аудита (AuditSettings)
- Структура настроек в API (политика паролей, сессии, rate limiting, IP-ограничения)

## 7. СИСТЕМА РЕГИСТРАЦИИ УЧРЕЖДЕНИЙ

### ❌ ГЭПы

#### 7.1 Неправильная логика обязательности документов при регистрации учреждений
**Требование**: Гибкая система определения обязательности документов в зависимости от предоставляемых услуг
**Реализация**: НЕ реализовано - поле documents обязательное для всех учреждений
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Средний

#### 7.2 Невозможность выбора услуги из каталога при добавлении услуги учреждению
**Требование**: Администратор должен выбирать услугу из глобального справочника при добавлении услуги в учреждение
**Реализация**: Исправлено - сериализатор ProviderServiceSerializer обновлен для выбора услуги из каталога
**Статус**: ✅ **ГЭП ЗАКРЫТ**
**Приоритет**: Средний

**Описание**: В сериализаторе ProviderServiceSerializer поле service было помечено как read_only=True, что не позволяло администратору выбирать услугу из каталога при создании связи учреждение-услуга.

**Исправления:**
- Изменен сериализатор для использования PrimaryKeyRelatedField
- Добавлена валидация уникальности услуги в учреждении
- Добавлена проверка корректности цен
- Добавлены все поля модели ProviderService в сериализатор
- Добавлен импорт модели Service

**Описание**: В текущей реализации поле `documents` в модели `ProviderForm` является обязательным для всех учреждений. Это неправильно, так как разные типы услуг требуют разные документы. Например, ветклиники нуждаются в лицензиях на медицинскую деятельность, а груминг-салоны - нет.

**Проблема**: 
- Поле `documents` обязательное для всех учреждений
- Нет связи между типами услуг и обязательностью документов
- Негибкий подход с заранее заданными типами учреждений
- Нет возможности настройки требований к документам

**Местоположение**: 
- `PetsCare/users/models.py` - модель ProviderForm
- `PetsCare/users/serializers.py` - ProviderAdminRegistrationSerializer

**Решение**: 
- Сделать поле `documents` необязательным в модели `ProviderForm`
- Добавить поле `requires_license` в модель `Service` (каталог услуг)
- Создать логику проверки: если учреждение предоставляет услуги с `requires_license=True`, то документы обязательны
- Добавить валидацию в сериализатор на основе выбранных услуг учреждения
- Создать систему настройки требований к документам через админку
- Интеграция с существующей системой каталога услуг
- Возможность настройки разных типов документов для разных услуг

### ❌ ГЭПы

#### 6.1 Отсутствует система настроек безопасности
**Требование**: Настраиваемые параметры безопасности, управляемые администратором через админский интерфейс
**Реализация**: Частично реализовано - есть API, но нет фактической реализации настроек
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Средний

**Описание**: В документации указано, что администратор должен настраивать политику паролей, настройки сессий, ограничения на вход и настройки аудита. В коде есть API для получения этих настроек, но сами настройки не определены в settings.py и не применяются системой.

**Проблема**: 
- Настройки используют `getattr` с дефолтными значениями, но сами переменные не определены
- Нет middleware для применения ограничений (rate limiting, IP-ограничения)
- Нет валидации паролей по настраиваемой политике
- Нет ограничения одновременных сессий
- Нет принудительного выхода при смене пароля

**Местоположение**: 
- `PetsCare/settings/api_views.py` - SecuritySettingsAPIView
- `PetsCare/settings.py` - отсутствуют настройки безопасности

**Решение**: 
- Создать модель `SecuritySettings` для хранения настроек в базе данных
- Определить настройки в settings.py с дефолтными значениями
- Создать middleware для применения ограничений
- Реализовать валидаторы паролей по настраиваемой политике
- Добавить систему ограничения сессий
- Реализовать принудительный выход при смене пароля

#### 6.2 Отсутствует админский интерфейс для настроек безопасности
**Требование**: Удобный интерфейс в Django Admin для управления настройками безопасности
**Реализация**: НЕ реализовано - есть только API, но нет админского интерфейса
**Статус**: ❌ **ГЭП ОТКРЫТ**
**Приоритет**: Средний

**Описание**: Для MVP администратор должен управлять настройками безопасности через Django Admin, а не через REST API. Текущий API для настроек безопасности избыточен и усложняет систему.

**Проблема**: 
- Отсутствует модель для настроек безопасности в базе данных
- Нет админского интерфейса для управления настройками
- API избыточен для административных функций
- Нет валидации настроек в админке

**Местоположение**: Отсутствует

**Решение**: 
- Создать модель `SecuritySettings` с полями для всех настроек безопасности
- Добавить `SecuritySettingsAdmin` в админку с удобным интерфейсом
- Убрать избыточный API для настроек безопасности
- Добавить валидацию настроек в модели
- Создать синглтон для глобальных настроек безопасности
- Добавить логирование изменений настроек безопасности 

---

#### 8 Отсутствует поиск и отображение доступности услуги в выбранное пользователем время для учреждений

**Описание:**
В текущей реализации пользователь при поиске учреждений может выбрать только услугу, но не указывает желаемую дату и/или время оказания услуги. Система не проверяет наличие свободных слотов для выбранной услуги в заданный временной интервал и не отображает "доступность" на карте. Это может вводить пользователя в заблуждение: учреждение отображается как доступное, хотя на самом деле свободных слотов на нужное время может не быть.

**Рекомендация по доработке:**
- Дата и время оказания услуги должны быть доступны для выбора, но не обязательны для заполнения.
- Если не указано время — система показывает первое доступное время записи в выбранный день.
- Если не указана дата — система показывает первое доступное окно вообще.
- Если указаны дата/время как ограничения снизу, для всех учреждений выводятся первые свободные окна начиная с указанного времени.
- Реализовать на бэкенде проверку наличия свободных слотов для выбранной услуги и времени.
- На карте и в списке учреждений отображать только те учреждения, где реально есть возможность записаться на выбранное или ближайшее время. 

---

#### Нет отображения на карте учреждений с ближайшими свободными окнами для выбранной услуги и времени

**Описание:**
В текущей реализации система не отображает на карте учреждения с ближайшими свободными окнами для выбранной услуги, начиная с указанной пользователем даты/времени. Пользователь не видит, где реально можно записаться на услугу в нужное время, что ухудшает UX и затрудняет быстрый выбор.

**Рекомендация по доработке:**
- Реализовать отображение на карте только тех учреждений, где есть свободные окна для выбранной услуги, начиная с указанной даты/времени (или ближайшее, если не указано).
- Показывать цену услуги сразу на карте.

---

#### Нет атомарной транзакции бронирования с обработкой гонок

**Описание:**
В текущей реализации возможна ситуация, когда несколько пользователей одновременно пытаются забронировать одно и то же окно. Нет гарантии атомарности операции: пользователь может получить ошибку только после попытки бронирования, а не на этапе выбора.

**Рекомендация по доработке:**
- Реализовать атомарную транзакцию бронирования с блокировкой слота на время операции.
- При неудаче (окно уже занято) — мгновенно убирать его из доступных и предлагать выбрать другое.

---

#### Нет защиты от злоупотреблений при попытках бронирования

**Описание:**
В текущей реализации отсутствуют механизмы защиты от злоупотреблений: пользователь может бесконечно пытаться бронировать окна, что может привести к нагрузке на систему или попыткам автоматизированного перебора.

**Рекомендация по доработке:**
- Ввести лимиты на количество попыток бронирования за определённый период.
- Реализовать антибот-защиту (например, капча, rate limit, блокировка подозрительной активности). 

---

#### Не реализовано экспоненциальное затухание веса отзывов при расчёте рейтинга

**Описание:**
В функциональном дизайне предусмотрено, что новые отзывы должны иметь больший вес при расчёте рейтинга учреждения/специалиста (экспоненциальное затухание). В текущей реализации все отзывы учитываются одинаково, без учёта возраста.

**Рекомендация по доработке:**
- Реализовать экспоненциальное затухание веса отзывов: чем старше отзыв, тем меньше его влияние на итоговый рейтинг.
- Пример формулы: вес = exp(-λ * возраст_отзыва_в_днях), где λ — коэффициент затухания. 

---

#### Не реализована интеграция с Google Perspective API для модерации отзывов

**Описание:**
В функциональном дизайне предусмотрена автоматическая модерация отзывов через Google Perspective API. В текущей реализации интеграция отсутствует.

**Рекомендация по доработке:**
- Реализовать отправку текста отзыва в Perspective API
- Настроить обработку результатов и пороговые значения для категорий
- Публиковать или отклонять отзывы на основании ответа API

#### Необходимо полностью удалить текущую реализацию модерации отзывов и перейти на модерацию через Perspective API

**Описание:**
В коде присутствует собственная логика фильтрации и модерации отзывов (ручные фильтры, проверки, списки слов и т.д.), которая должна быть полностью удалена.

**Рекомендация по доработке:**
- Удалить все локальные фильтры, проверки и связанные с ними сервисы
- Оставить только интеграцию с Perspective API для модерации отзывов 

---

### HIGH PRIORITY

- Отправка email-уведомлений реализована через SMTP (smtp.gmail.com). Требуется реализовать отправку через Gmail API (Google API) с использованием OAuth2 для повышения надежности, отслеживания доставки и соответствия требованиям безопасности Google. 

### 11. Необходимо убрать автоматическую разблокировку по прошествии времени

**Описание:** В текущей реализации системы блокировки учреждений по задолженности существует функция автоматического снятия блокировок через заданное количество дней (`auto_resolve_threshold_days` в `BlockingSystemSettings`). Это нежелательная функциональность, так как блокировка должна сниматься только при полном погашении задолженности или вручную администратором.

**Проблемы:**
- Автоматическое снятие блокировки без погашения задолженности нарушает финансовую дисциплину
- Учреждение может продолжать накапливать долги, зная что блокировка автоматически снимется
- Отсутствует контроль над процессом разблокировки

**Решение:**
1. Удалить поле `auto_resolve_threshold_days` из модели `BlockingSystemSettings`
2. Удалить задачу `auto_resolve_blockings()` из `billing/tasks.py`
3. Убрать логику автоматического снятия блокировок по времени
4. Оставить только два способа разблокировки:
   - Автоматическая при полном погашении задолженности
   - Ручная администратором/менеджером по биллингу

**Файлы для изменения:**
- `PetsCare/billing/models.py` - удалить поле `auto_resolve_threshold_days`
- `PetsCare/billing/tasks.py` - удалить функцию `auto_resolve_blockings()`
- `FunctionalDesign.md` - обновить описание флоу разблокировки 

---

12. **Отсутствует логика наследования и проверки порогов блокировки в контрактах**

**Описание:** В текущей реализации системы блокировок отсутствует логика, соответствующая функциональному дизайну:

1. **Поля порогов в контракте** (`debt_threshold`, `overdue_threshold_1/2/3`) имеют `null=True, blank=True` - они не обязательные
2. **Нет автоматического наследования** глобальных настроек при создании контракта
3. **Нет проверки** на соответствие глобальным настройкам при активации контракта
4. **Метод `get_blocking_level()`** возвращает 0, если пороги не установлены, вместо применения глобальных настроек
5. **Отсутствует логика активации** контракта (менеджер vs админ) в зависимости от соответствия стандартным условиям

**Требования по ФД:**
- Пороги должны наследоваться из глобальных настроек при создании контракта
- Поля порогов должны быть обязательными
- Если пороги отличаются от глобальных → контракт остается черновиком, активация только админом
- Если пороги стандартные → менеджер может активировать

**Решение:**
1. Сделать поля порогов обязательными в модели `Contract`
2. Добавить автоматическое наследование глобальных настроек при создании контракта
3. Добавить проверку соответствия глобальным настройкам при активации
4. Исправить логику `get_blocking_level()` для применения глобальных настроек как fallback
5. Обновить логику активации контракта согласно бизнес-правилам

**Файлы для изменения:**
- `PetsCare/billing/models.py` - сделать поля порогов обязательными, добавить логику наследования
- `PetsCare/billing/serializers.py` - обновить валидацию
- `PetsCare/billing/views.py` - добавить логику активации контракта 

---

**ГЭП #13: Отсутствуют базовые модели для аналитики пользователей**

**Описание:** В разделе 11.2 ФД описаны метрики роста пользователей, активности и конверсии, но в коде отсутствуют соответствующие модели и сервисы для их расчёта.

**Что описано в ФД, но не реализовано:**
- Модели для хранения данных о росте пользователей
- Сервисы для расчёта активности пользователей
- Логика конверсии "регистрация → бронирование"
- Отчёты по аналитике пользователей

**Файлы для изменения:**
- Создать `PetsCare/analytics/models.py` - модели для аналитики
- Создать `PetsCare/analytics/services.py` - сервисы расчёта метрик
- Добавить API endpoints для отчётов по пользователям

**Приоритет:** Низкий (не критично для MVP)

---

**ГЭП #15: Отсутствует система обнаружения попыток взлома**

**Описание:** В разделе 12.2 ФД упоминается "Попытки взлома" как часть мониторинга безопасности, но в коде отсутствует специализированная система их обнаружения.

**Что описано в ФД, но не реализовано:**
- Система обнаружения попыток брутфорс атак на пароли
- Мониторинг подозрительных паттернов входа в систему
- Обнаружение попыток SQL-инъекций
- Мониторинг попыток доступа к несуществующим ресурсам
- Система блокировки IP-адресов при подозрительной активности
- Уведомления администраторов о попытках взлома

**Текущая реализация:**
- Только стандартные настройки безопасности Django (SecurityMiddleware, CSRF, XFrameOptions)
- Базовое логирование через систему аудита
- Отсутствует специализированная система обнаружения атак

**Решение:**
1. Создать модель `SecurityThreat` для записи попыток взлома
2. Создать middleware `SecurityMonitoringMiddleware` для перехвата подозрительных запросов
3. Реализовать сервис `ThreatDetectionService` с алгоритмами обнаружения:
   - Брутфорс атаки (множественные неудачные попытки входа)
   - SQL-инъекции (паттерны в URL и POST данных)
   - Сканирование уязвимостей (доступ к несуществующим ресурсам)
4. Добавить систему блокировки IP-адресов
5. Интегрировать с системой уведомлений для оповещения администраторов

**Файлы для изменения:**
- Создать `PetsCare/security/models.py` - модели для угроз безопасности
- Создать `PetsCare/security/services.py` - сервисы обнаружения угроз
- Создать `PetsCare/security/middleware.py` - middleware для мониторинга
- Добавить `PetsCare/security/` в INSTALLED_APPS
- Обновить `settings.py` - добавить middleware

**Приоритет:** Средний (важно для безопасности, но не критично для MVP)

---

**ГЭП #16: Отсутствует система политик безопасности и их мониторинга**

**Описание:** В разделе 12.2 ФД упоминается "Нарушения политик безопасности" как часть мониторинга безопасности, но в коде отсутствует система политик и их проверки.

**Что описано в ФД, но не реализовано:**
- Система политик безопасности (password policy, session policy, access policy)
- Мониторинг соблюдения политик пользователями
- Автоматические действия при нарушении политик
- Система уведомлений о нарушениях политик
- Отчёты по соблюдению политик безопасности

**Текущая реализация:**
- Только базовые валидаторы паролей Django
- Отсутствует система политик и их мониторинга
- Нет автоматических действий при нарушениях

**Решение:**
1. Создать модель `SecurityPolicy` для определения политик:
   - Политика паролей (сложность, срок действия, история)
   - Политика сессий (время жизни, количество одновременных сессий)
   - Политика доступа (IP-ограничения, время доступа)
   - Политика данных (классификация, права доступа)
2. Создать модель `PolicyViolation` для записи нарушений
3. Реализовать сервис `PolicyEnforcementService` для проверки соблюдения политик
4. Добавить автоматические действия при нарушениях:
   - Блокировка аккаунта
   - Принудительная смена пароля
   - Уведомления администраторов
5. Интегрировать с системой уведомлений и аудита

**Файлы для изменения:**
- Создать `PetsCare/security/models.py` - модели политик и нарушений
- Создать `PetsCare/security/services.py` - сервисы проверки политик
- Создать `PetsCare/security/admin.py` - админский интерфейс для управления политиками
- Добавить API endpoints для управления политиками
- Обновить систему аутентификации для проверки политик

**Приоритет:** Средний (важно для безопасности, но не критично для MVP) 

---

**ГЭП #14: Отсутствует интеграция с Google Analytics для маркетинговой аналитики**

**Описание:** В разделе 11.2 ФД упоминается Google Analytics для маркетинговой аналитики (источники трафика, география, устройства), но интеграция не реализована.

**Что описано в ФД, но не реализовано:**
- Интеграция с Google Analytics 4
- Сбор данных о источниках трафика
- Анализ географии пользователей
- Статистика по устройствам и браузерам
- Отслеживание путей пользователя по сайту

**Файлы для изменения:**
- Добавить `django-google-analytics` в requirements.txt
- Настроить GA4 в settings.py
- Добавить GA4 код в шаблоны (когда будет фронт)
- Создать сервисы для получения данных из GA4 API

**Приоритет:** Низкий (не критично для MVP, нужен фронт)

---

**ГЭП #17: Отсутствует ограничение частоты запросов (rate limiting) для API**

**Описание:** В разделе 13.1 ФД упоминается "Ограничение частоты запросов" как часть аутентификации API, но система rate limiting не реализована.

**Что описано в ФД, но не реализовано:**
- Ограничение количества запросов для разных типов пользователей
- Различные лимиты для анонимных, авторизованных и административных пользователей
- Система квот для партнеров и внешних приложений
- Автоматическая блокировка при превышении лимитов
- Уведомления о приближении к лимитам

**Текущая реализация:**
- В настройках есть упоминания rate limiting, но нет реальной реализации
- Нет middleware или декораторов для ограничения запросов
- Нет настроек throttling в DRF

**Решение:**
1. Добавить `django-ratelimit` или настроить DRF throttling
2. Создать middleware для rate limiting:
   - Анонимные пользователи: 10 запросов в час
   - Авторизованные пользователи: 100 запросов в час
   - Администраторы: 1000 запросов в час
   - Партнеры: 500 запросов в час
3. Добавить систему квот для разных типов пользователей
4. Реализовать автоматическую блокировку при превышении лимитов
5. Интегрировать с системой уведомлений для оповещения о лимитах

**Файлы для изменения:**
- Добавить `django-ratelimit` в requirements.txt
- Создать `PetsCare/rate_limiting/middleware.py` - middleware для rate limiting
- Обновить `settings.py` - добавить настройки rate limiting
- Добавить декораторы для API views
- Обновить документацию API

**Приоритет:** Низкий (важно для масштабирования, но не критично для MVP)

---

**ГЭП #18: Неправильная частота проверки блокировок учреждений**

**Описание:** В коде настроена ежечасная проверка блокировок учреждений, но в ФД указано, что проверка должна выполняться ежедневно в 02:00.

**Что описано в ФД, но не реализовано:**
- Ежедневная проверка блокировок в 02:00 вместо ежечасной
- Настраиваемая частота проверок
- Поддержка различных расписаний (почасово, ежедневно, еженедельно, ежемесячно)

**Текущая реализация:**
- Проверка блокировок каждый час (3600.0 секунд)
- Не соответствует требованиям ФД

**Решение:**
1. Изменить расписание в `settings.py`:
   ```python
   'check-provider-blocking': {
       'task': 'billing.tasks.run_blocking_check',
       'schedule': crontab(hour=2, minute=0),  # Ежедневно в 02:00
   },
   ```
2. Добавить настройку частоты проверок в `BlockingSystemSettings`
3. Реализовать поддержку различных расписаний

**Файлы для изменения:**
- `PetsCare/settings.py` - изменить CELERY_BEAT_SCHEDULE
- `PetsCare/billing/models.py` - добавить поле для настройки частоты
- `PetsCare/billing/services.py` - обновить логику расписания

**Приоритет:** Низкий (не критично для функциональности, но важно для производительности)

---

**ГЭП #19: Ненужный функционал уведомлений об изменении цен услуг**

**Описание:** В коде реализована система уведомлений об изменении цен услуг, которая отправляет уведомления всем пользователям, когда-либо использовавшим услугу. Этот функционал не имеет бизнес-смысла.

**Проблемы с текущей реализацией:**
- Цена фиксируется при бронировании и не влияет на уже забронированные услуги
- Уведомления отправляются пользователям, которые использовали услугу в прошлом (даже 2 года назад)
- Нет действия, которое пользователь может предпринять после получения уведомления
- Создает информационный шум и спам пользователей
- Отсутствует бизнес-логика для такого уведомления

**Что нужно удалить:**
1. Задачу `send_price_change_notification_task` в `notifications/tasks.py`
2. Сигнал `handle_service_price_change_notifications` в `notifications/signals.py`
3. Management команду `send_price_change_notifications` в `notifications/management/commands/`
4. Тесты для этого функционала
5. Запись в `CELERY_BEAT_SCHEDULE` для еженедельной отправки

**Файлы для изменения:**
- `PetsCare/notifications/tasks.py` - удалить задачу
- `PetsCare/notifications/signals.py` - удалить сигнал
- `PetsCare/notifications/celery.py` - удалить из расписания
- `PetsCare/notifications/management/commands/send_price_change_notifications.py` - удалить файл
- `PetsCare/notifications/tests/test_new_tasks.py` - удалить тесты

**Приоритет:** Низкий (не критично, но улучшает пользовательский опыт)

---

**ГЭП #22: Ненужный функционал еженедельной сводки новых отзывов**

**Описание:** В расписании Celery есть задача для отправки еженедельной сводки новых отзывов, но сама функция не реализована. Этот функционал не имеет четкого назначения.

**Проблемы с этим функционалом:**
- Функция упоминается в расписании, но не реализована в коде
- Неясно, кому должна отправляться сводка (администраторам, владельцам учреждений?)
- Неясно, зачем нужна эта информация и какие действия должны предприниматься
- Дублирует функционал мгновенных уведомлений о новых отзывах
- Отсутствует бизнес-логика для такого уведомления
- Нет четкого понимания содержимого сводки

**Что нужно удалить:**
1. Запись в `CELERY_BEAT_SCHEDULE` для `send-new-review-summary`
2. Любые упоминания этой задачи в коде
3. Если функция будет реализована в будущем - удалить её

**Файлы для изменения:**
- `PetsCare/notifications/celery.py` - удалить из CELERY_BEAT_SCHEDULE
- `PetsCare/notifications/tasks.py` - удалить функцию, если она будет реализована

**Приоритет:** Низкий (не критично, но улучшает пользовательский опыт)

---

**ГЭП #23: Ненужный функционал ежемесячной аналитики уведомлений**

**Описание:** В расписании Celery есть задача для отправки ежемесячной аналитики уведомлений, но сама функция не реализована. Также есть endpoint для админ-аналитики, но функция тоже не реализована.

**Проблемы с этим функционалом:**
- Функция `send_monthly_notification_analytics_task` упоминается в расписании, но не реализована в коде
- Функция `admin_get_analytics` упоминается в URL, но не реализована в коде
- Неясно, кому должна отправляться аналитика (администраторам системы?)
- Неясно, зачем нужна эта информация и какие действия должны предприниматься
- Дублирует функционал `get_notification_stats` для получения статистики уведомлений
- Отсутствует бизнес-логика для такого уведомления
- Нет четкого понимания содержимого аналитики

**Что нужно удалить:**
1. Запись в `CELERY_BEAT_SCHEDULE` для `send-monthly-notification-analytics`
2. URL endpoint `GET /admin/notifications/analytics/` из `urls.py`
3. Любые упоминания этих задач в коде
4. Если функции будут реализованы в будущем - удалить их

**Файлы для изменения:**
- `PetsCare/notifications/celery.py` - удалить из CELERY_BEAT_SCHEDULE
- `PetsCare/notifications/urls.py` - удалить endpoint
- `PetsCare/notifications/api_views.py` - удалить функцию, если она будет реализована
- `PetsCare/notifications/tasks.py` - удалить функцию, если она будет реализована

**Приоритет:** Низкий (не критично, но улучшает пользовательский опыт)

---

**ГЭП #20: Неправильная логика напоминаний о бронированиях**

**Описание:** В коде реализована система напоминаний с фиксированным временем отправки (7:00), что не учитывает индивидуальные предпочтения пользователей и время их бронирований.

**Проблемы с текущей реализацией:**
- Все пользователи получают напоминания в одно и то же время (7:00)
- Не учитывается время бронирования пользователя
- Пользователь может получить напоминание через час после бронирования или за 8 часов до него
- Отсутствует возможность индивидуальной настройки времени напоминания
- Нет глобальной настройки времени напоминания по умолчанию

**Что нужно реализовать:**
1. **Глобальная настройка:** Время напоминания по умолчанию (например, за 2 часа до бронирования)
2. **Индивидуальная настройка:** Пользователь может изменить время напоминания в своих настройках
3. **Индивидуальная логика:** Каждый пользователь получает напоминание за свое настроенное время до бронирования
4. **Периодическая проверка:** Система проверяет каждые 15 минут, какие бронирования требуют напоминания
5. **Множественные напоминания:** Поддержка нескольких напоминаний (например, за 1 день и за 2 часа)

**Решение:**
1. Создать модель `ReminderSettings` с полями:
   - `user` - пользователь
   - `reminder_time_before_booking` - время напоминания до бронирования (в минутах)
   - `multiple_reminders` - поддержка множественных напоминаний
2. Изменить логику задачи `send_upcoming_booking_reminders_task`:
   - Проверять каждые 15 минут вместо фиксированного времени
   - Рассчитывать время напоминания индивидуально для каждого пользователя
   - Учитывать настройки пользователя
3. Добавить API для управления настройками напоминаний
4. Обновить расписание Celery Beat

**Файлы для изменения:**
- `PetsCare/notifications/models.py` - добавить модель ReminderSettings
- `PetsCare/notifications/tasks.py` - изменить логику напоминаний
- `PetsCare/notifications/celery.py` - обновить расписание
- `PetsCare/notifications/api_views.py` - добавить API для настроек
- `PetsCare/settings.py` - добавить глобальную настройку по умолчанию

**Приоритет:** Средний (важно для пользовательского опыта)

---

**ГЭП #21: Ненужный функционал уведомлений о завершенных услугах**

**Описание:** В расписании Celery есть задача для отправки уведомлений о завершенных услугах, но сама функция не реализована. Этот функционал не имеет бизнес-смысла.

**Проблемы с этим функционалом:**
- Пользователь уже знает, что услуга завершена (он был на приеме)
- Создает информационный шум и спам пользователей
- Нет действия, которое пользователь может предпринять после получения уведомления
- Отсутствует бизнес-логика для такого уведомления
- Функция упоминается в расписании, но не реализована в коде

**Что нужно удалить:**
1. Запись в `CELERY_BEAT_SCHEDULE` для `send-completed-service-notifications`
2. Любые упоминания этой задачи в коде
3. Если функция будет реализована в будущем - удалить её

**Файлы для изменения:**
- `PetsCare/notifications/celery.py` - удалить из CELERY_BEAT_SCHEDULE
- `PetsCare/notifications/tasks.py` - удалить функцию, если она будет реализована

**Приоритет:** Низкий (не критично, но улучшает пользовательский опыт) 