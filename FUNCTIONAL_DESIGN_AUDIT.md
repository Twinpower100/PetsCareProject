# Аудит актуальности FunctionalDesign.md

**Дата проверки:** 15 января 2026  
**Проверяющий:** AI Assistant  
**Статус:** Требуется обновление

## Резюме

Документ `FunctionalDesign.md` в целом актуален, но содержит несколько критических несоответствий с текущей реализацией:

1. **КРИТИЧНО:** Система контрактов (Contract) удалена из кода, но описана в документации
2. **ВАЖНО:** Отсутствует описание Step 0 в мастере регистрации провайдера
3. **СРЕДНЕ:** Некоторые детали процесса регистрации провайдера отличаются от реализации

---

## 1. КРИТИЧЕСКИЕ НЕСООТВЕТСТВИЯ

### 1.1 Система контрактов удалена, но описана в документации

**Проблема:**
- В разделе **11.1 "Система контрактов"** (строки 2162-2179) подробно описана система контрактов (`Contract`, `ContractType`, `ContractCommission`, `ContractDiscount`)
- В коде эти модели **удалены** (миграция `billing/migrations/0006_remove_contract_tables.py`)
- Вместо контрактов используется система **публичных оферт** (`PublicOffer`, `DocumentAcceptance`) из приложения `legal`

**Текущая реализация:**
- Провайдеры принимают публичную оферту при регистрации через wizard
- Создается `DocumentAcceptance` с привязкой к `LegalDocument` (тип `global_offer`)
- Региональные дополнения (`RegionalAddendum`) принимаются вместе с офертой
- Биллинг работает на основе условий из `BillingConfig`, а не из контрактов

**Что нужно исправить:**
1. Удалить или переименовать раздел 11.1 "Система контрактов"
2. Добавить описание системы публичных оферт:
   - Модель `PublicOffer` (глобальная оферта)
   - Модель `RegionalAddendum` (региональные дополнения)
   - Модель `DocumentAcceptance` (принятие документов)
   - Процесс принятия оферты в мастере регистрации
   - Подстановка переменных (комиссия, НДС, сроки оплаты)
3. Обновить раздел 11.3 "Обработка платежей" - убрать упоминания контрактов
4. Обновить раздел 11.4 "Система блокировки" - убрать упоминания контрактов

**Ссылки в коде:**
- `PetsCare/legal/models.py` - модели оферт
- `PetsCare/billing/migrations/0006_remove_contract_tables.py` - удаление контрактов
- `PetsCare/users/management/commands/test_provider_registration_flow.py` - комментарий "Contract НЕ создается (старая система удалена)"

---

## 2. ВАЖНЫЕ НЕСООТВЕТСТВИЯ

### 2.1 Отсутствует описание Step 0 в мастере регистрации провайдера

**Проблема:**
- В разделе **5.1 "Регистрация учреждения (Мастер регистрации)"** (строки 1119-1408) описан процесс регистрации через wizard
- Описаны шаги 1-4, но **отсутствует описание Step 0** (вводный шаг)
- В коде реализован `Step0ImportantInfo`, который:
  - Информирует о требованиях к email администратора (должен быть зарегистрирован в системе)
  - Требует подтверждения гарантии точности данных
  - Требует чекбокс подтверждения для продолжения

**Что нужно добавить:**
В раздел 5.1, перед "Шаг 1: Выбор страны регистрации", добавить:

#### Шаг 0: Важная информация и подтверждения
1. **Информация о требованиях:**
   - Система отображает предупреждение о том, что email администратора провайдера должен принадлежать пользователю, уже зарегистрированному и активному в системе
   - Пользователь должен убедиться, что указанный email существует в системе
2. **Гарантия точности данных:**
   - Система отображает предупреждение о том, что провайдер гарантирует точность и подлинность всех предоставленных данных
   - Предоставление ложной информации может привести к отклонению заявки или прекращению сотрудничества
3. **Подтверждение:**
   - Пользователь должен поставить галочку "Я подтверждаю, что прочитал и согласен с требованиями"
   - Только после подтверждения становится доступен переход к следующему шагу
   - Кнопка "Назад" ведет на страницу аккаунта пользователя

**Ссылки в коде:**
- `petcare-web-new/src/components/provider-registration/Step0ImportantInfo.tsx` - компонент Step 0
- `petcare-web-new/src/pages/ProviderRegistrationWizard.tsx` - использование Step 0

---

### 2.2 Процесс регистрации провайдера: автоматическое создание vs модерация

**Проблема:**
- В разделе **5.1, Шаг 5** (строки 1318-1354) описано:
  - Автоматическое создание заявки `ProviderForm` со статусом `pending`
  - Автоматическое назначение биллинг-менеджера
  - Автоматическое одобрение заявки и создание `Provider`
- В комментариях к коду (`test_provider_registration_flow.py`) указано:
  - Провайдер создается **автоматически** при создании заявки (через сигнал `post_save`)
  - Активация происходит **сразу** при одобрении заявки (если реквизиты и оферта заполнены)

**Несоответствие:**
- Документация описывает процесс с модерацией (заявка → одобрение → создание Provider)
- Код реализует упрощенный процесс (заявка → автоматическое создание Provider)

**Что нужно уточнить:**
1. Проверить текущую реализацию сигналов в `users/signals.py`
2. Обновить документацию в соответствии с фактической логикой:
   - Если модерация есть - описать процесс модерации
   - Если модерации нет - описать автоматический процесс
3. Указать условия автоматической активации провайдера

**Ссылки в коде:**
- `PetsCare/users/signals.py` - сигналы создания провайдера
- `PetsCare/users/management/commands/test_provider_registration_flow.py` - описание процесса

---

## 3. СРЕДНИЕ НЕСООТВЕТСТВИЯ

### 3.1 API эндпоинты для контрактов

**Проблема:**
- В разделе **14. API ЭНДПОИНТЫ** (строка 2727) упомянуты эндпоинты:
  - `GET/POST/PUT/PATCH/DELETE /contract-types/` - CRUD типов контрактов
  - `GET/POST/PUT/PATCH/DELETE /contracts/` - CRUD контрактов
- Эти эндпоинты не существуют, так как контракты удалены

**Что нужно исправить:**
1. Удалить упоминания эндпоинтов контрактов
2. Добавить эндпоинты для юридических документов:
   - `GET /api/v1/legal/registration/country/<country_code>/offer/` - получение оферты для регистрации
   - `GET /api/v1/legal/documents/` - список юридических документов
   - `GET /api/v1/legal/documents/<id>/` - детали документа

**Ссылки в коде:**
- `PetsCare/legal/urls.py` - URL-паттерны для юридических документов
- `PetsCare/legal/api_views.py` - API views для юридических документов

---

### 3.2 Права доступа биллинг-менеджера

**Проблема:**
- В разделе **11.2 "Управление менеджерами по биллингу"** (строки 2195-2220) описаны права доступа биллинг-менеджера
- Упоминаются разделы:
  - `Contract (Договоры)` - полный доступ
  - `ContractType (Типы договоров)` - только просмотр
  - `ContractCommission (Комиссии договоров)` - только просмотр
  - `ContractDiscount (Скидки договоров)` - только просмотр
- Эти разделы не существуют, так как контракты удалены

**Что нужно исправить:**
1. Удалить упоминания разделов контрактов
2. Добавить разделы для юридических документов (если биллинг-менеджер должен иметь к ним доступ):
   - `LegalDocument (Юридические документы)` - только просмотр
   - `DocumentAcceptance (Принятие документов)` - полный доступ к принятиям своих провайдеров
   - `RegionalAddendum (Региональные дополнения)` - только просмотр

---

### 3.3 Процесс принятия оферты в мастере

**Проблема:**
- В разделе **5.1, Шаг 4** (строки 1271-1317) описан процесс получения и принятия юридических документов
- Описание соответствует реализации, но можно дополнить:
  - Уточнить, что документы получаются через API эндпоинт `/api/v1/legal/registration/country/<country_code>/offer/`
  - Уточнить логику определения минимального времени чтения (30 секунд или scroll >= 95%)
  - Уточнить, что чекбокс становится доступным при выполнении любого из условий

**Что нужно дополнить:**
1. Добавить описание API эндпоинта для получения документов
2. Уточнить логику активации чекбокса принятия
3. Добавить описание обработки ошибок при получении документов

---

## 4. РЕКОМЕНДАЦИИ ПО ОБНОВЛЕНИЮ

### Приоритет 1 (Критично):
1. ✅ **Удалить или переписать раздел 11.1 "Система контрактов"**
   - Описать систему публичных оферт
   - Объяснить процесс принятия оферты
   - Описать подстановку переменных

2. ✅ **Обновить раздел 11.3 "Обработка платежей"**
   - Убрать упоминания контрактов
   - Описать работу с условиями из `BillingConfig`

3. ✅ **Обновить раздел 11.4 "Система блокировки"**
   - Убрать упоминания контрактов
   - Описать работу с условиями из `BillingConfig`

### Приоритет 2 (Важно):
4. ✅ **Добавить описание Step 0 в раздел 5.1**
   - Описать вводный шаг с предупреждениями
   - Описать требования к email администратора
   - Описать гарантию точности данных

5. ✅ **Уточнить процесс регистрации провайдера**
   - Проверить фактическую логику создания провайдера
   - Обновить описание в соответствии с кодом

### Приоритет 3 (Средне):
6. ✅ **Обновить раздел 14 "API ЭНДПОИНТЫ"**
   - Удалить эндпоинты контрактов
   - Добавить эндпоинты юридических документов

7. ✅ **Обновить раздел 11.2 "Управление менеджерами по биллингу"**
   - Удалить упоминания разделов контрактов
   - Добавить разделы юридических документов (если нужно)

---

## 5. ЧТО АКТУАЛЬНО И НЕ ТРЕБУЕТ ИЗМЕНЕНИЙ

✅ **Актуальные разделы:**
- Раздел 1: Управление пользователями и ролями
- Раздел 2: Управление питомцами
- Раздел 3: Система передержки питомцев
- Раздел 4: Глобальная настройка и справочники
- Раздел 5.2-5.3: Управление локациями и услугами учреждения
- Раздел 6: Система бронирования
- Раздел 7: Система уведомлений
- Раздел 8: Система рейтингов
- Раздел 9: Система отчетов
- Раздел 10: Защита от злоупотреблений
- Раздел 12: Интеграция услуг с типами животных
- Раздел 15: Периодические задачи

---

## 6. ЗАКЛЮЧЕНИЕ

Документ `FunctionalDesign.md` в целом актуален и хорошо структурирован, но требует обновления в части:
1. **Системы контрактов** - полностью переписать на систему оферт
2. **Мастера регистрации провайдера** - добавить Step 0 и уточнить процесс
3. **API эндпоинтов** - обновить список доступных эндпоинтов

Рекомендуется обновить документ в ближайшее время, чтобы избежать путаницы при разработке и поддержке системы.
