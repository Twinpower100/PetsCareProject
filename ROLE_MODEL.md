# Ролевая модель PetCare

## Общие принципы работы с адресами

### Требования к адресам по ролям пользователей

**Обычные пользователи (pet_owner)**:
- Адрес не является обязательным полем
- Могут использовать геолокацию устройства для поиска услуг
- При отказе в доступе к геолокации могут выбрать район на карте
- При отказе от выбора района обязаны ввести адрес вручную
- Адрес используется для персонализации поиска и рекомендаций

**Пэт-ситтеры (pet_sitter)**:
- Адрес является обязательным полем для регистрации и работы
- Адрес должен быть валидирован через систему валидации адресов
- Без валидного адреса ситтер не может быть найден в поиске
- Адрес используется для расчета расстояний при поиске клиентами
- Изменение адреса требует повторной валидации

**Учреждения (provider)**:
- Адрес является обязательным полем для регистрации учреждения
- Адрес должен быть валидирован через систему валидации адресов
- Без валидного адреса учреждение не может быть зарегистрировано
- Адрес используется для поиска учреждений клиентами
- Изменение адреса требует повторной валидации

**Сотрудники учреждений (employee)**:
- Адрес не является обязательным полем
- Для геопоиска используется адрес учреждения, где работает сотрудник
- Могут указать личный адрес для внутренних целей (не публично)
- Личный адрес не влияет на поиск и не отображается клиентам

### Система определения местоположения

**Приоритет источников местоположения**:
1. Геолокация устройства (GPS координаты через браузер)
2. Выбор района на интерактивной карте (fallback)
3. Ручной ввод адреса с автодополнением через Google Places API

**Кэширование местоположения**:
- Координаты пользователя кэшируются на 24 часа
- При изменении местоположения кэш обновляется автоматически
- Кэш используется для оптимизации поиска и уменьшения API-запросов

**Валидация координат**:
- Проверка корректности и разумности координат
- Обратное геокодирование для подтверждения точности
- Автоматическое исправление некорректных координат

## Основные принципы

### 1. **Мультиролевая система**
- Один пользователь может иметь несколько ролей одновременно
- Роли управляются вручную администраторами системы
- Роли не синхронизируются автоматически с моделями

### 2. **Ручное управление ролями**
- Роли назначаются и снимаются администраторами вручную
- Нет автоматической синхронизации с бизнес-логикой
- Полный контроль над назначением ролей

## Роли пользователей

### 1. **pet_owner** - Владелец питомца
- **Назначение:** Вручную администратором
- **Снятие:** Вручную администратором
- **Описание:** Пользователь, который владеет питомцами

### 2. **pet_sitter** - Передержка питомцев
- **Назначение:** Вручную администратором
- **Снятие:** Вручную администратором
- **Описание:** Пользователь, который может брать питомцев на передержку

### 3. **employee** - Сотрудник учреждения
- **Назначение:** Вручную администратором провайдера
- **Снятие:** Вручную администратором провайдера
- **Описание:** Сотрудник учреждения (ветеринар, грумер и т.д.)

### 4. **provider_admin** - Администратор учреждения
- **Назначение:** Вручную системным администратором
- **Снятие:** Вручную системным администратором
- **Описание:** Администратор учреждения, может управлять сотрудниками

### 5. **billing_manager** - Менеджер по биллингу
- **Назначение:** Вручную системным администратором
- **Снятие:** Вручную системным администратором
- **Описание:** Менеджер по биллингу, управляет финансовыми операциями

### 6. **system_admin** - Администратор системы
- **Назначение:** Вручную через админ-панель
- **Снятие:** Вручную через админ-панель
- **Описание:** Администратор системы с полными правами

### 7. **booking_manager** - Менеджер по бронированиям
- **Назначение:** Вручную системным администратором
- **Снятие:** Вручную системным администратором
- **Описание:** Менеджер по бронированиям, управляет процессом завершения и отмены бронирований

## Бизнес-процессы

### Назначение сотрудника в учреждение

1. **Подача заявки:**
   - Пользователь создает заявку `EmployeeJoinRequest`
   - Заявка отправляется администратору учреждения

2. **Рассмотрение заявки:**
   - Администратор учреждения рассматривает заявку
   - Может одобрить или отклонить

3. **Создание связи:**
   - При одобрении создается `EmployeeProvider`
   - **Администратор вручную назначает роль `employee`**

4. **Подтверждение сотрудника:**
   - Сотрудник может подтвердить или отклонить назначение
   - При подтверждении устанавливается `is_confirmed=True`

### Увольнение сотрудника

1. **Установка даты окончания:**
   - Администратор устанавливает `end_date` в `EmployeeProvider`
   - **Администратор вручную снимает роль `employee`**

2. **История работы:**
   - Связь сохраняется для истории
   - Сотрудник может быть повторно принят на работу

## Техническая реализация

### Методы управления ролями

```python
# Проверка ролей
user.has_role('employee')  # Проверяет наличие роли employee
user.has_role('provider_admin')  # Проверяет наличие роли provider_admin

# Добавление ролей
user.add_role('employee')  # Добавляет роль employee
user.add_role('pet_owner')  # Добавляет роль pet_owner

# Удаление ролей
user.remove_role('employee')  # Удаляет роль employee
user.remove_role('pet_owner')  # Удаляет роль pet_owner

# Получение ролей
user.get_roles()  # Возвращает все роли пользователя

# Проверка множественных ролей
user.has_any_role(['employee', 'provider_admin'])  # Хотя бы одна роль
user.has_all_roles(['employee', 'pet_owner'])  # Все роли
```

### Декораторы для проверки доступа

```python
from users.permissions import require_role

@require_role('employee')
def employee_only_view(request):
    """Только для сотрудников"""
    pass

@require_role(['employee', 'provider_admin'])
def employee_or_admin_view(request):
    """Для сотрудников и администраторов"""
    pass
```

## Преимущества ручного управления

1. **Контроль:** Полный контроль над назначением ролей
2. **Гибкость:** Можно назначать роли независимо от бизнес-логики
3. **Простота:** Нет сложной автоматической синхронизации
4. **Надежность:** Нет риска неправильной автоматической синхронизации
5. **Прозрачность:** Явное управление ролями

## Примеры использования

### В представлениях

```python
def approve_employee_request(request, request_id):
    """Одобрение заявки сотрудника"""
    join_request = EmployeeJoinRequest.objects.get(id=request_id)
    
    # Создаем связь сотрудник-учреждение
    EmployeeProvider.objects.create(
        employee=join_request.user.employee_profile,
        provider=join_request.provider,
        start_date=date.today()
    )
    
    # ВРУЧНУЮ назначаем роль employee
    join_request.user.add_role('employee')
    
    # Обновляем статус заявки
    join_request.status = 'approved'
    join_request.save()
    
    return redirect('employee_list')
```

### В админ-панели

```python
class UserAdmin(admin.ModelAdmin):
    """Административная панель для пользователей"""
    
    def assign_employee_role(self, request, queryset):
        """Назначить роль employee выбранным пользователям"""
        for user in queryset:
            user.add_role('employee')
        self.message_user(request, f"Роль employee назначена {queryset.count()} пользователям")
    
    actions = ['assign_employee_role']
```

## Заключение

Ручное управление ролями обеспечивает:
- Полный контроль над системой ролей
- Простоту и надежность
- Гибкость в назначении ролей
- Отсутствие сложной автоматической логики

Роли назначаются и снимаются администраторами вручную в соответствии с бизнес-процессами и потребностями системы.

## Система документов питомца и временные права передержчика

### Документы питомца

Система документов питомца позволяет хранить любые документы: паспорт, справки, сертификаты, страховки, фотографии и др. Все документы реализованы через универсальную модель файла (`PetRecordFile`), которая содержит:

- **Основные поля:** файл, название, описание
- **Тип документа:** связь с моделью `DocumentType`
- **Метаданные:** даты выдачи и истечения (опционально), номер документа, орган выдачи (опционально)
- **Аудит:** кто загрузил, дата загрузки

Типы документов настраиваются через отдельную модель `DocumentType` и могут быть связаны с категориями услуг (например, медицинские документы — с ветеринарными услугами).

Документы могут быть привязаны к:
- питомцу в целом (общие документы)
- медицинским записям (`MedicalRecord`)
- записям о процедурах (`PetRecord`)

### Права загрузки документов

Права на загрузку документов зависят от роли пользователя:

- **pet_owner** — может загружать любые документы для своих питомцев
- **pet_sitter** — во время передержки может загружать документы для питомца (например, фото состояния питомца, справки о посещении ветеринара)
- **employee** — может загружать документы только к своим записям (где он указан как исполнитель)
- **provider_admin** — может загружать документы к записям своего учреждения
- **system_admin** — может загружать документы везде

### Права доступа к документам (просмотр и скачивание)

Права на просмотр и скачивание документов:

- **pet_owner** — видит и скачивает все документы своего питомца
- **pet_sitter** — на время передержки получает права владельца:
  - видит все документы питомца
  - может записывать питомца на прием (дата записи и приема должны быть внутри периода передержки)
  - может добавлять файлы к записям
  - получает уведомления о записях, сделанных владельцем на период передержки
- **employee** — видит документы по своему профилю услуг (например, хирург — все медицинские справки)
- **provider_admin** — видит документы по профилю услуг учреждения
- **system_admin** — видит все документы

### Временные права передержчика

Система временных прав передержчика обеспечивает:

1. **Автоматическое получение прав:** Передержчик автоматически получает права владельца питомца на период передержки
2. **Запись на прием:** Передержчик может записывать питомца на прием в любой период передержки
3. **Уведомления:** Двусторонние уведомления между владельцем и передержчиком о записях на прием
4. **Автоматическое снятие прав:** Права автоматически снимаются по окончании периода передержки

### Уведомления

Система уведомлений для передержки:

- Передержчик получает уведомления о записях, сделанных владельцем на период передержки
- Владелец получает уведомления о записях, сделанных передержчиком на период передержки

### Техническая реализация

```python
# Проверка прав на документы
def can_upload_document(user, pet, record_type=None):
    """Проверяет права пользователя на загрузку документа"""
    if user.has_role('system_admin'):
        return True
    
    if user.has_role('pet_owner') and pet.owners.filter(id=user.id).exists():
        return True
    
    if user.has_role('pet_sitter') and is_active_sitter(user, pet):
        return True
    
    if user.has_role('employee') and record_type and is_record_employee(user, record_type):
        return True
    
    if user.has_role('provider_admin') and is_provider_admin(user, pet.provider):
        return True
    
    return False

def can_view_document(user, pet, document_type=None):
    """Проверяет права пользователя на просмотр документа"""
    if user.has_role('system_admin'):
        return True
    
    if user.has_role('pet_owner') and pet.owners.filter(id=user.id).exists():
        return True
    
    if user.has_role('pet_sitter') and is_active_sitter(user, pet):
        return True
    
    if user.has_role('employee') and document_type and is_employee_service_match(user, document_type):
        return True
    
    if user.has_role('provider_admin') and is_provider_admin(user, pet.provider):
        return True
    
    return False

def is_active_sitter(user, pet):
    """Проверяет, является ли пользователь активным передержчиком питомца"""
    return PetSitting.objects.filter(
        sitter=user,
        pet=pet,
        status='active',
        start_date__lte=date.today(),
        end_date__gte=date.today()
    ).exists()
```

### Преимущества системы

1. **Гибкость:** Универсальная модель документов для всех типов файлов
2. **Безопасность:** Детальный контроль прав доступа по ролям
3. **Автоматизация:** Автоматическое управление временными правами передержчика
4. **Прозрачность:** Полный аудит загрузки и доступа к документам
5. **Интеграция:** Связь документов с записями и услугами 

Интеграция с системой:
- Совместима с существующими моделями Pet и User
- Использует систему уведомлений
- Интегрирована с Django admin
- Поддерживает REST API
- Совместима с системой валидации удаления профилей

## Система отчетности

### Обзор системы отчетов

Система отчетности PetCare предоставляет аналитические данные для различных ролей пользователей, основанные исключительно на данных бронирований, сделанных через нашу систему.

### Для менеджеров учреждений:

1. **Отчет по доходам через систему бронирования** (главный отчет):
   - Общая сумма, полученная через нашу систему за период
   - Сумма комиссии, которую учреждение должно заплатить
   - Количество бронирований через систему
   - Детализация по услугам и периодам

2. **Отчет по загруженности сотрудников**:
   - Количество отработанных часов по сотрудникам
   - Количество оказанных услуг через систему
   - Эффективность использования времени

### Для биллинг-менеджеров (по их клиентам):

1. **Отчет по дебиторской задолженности**:
   - Список учреждений с задолженностью
   - Суммы долгов и сроки просрочки
   - История платежей учреждения
   - Количество дней просрочки

2. **Отчет по активности учреждений**:
   - Объемы услуг по учреждениям через систему

3. **Отчет по платежам**:
   - Полученные платежи за период
   - Ожидаемые платежи
   - Список просроченных платежей с количеством дней просрочки

### Для администраторов системы:

1. **Отчет по дебиторской задолженности** (все учреждения):
   - Список учреждений с задолженностью
   - Суммы долгов и сроки просрочки
   - История платежей учреждения
   - Количество дней просрочки

2. **Отчет по активности учреждений** (все учреждения):
   - Объемы услуг по учреждениям через систему

3. **Отчет по платежам** (все учреждения):
   - Полученные платежи за период
   - Ожидаемые платежи
   - Список просроченных платежей с количеством дней просрочки

4. **Общий отчет по системе**:
   - Общая статистика по всем учреждениям
   - Системные показатели
   - Качество услуг (жалобы)

### Функциональность:

- **Кнопки для генерации отчетов** в админ-панели
- **Фильтры по произвольным периодам** - выбор начальной и конечной даты
- **Множественные фильтры по учреждениям** - возможность выбрать несколько учреждений (для биллинг-менеджеров - только их клиенты, для админов - все)
- **Выгрузка в Excel** с готовыми табличными данными
- **Только данные нашей системы** - без учета прямых клиентов учреждений

### Ключевые принципы:

1. **Данные только нашей системы** - все отчеты строятся исключительно на данных бронирований, сделанных через нашу систему
2. **Дополнительная ценность** - показываем учреждениям дополнительную ценность, которую приносим
3. **Управление задолженностью** - предоставляем биллинг-менеджерам и админам информацию для управления задолженностью
4. **Отложено на развитие** - отчеты по клиентам и отменам будут добавлены в будущих версиях

### Техническая реализация:

```python
# Пример генерации отчета по доходам
def generate_income_report(provider, start_date, end_date):
    """Генерирует отчет по доходам для учреждения"""
    bookings = Booking.objects.filter(
        provider=provider,
        created_at__range=(start_date, end_date),
        status='completed'
    )
    
    total_income = sum(booking.amount for booking in bookings)
    commission = calculate_commission(total_income, provider.contract)
    
    return {
        'total_income': total_income,
        'commission': commission,
        'bookings_count': bookings.count(),
        'details': get_booking_details(bookings)
    }

# Пример генерации отчета по задолженности
def generate_debt_report(providers, start_date, end_date):
    """Генерирует отчет по дебиторской задолженности"""
    debts = []
    for provider in providers:
        overdue_payments = get_overdue_payments(provider, start_date, end_date)
        debts.append({
            'provider': provider,
            'total_debt': sum(payment.amount for payment in overdue_payments),
            'overdue_days': calculate_overdue_days(overdue_payments),
            'payment_history': get_payment_history(provider)
        })
    return debts
```

### Интеграция с ролевой моделью:

- **provider_admin** - доступ к отчетам своего учреждения
- **billing_manager** - доступ к отчетам по своим клиентам
- **system_admin** - доступ ко всем отчетам без ограничений
- **employee** - доступ только к своему расписанию и статистике

### Преимущества системы отчетности:

1. **Прозрачность** - учреждения видят дополнительную ценность от использования системы
2. **Контроль** - биллинг-менеджеры могут эффективно управлять задолженностью
3. **Аналитика** - администраторы получают полную картину работы системы
4. **Гибкость** - настраиваемые фильтры и периоды
5. **Автоматизация** - готовые отчеты без ручных вычислений 

## Автоматическая блокировка учреждений по задолженности

### Роли в системе автоматической блокировки

#### Система (автоматический процесс)
**Обязанности:**
- Расчёт задолженности по расписанию
- Определение срока просрочки от даты первого просроченного платежа
- Сравнение с порогами
- Автоматическая блокировка/разблокировка учреждений
- Отправка уведомлений

**Права**: Автоматическое управление статусами учреждений

#### Менеджер по биллингу (billing_manager)
**Обязанности:**
- Мониторинг задолженностей по своим клиентам
- Связь с учреждениями по вопросам задолженности
- Консультации по погашению задолженности
- Звонки при критических задолженностях

**Права**: Только просмотр информации о задолженностях своих клиентов

#### Админ системы (system_admin)
**Обязанности:**
- Настройка пороговых значений в договорах
- Массовая настройка по географическому принципу
- Массовая настройка по типу услуг
- Настройка периодичности проверок
- Ручная блокировка/разблокировка учреждений
- Исключение учреждений из автоматических проверок

**Права**: Полный контроль над блокировками и настройками системы

#### Руководитель учреждения (provider_admin)
**Обязанности**: 
- Просмотр информации о задолженности и статусе блокировки своего учреждения
- Погашение задолженности

**Права**: Просмотр информации о задолженности и статусе блокировки своего учреждения

### Интеграция с существующими ролями

Система автоматической блокировки интегрирована с существующей ролевой моделью:
- Использует существующие роли `billing_manager`, `system_admin`, `provider_admin`
- Не требует создания новых ролей
- Совместима с существующей системой уведомлений
- Интегрирована с системой договоров и биллинга 

## Ролевая модель доступа к шаблонам блокировки учреждений

### system_admin (Системный администратор)
- Полный доступ ко всем шаблонам блокировки
- Может создавать, редактировать, удалять шаблоны
- Может просматривать историю изменений шаблонов
- Может выполнять массовые операции с шаблонами

### billing_manager (Менеджер по биллингу)
- Может видеть только активные шаблоны блокировки (только для чтения)
- Видит только текущие параметры блокировки (пороги, сроки, валюта)
- Не видит историю изменений шаблонов
- Не получает уведомления о создании/изменении/удалении шаблонов
- При создании договора параметры блокировки автоматически подставляются из шаблона

### provider_admin (Администратор учреждения)
- Не видит шаблоны блокировки
- Видит только параметры блокировки, применённые к своему договору
- Получает уведомления только о факте блокировки учреждения

### Прочие роли
- Не имеют доступа к шаблонам блокировки и их параметрам

### Принципы
- Только system_admin управляет шаблонами
- billing_manager работает только с активными шаблонами и не может их менять
- provider_admin видит только итоговые параметры в своём договоре
- Договор не может быть активирован без шаблона блокировки для региона учреждения 

## Система автоматического планирования расписания

### Роли в системе автоматического планирования

#### provider_admin (Администратор учреждения)
**Обязанности:**
- Настройка рабочих мест учреждения и их специализации
- Настройка ограничений одновременности услуг в рабочих местах
- Управление расписанием учреждения (часы работы, выходные, праздники)
- Настройка потребности в специалистах по дням недели
- Управление приоритетами услуг для планирования
- Создание и редактирование отсутствий сотрудников (отпуска, больничные, отгулы)
- Запуск автоматического планирования расписания
- Просмотр и анализ отчетов по планированию
- Ручная корректировка автоматически созданных расписаний

**Права:**
- Полный доступ к управлению рабочими местами учреждения
- Управление расписанием учреждения и сотрудников
- Создание и редактирование всех типов отсутствий
- Запуск и остановка автоматического планирования
- Просмотр всех отчетов по планированию
- Ручная корректировка расписаний

#### employee (Сотрудник учреждения)
**Обязанности:**
- Просмотр своего рабочего расписания
- Настройка желаемого расписания (предпочтения по дням и часам)
- Уведомление о планируемых отсутствиях (отпуск, отгул)
- Получение уведомлений об изменениях в расписании

**Права:**
- Просмотр только своего расписания
- Настройка своих предпочтений по расписанию
- Создание заявок на отпуск и отгул
- Получение уведомлений о расписании

#### system_admin (Системный администратор)
**Обязанности:**
- Создание и управление типами рабочих мест
- Настройка глобальных параметров планирования
- Мониторинг работы системы автоматического планирования
- Управление алгоритмами планирования
- Создание и редактирование шаблонов расписаний
- Анализ эффективности планирования по всем учреждениям

**Права:**
- Полный доступ ко всем настройкам системы планирования
- Управление глобальными параметрами и алгоритмами
- Просмотр всех отчетов по планированию
- Создание и редактирование шаблонов
- Мониторинг работы системы

### Бизнес-процессы

#### Настройка рабочих мест
1. **provider_admin** создает рабочие места для учреждения
2. Настраивает специализацию каждого рабочего места
3. Устанавливает ограничения одновременности услуг
4. Определяет рабочие зоны для технических специалистов

#### Настройка потребности в специалистах
1. **provider_admin** анализирует потребности учреждения
2. Настраивает количество необходимых специалистов по дням недели
3. Устанавливает приоритеты услуг для планирования
4. Сохраняет настройки для автоматического планирования

#### Создание расписания
1. **provider_admin** запускает автоматическое планирование
2. Система анализирует потребности, предпочтения и ограничения
3. Создается оптимальное расписание с учетом всех параметров
4. **provider_admin** может корректировать результат вручную

#### Управление отсутствиями
1. **employee** создает заявку на отпуск/отгул
2. **provider_admin** одобряет или отклоняет заявку
3. **provider_admin** может создавать больничные для сотрудников
4. Система автоматически перепланирует расписание при отсутствиях

### Интеграция с существующими ролями

Система автоматического планирования интегрирована с существующей ролевой моделью:
- Использует существующие роли `provider_admin`, `employee`, `system_admin`
- Не требует создания новых ролей
- Совместима с существующей системой уведомлений
- Интегрирована с системой бронирования и управления услугами

### Преимущества ролевой модели

1. **Четкое разделение ответственности**: Каждая роль имеет определенные обязанности и права
2. **Гибкость**: Возможность настройки под потребности конкретного учреждения
3. **Контроль**: Полный контроль над процессом планирования со стороны администратора учреждения
4. **Автоматизация**: Минимальное участие сотрудников в процессе планирования
5. **Масштабируемость**: Система работает с любыми типами учреждений и услуг

## Роли в процессе завершения и отмены бронирований

### pet_owner (Владелец питомца)
**Обязанности:**
- Отмена своих бронирований до времени визита
- Получение уведомлений об отменах со стороны учреждения

**Права:**
- Отмена собственных бронирований через личный кабинет
- Просмотр истории своих бронирований и отмен
- Получение уведомлений об изменениях в бронированиях

### employee (Сотрудник учреждения)
**Обязанности:**
- Ручное завершение бронирований после оказания услуг
- Отметка "клиент не явился" при отсутствии клиента
- Получение уведомлений об отменах бронирований

**Права:**
- Завершение бронирований со статусами `completed` или `no_show`
- Просмотр своих завершенных бронирований
- Получение уведомлений об отменах

### provider_admin (Администратор учреждения)
**Обязанности:**
- Ручное завершение бронирований
- Отмена бронирований по инициативе учреждения
- Управление настройками автозавершения для учреждения
- Мониторинг отмен и завершений

**Права:**
- Завершение любых бронирований учреждения
- Отмена бронирований с указанием причины
- Настройка параметров автозавершения
- Просмотр отчетов по отменам и завершениям учреждения

### billing_manager (Менеджер по биллингу)
**Обязанности:**
- Мониторинг отмен бронирований по своим клиентам
- Анализ статистики отмен для управления задолженностью
- Консультации учреждений по вопросам отмен

**Права:**
- Просмотр отчетов по отменам только по своим клиентам
- Анализ статистики отмен по учреждениям
- Доступ к детализации отмен (кто отменил, когда, причина)

### system_admin (Системный администратор)
**Обязанности:**
- Настройка глобальных параметров автозавершения
- Мониторинг работы системы автозавершения
- Управление настройками уведомлений
- Анализ системной статистики отмен

**Права:**
- Полный доступ ко всем настройкам автозавершения
- Просмотр всех отчетов по отменам без ограничений
- Управление глобальными параметрами системы
- Мониторинг работы автоматических процессов

### Система (автоматический процесс)
**Обязанности:**
- Автоматическое завершение "зависших" бронирований
- Отправка уведомлений об отменах и завершениях
- Ведение статистики для отчетов

**Права:**
- Автоматическое изменение статусов бронирований
- Отправка системных уведомлений
- Генерация данных для отчетности

### Бизнес-процессы

#### Ручное завершение бронирования
1. **employee** или **provider_admin** находит бронирование в админке
2. Выбирает статус завершения (`completed` или `no_show`)
3. Система фиксирует время, статус, автора действия
4. Слот в расписании освобождается

#### Отмена бронирования клиентом
1. **pet_owner** отменяет бронирование через личный кабинет
2. Система меняет статус на `cancelled`
3. Отправляются уведомления **employee** и **provider_admin**
4. Слот освобождается

#### Отмена бронирования учреждением
1. **provider_admin** отменяет бронирование с указанием причины
2. Система меняет статус на `cancelled`
3. Отправляется уведомление **pet_owner**
4. Слот освобождается

#### Автоматическое завершение
1. Система проверяет "зависшие" бронирования по расписанию
2. Автоматически завершает бронирования старше настроенного периода
3. Присваивает статус из настроек автозавершения
4. Автор указывается как "Система"

### Интеграция с существующими ролями

Система завершения и отмены бронирований интегрирована с существующей ролевой моделью:
- Использует существующие роли без создания новых
- Совместима с системой уведомлений
- Интегрирована с системой отчетности
- Поддерживает транзакционную защиту

### Преимущества ролевой модели

1. **Четкое разделение ответственности**: Каждая роль имеет определенные права на завершение/отмену
2. **Контроль**: Полный контроль над процессом со стороны администраторов
3. **Автоматизация**: Минимальное участие пользователей в рутинных процессах
4. **Отчетность**: Детальная статистика по отменам для всех уровней
5. **Безопасность**: Транзакционная защита и проверка прав доступа 

## Роли в системе рейтингов и жалоб

### pet_owner (Владелец питомца)
**Обязанности:**
- Оставление отзывов и оценок после получения услуг
- Подача жалоб при некачественном обслуживании
- Использование рейтингов при выборе учреждений и специалистов
- Получение рекомендаций на основе рейтингов

**Права:**
- Создание отзывов и оценок для полученных услуг
- Подача жалоб с описанием проблем и прикреплением доказательств
- Просмотр рейтингов учреждений и специалистов
- Фильтрация результатов поиска по рейтингу
- Просмотр истории собственных отзывов и жалоб
- Получение уведомлений о статусе жалоб

### employee (Сотрудник учреждения)
**Обязанности:**
- Просмотр отзывов и оценок о своей работе
- Ответы на жалобы клиентов в течение 48 часов
- Использование рейтингов для профессионального развития
- Получение уведомлений о новых жалобах

**Права:**
- Просмотр отзывов и оценок о своей работе
- Ответы на жалобы клиентов
- Просмотр собственного рейтинга и его истории
- Получение уведомлений о жалобах и изменениях рейтинга
- Доступ к аналитике по своим отзывам

### provider_admin (Администратор учреждения)
**Обязанности:**
- Мониторинг рейтинга учреждения и сотрудников
- Ответы на жалобы клиентов
- Анализ отзывов для улучшения качества услуг
- Управление репутацией учреждения

**Права:**
- Просмотр рейтинга учреждения и всех сотрудников
- Ответы на жалобы клиентов
- Доступ к детальной аналитике по отзывам и жалобам
- Просмотр статистики по качеству услуг
- Сравнение с конкурентами
- Получение уведомлений о жалобах и изменениях рейтинга

### pet_sitter (Пэт-ситтер)
**Обязанности:**
- Просмотр отзывов от владельцев питомцев
- Ответы на жалобы клиентов
- Использование рейтинга для привлечения клиентов
- Поддержание высокого качества услуг

**Права:**
- Просмотр отзывов и оценок о своей работе
- Ответы на жалобы клиентов
- Просмотр собственного рейтинга и его истории
- Использование рейтинга в профиле для привлечения клиентов
- Получение уведомлений о новых отзывах и жалобах

### system_admin (Системный администратор)
**Обязанности:**
- Рассмотрение жалоб и принятие решений о их справедливости
- Мониторинг подозрительной активности в системе рейтингов
- Управление алгоритмами расчета рейтинга
- Корректировка рейтингов при необходимости
- Анализ общей статистики по системе рейтингов

**Права:**
- Полный доступ ко всем жалобам и отзывам
- Принятие решений о справедливости жалоб
- Ручная корректировка рейтингов с обоснованием
- Просмотр подозрительной активности
- Управление настройками системы рейтингов
- Доступ к полной аналитике по системе рейтингов
- Блокировка аккаунтов за злоупотребления

### Система (автоматический процесс)
**Обязанности:**
- Автоматический расчет рейтингов на основе отзывов и жалоб
- Обнаружение подозрительной активности
- Отправка уведомлений о изменениях рейтинга
- Фильтрация результатов поиска по рейтингу
- Генерация рекомендаций для клиентов

**Права:**
- Автоматическое изменение рейтингов
- Помечание подозрительных отзывов и жалоб
- Отправка системных уведомлений
- Исключение учреждений с низкими рейтингами из поиска
- Генерация данных для аналитики

### Бизнес-процессы

#### Оставление отзыва
1. **pet_owner** получает услугу и оставляет отзыв с оценкой
2. Система автоматически пересчитывает рейтинг **провайдера** и **специалиста**
3. Отправляются уведомления **провайдеру** и **специалисту**
4. Отзыв становится видимым для других клиентов

#### Подача жалобы
1. **pet_owner** подает жалобу с описанием проблемы
2. Система автоматически снижает рейтинг **провайдера** и **специалиста**
3. Отправляются уведомления **провайдеру**, **специалисту** и **system_admin**
4. **Провайдер** или **специалист** может ответить на жалобу в течение 48 часов

#### Рассмотрение жалобы
1. **system_admin** рассматривает жалобу и все материалы
2. Принимает решение о справедливости жалобы
3. Корректирует рейтинги всех участников
4. Отправляет уведомления о решении

#### Обнаружение подозрительной активности
1. Система автоматически анализирует паттерны отзывов и жалоб
2. Помечает подозрительную активность
3. Отправляет уведомления **system_admin**
4. **system_admin** может принять меры (блокировка, корректировка рейтингов)

### Интеграция с существующими ролями

Система рейтингов интегрирована с существующей ролевой моделью:
- Использует существующие роли без создания новых
- Совместима с системой уведомлений
- Интегрирована с системой бронирования и передержки
- Поддерживает защиту от манипуляций

### Преимущества ролевой модели

1. **Качество услуг**: Мотивация провайдеров к улучшению качества через рейтинги
2. **Прозрачность**: Клиенты видят реальные оценки учреждений и специалистов
3. **Справедливость**: Справедливое разрешение конфликтов через жалобы
4. **Защита**: Защита от манипуляций и злоупотреблений
5. **Контроль**: Полный контроль над системой рейтингов со стороны администраторов
6. **Аналитика**: Детальная аналитика для всех участников системы 

## Роли в системе валидации адресов

### pet_owner (Владелец питомца)
**Обязанности:**
- Ввод и валидация адреса в профиле пользователя
- Использование валидированного адреса для поиска ближайших услуг
- Обновление адреса при переезде или изменении местоположения

**Права:**
- Ввод адреса пошагово или одной строкой
- Использование автодополнения при вводе адреса
- Просмотр результатов валидации адреса
- Корректировка адреса при ошибках валидации
- Использование валидированного адреса для геопоиска

### pet_sitter (Пэт-ситтер)
**Обязанности:**
- Ввод и валидация адреса в профиле ситтера
- Обновление адреса при изменении места оказания услуг
- Использование валидированного адреса для привлечения клиентов

**Права:**
- Ввод адреса с автодополнением
- Просмотр результатов валидации
- Корректировка адреса при необходимости
- Использование координат для поиска клиентов

### employee (Сотрудник учреждения)
**Обязанности:**
- Использование валидированного адреса учреждения
- Информирование об изменениях адреса учреждения

**Права:**
- Просмотр валидированного адреса учреждения
- Уведомление администратора об изменениях адреса

### provider_admin (Администратор учреждения)
**Обязанности:**
- Ввод и валидация адреса учреждения
- Обновление адреса при переезде учреждения
- Управление адресами филиалов учреждения
- Мониторинг качества валидации адресов

**Права:**
- Полный доступ к управлению адресами учреждения
- Ввод адресов с автодополнением и валидацией
- Просмотр результатов валидации всех адресов
- Корректировка адресов при ошибках валидации
- Управление несколькими адресами для филиалов

### billing_manager (Менеджер по биллингу)
**Обязанности:**
- Мониторинг качества валидации адресов клиентов
- Консультации по вопросам валидации адресов
- Анализ статистики валидации адресов

**Права:**
- Просмотр статистики валидации адресов по клиентам
- Доступ к отчетам по качеству валидации
- Консультации клиентов по вопросам адресов

### system_admin (Системный администратор)
**Обязанности:**
- Управление настройками системы валидации адресов
- Мониторинг работы внешних API
- Управление кэшированием результатов валидации
- Настройка альтернативных сервисов геокодирования
- Анализ статистики использования API

**Права:**
- Полный доступ к настройкам системы валидации
- Управление API-ключами и лимитами
- Просмотр всех результатов валидации
- Управление кэшем валидации
- Настройка альтернативных сервисов
- Доступ к полной аналитике по валидации

### Система (автоматический процесс)
**Обязанности:**
- Автоматическая валидация адресов при вводе
- Геокодирование адресов через внешние API
- Кэширование результатов валидации
- Мониторинг лимитов API
- Автоматическое определение координат

**Права:**
- Автоматическое обращение к внешним API
- Сохранение результатов валидации
- Управление кэшем валидации
- Отправка уведомлений об ошибках валидации

### Бизнес-процессы

#### Ввод адреса пользователем
1. **Пользователь** (любой роли) начинает ввод адреса
2. Система предоставляет автодополнение через Google Places API
3. **Пользователь** выбирает подходящие варианты
4. Система автоматически валидирует адрес через Google Geocoding API
5. **Пользователь** корректирует адрес при необходимости
6. Система сохраняет валидированный адрес с координатами

#### Обновление адреса учреждения
1. **provider_admin** изменяет адрес учреждения
2. Система автоматически валидирует новый адрес
3. При успешной валидации адрес обновляется
4. Система уведомляет всех сотрудников об изменении адреса
5. Координаты обновляются для геопоиска

#### Мониторинг качества валидации
1. **system_admin** анализирует статистику валидации
2. Мониторит качество результатов геокодирования
3. Настраивает параметры валидации при необходимости
4. Управляет кэшированием для оптимизации

#### Обработка ошибок валидации
1. Система обнаруживает ошибку валидации
2. Отправляет уведомление **пользователю** с описанием проблемы
3. Предлагает альтернативные варианты адреса
4. **system_admin** получает уведомление о системных ошибках

### Интеграция с существующими ролями

Система валидации адресов интегрирована с существующей ролевой моделью:
- Использует существующие роли без создания новых
- Совместима с системой уведомлений
- Интегрирована с системой геопоиска
- Поддерживает все типы пользователей

### Преимущества ролевой модели

1. **Точность**: Высокая точность определения координат для всех пользователей
2. **Удобство**: Пошаговый ввод с автодополнением для всех ролей
3. **Контроль**: Полный контроль над процессом валидации со стороны администраторов
4. **Автоматизация**: Минимальное участие пользователей в процессе валидации
5. **Масштабируемость**: Поддержка различных типов адресов и регионов
6. **Оптимизация**: Эффективное использование внешних API через кэширование 

## Действия пользователей по поиску и фильтрации

### Общие принципы поиска

Система поиска PetCare предоставляет персонализированные возможности для каждой роли пользователя. Все поиски основаны на геопространственных технологиях с поддержкой расширенной фильтрации по различным критериям.

### pet_owner (Владелец питомца)

#### Поиск учреждений
**Доступные действия:**
- Поиск ветеринарных клиник по расстоянию, рейтингу, услугам
- Фильтрация по типу услуг (терапия, хирургия, диагностика, груминг)
- Поиск по цене (диапазон стоимости услуг)
- Фильтрация по времени работы (круглосуточно, только днем)
- Поиск по рейтингу (минимальный рейтинг от 1 до 5 звезд)
- Фильтрация по доступности (наличие свободных слотов)

**Ограничения:**
- Не видит заблокированные учреждения
- Не видит учреждения с рейтингом ниже 2.5 звезд
- Ограничен радиусом поиска (максимум 50 км)

**Результаты поиска:**
- Список учреждений с расстоянием, рейтингом, ценами
- Детальная информация об услугах и расписании
- Возможность бронирования напрямую из результатов поиска

#### Поиск пэт-ситтеров
**Доступные действия:**
- Поиск ситтеров по расстоянию и типу услуг
- Фильтрация по периоду передержки (даты)
- Поиск по цене за день/час передержки
- Фильтрация по условиям (у ситтера дома, у клиента, выезд)
- Поиск по типу животных (кошки, собаки, экзотические)
- Фильтрация по опыту и рейтингу

**Ограничения:**
- Не видит неактивных ситтеров
- Не видит ситтеров с рейтингом ниже 3.0 звезд
- Ограничен радиусом поиска (максимум 30 км)

**Результаты поиска:**
- Список ситтеров с фотографиями и описанием условий
- Информация о опыте, рейтинге, отзывах
- Возможность отправки заявки на передержку

#### Поиск других владельцев
**Доступные действия:**
- Поиск владельцев питомцев в своем районе
- Фильтрация по типу питомцев
- Поиск для обмена опытом и рекомендаций

**Ограничения:**
- Только с согласия других владельцев
- Ограниченная информация (без личных данных)

### pet_sitter (Пэт-ситтер)

#### Поиск клиентов
**Доступные действия:**
- Просмотр объявлений о поиске ситтеров
- Фильтрация по типу животных и периоду
- Поиск по расстоянию от своего адреса
- Фильтрация по условиям (у себя дома, у клиента)

**Ограничения:**
- Только активные объявления
- В рамках своего профиля услуг
- Ограничен радиусом поиска (максимум 20 км)

**Результаты поиска:**
- Список объявлений с описанием питомцев
- Информация о владельцах и требованиях
- Возможность отправки отклика

#### Поиск учреждений
**Доступные действия:**
- Поиск ветеринарных клиник для экстренной помощи
- Поиск зоомагазинов для покупки корма
- Фильтрация по расстоянию и рейтингу

**Ограничения:**
- Только для экстренных случаев
- Ограниченная информация о ценах

### employee (Сотрудник учреждения)

#### Поиск коллег
**Доступные действия:**
- Поиск других сотрудников своего учреждения
- Фильтрация по специализации
- Поиск по графику работы для замен

**Ограничения:**
- Только в рамках своего учреждения
- Только активные сотрудники
- Ограниченная контактная информация

**Результаты поиска:**
- Список коллег с специализацией
- Информация о графике работы
- Возможность связи через внутреннюю систему

#### Поиск клиентов
**Доступные действия:**
- Поиск клиентов по истории посещений
- Фильтрация по питомцам и услугам
- Поиск для напоминаний о приемах

**Ограничения:**
- Только клиенты своего учреждения
- Только в рамках своей специализации
- Соблюдение конфиденциальности

### provider_admin (Администратор учреждения)

#### Поиск сотрудников для найма
**Доступные действия:**
- Поиск потенциальных сотрудников по специализации
- Фильтрация по опыту и рейтингу
- Поиск по географическому расположению
- Фильтрация по доступности (полная/частичная занятость)

**Ограничения:**
- Только активные профили
- Соблюдение трудового законодательства
- Ограниченная личная информация

**Результаты поиска:**
- Список кандидатов с опытом и рейтингом
- Информация о специализации и графике
- Возможность отправки приглашения на работу

#### Поиск клиентов
**Доступные действия:**
- Поиск клиентов по истории посещений
- Фильтрация по активности и лояльности
- Поиск для маркетинговых кампаний
- Анализ клиентской базы

**Ограничения:**
- Только клиенты своего учреждения
- Соблюдение GDPR и конфиденциальности
- Использование только для бизнес-целей

#### Поиск конкурентов
**Доступные действия:**
- Анализ конкурентов в регионе
- Сравнение цен и услуг
- Исследование рынка

**Ограничения:**
- Только публичная информация
- Не для недобросовестной конкуренции

### billing_manager (Менеджер по биллингу)

#### Поиск учреждений с задолженностью
**Доступные действия:**
- Поиск учреждений по задолженности
- Фильтрация по сумме и сроку просрочки
- Поиск по региону и типу услуг
- Анализ платежной дисциплины

**Ограничения:**
- Только учреждения в своем регионе
- Только финансовая информация
- Соблюдение коммерческой тайны

**Результаты поиска:**
- Список учреждений с задолженностью
- Детализация долгов и сроков
- История платежей и контакты

#### Поиск для отчетности
**Доступные действия:**
- Поиск данных для финансовых отчетов
- Фильтрация по периодам и регионам
- Анализ доходов и комиссий

**Ограничения:**
- Только в рамках своих полномочий
- Использование для отчетности

### system_admin (Системный администратор)

#### Полный поиск пользователей
**Доступные действия:**
- Поиск всех пользователей системы
- Фильтрация по ролям и статусам
- Поиск по активности и регистрации
- Анализ пользовательской базы

**Ограничения:**
- Соблюдение конфиденциальности
- Использование только для администрирования
- Логирование всех действий поиска

**Результаты поиска:**
- Полная информация о пользователях
- История активности и ролей
- Возможность управления ролями

#### Поиск учреждений
**Доступные действия:**
- Поиск всех учреждений в системе
- Фильтрация по статусу и задолженности
- Анализ активности и качества услуг
- Мониторинг системы

**Ограничения:**
- Использование только для администрирования
- Соблюдение коммерческой тайны

#### Аналитика поисков
**Доступные действия:**
- Анализ популярных поисковых запросов
- Мониторинг эффективности поиска
- Оптимизация алгоритмов поиска
- Статистика использования системы

**Результаты:**
- Детальная аналитика по всем поискам
- Рекомендации по улучшению системы
- Отчеты по производительности

### booking_manager (Менеджер по бронированиям)

#### Поиск проблемных бронирований
**Доступные действия:**
- Поиск отмененных бронирований
- Фильтрация по причинам отмены
- Поиск no-show случаев
- Анализ жалоб и конфликтов

**Ограничения:**
- Только в рамках своих полномочий
- Использование для разрешения конфликтов

**Результаты поиска:**
- Список проблемных случаев
- Детализация причин и участников
- Возможность принятия мер

### Технические особенности поиска

#### Геопространственный поиск
- Все поиски используют координаты для расчета расстояний
- Формула гаверсинуса для точного расчета
- Геопространственные индексы для оптимизации
- Кэширование результатов для производительности

#### Фильтрация по ролям
- Каждая роль имеет свои ограничения доступа
- Автоматическая фильтрация результатов по правам
- Логирование всех поисковых запросов
- Защита от несанкционированного доступа

#### Персонализация
- Адаптация результатов под роль пользователя
- Учет истории поиска и предпочтений
- Рекомендательная система
- Сохранение избранных результатов

### Безопасность и конфиденциальность

#### Защита персональных данных
- Соблюдение GDPR и локального законодательства
- Ограничение доступа к личной информации
- Шифрование чувствительных данных
- Логирование доступа к персональным данным

#### Аудит поисковых запросов
- Запись всех поисковых запросов
- Мониторинг подозрительной активности
- Анализ паттернов использования
- Предотвращение злоупотреблений

### Преимущества системы поиска по ролям

1. **Безопасность**: Строгое разграничение доступа по ролям
2. **Персонализация**: Адаптация под потребности каждой роли
3. **Эффективность**: Оптимизированные запросы для каждой роли
4. **Контроль**: Полный аудит и мониторинг поисков
5. **Масштабируемость**: Поддержка роста количества пользователей
6. **Интеграция**: Полная интеграция с ролевой системой 

## 1. User (Пользователь)

**Описание**: 
Базовая учетная запись, через которую человек получает доступ к системе. Может совмещать несколько ролей (например, быть и владельцем питомца, и сотрудником учреждения, и пэт-ситтером). 

**Возможности**:
• Регистрация и вход в систему.
• Управление своими личными данными.
• Может быть связан с профилем сотрудника (Employee), владельца питомца (Pet Owner), пэт-ситтера (Sitter).
• Удаление своей учетной записи через личный кабинет (см. условия ниже).
• Получение уведомлений о назначении на роль сотрудника, необходимости подтверждения роли, отклонении/одобрении заявок, попытках удаления аккаунта и др.

**Работа с адресом**:
• Адрес не является обязательным полем
• Может использовать геолокацию устройства для поиска услуг
• При отказе в доступе к геолокации может выбрать район на карте
• При отказе от выбора района обязан ввести адрес вручную
• Адрес используется для персонализации поиска и рекомендаций

________________________________________
24. Система аудита и логирования по ролям

### Обзор системы аудита

Система аудита PetCare обеспечивает полный контроль и прозрачность всех действий пользователей в зависимости от их ролей. Каждая роль имеет определенные права доступа к логам и аудиту, что обеспечивает безопасность и соответствие принципу минимальных привилегий.

### pet_owner (Владелец питомца)

#### Доступ к логам
**Что может просматривать:**
- Собственные действия в системе
- История своих бронирований и изменений
- Логи своих питомцев (изменения карт, документов)
- История передач прав основного владельца
- Собственные отзывы и жалобы

**Ограничения:**
- Только собственные данные
- Не может видеть логи других пользователей
- Не может видеть системные логи

#### Аудит собственных действий
**Отслеживаемые операции:**
- Создание и отмена бронирований
- Изменения в профиле питомцев
- Загрузка и удаление документов
- Передача прав основного владельца
- Оставление отзывов и жалоб

**Отчеты:**
- История активности в системе
- Статистика использования услуг
- Отчет по питомцам и их документам

### employee (Сотрудник учреждения)

#### Доступ к логам
**Что может просматривать:**
- Собственные действия в системе
- Логи своих приемов и процедур
- История изменений в медицинских записях
- Собственное расписание и изменения
- Отзывы и жалобы на свою работу

**Ограничения:**
- Только собственные данные
- Не может видеть логи других сотрудников
- Не может видеть финансовые логи учреждения

#### Аудит профессиональной деятельности
**Отслеживаемые операции:**
- Проведение приемов и процедур
- Изменения в медицинских записях
- Заполнение рекомендаций
- Изменения в расписании работы
- Ответы на жалобы и отзывы

**Отчеты:**
- Статистика проведенных приемов
- Отчет по качеству работы (рейтинги)
- История изменений в записях

### provider_admin (Администратор учреждения)

#### Доступ к логам
**Что может просматривать:**
- Логи своего учреждения
- Действия всех сотрудников учреждения
- Бронирования в своем учреждении
- Изменения в услугах и ценах
- Финансовые операции учреждения

**Ограничения:**
- Только данные своего учреждения
- Не может видеть логи других учреждений
- Не может видеть системные логи

#### Аудит управления учреждением
**Отслеживаемые операции:**
- Управление сотрудниками (найм, увольнение)
- Изменения в расписании учреждения
- Изменения в услугах и ценах
- Обработка жалоб и конфликтов
- Управление документами учреждения

**Отчеты:**
- Отчет по активности сотрудников
- Статистика бронирований и отмен
- Отчет по качеству услуг
- Финансовая отчетность учреждения

### sitter (Пэт-ситтер)

#### Доступ к логам
**Что может просматривать:**
- Собственные действия в системе
- История передержек и изменений
- Отзывы и жалобы от клиентов
- Изменения в профиле и услугах
- Финансовые операции по передержкам

**Ограничения:**
- Только собственные данные
- Не может видеть логи клиентов
- Не может видеть системные логи

#### Аудит услуг передержки
**Отслеживаемые операции:**
- Создание и изменение профиля
- Подтверждение и отмена передержек
- Загрузка документов питомцев
- Ответы на отзывы и жалобы
- Изменения в условиях и ценах

**Отчеты:**
- Статистика передержек
- Отчет по рейтингу и отзывам
- Финансовая отчетность

### billing_manager (Менеджер по биллингу)

#### Доступ к логам
**Что может просматривать:**
- Финансовые операции своих учреждений
- Логи изменений договоров
- История блокировок и разблокировок
- Платежи и возвраты
- Отчеты по задолженности

**Ограничения:**
- Только учреждения в своем регионе
- Только финансовая информация
- Не может видеть личные данные пользователей

#### Аудит финансовых операций
**Отслеживаемые операции:**
- Создание и изменение договоров
- Изменение комиссий и скидок
- Блокировка и разблокировка учреждений
- Проведение платежей и возвратов
- Изменение условий блокировки

**Отчеты:**
- Отчет по дебиторской задолженности
- Статистика платежей
- Отчет по блокировкам
- Финансовая аналитика

### system_admin (Системный администратор)

#### Доступ к логам
**Что может просматривать:**
- Все логи системы
- Действия всех пользователей
- Системные операции и ошибки
- Изменения ролей и прав доступа
- Подозрительная активность

**Ограничения:**
- Соблюдение конфиденциальности
- Использование только для администрирования
- Логирование всех действий аудита

#### Аудит безопасности системы
**Отслеживаемые операции:**
- Изменения ролей и прав пользователей
- Создание и удаление инвайтов
- Системные настройки и конфигурации
- Блокировки и разблокировки пользователей
- Обнаружение подозрительной активности

**Отчеты:**
- Отчет по безопасности системы
- Анализ подозрительной активности
- Статистика изменений ролей
- Мониторинг системных ошибок

### Практические сценарии аудита по ролям

#### Сценарий 1: Расследование жалобы клиента
**Участники:**
- **provider_admin**: Просматривает логи бронирования и действий сотрудника
- **employee**: Просматривает собственные действия по данному случаю
- **system_admin**: Полный аудит всех участников конфликта

**Действия:**
- Анализ истории бронирования
- Просмотр действий сотрудника
- Проверка жалоб и ответов
- Принятие решения по конфликту

#### Сценарий 2: Финансовая проверка учреждения
**Участники:**
- **billing_manager**: Аудит финансовых операций учреждения
- **provider_admin**: Просмотр финансовых логов учреждения
- **system_admin**: Полный финансовый аудит

**Действия:**
- Проверка истории платежей
- Анализ изменений договоров
- Контроль блокировок
- Составление финансового отчета

#### Сценарий 3: Кадровый контроль
**Участники:**
- **provider_admin**: Аудит действий сотрудников
- **system_admin**: Полный кадровый аудит

**Действия:**
- Проверка истории найма и увольнений
- Анализ изменений ролей
- Контроль доступа к данным
- Мониторинг подозрительной активности

#### Сценарий 4: Аудит качества услуг
**Участники:**
- **provider_admin**: Анализ качества услуг учреждения
- **employee**: Просмотр собственных рейтингов
- **system_admin**: Общий анализ качества по системе

**Действия:**
- Анализ отзывов и жалоб
- Проверка рейтингов
- Исследование причин проблем
- Разработка мер по улучшению

### Отчетность по ролям

#### Стандартные отчеты для каждой роли
**pet_owner:**
- История активности в системе
- Отчет по питомцам и документам
- Статистика использования услуг

**employee:**
- Отчет по проведенным приемам
- Статистика качества работы
- История изменений в записях

**provider_admin:**
- Отчет по активности учреждения
- Статистика сотрудников
- Финансовая отчетность

**sitter:**
- Отчет по передержкам
- Статистика рейтингов
- Финансовая отчетность

**billing_manager:**
- Отчет по задолженности
- Статистика платежей
- Анализ финансовых показателей

**system_admin:**
- Отчет по безопасности
- Анализ подозрительной активности
- Общая статистика системы

### Преимущества ролевого аудита

1. **Безопасность**: Строгое разграничение доступа к логам
2. **Контроль**: Полный контроль действий каждой роли
3. **Прозрачность**: Прозрачность операций для всех участников
4. **Соответствие**: Соответствие требованиям по аудиту
5. **Эффективность**: Оптимизированные отчеты для каждой роли
6. **Защита**: Защита от злоупотреблений и нарушений

### Действия администратора по настройке системы логирования и аудита

#### Первоначальная настройка системы

**1. Установка и миграция**
```bash
# Создание миграций для системы аудита
python manage.py makemigrations audit

# Применение миграций к базе данных
python manage.py migrate audit
```

**2. Настройка в Django Admin**
- Вход в админ-панель: `http://localhost:8000/admin/`
- Переход в раздел **Audit → Audit Settings**
- Создание и настройка глобальных параметров системы

**3. Конфигурация основных параметров**
- **Logging Enabled**: Включение системы логирования
- **Security Audit Enabled**: Включение аудита безопасности
- **Log Retention (days)**: 365 дней для обычных логов
- **Security Audit Retention (days)**: 2555 дней (7 лет) для аудита
- **Auto Cleanup Enabled**: Автоматическая очистка старых записей
- **Cleanup Frequency (days)**: Периодичность очистки (7 дней)

#### Настройка прав доступа по ролям

**1. Создание групп пользователей**
- **Audit Viewers**: Базовый доступ к просмотру логов
- **Audit Managers**: Управление настройками и проверка записей
- **System Security Admins**: Полный доступ к системе безопасности

**2. Назначение прав по ролям**
- **pet_owner**: Доступ к собственным логам через группу Audit Viewers
- **employee**: Доступ к логам учреждения через группу Audit Viewers
- **provider_admin**: Доступ к логам учреждения + группа Audit Managers
- **sitter**: Доступ к собственным логам через группу Audit Viewers
- **billing_manager**: Доступ к финансовым логам + группа Audit Managers
- **system_admin**: Полный доступ через группу System Security Admins

**3. Настройка ограничений доступа**
- Ограничение просмотра логов по учреждениям для provider_admin
- Ограничение финансовых логов по регионам для billing_manager
- Полный доступ для system_admin с обязательным логированием действий

#### Настройка мониторинга и алертов

**1. Создание дашборда мониторинга**
- **Recent User Actions**: Последние действия пользователей
- **Critical Security Audits**: Критические записи аудита
- **Pending Reviews**: Записи, требующие проверки
- **System Performance**: Производительность системы логирования

**2. Настройка фильтров по ролям**
- **High Priority Audits**: Критические операции для system_admin
- **Financial Operations**: Финансовые операции для billing_manager
- **Provider Operations**: Операции учреждений для provider_admin
- **User Activity**: Активность пользователей для всех ролей

**3. Конфигурация уведомлений**
- Email уведомления о критических операциях
- Алерты при превышении лимитов активности
- Уведомления о подозрительной активности
- Мониторинг производительности системы

#### Настройка периодических задач

**1. Автоматическая очистка логов**
```bash
# Настройка еженедельной очистки
python manage.py cleanup_old_logs --force

# Тестовый запуск очистки
python manage.py cleanup_old_logs --dry-run
```

**2. Экспорт данных для архивирования**
```bash
# Ежемесячный экспорт всех данных
python manage.py export_audit_data --format json --include-logs --include-audits

# Экспорт данных за определенный период
python manage.py export_audit_data --start-date 2024-01-01 --end-date 2024-01-31
```

**3. Мониторинг статистики**
```bash
# Еженедельная статистика
python manage.py audit_statistics --period week

# Детальная месячная статистика
python manage.py audit_statistics --period month --detailed
```

#### Настройка резервного копирования

**1. Включение таблиц аудита в резервные копии**
- `audit_useraction` - логи действий пользователей
- `audit_securityaudit` - записи аудита безопасности
- `audit_auditsettings` - настройки системы

**2. Настройка архивирования**
- Ежемесячный экспорт в JSON/CSV форматах
- Сжатие исторических данных
- Хранение архивов в отдельном хранилище

#### Процедуры обслуживания по ролям

**1. Еженедельные процедуры для system_admin**
- Проверка критических записей аудита
- Анализ подозрительной активности
- Мониторинг производительности системы
- Проверка корректности логирования

**2. Ежемесячные процедуры для billing_manager**
- Аудит финансовых операций
- Проверка изменений договоров
- Анализ блокировок учреждений
- Составление финансовых отчетов

**3. Ежеквартальные процедуры для provider_admin**
- Аудит деятельности учреждения
- Анализ качества услуг
- Проверка действий сотрудников
- Оптимизация процессов

#### Контрольный список настройки

**Первоначальная настройка:**
- [ ] Миграции базы данных выполнены
- [ ] Настройки аудита сконфигурированы
- [ ] Middleware добавлен в settings.py
- [ ] Группы пользователей созданы
- [ ] Права доступа назначены по ролям

**Настройка мониторинга:**
- [ ] Дашборд в админке создан
- [ ] Фильтры по ролям настроены
- [ ] Уведомления и алерты настроены
- [ ] Процедуры реагирования определены

**Настройка обслуживания:**
- [ ] Периодические задачи настроены
- [ ] Резервное копирование настроено
- [ ] Процедуры архивирования определены
- [ ] Документация создана

**Тестирование по ролям:**
- [ ] Логирование действий каждой роли протестировано
- [ ] Ограничения доступа проверены
- [ ] Производительность системы оценена
- [ ] Процедуры восстановления протестированы

#### Рекомендации по безопасности для каждой роли

**1. system_admin**
- Ежедневная проверка критических записей аудита
- Еженедельный анализ подозрительной активности
- Ежемесячный полный аудит системы безопасности
- Регулярное обновление процедур реагирования

**2. billing_manager**
- Еженедельная проверка финансовых операций
- Мониторинг изменений договоров
- Контроль блокировок учреждений
- Анализ трендов финансовой активности

**3. provider_admin**
- Еженедельная проверка активности учреждения
- Мониторинг действий сотрудников
- Анализ качества услуг
- Контроль соблюдения процедур

**4. employee**
- Ежедневная проверка собственных действий
- Контроль корректности внесенных данных
- Соблюдение процедур безопасности
- Сообщение о подозрительной активности

**5. sitter**
- Контроль собственных действий в системе
- Проверка корректности данных о передержках
- Соблюдение процедур безопасности
- Мониторинг отзывов и рейтингов

**6. pet_owner**
- Контроль собственных действий в системе
- Проверка корректности данных питомцев
- Соблюдение процедур безопасности
- Мониторинг истории бронирований

#### Процедуры реагирования на инциденты

**1. Обнаружение подозрительной активности**
- Немедленное уведомление system_admin
- Блокировка подозрительных аккаунтов
- Анализ логов для выявления паттернов
- Документирование инцидента

**2. Критические финансовые операции**
- Уведомление billing_manager и system_admin
- Приостановка подозрительных операций
- Аудит всех связанных действий
- Принятие мер по предотвращению

**3. Нарушения безопасности учреждения**
- Уведомление provider_admin и system_admin
- Аудит действий сотрудников учреждения
- Принятие мер по исправлению
- Обновление процедур безопасности

**4. Системные сбои и ошибки**
- Немедленное уведомление system_admin
- Анализ логов для выявления причин
- Восстановление системы
- Документирование и анализ инцидента

#### Обучение и поддержка

**1. Обучение команды**
- Регулярные тренинги по процедурам аудита
- Обновление знаний о новых угрозах
- Практические занятия по реагированию
- Тестирование процедур безопасности

**2. Документация**
- Создание руководств для каждой роли
- Обновление процедур безопасности
- Документирование инцидентов
- Создание базы знаний

**3. Поддержка пользователей**
- Консультации по вопросам аудита
- Помощь в интерпретации логов
- Обучение использованию системы
- Техническая поддержка

#### Соответствие требованиям

**1. GDPR соответствие**
- Регулярные проверки обработки персональных данных
- Аудит прав на забвение и доступ
- Контроль согласий на обработку данных
- Обновление процедур в соответствии с требованиями

**2. PCI DSS соответствие**
- Аудит финансовых операций
- Защита чувствительных данных
- Мониторинг доступа к финансовой информации
- Регулярные проверки соответствия

**3. Внутренние требования**
- Соответствие корпоративным политикам
- Аудит соблюдения процедур
- Контроль качества услуг
- Мониторинг эффективности процессов

## ДЕЙСТВИЯ РОЛЕЙ В СИСТЕМЕ УВЕДОМЛЕНИЙ

### Общие принципы

Система уведомлений PetCare предоставляет разные возможности для разных ролей пользователей. Обязательные уведомления (верификация email, инвайты ролей) не настраиваются пользователями, а настраиваемые уведомления контролируются индивидуально каждым пользователем.

### 1. pet_owner (Владелец питомца)

#### Обязательные уведомления (не настраиваются)
- **Верификация email**: При регистрации получает email для подтверждения адреса
- **Сброс пароля**: Может запросить сброс пароля через email
- **Инвайты ролей**: Получает уведомления о назначении новых ролей

#### Настраиваемые уведомления
**Типы событий для настройки**:
- **Бронирование**: Новое бронирование, изменение бронирования
- **Отмена**: Отмена бронирования (клиентом или учреждением)
- **Передержка**: Напоминания о передержке питомца
- **Прием**: Напоминания о предстоящем приеме у ветеринара/грумера

**Действия**:
- Настраивает каналы доставки для каждого типа события (push, in-app, email)
- Настраивает время уведомления до события (30 мин, 1 час, 2 часа, 6 часов, 12 часов, 24 часа, мгновенно)
- Управляет настройками через мобильное приложение
- Получает тестовые уведомления для проверки настроек

### 2. pet_sitter (Пэт-ситтер)

#### Обязательные уведомления (не настраиваются)
- **Верификация email**: При регистрации получает email для подтверждения адреса
- **Сброс пароля**: Может запросить сброс пароля через email
- **Инвайты ролей**: Получает уведомления о назначении новых ролей

#### Настраиваемые уведомления
**Типы событий для настройки**:
- **Передержка**: Новые заявки на передержку, изменения в заявках
- **Отмена**: Отмена передержки клиентом
- **Отзывы**: Новые отзывы от клиентов
- **Система**: Важные изменения в системе

**Действия**:
- Настраивает каналы доставки для каждого типа события
- Настраивает время уведомления до события
- Управляет настройками через мобильное приложение
- Получает уведомления о новых заявках на передержку

### 3. employee (Сотрудник учреждения)

#### Обязательные уведомления (не настраиваются)
- **Верификация email**: При регистрации получает email для подтверждения адреса
- **Сброс пароля**: Может запросить сброс пароля через email
- **Инвайты ролей**: Получает уведомления о назначении новых ролей

#### Настраиваемые уведомления
**Типы событий для настройки**:
- **Прием**: Напоминания о предстоящих приемах
- **Расписание**: Изменения в расписании работы
- **Система**: Важные изменения в системе

**Действия**:
- Настраивает каналы доставки для каждого типа события
- Настраивает время уведомления до события
- Управляет настройками через мобильное приложение
- Получает уведомления о назначенных приемах

### 4. provider_admin (Администратор учреждения)

#### Обязательные уведомления (не настраиваются)
- **Верификация email**: При регистрации получает email для подтверждения адреса
- **Сброс пароля**: Может запросить сброс пароля через email
- **Инвайты ролей**: Получает уведомления о назначении новых ролей

#### Настраиваемые уведомления
**Типы событий для настройки**:
- **Сотрудники**: Заявки на работу, изменения в составе сотрудников
- **Бронирования**: Новые бронирования, отмены, изменения
- **Система**: Важные изменения в системе, блокировки учреждения
- **Финансы**: Уведомления о задолженности, платежах

**Действия**:
- Настраивает каналы доставки для каждого типа события
- Настраивает время уведомления до события
- Управляет настройками через мобильное приложение
- Получает уведомления о критических событиях учреждения

### 5. billing_manager (Менеджер по биллингу)

#### Обязательные уведомления (не настраиваются)
- **Верификация email**: При регистрации получает email для подтверждения адреса
- **Сброс пароля**: Может запросить сброс пароля через email
- **Инвайты ролей**: Получает уведомления о назначении новых ролей

#### Настраиваемые уведомления
**Типы событий для настройки**:
- **Финансы**: Критические финансовые операции, задолженности
- **Договоры**: Изменения в договорах, истечение сроков
- **Блокировки**: Автоматические блокировки учреждений
- **Система**: Важные изменения в системе

**Действия**:
- Настраивает каналы доставки для каждого типа события
- Настраивает время уведомления до события
- Управляет настройками через мобильное приложение
- Получает уведомления о критических финансовых событиях

### 6. system_admin (Администратор системы)

#### Обязательные уведомления (не настраиваются)
- **Верификация email**: При регистрации получает email для подтверждения адреса
- **Сброс пароля**: Может запросить сброс пароля через email
- **Инвайты ролей**: Получает уведомления о назначении новых ролей

#### Настраиваемые уведомления
**Типы событий для настройки**:
- **Система**: Критические системные события, сбои
- **Безопасность**: Подозрительная активность, нарушения безопасности
- **Производительность**: Проблемы с производительностью системы
- **Пользователи**: Критические действия пользователей

**Действия**:
- Настраивает каналы доставки для каждого типа события
- Настраивает время уведомления до события
- Управляет настройками через мобильное приложение
- Получает уведомления о критических системных событиях

### 7. booking_manager (Менеджер по бронированиям)

#### Обязательные уведомления (не настраиваются)
- **Верификация email**: При регистрации получает email для подтверждения адреса
- **Сброс пароля**: Может запросить сброс пароля через email
- **Инвайты ролей**: Получает уведомления о назначении новых ролей

#### Настраиваемые уведомления
**Типы событий для настройки**:
- **Бронирования**: Критические изменения в бронированиях
- **Отмены**: Массовые отмены, подозрительная активность
- **Система**: Проблемы с системой бронирований
- **Качество**: Жалобы, низкие рейтинги

**Действия**:
- Настраивает каналы доставки для каждого типа события
- Настраивает время уведомления до события
- Управляет настройками через мобильное приложение
- Получает уведомления о проблемах с качеством услуг

### Технические возможности ролей

#### Управление токенами устройств
**Все роли**:
- Автоматическая регистрация токенов при входе в приложение
- Удаление токенов при выходе из приложения
- Обновление токенов при их изменении
- Поддержка множественных устройств для одного пользователя

#### Централизованный сервис отправки
**Все роли**:
- Получение уведомлений через единый интерфейс
- Retry логика при ошибках отправки
- Логирование всех попыток отправки
- Очередь для массовых рассылок

#### HTML шаблоны для email
**Все роли**:
- Получение брендированных email с логотипом PetCare
- Поддержка переменных в шаблонах
- Адаптивный дизайн для мобильных устройств
- Текстовые версии для совместимости

### Безопасность и приватность

#### GDPR соответствие
**Все роли**:
- Согласие на получение уведомлений при регистрации
- Простая возможность отписки от уведомлений
- Минимизация персональных данных в уведомлениях
- Ограниченное хранение данных уведомлений

#### Ограничения частоты
**Все роли**:
- Защита от спама уведомлений
- Ограничения на количество уведомлений в единицу времени
- Возможность настройки "тихого времени"
- Приоритизация критических уведомлений

### Мониторинг и аналитика

#### Статистика по ролям
- **pet_owner**: Статистика уведомлений о бронированиях и передержках
- **pet_sitter**: Статистика уведомлений о заявках и отзывах
- **employee**: Статистика уведомлений о приемах и расписании
- **provider_admin**: Статистика уведомлений о сотрудниках и финансах
- **billing_manager**: Статистика финансовых уведомлений
- **system_admin**: Статистика системных уведомлений
- **booking_manager**: Статистика уведомлений о качестве услуг

#### Оптимизация по ролям
- Анализ предпочтений пользователей по каналам доставки
- Оптимизация времени отправки уведомлений
- A/B тестирование разных вариантов уведомлений
- Анализ конверсии уведомлений в действия

### Интеграция с существующими системами

#### Интеграция с ролевой моделью
- Разные типы уведомлений для разных ролей
- Разные настройки уведомлений для разных ролей
- Контроль доступа к настройкам уведомлений по ролям

#### Интеграция с системой бронирований
- Автоматические уведомления при событиях бронирований
- Настраиваемые напоминания о бронированиях
- Уведомления об отменах с причинами

#### Интеграция с системой передержек
- Уведомления о статусе передержек
- Напоминания о начале и окончании передержек
- Уведомления о новых заявках и отзывах

#### Интеграция с системой аудита
- Логирование всех действий с уведомлениями
- Аудит настроек пользователей
- Мониторинг подозрительной активности в уведомлениях