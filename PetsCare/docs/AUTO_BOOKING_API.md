# API автоматического бронирования работника

## Описание API автоматического бронирования

### Обзор

API автоматического бронирования позволяет клиентам автоматически бронировать свободного работника для услуги в указанное время. Система автоматически выбирает наиболее подходящего работника с учетом загруженности, рейтинга и доступности.

### Ключевые особенности

- **Автоматический выбор работника**: Система находит свободного работника, оказывающего данную услугу
- **Учет загруженности**: Приоритет отдается менее загруженным работникам
- **Учет рейтинга**: При равной загруженности выбирается работник с лучшим рейтингом
- **Транзакционная защита**: Полная защита от двойного бронирования
- **Учет технологического перерыва**: Система учитывает время на подготовку/уборку после услуги

### Временные параметры

- **Время оказания услуги** (`duration_minutes`): Длительность самой услуги
- **Технологический перерыв** (`tech_break_minutes`): Время на подготовку/уборку после услуги
- **Общая длительность слота**: `duration_minutes + tech_break_minutes`

### Эндпоинты

#### 1. Автоматическое бронирование работника

**POST** `/api/booking/auto-book-employee/`

Автоматически выбирает и бронирует работника для услуги.

**Параметры запроса:**
```json
{
    "pet_id": 1,
    "provider_id": 1,
    "service_id": 1,
    "start_time": "2024-05-15T10:00:00Z",
    "end_time": "2024-05-15T11:00:00Z",
    "price": 1500.00,
    "notes": "Дополнительные пожелания"
}
```

**Ответ при успехе:**
```json
{
    "success": true,
    "booking": {
        "id": 123,
        "booking_code": "BK20240515001",
        "pet": {
            "id": 1,
            "name": "Бобик"
        },
        "provider": {
            "id": 1,
            "name": "ВетКлиника №1"
        },
        "employee": {
            "id": 5,
            "name": "Иванов Иван Иванович",
            "position": "Ветеринар"
        },
        "service": {
            "id": 1,
            "name": "Вакцинация"
        },
        "start_time": "2024-05-15T10:00:00Z",
        "end_time": "2024-05-15T11:00:00Z",
        "service_duration_minutes": 45,
        "tech_break_minutes": 15,
        "total_duration_minutes": 60,
        "price": 1500.00,
        "status": "active",
        "notes": "Дополнительные пожелания"
    }
}
```

**Ответ при ошибке:**
```json
{
    "success": false,
    "error": "Нет доступных работников в указанное время",
    "available_times": [
        "2024-05-15T14:00:00Z",
        "2024-05-15T16:00:00Z"
    ]
}
```

#### 2. Получение доступных работников

**GET** `/api/booking/available-employees/`

Получает список доступных работников с их свободными слотами.

**Параметры запроса:**
```
?provider_id=1&service_id=1&date=2024-05-15&service_duration_minutes=60
```

**Ответ:**
```json
{
    "employees": [
        {
            "employee": {
                "id": 5,
                "name": "Иванов Иван Иванович",
                "position": "Ветеринар",
                "rating": 4.8
            },
            "available_slots": [
                {
                    "start_time": "2024-05-15T10:00:00Z",
                    "end_time": "2024-05-15T11:00:00Z",
                    "service_duration_minutes": 45,
                    "tech_break_minutes": 15,
                    "total_duration_minutes": 60
                },
                {
                    "start_time": "2024-05-15T14:00:00Z",
                    "end_time": "2024-05-15T15:00:00Z",
                    "service_duration_minutes": 45,
                    "tech_break_minutes": 15,
                    "total_duration_minutes": 60
                }
            ],
            "workload": 4.5,
            "rating": 4.8
        }
    ]
}
```

### Алгоритм выбора работника

1. **Поиск кандидатов**: Находятся все работники учреждения, оказывающие данную услугу
2. **Проверка доступности**: Проверяется доступность каждого работника в указанное время
3. **Расчет загруженности**: Вычисляется текущая загруженность работника на указанную дату
4. **Сортировка по приоритету**:
   - Первичный критерий: наименьшая загруженность
   - Вторичный критерий: лучший рейтинг
5. **Выбор работника**: Выбирается работник с наилучшими показателями

### Транзакционная защита

- Все операции бронирования выполняются в транзакциях
- Используется блокировка записей (`select_for_update`)
- Проверка доступности выполняется атомарно
- Защита от двойного бронирования одного слота

### Обработка ошибок

**Возможные ошибки:**
- `NO_AVAILABLE_EMPLOYEES`: Нет доступных работников
- `INVALID_TIME_SLOT`: Неверное время бронирования
- `SERVICE_NOT_AVAILABLE`: Услуга недоступна в учреждении
- `PET_NOT_FOUND`: Питомец не найден
- `PROVIDER_NOT_FOUND`: Учреждение не найдено

### Примеры использования

#### Пример 1: Бронирование вакцинации

```bash
curl -X POST http://localhost:8000/api/booking/auto-book-employee/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "pet_id": 1,
    "provider_id": 1,
    "service_id": 1,
    "start_time": "2024-05-15T10:00:00Z",
    "end_time": "2024-05-15T11:00:00Z",
    "price": 1500.00,
    "notes": "Первая вакцинация"
  }'
```

#### Пример 2: Поиск доступных работников

```bash
curl -X GET "http://localhost:8000/api/booking/available-employees/?provider_id=1&service_id=1&date=2024-05-15" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Настройки технологического перерыва

Технологический перерыв настраивается в админке для каждой услуги в учреждении:

1. Перейдите в админку Django
2. Откройте раздел "Provider Services"
3. Выберите нужную услугу в учреждении
4. Установите значение "Technical Break Minutes"
5. Сохраните изменения

**Примеры технологических перерывов:**
- Вакцинация: 15 минут (подготовка, уборка)
- Стрижка: 30 минут (уборка шерсти, дезинфекция)
- Хирургия: 45 минут (стерилизация инструментов, уборка)
- Консультация: 10 минут (подготовка кабинета)

## Основные возможности

- **Автоматический выбор работника**: Система автоматически находит свободного работника для услуги
- **Приоритет по загруженности**: Выбирается работник с наименьшей загруженностью
- **Приоритет по рейтингу**: При равной загруженности выбирается работник с лучшим рейтингом
- **Транзакционная безопасность**: Все операции защищены от конкурентного доступа
- **Проверка доступности**: Автоматическая проверка свободных слотов

## Эндпоинты

### 1. Автоматическое бронирование работника

**POST** `/api/auto-book-employee/`

Автоматически выбирает и бронирует работника для услуги.

#### Параметры запроса

```json
{
    "pet_id": 1,
    "provider_id": 1,
    "service_id": 1,
    "start_time": "2024-06-15T10:00:00Z",
    "end_time": "2024-06-15T11:00:00Z",
    "price": 1000.00,
    "notes": "Дополнительные примечания"
}
```

#### Обязательные поля

- `pet_id` - ID питомца (должен принадлежать пользователю)
- `provider_id` - ID учреждения
- `service_id` - ID услуги
- `start_time` - Время начала (ISO 8601 формат)
- `end_time` - Время окончания (ISO 8601 формат)
- `price` - Стоимость услуги

#### Опциональные поля

- `notes` - Примечания к бронированию

#### Пример успешного ответа

```json
{
    "success": true,
    "message": "Бронирование успешно создано",
    "booking": {
        "id": 123,
        "employee_name": "Иван Петров",
        "service_name": "Вакцинация",
        "start_time": "2024-06-15T10:00:00Z",
        "end_time": "2024-06-15T11:00:00Z",
        "price": 1000.00,
        "status": "active"
    }
}
```

#### Пример ошибки

```json
{
    "error": "Нет доступных работников для выбранного времени"
}
```

#### Коды ошибок

- `400` - Неверные параметры запроса
- `404` - Питомец, учреждение, услуга или работник не найдены
- `500` - Внутренняя ошибка сервера

### 2. Получение списка доступных работников

**GET** `/api/available-employees/`

Получает список доступных работников с их свободными слотами для выбранной услуги и даты.

#### Параметры запроса

- `provider_id` - ID учреждения (обязательно)
- `service_id` - ID услуги (обязательно)
- `date` - Дата в формате YYYY-MM-DD (обязательно)

#### Пример запроса

```
GET /api/available-employees/?provider_id=1&service_id=1&date=2024-06-15
```

#### Пример успешного ответа

```json
{
    "success": true,
    "available_employees": [
        {
            "employee_id": 1,
            "employee_name": "Иван Петров",
            "workload_hours": 2.5,
            "rating": 4.8,
            "available_slots": [
                {
                    "start_time": "2024-06-15T10:00:00Z",
                    "end_time": "2024-06-15T11:00:00Z",
                    "duration_minutes": 60
                },
                {
                    "start_time": "2024-06-15T14:00:00Z",
                    "end_time": "2024-06-15T15:00:00Z",
                    "duration_minutes": 60
                }
            ]
        },
        {
            "employee_id": 2,
            "employee_name": "Мария Сидорова",
            "workload_hours": 1.0,
            "rating": 4.5,
            "available_slots": [
                {
                    "start_time": "2024-06-15T09:00:00Z",
                    "end_time": "2024-06-15T10:00:00Z",
                    "duration_minutes": 60
                }
            ]
        }
    ]
}
```

## Алгоритм выбора работника

### Приоритеты выбора

1. **Доступность**: Работник должен быть свободен в указанное время
2. **Загруженность**: Выбирается работник с наименьшей загруженностью в день
3. **Рейтинг**: При равной загруженности выбирается работник с лучшим рейтингом

### Расчет загруженности

Загруженность рассчитывается как сумма часов всех активных бронирований работника на конкретную дату.

### Проверка доступности

Система проверяет:
- Отсутствие конфликтующих бронирований
- Рабочее время учреждения
- Расписание работника
- Перерывы работника

## Транзакционная безопасность

### Защита от конкурентного доступа

- Все операции создания бронирования обернуты в `@transaction.atomic`
- Используется `select_for_update()` для блокировки записей работников
- Проверка доступности происходит в рамках транзакции

### Обработка конфликтов

При одновременном бронировании одного работника:
1. Первый запрос получает блокировку
2. Второй запрос ждет освобождения блокировки
3. После освобождения второй запрос проверяет доступность заново
4. Если работник стал недоступен, система ищет другого работника

## Примеры использования

### JavaScript (Frontend)

```javascript
// Автоматическое бронирование работника
async function autoBookEmployee(bookingData) {
    try {
        const response = await fetch('/api/auto-book-employee/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(bookingData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('Бронирование создано:', result.booking);
            return result.booking;
        } else {
            console.error('Ошибка:', result.error);
            return null;
        }
    } catch (error) {
        console.error('Ошибка запроса:', error);
        return null;
    }
}

// Получение доступных работников
async function getAvailableEmployees(providerId, serviceId, date) {
    try {
        const response = await fetch(
            `/api/available-employees/?provider_id=${providerId}&service_id=${serviceId}&date=${date}`,
            {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }
        );
        
        const result = await response.json();
        
        if (result.success) {
            return result.available_employees;
        } else {
            console.error('Ошибка:', result.error);
            return [];
        }
    } catch (error) {
        console.error('Ошибка запроса:', error);
        return [];
    }
}
```

### Python (Backend)

```python
from booking.services import EmployeeAutoBookingService
from django.utils import timezone
from datetime import timedelta

# Автоматическое бронирование работника
def create_auto_booking(user, pet, provider, service, start_time, price):
    end_time = start_time + timedelta(hours=1)
    
    booking = EmployeeAutoBookingService.auto_book_employee(
        user=user,
        pet=pet,
        provider=provider,
        service=service,
        start_time=start_time,
        end_time=end_time,
        price=price,
        notes="Автоматическое бронирование"
    )
    
    if booking:
        print(f"Бронирование создано с работником: {booking.employee.user.get_full_name()}")
        return booking
    else:
        print("Нет доступных работников")
        return None

# Получение доступных работников
def get_employees_with_slots(provider, service, date):
    employees = EmployeeAutoBookingService.get_available_employees_with_slots(
        provider=provider,
        service=service,
        date=date
    )
    
    for item in employees:
        employee = item['employee']
        slots_count = len(item['available_slots'])
        workload = item['workload']
        rating = item['rating']
        
        print(f"Работник: {employee.user.get_full_name()}")
        print(f"Доступных слотов: {slots_count}")
        print(f"Загруженность: {workload} часов")
        print(f"Рейтинг: {rating}")
        print("---")
```

## Ограничения и особенности

### Временные ограничения

- Бронирование возможно только на будущее время
- Минимальный интервал между бронированиями: 15 минут
- Максимальный период бронирования: 8 часов

### Ограничения по работникам

- Работник должен быть активен в учреждении
- Работник должен оказывать выбранную услугу
- Работник должен иметь расписание на выбранный день

### Ограничения по учреждениям

- Учреждение должно быть активным
- Услуга должна быть активной в учреждении
- Учреждение должно работать в выбранное время

## Мониторинг и логирование

### Логирование операций

Все операции автоматического бронирования логируются:
- Время создания бронирования
- Выбранный работник
- Причина выбора (загруженность, рейтинг)
- Результат операции

### Метрики производительности

Система отслеживает:
- Время выполнения автоматического выбора
- Количество доступных работников
- Частота использования автоматического бронирования
- Успешность операций

## Интеграция с другими системами

### Уведомления

После автоматического бронирования отправляются уведомления:
- Клиенту о созданном бронировании
- Работнику о назначенном приеме
- Администратору учреждения

### Календарь

Автоматически созданные бронирования:
- Добавляются в календарь работника
- Отображаются в расписании учреждения
- Синхронизируются с внешними календарями

### Отчетность

Автоматические бронирования учитываются в отчетах:
- Загруженность работников
- Статистика услуг
- Эффективность автоматического выбора 