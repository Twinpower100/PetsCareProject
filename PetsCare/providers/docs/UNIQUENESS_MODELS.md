# Уникальность полей в моделях Provider и ProviderForm

## Provider (providers.Provider)

### Уникальные поля (глобально)

| Поле | Ограничение | Причина |
|------|-------------|--------|
| `name` | `unique=True` | Название организации не должно повторяться. |
| `phone_number` | `unique=True` | Один контактный телефон на одну организацию. |
| `email` | `unique=True` | Один контактный email на одну организацию. |

### Уникальность по составному ключу (страна + метрика)

Уникальность проверяется **по сочетанию страна + метрика**, а не по стране или по метрике отдельно. Один и тот же ИНН в разных странах допустим; в одной стране пара (country, tax_id) должна быть единственной. В модели заданы ограничения:

| Пары полей | Ограничение в модели | Причина |
|------------|----------------------|--------|
| **`(country, tax_id)`** | `UniqueConstraint` при заданной стране и непустом tax_id | ИНН идентифицирует юрлицо в рамках юрисдикции; в одной стране один провайдер — один ИНН. |
| **`(country, registration_number)`** | `UniqueConstraint` при заданной стране и непустом registration_number | Регистрационный номер уникален в рамках страны. |
| **`(country, vat_number)`** | `UniqueConstraint` при заданной стране и непустом vat_number | VAT ID уникален в рамках страны. |

Имена ограничений в БД:
- `providers_provider_unique_tax_id_per_country`
- `providers_provider_unique_reg_num_per_country`
- `providers_provider_unique_vat_per_country`

### Уникальность IBAN (глобально)

Один IBAN = один банковский счёт = одно юрлицо. В модели задано ограничение:

| Поле | Ограничение в модели | Причина |
|------|----------------------|--------|
| **`iban`** | `UniqueConstraint` при непустом iban | Один счёт — одно юрлицо; дубли IBAN в системе не допускаются. |

Имя ограничения в БД: `providers_provider_unique_iban`.

Проверка уникальности при регистрации выполняется в:
- `ProviderRegistrationWizardSerializer.validate()` (финальная отправка мастера);
- `ProviderRegistrationStep3ValidateAPIView` (валидация шага 3 с фронта).

В коде используется фильтр по полю, сравнение строк — без учёта регистра (`iexact`).

### Поля без уникальности

| Поле | Причина |
|------|--------|
| `kpp`, `director_name`, `bank_name`, `organization_type` | Справочные/вспомогательные поля, не идентификаторы. |
| `swift_bic` | Код банка (филиала); один SWIFT у многих провайдеров — норма. |

---

## ProviderForm (users.ProviderForm)

### Уникальность на уровне приложения, не БД

В модели **нет** ограничений уникальности для `tax_id`, `registration_number`, `vat_number`, `iban`.

Требование: **по составному ключу (страна + метрика)** не должно быть двух заявок в статусах `pending` или `approved` с одинаковой парой: (country, tax_id), (country, registration_number) или (country, vat_number); **IBAN** не должен повторяться среди заявок в этих статусах и среди провайдеров. Это проверяется в коде:
- в `ProviderRegistrationWizardSerializer.validate()` — при создании/обновлении заявки через мастер;
- в `ProviderRegistrationStep3ValidateAPIView` — при валидации шага 3.

Проверки: фильтр по `country` + полю + `status__in=['pending', 'approved']` (и сравнение строк без учёта регистра).

Все перечисленные правила согласованы с валидацией на шаге 3 и при финальной отправке мастера.
