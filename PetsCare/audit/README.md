# Система логирования и аудита PetCare

## Обзор

Система логирования и аудита PetCare обеспечивает полный контроль и прозрачность всех действий пользователей в системе. Система автоматически записывает все пользовательские действия, изменения данных и критически важные операции для обеспечения безопасности, контроля качества и соответствия требованиям.

## Компоненты системы

### 1. Централизованное логирование (UserAction)

**Модель:** `audit.models.UserAction`

**Назначение:** Запись всех действий пользователей в системе

**Что логируется:**
- HTTP запросы и ответы
- Бизнес-операции (бронирования, платежи, изменения данных)
- Системные события
- Изменения в базе данных

**Поля модели:**
- `user` - пользователь, выполнивший действие
- `action_type` - тип действия (create, update, delete, login, etc.)
- `content_object` - объект, с которым связано действие
- `details` - дополнительные детали в JSON формате
- `ip_address` - IP-адрес пользователя
- `user_agent` - User-Agent браузера
- `http_method` - HTTP метод запроса
- `url` - URL запроса
- `status_code` - статус ответа
- `execution_time` - время выполнения в секундах
- `timestamp` - временная метка

### 2. Система аудита безопасности (SecurityAudit)

**Модель:** `audit.models.SecurityAudit`

**Назначение:** Отслеживание критически важных операций безопасности

**Что аудируется:**
- Изменения ролей пользователей
- Управление инвайтами
- Финансовые операции
- Блокировка/разблокировка пользователей и учреждений
- Передача прав владения питомцами
- Подозрительная активность

**Поля модели:**
- `user` - пользователь, выполнивший операцию
- `audit_type` - тип аудита
- `content_object` - объект операции
- `details` - детали операции
- `old_values` - старые значения (для отслеживания изменений)
- `new_values` - новые значения
- `reason` - причина операции
- `is_critical` - флаг критичности
- `review_status` - статус проверки
- `reviewed_by` - кто проверил
- `review_comment` - комментарий проверяющего

### 3. Настройки аудита (AuditSettings)

**Модель:** `audit.models.AuditSettings`

**Назначение:** Глобальные настройки системы аудита

**Основные настройки:**
- `logging_enabled` - включение логирования
- `security_audit_enabled` - включение аудита безопасности
- `log_retention_days` - период хранения логов (365 дней)
- `security_audit_retention_days` - период хранения аудита (7 лет)
- `auto_cleanup_enabled` - автоматическая очистка старых записей
- `critical_operation_notifications` - уведомления о критических операциях

## Сервисы

### LoggingService

**Файл:** `audit.services.LoggingService`

**Основные методы:**
- `log_action()` - логирование действия пользователя
- `log_http_request()` - логирование HTTP запроса
- `log_business_operation()` - логирование бизнес-операции
- `log_system_event()` - логирование системного события

### SecurityAuditService

**Файл:** `audit.services.SecurityAuditService`

**Основные методы:**
- `audit_role_change()` - аудит изменения ролей
- `audit_invite_management()` - аудит управления инвайтами
- `audit_financial_operation()` - аудит финансовых операций
- `audit_blocking_operation()` - аудит блокировки/разблокировки
- `audit_ownership_transfer()` - аудит передачи прав владения
- `audit_suspicious_activity()` - аудит подозрительной активности

## Middleware

### AuditMiddleware

**Файл:** `audit.services.AuditMiddleware`

**Назначение:** Автоматическое логирование всех HTTP запросов

**Функциональность:**
- Перехват всех HTTP запросов
- Измерение времени выполнения
- Логирование метаданных запроса (IP, User-Agent, метод, URL)
- Интеграция с Django middleware

## Сигналы

**Файл:** `audit.signals`

**Назначение:** Автоматическое логирование изменений в базе данных

**Отслеживаемые модели:**
- `users.User` - изменения пользователей
- `pets.Pet` - изменения питомцев
- `booking.Booking` - изменения бронирований
- `billing.Contract` - изменения договоров
- `billing.Payment` - платежные операции
- `access.RoleInvite` - управление инвайтами
- `providers.Provider` - блокировка учреждений

## Команды управления

### cleanup_old_logs

**Назначение:** Очистка старых логов и записей аудита

**Использование:**
```bash
python manage.py cleanup_old_logs
python manage.py cleanup_old_logs --dry-run
python manage.py cleanup_old_logs --force
```

### export_audit_data

**Назначение:** Экспорт данных аудита в файлы

**Использование:**
```bash
python manage.py export_audit_data --format json
python manage.py export_audit_data --format csv --start-date 2024-01-01
python manage.py export_audit_data --include-logs --include-audits
```

### audit_statistics

**Назначение:** Вывод статистики аудита

**Использование:**
```bash
python manage.py audit_statistics
python manage.py audit_statistics --period month --detailed
```

## Утилиты

**Файл:** `audit.utils`

**Декораторы:**
- `@log_user_action()` - логирование действий пользователей
- `@audit_security_operation()` - аудит критических операций
- `@log_business_operation()` - логирование бизнес-операций
- `@audit_financial_operation()` - аудит финансовых операций
- `@log_database_changes()` - логирование изменений в БД
- `@audit_role_changes()` - аудит изменений ролей
- `@log_api_request()` - логирование API запросов
- `@audit_suspicious_activity()` - аудит подозрительной активности

**Контекстные менеджеры:**
- `AuditContext()` - контекст для аудита операций

## Админский интерфейс

### UserActionAdmin

**Функциональность:**
- Просмотр всех логов действий
- Фильтрация по типу действия, пользователю, дате
- Поиск по содержимому
- Экспорт выбранных записей
- Статистика по логам

### SecurityAuditAdmin

**Функциональность:**
- Просмотр записей аудита безопасности
- Фильтрация по типу аудита, критичности, статусу проверки
- Проверка и одобрение/отклонение записей
- Комментарии к проверке
- Статистика по аудиту

### AuditSettingsAdmin

**Функциональность:**
- Управление глобальными настройками аудита
- Настройка периодов хранения
- Включение/отключение компонентов
- Настройка уведомлений

## Интеграция с существующими системами

### Автоматическое логирование

Система автоматически интегрируется с существующими моделями через сигналы Django:

1. **Изменения пользователей** - логируются все изменения профилей, ролей
2. **Изменения питомцев** - логируются создание, изменение, удаление питомцев
3. **Бронирования** - логируются все операции с бронированиями
4. **Финансовые операции** - аудируются все платежи и изменения договоров
5. **Управление ролями** - аудируются все изменения ролей и инвайтов

### Middleware интеграция

AuditMiddleware автоматически логирует все HTTP запросы, обеспечивая полное покрытие активности пользователей.

## Безопасность

### Принципы безопасности

1. **Неизменяемость логов** - логи нельзя редактировать или удалять через обычный интерфейс
2. **Разграничение доступа** - доступ к логам только у администраторов
3. **Шифрование чувствительных данных** - пароли и токены не логируются
4. **Аудит критических операций** - все критические операции требуют проверки

### Права доступа

- **system_admin** - полный доступ к логам и аудиту
- **billing_manager** - доступ к финансовому аудиту
- **provider_admin** - доступ к логам своего учреждения
- **employee** - доступ к собственным логам
- **pet_owner, sitter** - доступ к собственным логам

## Производительность

### Оптимизации

1. **Индексы базы данных** - оптимизированные индексы для быстрого поиска
2. **Кэширование** - кэширование часто запрашиваемых данных
3. **Асинхронное логирование** - неблокирующее логирование через Celery
4. **Автоматическая очистка** - удаление старых записей для экономии места

### Мониторинг

1. **Метрики производительности** - отслеживание времени выполнения операций
2. **Алерты** - уведомления о критических операциях
3. **Дашборды** - визуализация статистики аудита

## Масштабируемость

### Горизонтальное масштабирование

1. **Разделение по датам** - партиционирование таблиц по датам
2. **Архивирование** - перемещение старых данных в архив
3. **Репликация** - репликация данных для отказоустойчивости

### Вертикальное масштабирование

1. **Оптимизация запросов** - использование select_related и prefetch_related
2. **Пагинация** - постраничная загрузка больших объемов данных
3. **Ленивая загрузка** - загрузка данных по требованию

## Соответствие требованиям

### GDPR

1. **Право на забвение** - возможность удаления данных пользователя
2. **Право на доступ** - возможность экспорта данных пользователя
3. **Согласие на обработку** - логирование согласий пользователей

### PCI DSS

1. **Аудит финансовых операций** - полное отслеживание платежей
2. **Защита чувствительных данных** - нелогирование номеров карт
3. **Мониторинг доступа** - отслеживание доступа к финансовым данным

## Разработка и тестирование

### Тестирование

1. **Unit тесты** - тестирование отдельных компонентов
2. **Integration тесты** - тестирование интеграции с другими системами
3. **Performance тесты** - тестирование производительности

### Разработка

1. **Локальная разработка** - настройка для разработки
2. **Staging окружение** - тестирование в staging
3. **Production развертывание** - развертывание в production

## Поддержка и обслуживание

### Мониторинг

1. **Здоровье системы** - мониторинг состояния системы аудита
2. **Производительность** - отслеживание производительности
3. **Ошибки** - мониторинг ошибок и исключений

### Обслуживание

1. **Резервное копирование** - регулярное резервное копирование логов
2. **Очистка** - автоматическая очистка старых записей
3. **Обновления** - обновление системы аудита 