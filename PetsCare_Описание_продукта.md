РОЛЕВАЯ МОДЕЛЬ
1. User (Пользователь)
Описание: 
Базовая учетная запись, через которую человек получает доступ к системе. Может совмещать несколько ролей (например, быть и владельцем питомца, и сотрудником учреждения, и пэт-ситтером). 
Возможности:
•	Регистрация и вход в систему.
•	Управление своими личными данными.
•	Может быть связан с профилем сотрудника (Employee), владельца питомца (Pet Owner), пэт-ситтера (Sitter).
•	Удаление своей учетной записи через личный кабинет (см. условия ниже).
•	Получение уведомлений о назначении на роль сотрудника, необходимости подтверждения роли, отклонении/одобрении заявок, попытках удаления аккаунта и др.
________________________________________
2. Pet Owner (Владелец питомца)
Описание:
Пользователь, у которого есть хотя бы один питомец.
Первый владелец питомца (лицо, создавшее карту питомца), назначается основным владельцем
Возможности:
•	Добавлять, редактировать и удалять своих питомцев.
•	Основной владелец может назначать питомцам других владельцев. 
•	Основной владелец может передать свои полномочия другому владельцу. У питомца может быть только один основной владелец, поэтому, в момент передачи полномочий основного владельца передающий полномочия перестает быть основным владельцем.
•	Просматривать историю посещений, медицинские записи, рекомендации.
•	Загружать и скачивать документы, связанные с питомцем.
•	Поиск и выбор услуг:
•	Искать услуги (ветеринария, груминг, вакцинация, передержка и др.) по названию, категории, цене, рейтингу, местоположению.
•	Искать учреждения (ветклиники, салоны и др.), предоставляющие услуги, с помощью фильтров (по городу, району, рейтингу, наличию свободных слотов и т.д.).
•	Искать частных лиц (пэт-ситтеров), предоставляющих услуги передержки, выгула, ухода и др.
•	Просматривать профили учреждений и специалистов, отзывы, расписание, стоимость услуг.
•	Запись на услуги:
•	Записывать питомца на выбранную услугу в учреждении или к частному лицу (пэт-ситтеру).
•	Выбирать удобное время из доступных слотов.
•	Получать подтверждение и напоминания о записи.
•	Отменять или переносить запись (если это разрешено политикой).
•	Процесс передержки:
•	Искать пэт-ситтеров (частных лиц), предоставляющих услуги передержки.
•	Просматривать условия, стоимость, отзывы, опыт, свободные даты.
•	Оформлять заявку на передержку питомца на нужные даты.
•	Передавать дополнительную информацию о питомце (особенности ухода, питание, лекарства и т.д.).
•	Получать уведомления о статусе заявки, подтверждении, напоминания о начале/окончании передержки.
•	Просматривать историю всех заявок на передержку.
•	Получать уведомления о предстоящих визитах, вакцинациях, передержках и т.д.
•	Оставлять отзывы об учреждениях, пэт-ситтерах и услугах.
•	Удалять свою учетную запись (при соблюдении условий, см. ниже).
________________________________________
3. Employee (Сотрудник учреждения)
Описание:
Пользователь, для которого создан профиль сотрудника (Employee). Может работать в одном или нескольких учреждениях (Provider).
Возможности:
•	Просматривать свое расписание (рабочие смены, выходные, отпуска).
•	Получать уведомления о назначенных приемах, изменениях в расписании.
•	Вести приемы, заполнять медицинские карты, оставлять рекомендации.
•	Не имеет права редактировать свой график — только просматривать.
•	Может выгружать свое расписание в Excel (для личного учета или отчетности).
•	Не может удалить свою учетную запись, если есть активные рабочие смены или незавершённые задачи (см. условия ниже).
•	Снять роль сотрудника может только админ учреждения.
•	Не может самостоятельно добавить себе роль сотрудника — только через назначение админом учреждения или по заявке.
•	Подтверждение роли: 
o	После назначения сотрудником должен подтвердить согласие (через email или личный кабинет, поле is_confirmed).
•	Заявка на вступление: 
o	Может отправить заявку на вступление в учреждение (EmployeeJoinRequest), которую рассматривает админ.
•	История ролей: 
o	Вся история работы хранится (start_date, end_date в EmployeeProvider).
•	Увольнение/деактивация: 
o	После увольнения теряет доступ к истории приёмов, расписанию и т.д.
•	Удаление аккаунта: 
o	Если есть активные смены/задачи — удаление блокируется. При попытке удаления аккаунта админы учреждения получают уведомление.
________________________________________
4. Provider (Учреждение)
Описание:
Организация, предоставляющая услуги (ветклиника, груминг-салон и т.д.).
Возможности:
•	Управлять списком сотрудников (через менеджеров).
•	Управлять услугами, ценами, расписанием работы учреждения.
•	Просматривать и анализировать загрузку сотрудников.
•	Выгружать расписания сотрудников и учреждения в Excel для отчетности.
________________________________________
5. EmployeeProvider (Связь сотрудник-учреждение)
Описание: Промежуточная модель между Employee и Provider, определяет, где и с какого по какое время работает сотрудник, а также его роль (обычный сотрудник или менеджер).
Ключевые поля:
•	employee (FK на Employee)
•	provider (FK на Provider)
•	start_date, end_date (период работы)
•	is_manager (флаг: является ли сотрудник менеджером/админом этого учреждения)
________________________________________
6. Provider Manager (Менеджер/админ учреждения)
Описание:
Сотрудник, у которого в EmployeeProvider для конкретного учреждения стоит is_manager=True.
Возможности:
•	Только менеджер может управлять расписанием всех сотрудников своего учреждения (создавать, редактировать, применять шаблоны, отмечать отпуска, замены и т.д.).
•	Использовать помощник составления расписания (например, массовое применение шаблонов, автоматическое распределение смен).
•	Управлять списком сотрудников (добавлять, удалять, назначать роли).
•	Управлять услугами и ценами учреждения.
•	Формировать, просматривать и выгружать следующие отчеты только в рамках тех учреждений, в которых он назначен администратором:
o	расписания всех сотрудников (или выбранному списку) по выбранному списку учреждений в Excel за период.
o	Количество отработанных часов за период выбранного списка сотрудников / учреждений, услуг
o	Количество тех или оказанных услуг за период, план услуг с фильтрацией по типам / наименованиям услуг
o	Сумму, которую, согласно прейскуранту услуг, принес тот или иной исполнитель – работник учреждения в разрезе учреждений с возможностью фильтрации по списку учреждений, списку работников 
o	Дебиторская задолженность перед организацией – поставщиком программного обеспечения (перед проектом) в разрезе учреждений с возможностью фильтрации по списку учреждений
•	Получать уведомления о важных событиях (отпуска, массовые изменения, сбои в расписании).
________________________________________
7. Sitter (Пэт-ситтер, частное лицо для передержки/ухода)
Описание:
Пользователь, предоставляющий услуги передержки, выгула, ухода за животными на дому или у себя.
Возможности:
•	Создавать и редактировать свой профиль пэт-ситтера (описание, опыт, условия, стоимость, фото, отзывы).
•	Указывать доступные даты и время для передержки/ухода.
•	Получать заявки от владельцев питомцев, подтверждать или отклонять их.
•	Вести историю передержек, получать отзывы.
•	Получать уведомления о новых заявках, изменениях, напоминания.
•	Выгружать свою историю передержек в Excel (для отчетности).
•	Предоставлять данные геолокации
________________________________________
8. System/Billing Manager (Системный/биллинг-менеджер)
Описание: Пользователь с расширенными правами (например, сотрудник управляющей компании или бухгалтерии). 
Возможности:
•	ВЕДЕНИЕ 
o	ДОГОВОРОВ И ИХ УСЛОВИЙ
o	ОПЛАТ, 
o	ВОЗВРАТОВ, 
•	АНАЛИЗ ДЕБИТОРСКОЙ ЗАДОЛЖЕННОСТИ С ПОМОЩЬЮ ОТЧЕТА??? (ПРОВЕРИТЬ, ИМЕЕТСЯ ЛИ ФУНКЦИОНАЛ ИЛИ ТРЕБУЕТСЯ РЕАЛИЗАЦИЯ?)
•	Просматривать и выгружать расписания по всем учреждениям, к которым имеет доступ. ЭТОГО БЫТЬ НЕ ДОЛЖНО. ПРОВЕРИТЬ
•	Анализировать загрузку (ЭТОГО БЫТЬ НЕ ДОЛЖНО, ПРОВЕРИТЬ) формировать отчеты по оплатам для бухгалтерии. (ПРОВЕРИТЬ, ИМЕЕТСЯ ЛИ ФУНКЦИОНАЛ ИЛИ ТРЕБУЕТСЯ РЕАЛИЗАЦИЯ?)
•	Блокировать учреждения в системе в случае дебиторской задолженности (ПРОВЕРИТЬ, ИМЕЕТСЯ ЛИ ФУНКЦИОНАЛ ИЛИ ТРЕБУЕТСЯ РЕАЛИЗАЦИЯ?)
________________________________________
Админ (менеджер) Проекта
Описание: Пользователь с расширенными правами. Работает в админке.
Возможности:
•	Дает полномочия Системный/биллинг-менеджер юзерам
•	Все, что может Системный/биллинг-менеджер
•	Согласовывает заявку учреждения
•	Дает права админа учреждения пользователю???
________________________________________
9. Помощник составления расписания
Описание:
Инструмент для менеджеров учреждений, позволяющий быстро и удобно формировать расписание.
Возможности:
•	Применять шаблоны расписаний (например, стандартная неделя, сменный график).
•	Массово назначать рабочие смены, отпуска, замены.
•	Проверять пересечения и конфликты в расписании.
•	Автоматически распределять смены по сотрудникам (если включена соответствующая логика).
•	Сохранять и повторно использовать шаблоны.
•	Создать паттерн для сотрудника. Например, Сотрудник Иванов работает понедельник, среда, пятница с 13 до 18 по нечетным неделям; вторник, четверг – с 9 до 14. (ПРОВЕРИТЬ, ИМЕЕТСЯ ЛИ ФУНКЦИОНАЛ ИЛИ ТРЕБУЕТСЯ РЕАЛИЗАЦИЯ?)
________________________________________
10. Выгрузки (Экспорт расписаний и истории)
Описание:
Возможность выгружать расписания сотрудников, учреждений, пэт-ситтеров, историю передержек в Excel.
Кто может:
•	Сотрудник — свое расписание.
•	Менеджер учреждения — расписание всех сотрудников своего учреждения (по выбранным сотрудникам/периодам).
•	Пэт-ситтер — свою историю передержек.
•	Системный/биллинг-менеджер — расписания по всем доступным учреждениям. (НЕТ. ОН ЗАНИМАЕТСЯ БИЛЛИНГОМ. ПРОВЕРИТЬ)
•	Системный/биллинг-менеджер 
Возможности:
•	Выбор периода, сотрудников, провайдеров, пэт-ситтеров для выгрузки.
•	Формирование Excel-файла с нужными данными (смены, отпуска, замены, типы слотов, заявки на передержку).
•	Возможность фильтрации и группировки данных в Excel.
________________________________________
11. Условия удаления учетной записи (User)
Удаление учетной записи возможно только если:
•	Пользователь не является активным сотрудником или менеджером учреждения, либо все его рабочие обязанности завершены/переданы.
•	Если пользователь совмещает роли (например, владелец питомца и сотрудник/пэт-ситтер), система требует сначала деактивировать профиль сотрудника/пэт-ситтера или завершить все рабочие задачи/передержки.
•	Пользователь не является основным владельцем (ПРОВЕРИТЬ, ИМЕЕТСЯ ЛИ ФУНКЦИОНАЛ ИЛИ ТРЕБУЕТСЯ РЕАЛИЗАЦИЯ?)
•	Если пользователь был сотрудником или пэт-ситтером, администратору учреждения или владельцам питомцев отправляется уведомление о том, что сотрудник/пэт-ситтер удалил свою учетную запись. ________________________________________
12. Пересечение ролей
•	Один пользователь может быть одновременно владельцем питомца, сотрудником учреждения, менеджером и пэт-ситтером.
•	Все роли реализуются через одну учетную запись (User), дополнительные права и возможности определяются наличием связанных сущностей (Employee, EmployeeProvider, Pet, Sitter и т.д.).
•	В интерфейсе можно показывать разные разделы и функции в зависимости от ролей пользователя.
________________________________________
13. Примеры сценариев
•	Владелец питомца ищет пэт-ситтера для передержки на время отпуска, оформляет заявку, получает подтверждение, оставляет отзыв.
•	Владелец питомца ИЩЕТ КЛИНИКУ, записывает своего кота на прием в ветклинику, выбирает удобное время, получает напоминание.
•	Пэт-ситтер указывает свободные даты, получает заявки, подтверждает передержку, выгружает историю в Excel.
•	Менеджер учреждения массово применяет шаблон расписания к сотрудникам на месяц вперед, выгружает расписание для бухгалтерии.
•	Сотрудник может только просматривать свое расписание, но не редактировать его.
•	Пользователь не может удалить свою учетную запись, если у него есть активные рабочие смены, заявки на передержку или он является менеджером учреждения или он является основным владельцем питомца.

•	Фиксация всех отмен бронирований с указанием инициатора (админ, клиент, провайдер, система), времени и причины.
•	Возможность для клиента отметить "услуга не оказана" после времени брони, если услуга не оказана и бронь не отменена.
•	Возможность для провайдера/работника отметить "клиент не явился".
•	Ведение отдельной статистики и рейтинга для провайдера, работника и клиента на основе отмен, no-show и жалоб.
•	Различные уровни влияния на рейтинг в зависимости от типа нарушения (отмена админом — мягкий штраф, неоказание услуги — жёсткий штраф).
•	Уведомления всем сторонам о важных событиях (отмена, no-show, жалоба).
•	Возможность анализа и выгрузки статистики по качеству сервиса.
•	Учёт форс-мажоров и технических ошибок как отдельные статусы, не влияющие на рейтинг.

________________________________________
14. Бизнес-процесс бронирования и оказания услуги

### 1. Создание и управление расписанием

#### 1.1. Расписание провайдера (учреждения)
**Входящие данные для составления расписания учреждения:**
- **Тип учреждения**: ветеринарная клиника, груминг-салон, зоомагазин и т.д.
- **Специфика работы**: круглосуточная работа, выходные дни, праздничные дни
- **Технические перерывы**: время на уборку, дезинфекцию, пересменку
- **Сезонность**: изменение часов работы в зависимости от сезона

**Процесс составления расписания учреждения:**
1. Админ провайдера задаёт общее расписание работы учреждения по дням недели
2. Для каждого дня указывается:
   - Время открытия (`open_time`)
   - Время закрытия (`close_time`)
   - Статус выходного дня (`is_closed`)
3. Это расписание определяет, когда в принципе возможны приёмы
4. Расписание учреждения является базовым ограничением для всех работников

**Особенности расписания учреждения:**
- Расписание задается по дням недели (понедельник-воскресенье)
- Можно указать разные часы работы для разных дней
- Можно отметить день как выходной (`is_closed=True`)
- Если время открытия/закрытия не указано, учреждение считается работающим весь день

#### 1.2. Расписание работника
**Входящие данные для составления расписания:**
- **Расписание учреждения** (`ProviderSchedule`): часы работы учреждения по дням недели, выходные дни
- **Шаблоны расписаний** (`SchedulePattern`): типовые графики работы для быстрого применения
- **Предпочтения работника** (`EmployeeSchedule`): желаемые часы работы (не жесткие требования)
- **Существующие бронирования** (`Booking`): уже забронированные слоты, которые нельзя нарушить

**Процесс составления расписания:**
1. Админ провайдера формирует индивидуальное расписание каждого работника с помощью шаблона (например, повторяющийся график: первая неделя — понедельник, среда, пятница с 8:00 до 15:00, вторая неделя — вторник, четверг с 15:00 до 21:00)
2. Система автоматически проверяет, что расписание работника не выходит за рамки рабочего времени учреждения
3. При попытке создать расписание вне рабочих часов учреждения система выдает ошибку валидации
4. Работник не может сам менять своё расписание — только просматривать
5. При изменении расписания система автоматически отменяет пересекающиеся бронирования

**Валидация расписания работника:**
- Время начала работы не может быть раньше времени открытия учреждения
- Время окончания работы не может быть позже времени закрытия учреждения
- Перерывы работника должны быть в рамках рабочего времени
- При изменении расписания проверяется отсутствие конфликтов с существующими бронированиями

#### 1.3. Изменение расписания и отмена бронирований
- Любое изменение расписания (работника или учреждения) инициируется и подтверждается только админом провайдера.
- Если на изменяемом участке расписания уже есть активные бронирования, система автоматически отменяет все пересекающиеся бронирования.
- Важно фиксировать только кто отменил бронирование (владелец питомца или провайдер).
- Всем клиентам отправляется уведомление об отмене.
- Это влияет на рейтинг провайдера/работника.

### 2. Бронирование услуги

**Входящие данные для расчета доступных слотов:**
- **Расписание работника** (`Schedule`): рабочие дни, часы работы, перерывы
- **Расписание учреждения** (`ProviderSchedule`): часы работы учреждения по дням недели
- **Время оказания услуги** (`ProviderService.duration_minutes`): длительность конкретной услуги в учреждении
- **Существующие бронирования** (`Booking`): уже забронированные слоты со статусами `active`, `pending_confirmation`
- **Отсутствия работника** (`Vacation`, `SickLeave`, `DayOff`): отпуска, больничные, отгулы

**Процесс расчета доступных слотов:**
1. Система получает расписание работника на нужный день недели
2. Проверяет, что работник работает в этот день (`is_working=True`)
3. Учитывает перерывы работника (если есть)
4. Разбивает рабочий день на слоты по длительности услуги (`duration_minutes`)
5. Исключает слоты, пересекающиеся с существующими бронированиями
6. Проверяет, что слоты не попадают в периоды отсутствия работника

**Процесс бронирования:**
- Клиент выбирает услугу, учреждение, время из доступных слотов
- Клиент может выбрать конкретного работника или доверить автоматический выбор
- При автоматическом выборе система находит свободного работника, оказывающего данную услугу
- Клиент может фильтровать варианты по карте, цене и другим параметрам
- Система создаёт запись Booking со статусом `active`
- При создании бронирования применяется транзакционная защита для предотвращения конфликтов

**Автоматический выбор работника:**
- Система анализирует всех работников учреждения, оказывающих выбранную услугу
- Проверяет доступность работников в выбранное время
- Выбирает работника с наименьшей загруженностью или по приоритету
- При равной загруженности выбирает работника с лучшим рейтингом
- Если свободных работников нет, предлагает альтернативное время
- Клиент может принять автоматический выбор или выбрать работника вручную

### 3. Отмена до времени услуги

#### 3.1. Отмена клиентом
- Клиент может отменить бронь до наступления времени услуги.
- Статус меняется на `cancelled_by_client`.
- Не влияет на рейтинг провайдера.

#### 3.2. Отмена по инициативе провайдера
- Всегда оформляется только через изменение расписания (работника или учреждения).
- Система автоматически отменяет все пересекающиеся бронирования.
- Влияет на рейтинг провайдера/работника.

### 4. Время оказания услуги

- После наступления времени брони работник/админ должен явно завершить услугу (например, кнопка "услуга оказана").
- Статус Booking меняется на `completed`.
- Можно добавить комментарий работника (например, для медицинских услуг).
- Клиенту отправляется уведомление "услуга оказана".

### 5. Проблемные ситуации после времени брони

#### 5.1. Клиент не пришёл
- Работник/админ отмечает "клиент не явился" (кнопка в интерфейсе).
- Статус Booking меняется на `no_show_by_client`.
- Влияет на рейтинг клиента.
- Клиенту отправляется уведомление.

#### 5.2. Услуга не оказана
- Клиент после времени брони видит кнопку "услуга не оказана".
- Может нажать, если услуга реально не оказана.
- Статус Booking меняется на `no_show_by_provider`.
- Влияет на рейтинг провайдера/работника.
- Провайдеру/работнику отправляется уведомление.

#### 5.3. Жалоба на качество
- Клиент может оставить жалобу (текстовое поле) после времени брони, если услуга оказана некачественно.
- Жалоба фиксируется в Booking.
- Влияет на рейтинг провайдера/работника.
- Админ видит жалобу в админке.

### 6. Если никто не сделал отметку
- Статус бронирования остаётся `pending_confirmation` (ожидает подтверждения).
- Не влияет на рейтинг.
- Админ видит такие бронирования в админке и может разбирать вручную.
- Через N дней (например, 7) система может автоматически завершить такие бронирования как `completed`, если не было жалоб.

### 7. Рейтинг
- Система автоматически меняет рейтинг провайдера/работника/клиента в зависимости от статуса и наличия жалобы.
- Рейтинг можно скорректировать вручную через админку (с комментарием).

### 8. Уведомления
- Всем сторонам отправляются уведомления о важных событиях: отмена, no-show, жалоба, завершение услуги.

### 9. Аналитика и отчёты
- В админке доступны фильтры и отчёты по всем статусам, отменам, no-show, жалобам, рейтингам.

### 10. Форс-мажор
- В системе нет отдельного статуса "force majeure" для отмены бронирования.
- Если админ учреждения не может выполнять свои обязанности (например, заболел/умер), вопрос решается вручную между учреждением и админом всего проекта, и рейтинг корректируется постфактум по согласованию.

### 11. Процесс завершения и отмены бронирований

#### 11.1. Ручное завершение бронирования

**Кто может завершить:**
- Специалист (employee)
- Администратор учреждения (provider_admin)

**Как происходит:**
1. После визита специалист или админ находит бронирование в админке.
2. Завершает приём, выбирая статус:
   - Завершено (`completed`)
   - Не явился (`no_show`)
3. Система фиксирует время, статус, автора действия.
4. Слот в расписании освобождается.

#### 11.2. Автоматическое завершение (фолбэк)

**Когда срабатывает:**
- Системная задача запускается по расписанию (параметры глобальные)
- Проверяет все бронирования со статусом `confirmed`, дата визита которых попадает в диапазон: от (сегодня - auto_complete_days) до (вчера включительно).

**Что происходит:**
1. Все найденные "зависшие" бронирования автоматически переводятся в статус, указанный в настройках (например, `auto_completed` или `no_show`).
2. Время завершения фиксируется, автор — "Система".
3. Слот освобождается.

#### 11.3. Отмена бронирования

**Кто может отменить:**
- Клиент (pet_owner) — через личный кабинет/интерфейс
- Администратор учреждения (provider_admin)

**Как происходит:**
1. Клиент или админ инициирует отмену бронирования до визита.
2. Система меняет статус на `cancelled`, освобождает слот.
3. Всем заинтересованным сторонам отправляются уведомления:
   - Email
   - Push-уведомление
   - Внутреннее уведомление в сервисе

**Кому отправляются уведомления:**
- Если отменил клиент — специалисту и админу учреждения.
- Если отменил админ — клиенту.

#### 11.4. Настройки автозавершения

**Модель**: `BookingAutoCompleteSettings`
- `auto_complete_enabled` — включено ли автозавершение (Boolean)
- `auto_complete_days` — через сколько дней завершать (Integer)
- `auto_complete_status` — статус при автозавершении (ChoiceField)
- `created_at`, `updated_at` — метки времени

**Глобальные параметры:**
- Периодика запуска сервиса автозавершения
- Время запуска сервиса автозавершения

#### 11.5. Статусы бронирований

**Жизненный цикл:**
- `pending_confirmation` → `confirmed` → `completed`/`no_show`/`cancelled`
- `pending_confirmation` → `cancelled` (отмена до подтверждения)
- `confirmed` → `auto_completed` (автоматическое завершение)

**Все статусы:**
- `pending_confirmation` — ожидает подтверждения
- `confirmed` — подтверждено, ожидает приема
- `completed` — прием успешно завершен
- `no_show` — клиент не явился
- `cancelled` — отменено
- `auto_completed` — автоматически завершено системой

#### 11.6. Отчётность по отменам

**Требования к отчёту:**
- Отчёт должен содержать данные по каждой отмене с детализацией:
  - Период (дата/месяц/неделя)
  - Учреждение (с указанием конкретного учреждения)
  - Услуга
  - Тип услуги
  - Кто отменил (клиент / учреждение)
  - Конкретный клиент (ФИО, ID или другой идентификатор)
  - Дата и время отмены
  - Причина отмены (если указана)

**Доступ к отчётам:**
- **billing_manager** — доступ только к отчётам по тем учреждениям, к которым они прикреплены
- **system_admin** — доступ ко всем данным по отменам

**Пример строки отчёта:**
| Дата      | Учреждение   | Услуга      | Тип услуги | Кто отменил | Клиент         | Время отмены      | Причина      |
|-----------|--------------|-------------|------------|-------------|----------------|-------------------|--------------|
| 2024-05-10| ВетКлиника №1| Вакцинация  | Ветеринар  | Клиент      | Иванов И.И.    | 2024-05-09 18:00  | Передумал    |
| 2024-05-11| ВетКлиника №2| Стерилизация| Хирургия   | Учреждение  | Петрова А.А.   | 2024-05-10 09:30  | Врач болен   |

#### 11.7. Исключения

- Бронирования со статусом `cancelled` не попадают под автоматическое завершение.
- Автоматически завершаются только бронирования со статусом `confirmed` и с датой визита в нужном диапазоне.

#### 11.8. Безопасность и транзакции

**Транзакционная защита:**
- Все операции завершения обернуты в транзакции
- Блокировка бронирования на время изменения
- Проверка прав доступа (кто может завершать)

**Валидация:**
- Нельзя завершить уже завершенное бронирование
- Нельзя завершить отмененное бронирование
- Проверка корректности статуса

#### 11.9. Логирование и аудит

**Что логируется:**
- Кто завершил бронирование
- Когда завершил
- Какой статус присвоил
- Было ли это ручное или автоматическое завершение

**Логирование отмен для аудита не требуется, но данные для отчёта должны сохраняться.**

ПРОЦЕСС ПЕРЕДЕРЖКИ (Pet Sitting Process)

1. Владелец питомца создает объявление (PetSittingAd):
   - Указывает период, радиус, тип животного, условия (возмездно/безвозмездно).
   - Объявление получает статус 'active'.

2. Система уведомляет подходящих ситтеров (по фильтрам: радиус, тип животного, период).

3. Ситтеры отправляют отклики (PetSittingResponse):
   - Каждый отклик имеет статус 'pending'.

4. Владелец выбирает одного ситтера:
   - Выбранный отклик получает статус 'accepted', остальные — 'rejected'.
   - Объявление получает статус 'in_progress'.
   - Создается сущность PetSitting со статусом 'waiting_start'.
   - Система уведомляет всех участников о результате выбора.

5. Передача питомца:
   - Оба участника (владелец и ситтер) подтверждают передачу (owner_confirmed_start, sitter_confirmed_start).
   - После обоих подтверждений статус PetSitting становится 'active'.
   - Если кто-то не подтверждает — система отправляет напоминания.

6. Возврат питомца:
   - Владелец инициирует возврат, оба подтверждают (owner_confirmed_end, sitter_confirmed_end).
   - После обоих подтверждений статус PetSitting становится 'waiting_review'.

7. Оценка:
   - Владелец обязан оставить отзыв (Review) — без этого процесс не завершить.
   - После отзыва статус PetSitting становится 'completed', рейтинг ситтера обновляется.
   - Если отзыв не оставлен в течение N дней — система завершает процесс автоматически.

8. Отмена и отказ:
   - Владелец может отменить объявление до выбора ситтера (ad.status = 'cancelled').
   - После выбора ситтера, но до передачи питомца — обе стороны могут отменить (PetSitting.status = 'cancelled').
   - После передачи — отмена только по согласованию или через поддержку (force majeure).
   - Все отмены фиксируются, статусы обновляются, уведомления рассылаются.

9. Уведомления:
   - Система уведомляет всех участников о каждом важном событии (выбор, подтверждение, отзыв, отмена, напоминания).

10. Статусы:
   - PetSittingAd: 'active', 'in_progress', 'closed', 'cancelled'.
   - PetSittingResponse: 'pending', 'accepted', 'rejected', 'cancelled'.
   - PetSitting: 'waiting_start', 'active', 'waiting_end', 'waiting_review', 'completed', 'cancelled'.

________________________________________
15. Система назначения ролей

### Обзор системы инвайтов

В PetCare реализована система инвайтов для безопасного и контролируемого назначения ролей работника (employee) и биллинг-менеджера (billing_manager). Эта система заменяет прямое назначение ролей через API и обеспечивает обязательное подтверждение со стороны пользователя.

### Модель RoleInvite

Система использует модель RoleInvite для управления процессом назначения ролей:

- **inviter**: пользователь, отправляющий приглашение (админ провайдера для роли работника, системный админ для роли биллинг-менеджера)
- **invitee**: пользователь, получающий приглашение на роль
- **role_type**: тип роли ('employee' или 'billing_manager')
- **provider**: учреждение (обязательно для роли работника, не требуется для биллинг-менеджера)
- **token**: уникальный токен для подтверждения приглашения
- **status**: статус приглашения ('pending', 'accepted', 'rejected', 'expired')
- **created_at**: дата и время создания приглашения
- **expires_at**: дата и время истечения (24 часа с момента создания)
- **accepted_at**: дата и время принятия приглашения
- **rejected_at**: дата и время отклонения приглашения

### Процесс назначения роли работника (employee)

1. **Инициация приглашения**: Администратор провайдера создает приглашение для пользователя на роль работника в своем учреждении через API или админ-панель.

2. **Генерация токена**: Система автоматически генерирует уникальный токен и устанавливает срок действия 24 часа.

3. **Отправка уведомления**: Пользователь получает email с:
   - Информацией о приглашении
   - Токеном для подтверждения
   - QR-кодом для мобильного подтверждения
   - Ссылкой на страницу подтверждения

4. **Подтверждение пользователем**: Пользователь может подтвердить приглашение:
   - Через веб-интерфейс по токену
   - Через QR-код на мобильном устройстве
   - Через API с токеном

5. **Активация роли**: После подтверждения система:
   - Создает запись Employee для пользователя
   - Связывает пользователя с учреждением
   - Назначает соответствующие права доступа
   - Отправляет уведомления всем участникам процесса

### Процесс назначения роли биллинг-менеджера (billing_manager)

1. **Инициация приглашения**: Системный администратор создает приглашение для пользователя на роль биллинг-менеджера.

2. **Генерация токена**: Система генерирует уникальный токен с 24-часовым сроком действия.

3. **Отправка уведомления**: Пользователь получает email с токеном и QR-кодом.

4. **Подтверждение пользователем**: Пользователь подтверждает приглашение любым из доступных способов.

5. **Активация роли**: После подтверждения система назначает роль billing_manager и предоставляет доступ к финансовым функциям.

### API для управления инвайтами

Система предоставляет полный набор API для управления инвайтами:

- **POST /api/role-invites/**: создание нового приглашения
- **GET /api/role-invites/{token}/**: получение информации о приглашении по токену
- **POST /api/role-invites/{token}/accept/**: принятие приглашения
- **POST /api/role-invites/{token}/reject/**: отклонение приглашения
- **GET /api/role-invites/{token}/qr/**: получение QR-кода для приглашения
- **DELETE /api/role-invites/{id}/**: удаление приглашения (для отмены)
- **POST /api/role-invites/cleanup/**: очистка истекших приглашений
- **POST /api/role-invites/{id}/dismiss/**: увольнение пользователя с роли

### Безопасность и контроль

Система инвайтов обеспечивает высокий уровень безопасности:

- **Временные ограничения**: Все приглашения действительны только 24 часа
- **Обязательное подтверждение**: Роль активируется только после явного подтверждения пользователем
- **Логирование**: Все действия с инвайтами записываются в лог для аудита
- **Автоматические уведомления**: Система уведомляет всех участников о каждом этапе процесса
- **QR-коды**: Альтернативный способ подтверждения через мобильные устройства
- **Автоочистка**: Система автоматически удаляет истекшие приглашения

### Преимущества системы инвайтов

1. **Безопасность**: Замена прямого назначения ролей контролируемым процессом с подтверждением
2. **Прозрачность**: Полная история назначений и изменений ролей
3. **Подтверждение**: Пользователь должен явно согласиться с назначением роли
4. **Гибкость**: Возможность отклонения приглашений пользователем
5. **Автоматизация**: Минимальное участие администраторов в процессе
6. **Аудит**: Полное логирование всех действий для контроля и анализа

### Интеграция с существующей системой

Система инвайтов полностью интегрирована с существующей ролевой моделью:
- Совместима с существующими ролями и правами доступа
- Использует существующую систему уведомлений
- Интегрирована с Django admin для управления
- Поддерживает REST API для внешних интерфейсов
- Совместима с существующими моделями Employee и UserType


________________________________________
16. Система передачи прав основного владельца питомца

В PetCare реализована система передачи прав основного владельца питомца через инвайты. Эта система позволяет основному владельцу безопасно передать свои полномочия другому пользователю с обязательным подтверждением.\n\nМодель PetOwnershipInvite:\n- pet: питомец, для которого происходит передача прав\n- email: email получателя приглашения\n- token: уникальный токен для подтверждения приглашения\n- expires_at: дата и время истечения (24 часа с момента создания)\n- type: тип инвайта ('invite' для добавления совладельца или 'transfer' для передачи прав основного владельца)\n- invited_by: пользователь, отправивший приглашение (основной владелец)\n- is_used: флаг использования инвайта\n- created_at: дата и время создания приглашения\n\nПроцесс передачи прав основного владельца:\n1. Инициация передачи: Основной владелец питомца создает инвайт на передачу прав через API или веб-интерфейс.\n2. Генерация токена: Система автоматически генерирует уникальный токен и устанавливает срок действия 24 часа.\n3. Отправка уведомления: Получатель получает email с информацией о передаче прав, токеном, QR-кодом и ссылкой на подтверждение.\n4. Подтверждение получателем: Получатель подтверждает передачу прав через веб-интерфейс, QR-код или API.\n5. Активация передачи: После подтверждения система устанавливает нового пользователя как основного владельца, добавляет его в список владельцев питомца, отправляет уведомления и логирует все действия.\n\nAPI для управления передачей прав:\n- POST /api/pets/{pet_id}/invite/: создание инвайта на передачу прав\n- POST /api/pets/accept-invite/: принятие инвайта по токену\n- GET /api/pets/invite/{token}/qr/: получение QR-кода для инвайта\n- GET /api/pets/invite/{token}/: получение информации об инвайте\n\nБезопасность и контроль:\n- Все инвайты действительны только 24 часа\n- Права передаются только после явного подтверждения получателем\n- Все действия с передачей прав записываются в лог для аудита\n- Система уведомляет всех участников о каждом этапе процесса\n- Поддерживается подтверждение через QR-код\n- Система автоматически удаляет истекшие инвайты\n\nПреимущества:\n1. Безопасность: Контролируемый процесс передачи прав с обязательным подтверждением\n2. Прозрачность: Полная история передачи прав и изменений владельцев\n3. Подтверждение: Получатель должен явно согласиться с получением прав\n4. Гибкость: Возможность отклонения передачи прав получателем\n5. Автоматизация: Минимальное участие администраторов в процессе\n6. Аудит: Полное логирование всех действий для контроля и анализа\n\nИнтеграция с системой:\n- Совместима с существующими моделями Pet и User\n- Использует систему уведомлений\n- Интегрирована с Django admin\n- Поддерживает REST API\n- Совместима с системой валидации удаления профилей

________________________________________
17. Система документов питомца и временные права передержчика

### Документы питомца
- Для каждого питомца можно хранить любые документы: паспорт, справки, сертификаты, страховки, фотографии и др.
### Документы питомца

- Для каждого питомца можно хранить любые документы: паспорт, справки, сертификаты, страховки, фотографии и др.
- Все документы реализованы через универсальную модель файла (`PetRecordFile`), которая содержит:
  - файл, название, описание
  - тип документа (связь с моделью `DocumentType`)
  - даты выдачи и истечения (опционально)
  - номер документа, орган выдачи (опционально)
  - кто загрузил, дата загрузки
- Типы документов настраиваются через отдельную модель `DocumentType` и могут быть связаны с категориями услуг (например, медицинские документы — с ветеринарными услугами).
- Документы могут быть привязаны к:
  - питомцу в целом (общие документы)
  - медицинским записям (`MedicalRecord`)
  - записям о процедурах (`PetRecord`)

### Права загрузки документов

- **Владелец питомца** — может загружать любые документы для своих питомцев.
- **Передержчик** — во время передержки может загружать документы для питомца (например, фото состояния питомца, справки о посещении ветеринара).
- **Сотрудник учреждения** — может загружать документы только к своим записям (где он указан как исполнитель).
- **Админ учреждения** — может загружать документы к записям своего учреждения.
- **Системный админ** — может загружать документы везде.

### Права доступа к документам (просмотр и скачивание)

- **Владелец питомца** — видит и скачивает все документы своего питомца.
- **Передержчик** — на время передержки получает права владельца:
  - видит все документы питомца
  - может записывать питомца на прием (дата записи и приема должны быть внутри периода передержки)
  - может добавлять файлы к записям
  - получает уведомления о записях, сделанных владельцем на период передержки
- **Сотрудник учреждения** — видит документы по своему профилю услуг (например, хирург — все медицинские справки).
- **Админ учреждения** — видит документы по профилю услуг учреждения.
- **Системный админ** — видит все документы.

### Уведомления

- Передержчик получает уведомления о записях, сделанных владельцем на период передержки.
- Владелец получает уведомления о записях, сделанных передержчиком на период передержки. 

________________________________________
18. Система отчетности

Система отчетности PetCare предоставляет аналитические данные для различных ролей пользователей, основанные исключительно на данных бронирований, сделанных через нашу систему.

### Для менеджеров учреждений:
- **Отчет по доходам через систему бронирования** (главный отчет): сумма, комиссия, количество бронирований, детализация по услугам и периодам
- **Отчет по загруженности сотрудников**: часы, количество услуг, эффективность

### Для биллинг-менеджеров (по их клиентам):
- **Отчет по дебиторской задолженности**: список учреждений с задолженностью, суммы долгов, сроки просрочки, история платежей, количество дней просрочки
- **Отчет по активности учреждений**: объемы услуг по учреждениям через систему
- **Отчет по платежам**: полученные платежи за период, ожидаемые платежи, список просроченных платежей с количеством дней просрочки
- **Отчет по отменам бронирований**: количество отмен по учреждениям, детализация по причинам отмен, статистика по периодам

### Для администраторов системы:
- Все те же отчеты, что и у биллинг-менеджеров, но без ограничений по учреждениям
- **Общий отчет по системе**: статистика, показатели, качество услуг (жалобы)

### Функциональность:
- Кнопки для генерации отчетов в админ-панели
- Фильтры по произвольным периодам (выбор начальной и конечной даты)
- Множественные фильтры по учреждениям (можно выбрать несколько учреждений)
- Выгрузка в Excel с готовыми табличными данными
- Только данные нашей системы (без учета прямых клиентов учреждений) 

________________________________________
19. Автоматическая блокировка учреждений по задолженности

### Обзор системы автоматической блокировки

Система автоматической блокировки учреждений по задолженности обеспечивает финансовый контроль и предотвращение накопления задолженности. Система работает на основе настроенных пороговых значений в договорах и автоматически применяет различные уровни ограничений в зависимости от суммы и срока задолженности.

### Настройки в договоре (Contract)

Каждый договор содержит следующие параметры для автоматической блокировки:

- **Порог долга в стоимости** (в валюте региона) - максимальная допустимая сумма задолженности
- **Порог1 в днях** - срок просрочки для информирования
- **Порог2 в днях** - срок просрочки для исключения из поиска
- **Порог3 в днях** - срок просрочки для полной блокировки
- **Валюта** - автоматически по региону, с возможностью изменения
- **Допустимая отсрочка платежа** (в днях) - учитывается при расчете срока просрочки

**Массовая настройка**: Возможность установить параметры для всех учреждений по географическому принципу и по типу услуг.

### Логика блокировки

#### Условие 1: Долг ≤ порог долга в стоимости
- **Действие**: Информирование о задолженности
- **Функционал**: Все функции доступны, учреждение в поиске
- **Разблокировка**: Автоматическая при полном погашении задолженности

#### Условие 2: Долг > порог долга в стоимости

**2.1: Срок просрочки ≤ порог1 в днях**
- **Действие**: Информирование
- **Функционал**: Все функции доступны, учреждение в поиске
- **Разблокировка**: Автоматическая при полном погашении задолженности

**2.2: Срок просрочки ≤ порог2 в днях**
- **Действие**: Информирование + исключение из поиска
- **Функционал**: Учреждение не видно клиентам
- **Разблокировка**: Автоматическая при полном погашении задолженности

**2.3: Срок просрочки ≤ порог3 в днях**
- **Действие**: Полная блокировка
- **Функционал**: Только личный кабинет с информацией о долге и просрочке
- **Разблокировка**: Автоматическая при полном погашении задолженности

**2.4: Срок просрочки > порог3 в днях**
- **Действие**: Полная блокировка
- **Функционал**: Только личный кабинет с информацией о долге и просрочке
- **Разблокировка**: Автоматическая при полном погашении задолженности

### Процесс мониторинга и уведомлений

#### Проверка по расписанию
Система анализирует все активные учреждения согласно настроенной периодичности:
- Рассчитывает текущую задолженность по договорам
- Определяет срок просрочки от даты первого просроченного платежа
- Сравнивает с пороговыми значениями
- Запускает соответствующие действия

#### Схема уведомлений

**Условие 1: Долг ≤ порог долга в стоимости**
- **Канал**: Email + уведомление в системе
- **Получатели**: Руководитель учреждения, менеджер по биллингу
- **Содержание**: "Информация о задолженности. Текущая сумма: X руб. Допустимый порог: Y руб."

**Условие 2: Долг > порог долга в стоимости**

**2.1: Срок просрочки ≤ порог1 в днях**
- **Канал**: Email + push-уведомление + уведомление в системе
- **Получатели**: Руководитель учреждения, менеджер по биллингу
- **Содержание**: "Уведомление о задолженности. Сумма: X руб. Срок просрочки: Y дней."

**2.2: Срок просрочки ≤ порог2 в днях**
- **Канал**: Email + push + уведомление в системе
- **Получатели**: Руководитель учреждения, менеджер по биллингу, админ системы
- **Содержание**: "Учреждение исключено из поиска. Задолженность: X руб. Срок просрочки: Y дней."

**2.3: Срок просрочки ≤ порог3 в днях**
- **Канал**: Email + push + уведомление в системе + звонок менеджера
- **Получатели**: Руководитель учреждения, менеджер по биллингу, админ системы
- **Содержание**: "КРИТИЧНО! Учреждение заблокировано. Задолженность: X руб. Срок просрочки: Y дней."

**2.4: Срок просрочки > порог3 в днях**
- **Канал**: Email + push + уведомление в системе + звонок менеджера
- **Получатели**: Руководитель учреждения, менеджер по биллингу, админ системы
- **Содержание**: "КРИТИЧЕСКАЯ ЗАДОЛЖЕННОСТЬ! Учреждение заблокировано. Требуется обращение в службу поддержки."

### Роли участников

#### Система (автоматический процесс)
**Обязанности:**
- Расчёт задолженности по расписанию
- Определение срока просрочки от даты первого просроченного платежа
- Сравнение с порогами
- Автоматическая блокировка/разблокировка
- Отправка уведомлений

**Права**: Автоматическое управление статусами учреждений

#### Менеджер по биллингу
**Обязанности:**
- Мониторинг задолженностей
- Связь с учреждениями
- Консультации по погашению задолженности
- Звонки при критических задолженностях

**Права**: Только просмотр информации о задолженностях

#### Админ системы (руководство платформы)
**Обязанности:**
- Настройка пороговых значений в договорах
- Массовая настройка по географическому принципу
- Массовая настройка по типу услуг
- Настройка периодичности проверок
- Ручная блокировка/разблокировка учреждений
- Исключение учреждений из автоматических проверок

**Права**: Полный контроль над блокировками и настройками системы

#### Руководитель учреждения
**Обязанности**: 
- Просмотр информации о задолженности и статусе блокировки
- Погашение задолженности

**Права**: Просмотр информации о задолженности и статусе блокировки

### Процесс разблокировки

#### Автоматическая разблокировка
- При полном погашении задолженности
- Система автоматически восстанавливает функционал
- Отправляются уведомления о разблокировке

#### Ручная блокировка/разблокировка админом
- Админ может заблокировать учреждение при любой задолженности
- Админ может разблокировать учреждение при любой задолженности
- Возможность исключить учреждение из автоматических проверок
- Обязательное обоснование в системе

### Расчет срока просрочки

#### Методика расчета
- От даты первого просроченного платежа
- Учитывается допустимая отсрочка платежа из договора
- Формула: `Срок просрочки = Текущая дата - (Дата платежа + Допустимая отсрочка)`

#### Примеры
- Допустимая отсрочка: 7 дней
- Дата платежа: 1 января
- Текущая дата: 15 января
- Срок просрочки: 15 - (1 + 7) = 7 дней

### Глобальные параметры
- **Периодичность пересчёта задолженности**: Настраиваемая (дни/недели/месяцы)
- **Время выполнения проверки**: Настраиваемая величина (например, каждый день в 9:00)
- **Массовая настройка**: Возможность установить параметры для всех учреждений по географическому принципу и по списку услуг

### Преимущества системы автоматической блокировки

1. **Финансовый контроль**: Автоматическое предотвращение накопления задолженности
2. **Гибкость**: Настраиваемые пороги для разных учреждений и регионов
3. **Прозрачность**: Полная информация о статусе задолженности для всех участников
4. **Автоматизация**: Минимальное участие администраторов в процессе
5. **Безопасность**: Поэтапное ограничение доступа в зависимости от серьезности задолженности
6. **Аудит**: Полное логирование всех действий для контроля и анализа

**Массовая настройка**: Возможность установить параметры для всех учреждений по географическому принципу и по типу услуг.

### Логика блокировки

#### Условие 1: Долг ≤ порог долга в стоимости
- **Действие**: Информирование о задолженности
- **Функционал**: Все функции доступны, учреждение в поиске
- **Разблокировка**: Автоматическая при полном погашении задолженности

#### Условие 2: Долг > порог долга в стоимости

**2.1: Срок просрочки ≤ порог1 в днях**
- **Действие**: Информирование
- **Функционал**: Все функции доступны, учреждение в поиске
- **Разблокировка**: Автоматическая при полном погашении задолженности

**2.2: Срок просрочки ≤ порог2 в днях**
- **Действие**: Информирование + исключение из поиска
- **Функционал**: Учреждение не видно клиентам
- **Разблокировка**: Автоматическая при полном погашении задолженности

**2.3: Срок просрочки ≤ порог3 в днях**
- **Действие**: Полная блокировка
- **Функционал**: Только личный кабинет с информацией о долге и просрочке
- **Разблокировка**: Автоматическая при полном погашении задолженности

**2.4: Срок просрочки > порог3 в днях**
- **Действие**: Полная блокировка
- **Функционал**: Только личный кабинет с информацией о долге и просрочке
- **Разблокировка**: Автоматическая при полном погашении задолженности

### Процесс мониторинга и уведомлений

#### Проверка по расписанию
Система анализирует все активные учреждения согласно настроенной периодичности:
- Рассчитывает текущую задолженность по договорам
- Определяет срок просрочки от даты первого просроченного платежа
- Сравнивает с пороговыми значениями
- Запускает соответствующие действия

#### Схема уведомлений

**Условие 1: Долг ≤ порог долга в стоимости**
- **Канал**: Email + уведомление в системе
- **Получатели**: Руководитель учреждения, менеджер по биллингу
- **Содержание**: "Информация о задолженности. Текущая сумма: X руб. Допустимый порог: Y руб."

**Условие 2: Долг > порог долга в стоимости**

**2.1: Срок просрочки ≤ порог1 в днях**
- **Канал**: Email + push-уведомление + уведомление в системе
- **Получатели**: Руководитель учреждения, менеджер по биллингу
- **Содержание**: "Уведомление о задолженности. Сумма: X руб. Срок просрочки: Y дней."

**2.2: Срок просрочки ≤ порог2 в днях**
- **Канал**: Email + push + уведомление в системе
- **Получатели**: Руководитель учреждения, менеджер по биллингу, админ системы
- **Содержание**: "Учреждение исключено из поиска. Задолженность: X руб. Срок просрочки: Y дней."

**2.3: Срок просрочки ≤ порог3 в днях**
- **Канал**: Email + push + уведомление в системе + звонок менеджера
- **Получатели**: Руководитель учреждения, менеджер по биллингу, админ системы
- **Содержание**: "КРИТИЧНО! Учреждение заблокировано. Задолженность: X руб. Срок просрочки: Y дней."

**2.4: Срок просрочки > порог3 в днях**
- **Канал**: Email + push + уведомление в системе + звонок менеджера
- **Получатели**: Руководитель учреждения, менеджер по биллингу, админ системы
- **Содержание**: "КРИТИЧЕСКАЯ ЗАДОЛЖЕННОСТЬ! Учреждение заблокировано. Требуется обращение в службу поддержки."

### Роли участников

#### Система (автоматический процесс)
**Обязанности:**
- Расчёт задолженности по расписанию
- Определение срока просрочки от даты первого просроченного платежа
- Сравнение с порогами
- Автоматическая блокировка/разблокировка
- Отправка уведомлений

**Права**: Автоматическое управление статусами учреждений

#### Менеджер по биллингу
**Обязанности:**
- Мониторинг задолженностей
- Связь с учреждениями
- Консультации по погашению задолженности
- Звонки при критических задолженностях

**Права**: Только просмотр информации о задолженностях

#### Админ системы (руководство платформы)
**Обязанности:**
- Настройка пороговых значений в договорах
- Массовая настройка по географическому принципу
- Массовая настройка по типу услуг
- Настройка периодичности проверок
- Ручная блокировка/разблокировка учреждений
- Исключение учреждений из автоматических проверок

**Права**: Полный контроль над блокировками и настройками системы

#### Руководитель учреждения
**Обязанности**: 
- Просмотр информации о задолженности и статусе блокировки
- Погашение задолженности

**Права**: Просмотр информации о задолженности и статусе блокировки

### Процесс разблокировки

#### Автоматическая разблокировка
- При полном погашении задолженности
- Система автоматически восстанавливает функционал
- Отправляются уведомления о разблокировке

#### Ручная блокировка/разблокировка админом
- Админ может заблокировать учреждение при любой задолженности
- Админ может разблокировать учреждение при любой задолженности
- Возможность исключить учреждение из автоматических проверок
- Обязательное обоснование в системе

### Расчет срока просрочки

#### Методика расчета
- От даты первого просроченного платежа
- Учитывается допустимая отсрочка платежа из договора
- Формула: `Срок просрочки = Текущая дата - (Дата платежа + Допустимая отсрочка)`

#### Примеры
- Допустимая отсрочка: 7 дней
- Дата платежа: 1 января
- Текущая дата: 15 января
- Срок просрочки: 15 - (1 + 7) = 7 дней

### Глобальные параметры
- **Периодичность пересчёта задолженности**: Настраиваемая (дни/недели/месяцы)
- **Время выполнения проверки**: Настраиваемая величина (например, каждый день в 9:00)
- **Массовая настройка**: Возможность установить параметры для всех учреждений по географическому принципу и по списку услуг

### Преимущества системы автоматической блокировки

1. **Финансовый контроль**: Автоматическое предотвращение накопления задолженности
2. **Гибкость**: Настраиваемые пороги для разных учреждений и регионов
3. **Прозрачность**: Полная информация о статусе задолженности для всех участников
4. **Автоматизация**: Минимальное участие администраторов в процессе
5. **Безопасность**: Поэтапное ограничение доступа в зависимости от серьезности задолженности
6. **Аудит**: Полное логирование всех действий для контроля и анализа

## Система шаблонов блокировки учреждений

### Обзор системы шаблонов блокировки

Система шаблонов блокировки обеспечивает централизованное управление параметрами автоматической блокировки учреждений по географическому принципу. Шаблоны позволяют устанавливать единые стандарты блокировки для учреждений в определённых регионах и автоматически применять их при создании новых договоров.

### Модель BlockingTemplate

Система использует модель `BlockingTemplate` для управления шаблонами блокировки:
- **name**: Название шаблона
- **country**: Страна (обязательно)
- **region**: Область/регион (опционально)
- **city**: Город (опционально)
- **is_active**: Статус активности шаблона
- **debt_threshold**: Порог долга в стоимости (в валюте региона)
- **threshold1_days**: Порог1 в днях (срок просрочки для информирования)
- **threshold2_days**: Порог2 в днях (срок просрочки для исключения из поиска)
- **threshold3_days**: Порог3 в днях (срок просрочки для полной блокировки)
- **currency**: Валюта (автоматически по региону)
- **payment_delay_days**: Допустимая отсрочка платежа (в днях)
- **created_by**: Кто создал шаблон
- **created_at**: Дата и время создания
- **updated_at**: Дата и время последнего обновления

### Географическая иерархия

Система поддерживает трёхуровневую географическую иерархию:
1. **Страна** (обязательно) — базовый уровень
2. **Область/регион** (опционально) — средний уровень
3. **Город** (опционально) — детальный уровень

**Принцип поиска шаблона:**
- Поиск происходит только по одному из уровней (город, или область, или страна)
- Приоритет: город → область → страна
- Если найден шаблон по городу, поиск прекращается
- Если шаблон по городу не найден, ищется по области
- Если шаблон по области не найден, ищется по стране
- Если шаблон не найден ни на одном уровне, договор не создаётся

### Бизнес-процесс создания договора

#### 1. Создание договора менеджером по биллингу
1. **Выбор учреждения**: Менеджер выбирает учреждение для создания договора
2. **Автоматический поиск шаблона**: Система ищет активный шаблон по географическому принципу
3. **Применение параметров**: Если шаблон найден, его параметры автоматически копируются в договор
4. **Создание договора**: Договор создаётся со статусом `active` и применёнными параметрами блокировки

#### 2. Алгоритм поиска шаблона

```python
def find_blocking_template(provider):
    # 1. Поиск по городу
    if provider.city:
        template = BlockingTemplate.objects.filter(city=provider.city, is_active=True).first()
        if template:
            return template
    # 2. Поиск по области
    if provider.region:
        template = BlockingTemplate.objects.filter(region=provider.region, city__isnull=True, is_active=True).first()
        if template:
            return template
    # 3. Поиск по стране
    template = BlockingTemplate.objects.filter(country=provider.country, region__isnull=True, city__isnull=True, is_active=True).first()
    return template
```

#### 3. Создание договора без шаблона
Если шаблон не найден:
- Договор создаётся только в статусе `draft`
- Менеджер не может активировать договор
- Требуется создание шаблона администратором
- После создания шаблона договор можно активировать

### Управление шаблонами

#### Создание шаблона (только system_admin)
- Только системные администраторы могут создавать шаблоны
- Создание шаблона сразу делает его активным
- Система проверяет уникальность географической комбинации

#### Редактирование шаблона (только system_admin)
- Только системные администраторы могут редактировать шаблоны
- Все изменения записываются в историю
- Изменения не влияют на существующие договоры

#### Удаление шаблона (только system_admin)
- Только системные администраторы могут удалять шаблоны
- Удаление не влияет на существующие договоры
- Нельзя удалить шаблон, если есть активные договоры с его параметрами

### Права доступа к шаблонам

#### system_admin (Системный администратор)
- Полные права: создание, редактирование, удаление шаблонов, просмотр истории изменений, управление статусами активности, массовые операции

#### billing_manager (Менеджер по биллингу)
- Просмотр только активных шаблонов (readonly)
- Видят уровень блокировки (пороги)
- НЕ видят историю изменений
- НЕ видят уведомления об изменениях
- Автоматическое получение параметров при создании договора

#### provider_admin (Администратор учреждения)
- Не видят шаблоны блокировки
- Видят только параметры в своём договоре
- Получают уведомления о блокировках

### Интеграция с системой договоров

При создании договора система автоматически:
1. Ищет шаблон по географическому принципу
2. Копирует параметры в договор:
   - debt_threshold
   - threshold1_days
   - threshold2_days
   - threshold3_days
   - currency
   - payment_delay_days
3. Создаёт договор со статусом `active`

Если шаблон не найден — договор создаётся только в статусе `draft`.

### Преимущества системы шаблонов
1. **Централизация**: Единое управление параметрами блокировки
2. **Автоматизация**: Автоматическое применение параметров при создании договоров
3. **Географическая гибкость**: Разные параметры для разных регионов
4. **Контроль**: Строгое разграничение прав доступа
5. **Безопасность**: Невозможность создания договоров без шаблонов

________________________________________
20. Система автоматического планирования расписания

### Обзор системы автоматического планирования

Система автоматического планирования расписания обеспечивает эффективное управление рабочими расписаниями сотрудников учреждений с учетом ресурсов, ограничений и предпочтений. Система автоматически создает оптимальные расписания на основе настроенных параметров и разрешает конфликты по приоритетам.

### Ресурсы учреждения

#### Рабочие места (Workplace)
- Каждое рабочее место может быть специализировано под определенные услуги
- В одном рабочем месте может оказываться несколько разных услуг одновременно
- Настройка списка разрешенных одновременных услуг для каждого рабочего места
- Учет времени на подготовку/уборку рабочего места между услугами (для бронирования, не для расписания работников)

#### Ограничения одновременности
- Настраиваемые ограничения на уровне "услуга-рабочее место"
- Пример: "рентген и УЗИ нельзя одновременно в рабочем месте 1"
- Учреждение может одновременно выполнять все заявленные услуги

### Расписание учреждения

#### Часы работы
- По умолчанию - единый график для всего учреждения
- Возможность настройки разных графиков для разных процедур
- Учет праздничных и выходных дней согласно календарю
- Перерывы только для работников, не для учреждения

#### Потребность в специалистах
- Настройка потребности по дням недели
- Пример: "в понедельник нужно 2 терапевта"
- При нехватке специалистов - приоритет потребности учреждения над пожеланиями работников

### Специалисты и услуги

#### Услуги специалистов
- Каждый специалист может оказывать несколько услуг
- Технические специалисты (уборщики, программисты и т.д.) не оказывают услуги потребителю напрямую
- Рабочие зоны технических специалистов - список рабочих мест

#### Приоритеты услуг
- Приоритет услуги при планировании для специалистов с множественными услугами
- Пример: сначала покрываем терапию, потом груминг
- Настройка приоритетов услуг для автоматизации расписания

### Желаемое расписание работника

#### Предпочтения
- Гибкие предпочтения (пожелания, не жесткие требования)
- Настройка по дням недели и часам
- Пример: пн, ср, пт - с 9 до 13, вт с 12 до 20, чт - не работать

### Система отсутствий

#### Типы отсутствий (отдельные сущности)
- **Отпуск (Vacation)** - планируется заранее, известна дата окончания
- **Больничный (SickLeave)** - может быть экстренным, дата окончания может быть неизвестна
- **Отгул (DayOff)** - планируется заранее, известна дата

#### Обработка отсутствий
- Отпуска и отгулы - менеджер вносит корректировки вручную
- Больничные - внезапные, требуют оперативного перепланирования
- Отчет по непокрытым бронированиям/освободившимся возможностям

### Алгоритм планирования

#### Жадный алгоритм
1. Берем день недели
2. Для каждого часа проверяем потребность в специалистах по услугам
3. Назначаем доступных специалистов с учетом их предпочтений
4. Разрешаем конфликты по приоритетам услуг
5. Учитываем ограничения одновременности в рабочих местах

### Отчетность

#### Основные отчеты
- Отчет по покрытию потребности в часах за период
- Отчет по использованию рабочих мест
- Отчет по непокрытым бронированиям при отсутствиях

### Интеграция с существующей системой

#### Связи с существующими моделями
- Интеграция с `Provider` (учреждение)
- Интеграция с `Service` (услуги)
- Интеграция с `Employee` (сотрудники)
- Интеграция с системой бронирования

### Модели данных

#### Новые модели
- `Workplace` (рабочее место) - абстрактный термин для кабинета, зала, студии и т.д.
- `WorkplaceAllowedServices` (разрешенные одновременные услуги в рабочем месте)
- `ServicePriority` (приоритеты услуг для планирования)
- `Vacation` (отпуск)
- `SickLeave` (больничный)
- `DayOff` (отгул)
- `EmployeeSchedule` (желаемое расписание работника)
- `ProviderSchedule` (расписание учреждения)
- `StaffingRequirement` (потребность в специалистах)

### Масштабируемость

#### Расширение на другие сервисы
- Система спроектирована для работы с любыми типами учреждений
- Рабочие места могут быть: кабинетами, залами, студиями, площадками и т.д.
- Услуги могут быть: медицинскими, спортивными, образовательными, развлекательными
- Алгоритм планирования универсален и не зависит от типа учреждения

### Преимущества системы автоматического планирования

1. **Эффективность**: Автоматическое создание оптимальных расписаний
2. **Гибкость**: Учет предпочтений работников и потребностей учреждения
3. **Масштабируемость**: Работа с любыми типами учреждений и услуг
4. **Автоматизация**: Минимальное участие менеджеров в планировании
5. **Контроль**: Детальная отчетность и мониторинг
6. **Интеграция**: Полная совместимость с существующей системой

________________________________________
21. Система рейтингов и жалоб

### Обзор системы рейтингов

Система рейтингов и жалоб обеспечивает контроль качества услуг, прозрачность для клиентов и мотивацию для провайдеров. Система автоматически рассчитывает рейтинги на основе различных факторов и предоставляет механизм подачи жалоб для разрешения конфликтных ситуаций.

### Участники системы рейтингов

#### Клиенты (pet_owner)
- Оставляют отзывы и оценки после получения услуг
- Подают жалобы при некачественном обслуживании
- Видят рейтинги учреждений и специалистов при выборе услуг
- Получают рекомендации на основе рейтингов

#### Учреждения (provider)
- Получают рейтинги на основе качества услуг
- Видят детальную аналитику по отзывам и жалобам
- Могут отвечать на жалобы и отзывы
- Используют рейтинги для улучшения качества услуг

#### Специалисты (employee)
- Получают индивидуальные рейтинги
- Видят отзывы о своей работе
- Могут отвечать на отзывы и жалобы
- Используют рейтинги для профессионального развития

#### Пэт-ситтеры (pet_sitter)
- Получают рейтинги на основе качества передержки
- Видят отзывы от владельцев питомцев
- Могут отвечать на отзывы и жалобы
- Используют рейтинги для привлечения клиентов

### Алгоритм расчета рейтинга

#### Базовый рейтинг
- **Шкала**: от 1 до 5 звезд
- **Основа**: средняя оценка от всех отзывов
- **Вес**: каждый отзыв имеет одинаковый вес

#### Факторы влияния на рейтинг

**Положительные факторы:**
- Высокие оценки отзывов (4-5 звезд)
- Положительные комментарии
- Регулярные услуги без жалоб
- Быстрые ответы на жалобы

**Отрицательные факторы:**
- Низкие оценки отзывов (1-2 звезды)
- Жалобы от клиентов
- Отмены бронирований по инициативе провайдера
- Отсутствие ответов на жалобы
- No-show (клиент не явился)

#### Взвешенный расчет
- **Отзывы**: 60% от общего рейтинга
- **Жалобы**: 25% от общего рейтинга
- **Отмены**: 10% от общего рейтинга
- **No-show**: 5% от общего рейтинга

#### Формула расчета
```
Рейтинг = (Средний_отзыв * 0.6) + (Жалобы_коэффициент * 0.25) + (Отмены_коэффициент * 0.1) + (No_show_коэффициент * 0.05)
```

### Система жалоб

#### Типы жалоб
- **Качество услуги**: некачественное оказание услуги
- **Отсутствие специалиста**: специалист не явился на прием
- **Грубость персонала**: некорректное поведение сотрудников
- **Санитарные условия**: неудовлетворительные условия
- **Другое**: прочие претензии

#### Процесс подачи жалобы
1. **Клиент** подает жалобу через личный кабинет
2. Выбирает тип жалобы и описывает проблему
3. Прикрепляет доказательства (фото, документы)
4. Система автоматически уведомляет **провайдера** и **специалиста**
5. **Провайдер** или **специалист** может ответить на жалобу
6. **Админ проекта** рассматривает жалобу и принимает решение
7. Решение влияет на рейтинг всех участников

#### Статусы жалоб
- **pending**: ожидает рассмотрения
- **in_progress**: рассматривается
- **resolved**: разрешена
- **rejected**: отклонена
- **closed**: закрыта

### Бизнес-процесс обработки жалоб

#### 1. Подача жалобы
- **Клиент** создает жалобу с описанием проблемы
- Система автоматически снижает рейтинг **провайдера** и **специалиста**
- Отправляются уведомления всем участникам

#### 2. Ответ на жалобу
- **Провайдер** или **специалист** может ответить на жалобу
- Ответ должен быть дан в течение 48 часов
- При отсутствии ответа рейтинг снижается дополнительно

#### 3. Рассмотрение жалобы
- **Админ проекта** рассматривает жалобу и все материалы
- Может запросить дополнительную информацию
- Принимает решение о справедливости жалобы

#### 4. Решение по жалобе
- **Справедливая жалоба**: рейтинг **провайдера** и **специалиста** снижается
- **Несправедливая жалоба**: рейтинг **клиента** снижается, рейтинг **провайдера** и **специалиста** восстанавливается
- **Частично справедливая**: рейтинги корректируются пропорционально

### Защита от манипуляций

#### Обнаружение подозрительной активности
- Система отслеживает паттерны отзывов и жалоб
- Выявляет массовые отзывы от одного пользователя
- Контролирует частоту жалоб от одного клиента
- Отслеживает взаимные отзывы между пользователями

#### Меры защиты
- **Ограничение частоты**: не более 1 жалобы в день от одного клиента
- **Проверка подлинности**: анализ IP-адресов и устройств
- **Модерация**: проверка содержания жалоб и отзывов
- **Санкции**: блокировка аккаунтов за злоупотребления

#### Уведомления о подозрительной активности
- **Админы проекта** получают уведомления о подозрительной активности
- Система автоматически помечает подозрительные отзывы и жалобы
- Админы могут вручную проверять и корректировать рейтинги

### Рекомендательная система

#### Алгоритм рекомендаций
- Система анализирует рейтинги учреждений и специалистов
- Учитывает географическое расположение клиента
- Рекомендует услуги с высокими рейтингами
- Исключает учреждения с низкими рейтингами из рекомендаций

#### Фильтрация результатов
- **Клиенты** могут фильтровать учреждения по рейтингу
- Минимальный рейтинг для отображения в поиске: 3.5 звезды
- Учреждения с рейтингом ниже 2.5 звезд скрываются из поиска
- Специальные пометки для учреждений с рейтингом выше 4.5 звезд

### Отчетность и аналитика

#### Для провайдеров
- Детальная статистика по отзывам и жалобам
- Анализ трендов изменения рейтинга
- Сравнение с конкурентами
- Рекомендации по улучшению качества

#### Для админов проекта
- Общая статистика по системе рейтингов
- Анализ подозрительной активности
- Отчеты по жалобам и их разрешению
- Мониторинг качества услуг по учреждениям

#### Для клиентов
- Прозрачная информация о рейтингах
- История собственных отзывов и жалоб
- Статистика по учреждениям и специалистам

### Интеграция с существующей системой

#### Связи с существующими моделями
- Интеграция с `Booking` (бронирования)
- Интеграция с `Provider` (учреждения)
- Интеграция с `Employee` (специалисты)
- Интеграция с `PetSitting` (передержка)
- Интеграция с системой уведомлений

#### Автоматические действия
- Автоматическое снижение рейтинга при жалобах
- Автоматическое восстановление рейтинга при разрешении жалоб
- Автоматические уведомления о изменениях рейтинга
- Автоматическое исключение из поиска при низких рейтингах

### Преимущества системы рейтингов

1. **Качество услуг**: Мотивация провайдеров к улучшению качества
2. **Прозрачность**: Клиенты видят реальные оценки учреждений
3. **Контроль**: Система контроля качества услуг
4. **Справедливость**: Справедливое разрешение конфликтов
5. **Защита**: Защита от манипуляций и злоупотреблений
6. **Аналитика**: Детальная аналитика для всех участников

### Модели данных

#### Новые модели
- `Rating` (рейтинг) - рейтинг учреждения, специалиста или пэт-ситтера
- `Review` (отзыв) - отзыв клиента о полученной услуге
- `Complaint` (жалоба) - жалоба клиента на качество услуги
- `ComplaintResponse` (ответ на жалобу) - ответ провайдера или специалиста
- `RatingHistory` (история рейтинга) - история изменений рейтинга
- `SuspiciousActivity` (подозрительная активность) - записи о подозрительной активности

### Масштабируемость

#### Расширение функционала
- Система спроектирована для работы с любыми типами услуг
- Возможность добавления новых типов жалоб
- Гибкие алгоритмы расчета рейтинга
- Настраиваемые пороги для фильтрации

#### Интеграция с внешними системами
- Возможность интеграции с внешними системами отзывов
- Экспорт данных для аналитических систем
- API для получения рейтингов и отзывов
- Интеграция с социальными сетями

________________________________________
22. Система поиска и фильтрации

### Обзор системы поиска и фильтрации

Система поиска и фильтрации PetCare обеспечивает эффективный поиск учреждений, специалистов, пэт-ситтеров и пользователей с использованием умной системы определения местоположения. Система автоматически определяет местоположение пользователя через устройство, предоставляет fallback на выбор района на карте и поддерживает ручной ввод адреса с автодополнением.

### Основные принципы поиска

#### Умная система определения местоположения
- **Приоритет 1**: Геолокация устройства (GPS координаты через браузер)
- **Приоритет 2**: Выбор района на интерактивной карте (fallback)
- **Приоритет 3**: Ручной ввод адреса с автодополнением через Google Places API
- **Кэширование**: Сохранение координат на 24 часа для оптимизации
- **Валидация**: Проверка корректности и разумности координат

#### Требования к адресам по ролям пользователей
- **Обычные пользователи (pet_owner)**: Адрес не обязателен, может использовать геолокацию устройства
- **Пэт-ситтеры (sitter)**: Адрес обязателен для поиска и предоставления услуг
- **Учреждения (provider)**: Адрес обязателен для регистрации и работы в системе
- **Сотрудники учреждений (employee)**: Адрес не обязателен, наследует адрес учреждения

#### Геопространственный поиск
- **Основа**: поиск по координатам (широта, долгота)
- **Расчет расстояний**: формула гаверсинуса для точного расчета
- **Радиус поиска**: настраиваемый радиус в километрах (0.1-100 км)
- **Оптимизация**: геопространственные индексы для быстрого поиска

### Поиск учреждений (Provider)

#### Базовый поиск по расстоянию
**API**: `GET /api/providers/search/`

**Основные параметры**:
- `latitude`, `longitude` - координаты поиска (обязательно)
- `radius_km` - радиус поиска в километрах (по умолчанию 10)
- `service_type` - тип услуги (ветеринария, груминг, вакцинация и т.д.)
- `rating_min` - минимальный рейтинг (от 1 до 5)
- `price_min`, `price_max` - диапазон цен в валюте региона
- `is_available` - доступность для бронирования (true/false)

**Определение местоположения**:
- Система автоматически запрашивает геолокацию устройства пользователя
- При отказе в доступе к геолокации предлагает выбор района на карте
- При отказе от выбора района требует ручной ввод адреса
- Координаты кэшируются на 24 часа для оптимизации

#### Расширенная фильтрация учреждений
**По категориям услуг**:
- Ветеринарные услуги (терапия, хирургия, диагностика)
- Груминг и уход (стрижка, мытье, маникюр)
- Вакцинация и профилактика
- Дрессировка и поведение
- Зоотовары и питание

**По рейтингу и отзывам**:
- Минимальный рейтинг (1-5 звезд)
- Количество отзывов
- Качество обслуживания
- Чистота и порядок

**По цене и стоимости**:
- Диапазон цен за услугу
- Стоимость консультации
- Скидки и акции
- Способы оплаты

**По доступности и расписанию**:
- Наличие свободных слотов
- Время работы (круглосуточно, только днем)
- Работа в выходные
- Экстренная помощь

**По местоположению**:
- Район города
- Близость к метро/остановке
- Парковка для клиентов
- Доступность для инвалидов

#### Результаты поиска учреждений
- **Основная информация**: название, адрес, телефон, сайт
- **Расстояние**: точное расстояние от точки поиска
- **Рейтинг**: средний рейтинг и количество отзывов
- **Услуги**: список доступных услуг с ценами
- **Расписание**: часы работы и доступность
- **Фотографии**: изображения учреждения и персонала
- **Статус**: активное/заблокированное/на модерации

### Поиск пэт-ситтеров (Sitter)

#### Базовый поиск по расстоянию
**API**: `GET /api/sitters/search/`

**Основные параметры**:
- `latitude`, `longitude` - координаты поиска (обязательно)
- `radius_km` - радиус поиска
- `service_type` - тип услуги (передержка, выгул, уход)
- `rating_min` - минимальный рейтинг
- `price_min`, `price_max` - диапазон цен за день/час
- `date_from`, `date_to` - период передержки

**Особенности поиска ситтеров**:
- Поиск осуществляется только среди ситтеров с подтвержденным адресом
- Система автоматически исключает ситтеров без валидного адреса
- Расстояние рассчитывается от координат пользователя до адреса ситтера
- При отсутствии местоположения пользователя предлагается ввод адреса

#### Расширенная фильтрация ситтеров
**По услугам**:
- Передержка (дома у ситтера или у клиента)
- Выгул собак (индивидуальный или групповой)
- Уход за животными (кормление, уборка)
- Дрессировка и воспитание
- Транспортировка животных

**По расписанию и доступности**:
- Доступность в нужные даты
- Гибкость графика (утро, день, вечер, ночь)
- Экстренная помощь
- Длительность передержки

**По опыту и квалификации**:
- Стаж работы с животными
- Образование и сертификаты
- Специализация по типам животных
- Опыт с особыми потребностями

**По условиям размещения**:
- У ситтера дома (с описанием условий)
- У клиента дома
- Выезд к клиенту
- Размер помещения и двора
- Наличие других животных

**По типу животных**:
- Кошки (взрослые, котята, пожилые)
- Собаки (маленькие, средние, большие)
- Экзотические животные
- Птицы и грызуны
- Множественные животные

#### Результаты поиска ситтеров
- **Профиль**: фото, имя, возраст, опыт
- **Условия**: описание дома, двора, соседства
- **Услуги**: список услуг с ценами
- **Расписание**: доступность по дням и времени
- **Отзывы**: рейтинг и комментарии клиентов
- **Фотографии**: дом, двор, предыдущие питомцы
- **Документы**: сертификаты, справки, страховка

### Поиск пользователей (User)

#### Поиск владельцев питомцев
**API**: `GET /api/users/search/`

**Параметры поиска**:
- `latitude`, `longitude` - координаты
- `radius_km` - радиус поиска
- `user_type` - тип пользователя (pet_owner)
- `has_pets` - наличие питомцев
- `pet_type` - тип питомцев (кошки, собаки и т.д.)

#### Поиск сотрудников учреждений
**Фильтрация по ролям**:
- `employee` - обычные сотрудники
- `provider_admin` - администраторы учреждений
- `specialization` - специализация (ветеринар, грумер)

**По учреждению**:
- Поиск сотрудников конкретного учреждения
- Фильтрация по отделениям/филиалам
- Поиск по графику работы

### Техническая реализация поиска

#### Геопространственные индексы
```python
# Индексы в моделях для оптимизации геопоиска
class Meta:
    indexes = [
        models.Index(fields=['latitude', 'longitude']),
        GistIndex(fields=['location']),  # PostGIS
        models.Index(fields=['rating']),
        models.Index(fields=['is_active']),
    ]
```

#### Расчет расстояний
- **Формула гаверсинуса** для точного расчета расстояний между точками
- **Кэширование результатов** для оптимизации производительности
- **Индексы по координатам** для быстрого поиска в радиусе

#### Фильтрация результатов
```python
# Пример фильтрации учреждений
def filter_providers(queryset, filters):
    if filters.get('service_type'):
        queryset = queryset.filter(services__type=filters['service_type'])
    
    if filters.get('rating_min'):
        queryset = queryset.filter(rating__gte=filters['rating_min'])
    
    if filters.get('price_min'):
        queryset = queryset.filter(services__price__gte=filters['price_min'])
    
    if filters.get('is_available'):
        queryset = queryset.filter(has_available_slots=True)
    
    return queryset
```

#### Оптимизация производительности
- **Кэширование**: результатов геокодирования на 30 дней
- **Пагинация**: ограничение результатов (по умолчанию 50)
- **Ленивая загрузка**: загрузка деталей по требованию
- **Сжатие данных**: оптимизация передачи результатов

### API для поиска

#### Основные эндпоинты
```python
# Поиск учреждений
GET /api/providers/search/
GET /api/providers/{id}/services/
GET /api/providers/{id}/schedule/

# Поиск ситтеров  
GET /api/sitters/search/
GET /api/sitters/{id}/schedule/
GET /api/sitters/{id}/reviews/

# Поиск пользователей
GET /api/users/search/
GET /api/users/{id}/profile/
GET /api/users/{id}/pets/
```

#### Параметры запросов
```python
# Пример запроса поиска учреждений
{
    "latitude": 55.7558,
    "longitude": 37.6176,
    "radius_km": 10,
    "service_type": "veterinary",
    "rating_min": 4.0,
    "price_min": 1000,
    "price_max": 5000,
    "is_available": true,
    "working_hours": "24/7",
    "has_parking": true
}

# Пример запроса поиска ситтеров
{
    "latitude": 55.7558,
    "longitude": 37.6176,
    "radius_km": 15,
    "service_type": "pet_sitting",
    "date_from": "2024-06-01",
    "date_to": "2024-06-15",
    "pet_type": "dog",
    "price_min": 500,
    "price_max": 2000,
    "at_sitter_home": true
}
```

### Интеграция с системой рейтингов

#### Фильтрация по рейтингу
- **Минимальный рейтинг для отображения**: 3.5 звезды
- **Скрытие низкорейтинговых**: учреждения с рейтингом ниже 2.5 звезд
- **Премиум-статус**: специальные пометки для рейтинга выше 4.5 звезд
- **Верификация отзывов**: проверка подлинности отзывов

#### Рекомендательная система
- **Анализ поведения**: учет истории поиска и бронирований
- **Персонализация**: адаптация результатов под предпочтения
- **Популярность**: учет популярности провайдеров в регионе
- **Сезонность**: учет сезонных предпочтений

### Блокировка учреждений по задолженности

#### Исключение из поиска
- **Автоматическая блокировка**: при превышении порогов задолженности
- **Исключение из результатов**: заблокированные учреждения не показываются
- **Восстановление**: автоматическое возвращение в поиск при погашении
- **Уведомления**: информирование о блокировке/разблокировке

#### Мониторинг задолженности
- **Проверка по расписанию**: ежедневная проверка задолженности
- **Пороговые значения**: настраиваемые пороги для разных регионов
- **Градация блокировки**: поэтапное ограничение доступа
- **Ручное управление**: возможность ручной блокировки/разблокировки

### Масштабируемость и расширение

#### Поддержка новых типов поиска
- **По специализациям**: узкоспециализированные услуги
- **По времени работы**: гибкие графики и экстренная помощь
- **По дополнительным услугам**: доставка, консультации, выезд
- **По оборудованию**: наличие специального оборудования

#### Интеграция с внешними системами
- **Картографические сервисы**: интеграция с Google Maps, Яндекс.Карты
- **Экспорт результатов**: выгрузка в различные форматы
- **API для внешних приложений**: открытое API для интеграции
- **Мобильные приложения**: оптимизация для мобильных устройств

### Мониторинг и аналитика

#### Статистика поисков
- **Популярные фильтры**: анализ наиболее используемых параметров
- **География поисков**: карта популярных районов поиска
- **Эффективность поиска**: конверсия поиска в бронирование
- **Время поиска**: анализ времени, затрачиваемого на поиск

#### Оптимизация системы
- **Анализ медленных запросов**: выявление узких мест
- **Оптимизация индексов**: улучшение производительности
- **A/B тестирование**: тестирование новых алгоритмов поиска
- **Машинное обучение**: улучшение рекомендаций

### Преимущества системы поиска

1. **Точность**: Высокая точность геопространственного поиска
2. **Персонализация**: Адаптация результатов под пользователя
3. **Производительность**: Оптимизированные запросы и кэширование
4. **Гибкость**: Множественные фильтры и параметры поиска
5. **Масштабируемость**: Поддержка роста количества пользователей
6. **Интеграция**: Полная интеграция с другими системами PetCare

________________________________________
23. Система валидации адресов

### Обзор системы валидации адресов

Система валидации адресов обеспечивает точность и достоверность географических данных в PetCare. Система использует комплексный подход к валидации адресов через внешние API и предоставляет структурированный процесс ввода адресов с автоматическим определением координат.

### Структурированная модель адреса

#### Основные компоненты адреса
- **Страна** - обязательное поле, выбор из стандартизированного списка стран
- **Регион/Область** - административная единица (область, край, штат)
- **Город/Населенный пункт** - обязательное поле с автодополнением
- **Район** - административный район города (опционально)
- **Улица** - обязательное поле с автодополнением
- **Номер дома** - обязательное поле, может содержать буквы и дроби
- **Корпус/Строение** - дополнительная информация о здании (опционально)
- **Квартира/Офис** - номер помещения (опционально)
- **Почтовый индекс** - обязательное поле, автоматически определяется

#### Автоматически заполняемые поля
- **Широта и долгота** - координаты, определяемые автоматически при валидации
- **Стандартизированный адрес** - форматированный адрес от API
- **Статус валидации** - результат проверки адреса (valid, invalid, pending)
- **Точность геокодирования** - уровень точности определения координат

### Пошаговый процесс ввода адреса

#### 1. Выбор страны
- Пользователь выбирает страну из стандартизированного списка
- Выбор страны определяет доступные регионы и валюту по умолчанию

#### 2. Ввод города с автодополнением
- Пользователь начинает вводить название города
- Система использует Google Places API для автодополнения
- Показываются подходящие варианты с указанием региона
- Пользователь выбирает нужный город из списка

#### 3. Ввод улицы с автодополнением
- Пользователь вводит название улицы
- Система предлагает варианты улиц в выбранном городе
- Автодополнение учитывает уже выбранные компоненты адреса

#### 4. Ввод номера дома
- Пользователь вводит номер дома
- Поддерживаются буквы, дроби и дополнительные символы
- Система валидирует формат номера дома

#### 5. Дополнительные поля
- Пользователь может указать корпус/строение
- Пользователь может указать номер квартиры/офиса
- Все дополнительные поля опциональны

#### 6. Автоматическое определение индекса
- Система автоматически определяет почтовый индекс
- Индекс получается через Google Geocoding API
- Пользователь может скорректировать индекс вручную

### Процесс валидации адреса

#### 1. Предварительная валидация
- Проверка заполнения обязательных полей
- Валидация формата номера дома
- Проверка корректности почтового индекса

#### 2. Геокодирование через Google Maps API
- Система формирует полный адрес из компонентов
- Отправляет запрос к Google Geocoding API
- Получает координаты и стандартизированный адрес

#### 3. Проверка качества результата
- Анализ точности геокодирования (ROOFTOP, RANGE_INTERPOLATED, GEOMETRIC_CENTER)
- Проверка соответствия компонентов адреса
- Валидация полученных координат

#### 4. Обратное геокодирование
- Система отправляет координаты обратно в Google Geocoding API
- Получает стандартизированный адрес для проверки
- Сравнивает с исходным адресом

#### 5. Финальная валидация
- Проверка всех компонентов адреса
- Установка статуса валидации
- Сохранение координат и стандартизированного адреса

### Интеграция с внешними API

#### Google Maps Places API
- **Назначение**: Автодополнение при вводе адреса
- **Функции**: Предоставление подсказок для городов, улиц, районов
- **Ограничения**: Лимиты запросов, стоимость за запрос
- **Кэширование**: Кэширование результатов для экономии API-запросов

#### Google Maps Geocoding API
- **Назначение**: Преобразование адреса в координаты
- **Функции**: Получение координат, стандартизация адреса, разбивка на компоненты
- **Ограничения**: Лимиты запросов, стоимость за запрос
- **Кэширование**: Кэширование результатов для экономии API-запросов

#### Альтернативные сервисы
- **OpenStreetMap Nominatim**: Бесплатный сервис геокодирования
- **Яндекс.Карты API**: Альтернатива для российских адресов
- **HERE Geocoding API**: Коммерческий сервис с высокой точностью

### Система кэширования и оптимизации

#### Кэширование результатов
- Кэширование результатов геокодирования на 30 дней
- Кэширование результатов автодополнения на 7 дней
- Уменьшение количества API-запросов
- Снижение стоимости использования внешних API

#### Оптимизация запросов
- Группировка запросов для уменьшения нагрузки
- Приоритизация запросов по важности
- Ограничение частоты запросов
- Мониторинг лимитов API

### Интеграция с существующими моделями

#### Модель Provider (Учреждение)
- Автоматическое определение координат при создании учреждения
- Валидация адреса при редактировании профиля
- Использование координат для геопоиска

#### Модель SitterProfile (Пэт-ситтер)
- Валидация адреса при создании профиля ситтера
- Автоматическое определение координат
- Использование для поиска ближайших ситтеров

#### Модель User (Пользователь)
- Валидация адреса в профиле пользователя
- Автоматическое определение координат
- Использование для персонализации поиска

### Бизнес-процесс валидации

#### 1. Создание адреса
- Пользователь заполняет форму адреса пошагово
- Система предоставляет автодополнение на каждом этапе
- Пользователь может ввести адрес одной строкой или по компонентам

#### 2. Валидация в реальном времени
- Система валидирует каждый компонент адреса
- Показывает ошибки и предупреждения
- Предлагает исправления и альтернативы

#### 3. Финальная проверка
- Система выполняет полную валидацию адреса
- Определяет координаты и стандартизированный адрес
- Устанавливает статус валидации

#### 4. Сохранение и использование
- Адрес сохраняется в структурированном виде
- Координаты используются для геопоиска
- Стандартизированный адрес используется для отображения

### Преимущества системы валидации адресов

1. **Точность**: Высокая точность определения координат через Google Maps API
2. **Стандартизация**: Единый формат адресов для всей системы
3. **Автоматизация**: Автоматическое определение координат и индекса
4. **Удобство**: Пошаговый ввод с автодополнением
5. **Валидация**: Комплексная проверка корректности адреса
6. **Оптимизация**: Кэширование и оптимизация API-запросов
7. **Масштабируемость**: Поддержка различных стран и регионов

### Модели данных

#### Новые модели
- `Address` (адрес) - структурированная модель адреса
- `AddressValidation` (валидация адреса) - результаты валидации
- `AddressCache` (кэш адресов) - кэширование результатов API
- `Country` (страна) - справочник стран
- `Region` (регион) - справочник регионов

### Масштабируемость

#### Расширение функционала
- Поддержка новых стран и регионов
- Интеграция с дополнительными API геокодирования
- Расширение типов адресов (P.O. Box, военные адреса)
- Поддержка многоязычных адресов

#### Интеграция с внешними системами
- Экспорт адресов в стандартные форматы
- Интеграция с почтовыми сервисами
- Связь с системами доставки
- Интеграция с картографическими сервисами

### Система поиска и фильтрации

#### Улучшенный геолокационный поиск
- **Геолокация устройства** (приоритет): Автоматическое получение координат через браузер
- **Выбор района на карте** (fallback): Интерактивная карта для выбора центра поиска
- **Ручной ввод адреса** (последний вариант): Автодополнение через Google Places API
- **Кэширование местоположения**: Сохранение координат на 24 часа для оптимизации

#### Умная система определения местоположения
- **Приоритет источников**: Устройство → Карта → Ручной ввод
- **Автоматическое обновление**: При изменении местоположения
- **Валидация координат**: Проверка корректности и разумности
- **Обратное геокодирование**: Получение адреса по координатам

#### Фильтры учреждений
- **Тип учреждения**: Ветеринарная клиника, груминг-салон, зоомагазин и т.д.
- **Рейтинг**: Фильтрация по минимальному рейтингу
- **Статус активности**: Только работающие учреждения
- **Доступные услуги**: Фильтрация по конкретным услугам
- **Расстояние**: Настраиваемый радиус поиска (0.1-100 км)

#### Фильтры сотрудников
- **Специализация**: Фильтрация по оказываемым услугам
- **Рейтинг**: Сортировка по рейтингу сотрудника
- **Загруженность**: Приоритет менее загруженным сотрудникам
- **Доступность**: Только свободные в указанное время
- **Расстояние**: Сортировка по удаленности от пользователя

#### Фильтры пэт-ситтеров
- **Тип услуг**: Выгул, присмотр, кормление, дрессировка
- **Опыт работы**: Фильтрация по стажу
- **Рейтинг**: Сортировка по отзывам клиентов
- **Ценовой диапазон**: Фильтрация по стоимости услуг
- **Доступность**: Проверка свободного времени
- **Расстояние**: Приоритет ближайшим ситтерам

#### API для геолокации
- **Получение местоположения**: `GET /api/geolocation/user-location/`
- **Сохранение координат устройства**: `POST /api/geolocation/device-location/`
- **Сохранение выбранного района**: `POST /api/geolocation/map-location/`
- **Информация о местоположении**: `GET /api/geolocation/location-info/`
- **Очистка местоположения**: `DELETE /api/geolocation/clear-location/`

#### Преимущества новой системы
- **Удобство**: Автоматическое определение местоположения
- **Точность**: GPS координаты устройства
- **Производительность**: Кэширование и оптимизация
- **Гибкость**: Множественные способы определения местоположения

________________________________________
24. Система логирования и аудита

### Обзор системы логирования и аудита

Система логирования и аудита PetCare обеспечивает полный контроль и прозрачность всех действий пользователей в системе. Система автоматически записывает все пользовательские действия, изменения данных и критически важные операции для обеспечения безопасности, контроля качества и соответствия требованиям.

### Централизованное логирование

#### Принципы логирования
- **Логирование всех действий**: Каждое действие пользователя записывается в лог
- **Автоматическое логирование**: Система автоматически отслеживает все операции
- **Структурированные данные**: Логи содержат структурированную информацию для анализа
- **Долгосрочное хранение**: Логи хранятся в течение установленного периода
- **Производительность**: Оптимизированное логирование без влияния на работу системы

#### Что логируется
**Все HTTP-запросы к системе:**
- URL и метод запроса
- Пользователь, выполнивший запрос
- Время выполнения запроса
- IP-адрес пользователя
- Результат запроса (успех/ошибка)

**Все изменения в базе данных:**
- Создание новых записей
- Изменение существующих записей
- Удаление записей
- Тип изменяемого объекта
- Старые и новые значения полей

**Бизнес-операции:**
- Создание и отмена бронирований
- Платежи и возвраты
- Изменения в расписании
- Создание и обработка жалоб
- Изменения рейтингов

**Системные события:**
- Входы и выходы пользователей
- Изменения ролей и прав доступа
- Блокировки и разблокировки учреждений
- Автоматические операции системы
- Ошибки и исключения

### Система аудита

#### Критически важные операции для аудита
**Управление пользователями и ролями:**
- Создание и удаление инвайтов ролей
- Подтверждение и отклонение инвайтов
- Увольнение сотрудников с ролей
- Изменения прав доступа пользователей
- Передача прав основного владельца питомца

**Финансовые операции:**
- Создание и изменение договоров с учреждениями
- Изменение условий блокировки учреждений
- Изменение комиссий и скидок
- Блокировка и разблокировка учреждений по задолженности
- Проведение платежей и возвратов
- Изменение валютных курсов

**Система рейтингов и жалоб:**
- Модерация отзывов (скрытие/показ)
- Обработка жалоб (изменение статусов)
- Блокировка пользователей за нарушения
- Изменение рейтингов вручную
- Обнаружение подозрительной активности

**Управление питомцами:**
- Передача прав основного владельца
- Добавление и удаление совладельцев
- Изменение медицинских записей
- Загрузка и удаление документов питомцев

#### Права доступа к логам и аудиту

**Админы учреждений:**
- Логи своих учреждений
- Логи своих сотрудников
- Логи бронирований в своем учреждении
- Аудит изменений в профиле учреждения

**Биллинг-менеджеры:**
- Логи финансовых операций своих учреждений
- Логи изменений договоров
- Аудит блокировок и разблокировок
- Отчеты по платежам и задолженностям

**Супер-админы:**
- Все логи системы
- Полный аудит безопасности
- Логи изменений ролей и прав доступа
- Аудит системных операций
- Отчеты по подозрительной активности

### Практические сценарии использования

#### Сценарий 1: Расследование жалобы
Админ может посмотреть:
- Кто и когда изменил статус бронирования
- Кто обрабатывал жалобу и какие действия выполнял
- История изменений в карте питомца
- Все взаимодействия с клиентом

#### Сценарий 2: Финансовая проверка
Биллинг-менеджер может проверить:
- Кто изменял комиссии и когда
- История блокировок учреждения
- Кто делал возвраты и по каким причинам
- Все платежные операции по учреждению

#### Сценарий 3: Кадровый контроль
Супер-админ может отследить:
- Кто создавал инвайты на роли
- История увольнений и их причины
- Изменения прав доступа пользователей
- Подозрительная активность в системе

#### Сценарий 4: Аудит безопасности
Система автоматически отслеживает:
- Попытки несанкционированного доступа
- Массовые операции от одного пользователя
- Изменения критически важных настроек
- Подозрительные паттерны поведения

### Отчетность и аналитика

#### Стандартные отчеты
**Отчет по активности пользователей:**
- Количество действий по пользователям
- Время активности в системе
- Популярные функции и операции
- География использования системы

**Отчет по изменениям данных:**
- Частота изменений по типам объектов
- Пользователи с наибольшим количеством изменений
- Время пиковой активности
- Тренды изменений по периодам

**Отчет по безопасности:**
- Попытки несанкционированного доступа
- Подозрительная активность
- Изменения ролей и прав
- Блокировки и разблокировки

**Отчет по финансовым операциям:**
- История изменений договоров
- Операции с платежами
- Блокировки по задолженности
- Изменения комиссий и скидок

#### Фильтры и поиск
- Фильтрация по пользователям
- Фильтрация по типам операций
- Фильтрация по периодам времени
- Фильтрация по объектам системы
- Поиск по ключевым словам
- Экспорт отчетов в Excel

### Интеграция с существующими системами

#### Интеграция с системой уведомлений
- Уведомления о критических изменениях
- Алерты о подозрительной активности
- Ежедневные отчеты по активности
- Уведомления о превышении лимитов

#### Интеграция с системой отчетности
- Автоматическое создание отчетов
- Интеграция с существующими отчетами
- Экспорт данных для внешних систем
- API для получения логов

#### Интеграция с системой безопасности
- Автоматическое обнаружение угроз
- Блокировка подозрительных пользователей
- Интеграция с системой рейтингов
- Защита от манипуляций

### Преимущества системы логирования и аудита

1. **Безопасность**: Полный контроль всех действий в системе
2. **Прозрачность**: Отслеживание всех изменений и операций
3. **Соответствие**: Соответствие требованиям по аудиту и контролю
4. **Расследование**: Возможность расследования инцидентов
5. **Аналитика**: Детальная аналитика использования системы
6. **Защита**: Защита от злоупотреблений и нарушений
7. **Доверие**: Повышение доверия пользователей к системе

### Масштабируемость

#### Расширение функционала
- Поддержка новых типов операций
- Интеграция с внешними системами аудита
- Расширенные алгоритмы обнаружения угроз
- Машинное обучение для анализа логов

#### Производительность
- Оптимизация хранения логов
- Сжатие исторических данных
- Распределенное хранение логов
- Быстрый поиск и фильтрация

#### Интеграция с внешними системами
- Экспорт логов в стандартные форматы
- Интеграция с SIEM-системами
- Связь с системами мониторинга
- API для внешних аналитических систем

### Настройки администратора системы

#### Первоначальная настройка системы логирования и аудита

**1. Создание миграций базы данных**
```bash
cd PetsCare
python manage.py makemigrations audit
python manage.py migrate
```

**2. Настройка в Django Admin**
- Войти в Django Admin: `http://localhost:8000/admin/`
- Перейти в раздел **Audit → Audit Settings**
- Настроить основные параметры системы

**3. Основные настройки аудита**
- **Logging Enabled**: Включить логирование всех действий
- **Security Audit Enabled**: Включить аудит критических операций
- **Log Retention (days)**: 365 дней хранения обычных логов
- **Security Audit Retention (days)**: 2555 дней (7 лет) хранения аудита безопасности
- **Auto Cleanup Enabled**: Включить автоматическую очистку старых записей
- **Cleanup Frequency (days)**: 7 дней (очистка раз в неделю)

**4. Настройки логирования**
- **Log HTTP Requests**: Логировать все HTTP запросы к системе
- **Log Database Changes**: Логировать изменения в базе данных
- **Log Business Operations**: Логировать бизнес-операции (бронирования, платежи)
- **Log System Events**: Логировать системные события
- **Minimum Log Level**: INFO (уровень детализации логов)

**5. Настройки уведомлений**
- **Critical Operation Notifications**: Уведомления о критических операциях
- **Notification Email**: Email для получения уведомлений о безопасности

#### Настройка прав доступа

**1. Создание групп пользователей**
- **Audit Viewers**: Просмотр логов и аудита, экспорт данных
- **Audit Managers**: Управление настройками, проверка записей аудита
- **System Admins**: Полный доступ к системе аудита

**2. Назначение прав**
- Добавить администраторов в группу "Audit Managers"
- Назначить права на просмотр логов соответствующим ролям
- Настроить ограничения доступа по ролям пользователей

#### Настройка периодических задач

**1. Автоматическая очистка логов**
```bash
# Настройка задачи очистки через Celery
python manage.py cleanup_old_logs --force
```

**2. Экспорт данных для архивирования**
```bash
# Ежемесячный экспорт данных
python manage.py export_audit_data --format json --start-date 2024-01-01
```

**3. Мониторинг статистики**
```bash
# Проверка статистики аудита
python manage.py audit_statistics --period month --detailed
```

#### Настройка мониторинга

**1. Создание дашборда в админке**
- **Recent User Actions**: Последние действия пользователей
- **Critical Audits**: Критические записи аудита безопасности
- **Pending Reviews**: Записи, требующие проверки администратором
- **System Performance**: Производительность системы логирования

**2. Настройка фильтров**
- **High Priority Audits**: Критические операции безопасности
- **Failed Operations**: Неудачные операции и ошибки
- **Suspicious Activity**: Подозрительная активность пользователей
- **Financial Operations**: Финансовые операции и изменения

**3. Настройка алертов**
- Уведомления при превышении лимитов логов
- Алерты о критических операциях безопасности
- Уведомления о подозрительной активности
- Мониторинг производительности системы

#### Настройка резервного копирования

**1. Включение в резервные копии**
- Таблица `audit_useraction` - логи действий пользователей
- Таблица `audit_securityaudit` - записи аудита безопасности
- Таблица `audit_auditsettings` - настройки системы аудита

**2. Архивирование старых данных**
- Ежемесячный экспорт данных в JSON/CSV форматах
- Сжатие и архивирование исторических логов
- Хранение архивов в отдельном хранилище

#### Процедуры обслуживания

**1. Еженедельные процедуры**
- Проверка статистики аудита
- Мониторинг производительности системы
- Проверка критических записей аудита
- Очистка старых логов

**2. Ежемесячные процедуры**
- Анализ трендов использования системы
- Проверка эффективности настроек безопасности
- Архивирование данных за прошедший месяц
- Обновление процедур реагирования

**3. Квартальные процедуры**
- Полный аудит системы безопасности
- Анализ производительности и оптимизация
- Обновление настроек и конфигурации
- Обучение команды новым процедурам

#### Контрольный список настройки

**Первоначальная настройка:**
- [ ] Миграции базы данных выполнены
- [ ] Настройки аудита сконфигурированы в админке
- [ ] Middleware добавлен в settings.py
- [ ] Права доступа назначены пользователям
- [ ] Email уведомления настроены

**Настройка мониторинга:**
- [ ] Дашборд в админке создан
- [ ] Фильтры и поиск настроены
- [ ] Алерты и уведомления настроены
- [ ] Процедуры реагирования определены

**Настройка обслуживания:**
- [ ] Периодические задачи настроены
- [ ] Резервное копирование настроено
- [ ] Процедуры архивирования определены
- [ ] Документация создана

**Тестирование системы:**
- [ ] Логирование HTTP запросов протестировано
- [ ] Аудит критических операций проверен
- [ ] Производительность системы оценена
- [ ] Процедуры восстановления протестированы

#### Рекомендации по безопасности

**1. Регулярный мониторинг**
- Ежедневная проверка критических записей аудита
- Еженедельный анализ статистики безопасности
- Ежемесячный полный аудит системы

**2. Реагирование на инциденты**
- Процедуры реагирования на критические события
- Эскалация инцидентов по уровням серьезности
- Документирование всех инцидентов и действий

**3. Обучение команды**
- Регулярное обучение по процедурам аудита
- Обновление знаний о новых угрозах
- Практические тренировки по реагированию

**4. Соответствие требованиям**
- Регулярные проверки соответствия GDPR
- Аудит соответствия требованиям безопасности
- Обновление процедур в соответствии с новыми требованиями

## СИСТЕМА УВЕДОМЛЕНИЙ

### Обзор системы уведомлений

Система уведомлений PetCare обеспечивает своевременное информирование пользователей о важных событиях через различные каналы доставки. Система разделена на обязательные уведомления (не настраиваются пользователями) и настраиваемые уведомления (контролируются пользователями).

### 1. Обязательные уведомления (не настраиваются пользователями)

#### 1.1 Верификация email (КРИТИЧНО)
**Требование**: При регистрации нового пользователя отправлять email с ссылкой для подтверждения адреса

**Функционал**: 
- Генерация токена подтверждения
- Отправка email с ссылкой для верификации
- Блокировка доступа к системе до подтверждения email
- Возможность повторной отправки подтверждения

**Приоритет**: Критический

#### 1.2 Сброс пароля через email
**Требование**: Возможность сброса пароля через email

**Функционал**:
- Форма запроса сброса пароля
- Отправка email с временной ссылкой для сброса
- Ограничение времени действия ссылки (24 часа)
- Безопасная генерация временных токенов

#### 1.3 Система инвайтов ролей (КРИТИЧНО)
**Требование**: Автоматические уведомления при работе с инвайтами ролей

**Функционал**:
- **При создании инвайта**: Email получателю с ссылкой для принятия роли
- **При принятии инвайта**: Email создателю инвайта о принятии
- **При отклонении инвайта**: Email создателю инвайта об отклонении
- **При истечении инвайта**: Email создателю о необходимости продления
- **Push/In-app уведомления**: Мгновенные уведомления о новых инвайтах

### 2. Настраиваемые уведомления (контролируются пользователями)

#### 2.1 Типы событий для уведомлений
- **Бронирование**: Новое бронирование, изменение бронирования
- **Отмена**: Отмена бронирования (клиентом или учреждением)
- **Передержка**: Напоминания о передержке питомца
- **Прием**: Напоминания о предстоящем приеме у ветеринара/грумера

#### 2.2 Каналы доставки для каждого типа событий
- **Push-уведомления**: Мгновенные уведомления на устройство
- **In-app уведомления**: Уведомления внутри приложения
- **Email**: Отправка на email адрес

#### 2.3 Время уведомления до события
**Настраиваемые интервалы**: 
- 30 минут до события
- 1 час до события
- 2 часа до события
- 6 часов до события
- 12 часов до события
- 24 часа до события
- Мгновенно при создании события

### 3. Система настроек пользователей

#### 3.1 Модель настроек уведомлений
**Структура**: Для каждого типа события → канал → время уведомления

**Пример настроек**:
```
Бронирование:
  - Push: 24 часа, 1 час
  - In-app: 2 часа
  - Email: 12 часов

Отмена:
  - Push: мгновенно
  - In-app: мгновенно
  - Email: не отправлять

Передержка:
  - Push: 1 час
  - In-app: 2 часа
  - Email: 6 часов

Прием:
  - Push: 30 минут
  - In-app: 1 час
  - Email: 24 часа
```

#### 3.2 Управление через приложение
**Требование**: Удобное управление настройками через мобильное приложение

**Функционал**:
- Экран настроек уведомлений с переключателями
- Выбор каналов для каждого типа события
- Настройка времени уведомления для каждого канала
- Предварительный просмотр настроек
- Тестовые уведомления для проверки настроек

### 4. Техническая реализация

#### 4.1 Управление токенами устройств
**Требование**: Централизованное управление токенами устройств для push-уведомлений

**Функционал**:
- Автоматическая регистрация токенов при входе в приложение
- Удаление токенов при выходе из приложения
- Обновление токенов при их изменении
- Поддержка множественных устройств для одного пользователя

#### 4.2 Централизованный сервис отправки
**Требование**: Централизованный сервис для отправки всех типов уведомлений

**Функционал**:
- Единый интерфейс для отправки email, push и in-app уведомлений
- Retry логика при ошибках отправки
- Логирование всех попыток отправки
- Очередь для массовых рассылок

#### 4.3 HTML шаблоны для email
**Требование**: Красивые HTML шаблоны для email уведомлений

**Функционал**:
- Брендированные шаблоны с логотипом PetCare
- Поддержка переменных в шаблонах
- Адаптивный дизайн для мобильных устройств
- Текстовые версии для совместимости

### 5. Сервис рассылки

#### 5.1 Email рассылка
**Сервис**: Django Email Backend с поддержкой SMTP
- **SMTP сервер**: Gmail SMTP для разработки и тестирования
- **Настройка**: smtp.gmail.com:587 с TLS шифрованием
- **Лимиты**: 500 писем/день для обычных аккаунтов Gmail
- **Шаблоны**: Django Templates с поддержкой переменных
- **Очередь**: Celery для асинхронной отправки
- **Retry логика**: Автоматические повторные попытки при ошибках
- **Безопасность**: Использование паролей приложений Gmail

#### 5.2 Push-уведомления
**Сервис**: django-push-notifications
- **Android**: Firebase Cloud Messaging (FCM)
- **iOS**: Apple Push Notification Service (APNS)
- **Web**: Web Push API
- **Управление токенами**: Автоматическое обновление и очистка

#### 5.3 In-app уведомления
**Сервис**: Собственная система уведомлений
- **Хранение**: База данных с моделью Notification
- **Доставка**: WebSocket для реального времени
- **Управление**: API для создания и управления уведомлениями

### 6. Архитектура системы уведомлений

#### 6.1 Модели данных
- **NotificationType**: Типы уведомлений (бронирование, отмена, передержка, прием)
- **NotificationTemplate**: Шаблоны для email и push-уведомлений
- **NotificationPreference**: Настройки пользователей по типам уведомлений
- **Notification**: Основная модель уведомлений
- **Reminder**: Напоминания о процедурах для питомцев

#### 6.2 Компоненты системы
- **NotificationService**: Центральный сервис отправки уведомлений
- **EmailService**: Специализированный сервис для email
- **PushService**: Специализированный сервис для push-уведомлений
- **PreferenceService**: Управление настройками пользователей
- **SchedulerService**: Планирование отложенных уведомлений

#### 6.3 Автоматизация
- **Celery задачи**: Асинхронная отправка уведомлений
- **Django сигналы**: Автоматическое создание уведомлений при событиях
- **Планировщик**: Отложенные уведомления и напоминания
- **Очистка**: Автоматическая очистка старых уведомлений

### 7. Безопасность и производительность

#### 7.1 Безопасность
- **Верификация email**: Обязательная верификация при регистрации
- **Токены безопасности**: Безопасная генерация токенов для сброса пароля
- **Ограничения частоты**: Защита от спама уведомлений
- **Шифрование**: Защита персональных данных в уведомлениях

#### 7.2 Производительность
- **Очереди**: Асинхронная обработка уведомлений
- **Кэширование**: Кэширование настроек пользователей
- **Балансировка нагрузки**: Распределение нагрузки между сервисами
- **Мониторинг**: Отслеживание производительности системы

#### 7.3 Масштабируемость
- **Горизонтальное масштабирование**: Добавление новых серверов
- **Вертикальное масштабирование**: Увеличение ресурсов серверов
- **База данных**: Оптимизация запросов и индексов
- **CDN**: Использование CDN для статических ресурсов

### 8. Интеграция с существующей системой

#### 8.1 Интеграция с ролевой моделью
- **Уведомления по ролям**: Разные типы уведомлений для разных ролей
- **Настройки по ролям**: Разные настройки уведомлений для разных ролей
- **Права доступа**: Контроль доступа к настройкам уведомлений

#### 8.2 Интеграция с системой бронирований
- **События бронирований**: Автоматические уведомления при событиях
- **Напоминания**: Настраиваемые напоминания о бронированиях
- **Отмены**: Уведомления об отменах с причинами

#### 8.3 Интеграция с системой передержек
- **События передержек**: Уведомления о статусе передержек
- **Напоминания**: Напоминания о начале и окончании передержек
- **Отзывы**: Напоминания о необходимости оставить отзыв

### 9. Мониторинг и аналитика

#### 9.1 Мониторинг системы
- **Статистика отправки**: Количество отправленных уведомлений
- **Статистика доставки**: Процент успешной доставки
- **Статистика открытий**: Процент открытых уведомлений
- **Ошибки**: Мониторинг ошибок отправки

#### 9.2 Аналитика пользователей
- **Предпочтения**: Анализ предпочтений пользователей по каналам
- **Вовлеченность**: Анализ вовлеченности пользователей
- **Конверсия**: Анализ конверсии уведомлений в действия
- **Отписки**: Анализ причин отписки от уведомлений

#### 9.3 Оптимизация
- **A/B тестирование**: Тестирование разных вариантов уведомлений
- **Время отправки**: Оптимизация времени отправки уведомлений
- **Контент**: Оптимизация содержания уведомлений
- **Частота**: Оптимизация частоты уведомлений

### 10. Соответствие требованиям

#### 10.1 GDPR и приватность
- **Согласие**: Получение согласия на уведомления
- **Отписка**: Простая возможность отписки от уведомлений
- **Данные**: Минимизация персональных данных в уведомлениях
- **Хранение**: Ограниченное хранение данных уведомлений

#### 10.2 Доступность
- **Альтернативные форматы**: Поддержка альтернативных форматов
- **Языки**: Поддержка множественных языков
- **Устройства**: Поддержка различных устройств
- **Ограничения**: Учет ограничений пользователей

#### 10.3 Стандарты
- **Email стандарты**: Соответствие стандартам email
- **Push стандарты**: Соответствие стандартам push-уведомлений
- **Web стандарты**: Соответствие веб-стандартам
- **Мобильные стандарты**: Соответствие стандартам мобильных платформ
