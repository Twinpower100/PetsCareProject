# PetsCare API

## Описание
API для системы управления ветеринарной клиникой PetsCare. Предоставляет функционал для работы с контрактами, платежами, счетами и возвратами.

## Аутентификация
API использует JWT-токены для аутентификации. Для получения токена используйте эндпоинт `/api/token/`.

## Эндпоинты

### Контракты

#### Получение списка контрактов
```
GET /api/contracts/
```
Возвращает список всех контрактов. Доступно только для администраторов.

#### Создание контракта
```
POST /api/contracts/
```
Создает новый контракт. Требуется авторизация.

#### Получение деталей контракта
```
GET /api/contracts/{id}/
```
Возвращает детальную информацию о контракте.

#### Загрузка документа контракта
```
GET /api/contracts/{id}/download_document/
```
Скачивает документ, прикрепленный к контракту.

### Типы контрактов

#### Получение списка типов контрактов
```
GET /api/contract-types/
```
Возвращает список всех типов контрактов.

### Платежи

#### Получение списка платежей
```
GET /api/payments/
```
Возвращает список всех платежей.

#### Создание платежа
```
POST /api/payments/
```
Создает новый платеж.

### Счета

#### Получение списка счетов
```
GET /api/invoices/
```
Возвращает список всех счетов.

#### Создание счета
```
POST /api/invoices/
```
Создает новый счет.

### Возвраты

#### Получение списка возвратов
```
GET /api/refunds/
```
Возвращает список всех возвратов.

#### Создание возврата
```
POST /api/refunds/
```
Создает новый возврат.

## Логирование
Логи приложения сохраняются в директории `logs/billing.log`. Логирование включает информацию о:
- Создании и обновлении контрактов
- Платежах и возвратах
- Ошибках и исключениях

## Установка и запуск

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Примените миграции:
```bash
python manage.py migrate
```

3. Запустите сервер:
```bash
python manage.py runserver
```

## Тестирование
Для запуска тестов используйте:
```bash
python manage.py test billing
```

## Система многоуровневой блокировки учреждений

Система автоматической блокировки учреждений по задолженности обеспечивает финансовый контроль и предотвращение накопления долгов. Блокировка работает на основе пороговых значений, заданных в договоре.

### Уровни блокировки:
- **0** — Нет блокировки (все функции доступны)
- **1** — Информационное уведомление (учреждение получает предупреждение, но не блокируется)
- **2** — Исключение из поиска (учреждение не отображается в поиске, но может работать с текущими клиентами)
- **3** — Полная блокировка (все функции недоступны)

### Принципы работы:
- Пороговые значения (debt_threshold, overdue_threshold_1/2/3) настраиваются индивидуально для каждого договора.
- Проверка задолженности и применение блокировки происходит автоматически по расписанию (каждый час через Celery Beat).
- Уведомления отправляются ответственным лицам учреждения и менеджерам по биллингу.
- Массовые действия по установке порогов и применению блокировки доступны в админке.

### Настройка:
- Все параметры по умолчанию задаются в `BLOCKING_SETTINGS` в `settings.py`.
- Для ручной проверки и управления используйте сервисы и действия в админке.

### Тестирование:
- Для проверки работы блокировки выполните:
```bash
python manage.py test billing
``` 