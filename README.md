# PetsCare API

[![GitHub](https://img.shields.io/badge/GitHub-Repository-blue?style=flat-square&logo=github)](https://github.com/Twinpower100/PetCare)

## Описание
API для системы управления ветеринарной клиникой PetsCare. Предоставляет функционал для работы с юридическими документами (оферты/акцепты), платежами, счетами и возвратами.

## Архитектура Provider/ProviderLocation

Система использует двухуровневую архитектуру для провайдеров услуг:

### Provider (Организация)
- **Provider** представляет юридическое лицо (организацию)
- Уникальные поля: `name`, `email`, `phone_number`, `tax_id`, `registration_number`
- Содержит юридический адрес организации
- Управляет категориями услуг уровня 0 (`available_category_levels`)
- Биллинг, юридические документы и блокировки работают на уровне организации

### ProviderLocation (Локация)
- **ProviderLocation** представляет физическую точку предоставления услуг
- Каждая организация может иметь множество локаций
- Каждая локация имеет:
  - Свой адрес и координаты
  - Контактную информацию (email, телефон - НЕ уникальные)
  - Набор услуг с ценами (`ProviderLocationService`)
  - Расписание работы
- Бронирования работают на уровне локации
- При деактивации локации все активные и будущие бронирования автоматически отменяются

### Основные изменения
- Поиск провайдеров теперь работает с локациями
- Пользователи видят конкретные локации с адресами при поиске
- Сотрудники (`Employee`) могут работать в нескольких локациях (ManyToMany)
- Расписания (`Schedule`) привязаны к локациям, а не к организациям

## Аутентификация
API использует JWT-токены для аутентификации. Для получения токена используйте эндпоинт `/api/v1/login/`.

## Эндпоинты

### Юридические документы

#### Получение публичного документа по типу
```
GET /api/v1/legal/documents/{document_type}/
```
Возвращает публичный документ (например, Terms of Service, Privacy Policy).

#### Принятие документа
```
POST /api/v1/legal/documents/{id}/accept/
```
Создает запись акцепта документа (для провайдера или пользователя).

### Платежи

#### Получение списка платежей
```
GET /api/v1/payments/
```
Возвращает список всех платежей.

#### Создание платежа
```
POST /api/v1/payments/
```
Создает новый платеж.

### Счета

#### Получение списка счетов
```
GET /api/v1/invoices/
```
Возвращает список всех счетов.

#### Создание счета
```
POST /api/v1/invoices/
```
Создает новый счет.

### Возвраты

#### Получение списка возвратов
```
GET /api/v1/refunds/
```
Возвращает список всех возвратов.

#### Создание возврата
```
POST /api/v1/refunds/
```
Создает новый возврат.

## Логирование
Логи приложения сохраняются в директории `logs/billing.log`. Логирование включает информацию о:
- Создании и обновлении юридических документов
- Платежах и возвратах
- Ошибках и исключениях

## Установка и запуск

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Примените миграции:
```bash
python manage.py migrate
```

3. Запустите сервер:
```bash
python manage.py runserver
```

## Тестирование
Для запуска тестов используйте:
```bash
python manage.py test billing
```

## Система многоуровневой блокировки учреждений

Система автоматической блокировки учреждений по задолженности обеспечивает финансовый контроль и предотвращение накопления долгов. Блокировка работает на основе пороговых значений, заданных в договоре.

### Уровни блокировки:
- **0** — Нет блокировки (все функции доступны)
- **1** — Информационное уведомление (учреждение получает предупреждение, но не блокируется)
- **2** — Исключение из поиска (учреждение не отображается в поиске, но может работать с текущими клиентами)
- **3** — Полная блокировка (все функции недоступны)

### Принципы работы:
- Пороговые значения (debt_threshold, overdue_threshold_1/2/3) настраиваются индивидуально для каждого учреждения.
- Проверка задолженности и применение блокировки происходит автоматически по расписанию (каждый час через Celery Beat).
- Уведомления отправляются ответственным лицам учреждения и менеджерам по биллингу.
- Массовые действия по установке порогов и применению блокировки доступны в админке.

### Настройка:
- Все параметры по умолчанию задаются в `BLOCKING_SETTINGS` в `settings.py`.
- Для ручной проверки и управления используйте сервисы и действия в админке.

### Тестирование:
- Для проверки работы блокировки выполните:
```bash
python manage.py test billing
``` 