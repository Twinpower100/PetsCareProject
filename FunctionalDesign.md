# Функциональный дизайн системы PetCare

## Обзор системы

PetCare - это комплексная система управления ветеринарными услугами, которая объединяет владельцев домашних животных, поставщиков услуг (ветклиники, груминг-салоны) и специалистов в единую экосистему.

**Платформы:**
- Веб-приложение на React для всех пользователей
- Мобильное приложение (React Native) для владельцев питомцев и ситтеров
- Push-уведомления для мгновенного информирования о важных событиях

## 1. УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ И РОЛЯМИ

### 1.1 Регистрация и аутентификация

**Процесс регистрации:**
1. Любой человек может зарегистрироваться в системе, введя email, пароль, имя, телефон
2. Система проверяет уникальность email
3. Отправляется email для подтверждения
4. После подтверждения аккаунт активируется
5. Пользователь получает базовую роль "Владелец питомца"

**Регистрация через Google OAuth:**
1. Пользователь нажимает "Войти через Google"
2. Перенаправляется на страницу авторизации Google
3. Пользователь разрешает доступ к данным профиля
4. Система получает данные: email, имя, фото профиля
5. Создается аккаунт с базовой ролью "Владелец питомца"
6. Пользователь автоматически входит в систему

**Процесс входа:**
1. Пользователь вводит email и пароль
2. Система проверяет учетные данные
3. Генерируется JWT-токен для сессии
4. Пользователь получает доступ к функциям согласно роли

**Вход через Google OAuth:**
1. Пользователь нажимает "Войти через Google"
2. Если аккаунт уже существует - происходит вход
3. Если аккаунта нет - создается новый
4. Генерируется JWT-токен для сессии
5. Пользователь получает доступ к функциям согласно роли

### 1.2 Система ролей и разрешений

**Общее описание:**
Система поддерживает мультиролевую архитектуру, где пользователи могут иметь несколько ролей одновременно. Права доступа определяются через предопределенные наборы разрешений, что обеспечивает консистентность и упрощает управление.

**Типы ролей и их назначение:**

**Автоматически назначаемые роли:**
- **pet_owner** - Владелец питомца (базовая роль)
  - Назначается автоматически при регистрации пользователя
  - Предоставляет базовые права для управления питомцами и бронирования услуг

- **pet_sitter** - Передержка питомцев
  - Назначается автоматически при создании профиля ситтера
  - Предоставляет права для оказания услуг передержки

**Роли, назначаемые через систему инвайтов:**
- **employee** - Сотрудник учреждения
  - Назначается администратором учреждения через систему инвайтов
  - Предоставляет права для работы с клиентами в рамках учреждения

**Роли, создаваемые через системную админку:**
- **institution_admin** - Администратор учреждения
  - Создается системным администратором
  - Предоставляет права управления учреждением и его сотрудниками

- **billing_manager** - Менеджер по биллингу
  - Создается системным администратором
  - Предоставляет права управления финансовыми операциями

- **booking_manager** - Менеджер по бронированиям
  - Создается системным администратором
  - Предоставляет права управления бронированиями и разрешения конфликтов

- **system_admin** - Системный администратор
  - Создается системным администратором
  - Предоставляет полный доступ ко всем функциям системы

**Алгоритм назначения ролей:**
1. **Автоматические роли** назначаются системой при создании соответствующих профилей
2. **Роли учреждений** назначаются через систему инвайтов администратором учреждения
3. **Системные роли** создаются и назначаются системным администратором
4. **Права доступа** определяются предопределенными наборами разрешений (см. раздел 1.2.3)
5. **Пользователь может иметь несколько ролей** одновременно с накоплением прав

**Архитектура системы прав:**

**1. Словарь разрешений с описаниями:**
- Централизованный словарь всех доступных разрешений в системе
- Каждое разрешение имеет техническое название и понятное описание
- Примеры: `users.add_user` → "Adding new users", `pets.view_pet` → "Viewing pets"
- Словарь используется для валидации и отображения прав в интерфейсе
- **Конфигурируется только через хардкод** - не настраивается пользователями через интерфейс

**2. Предопределенные наборы прав для ролей:**
- **system_admin** - полный доступ ко всем функциям системы
- **institution_admin** - управление учреждением и его сотрудниками
- **billing_manager** - управление финансовыми операциями
- **booking_manager** - управление бронированиями и разрешение конфликтов
- **employee** - базовые права для работы с клиентами
- **pet_owner** - базовые права владельца питомца
- **pet_sitter** - права для предоставления услуг передержки

**3. Выбор набора прав при создании роли:**
- В админке Django поле "Permission Set" с выбором из предопределенных наборов
- Поле "Custom Permissions" (используется только если выбран "custom")
- Автоматическое заполнение разрешений на основе выбранного набора
- Возможность создания кастомных ролей с индивидуальными правами

#### 1.2.1 Система инвайтов

**Общее описание:**
Система должна поддерживать приглашения пользователей на различные роли и права доступа. Инвайты генерируются авторизованными пользователями и содержат уникальные токены или QR-коды для быстрого принятия приглашений.

**Типы инвайтов:**

**Инвайты на роли в учреждениях:**
- **Роль сотрудника (employee)** - приглашение на работу в учреждение

**Инвайты на роли в сервисе:**
- **Роль менеджера по биллингу (billing_manager)** - приглашение на управление финансовыми операциями сервиса

**Инвайты на совладение питомцами:**
- **Добавление совладельца (invite)** - приглашение стать совладельцем питомца
- **Передача прав основного владельца (transfer)** - передача прав основного владельца другому пользователю

**Процесс создания инвайта:**
1. **Инициация** - авторизованный пользователь создает инвайт
2. **Генерация токена/QR-кода** - система создает уникальный идентификатор
3. **Установка срока действия** - инвайт имеет ограниченный срок действия
4. **Отправка уведомления** - система отправляет уведомление о создании инвайта

**Процесс принятия инвайта:**
1. **Получение токена/QR-кода** - пользователь получает токен или сканирует QR-код
2. **Верификация** - система проверяет валидность и срок действия инвайта
3. **Подтверждение** - пользователь подтверждает принятие роли/прав
4. **Активация** - система назначает пользователю соответствующую роль или права
5. **Уведомления** - отправляются уведомления инициатору и новому участнику

**Функциональные требования:**
- **Генерация токенов/QR-кодов** - уникальные идентификаторы для каждого инвайта
- **Валидация инвайтов** - проверка срока действия и статуса
- **Отслеживание статуса** - pending, accepted, expired, cancelled
- **История инвайтов** - сохранение всех созданных и принятых инвайтов
- **Отзыв инвайтов** - возможность отменить инвайт до его принятия

**Бизнес-правила:**
- Только авторизованные пользователи могут создавать соответствующие инвайты
- Пользователь может иметь только одну роль в одном учреждении
- Пользователь может иметь роль менеджера по биллингу в сервисе
- Инвайт автоматически истекает по истечении срока действия
- Принятый инвайт нельзя отменить
- Токен/QR-код уникален для каждого инвайта и не может быть переиспользован
- Система предотвращает создание дублирующих инвайтов

**Интеграция:**
- Интеграция с системой ролей и разрешений
- Интеграция с системой уведомлений
- Интеграция с мобильным приложением для сканирования QR-кодов
- Интеграция с системой управления учреждениями и питомцами

#### 1.2.2 Передача полномочий менеджера учреждения

**Общее описание:**
Система должна поддерживать процесс передачи полномочий администратора учреждения другому пользователю. Это критически важная функция для обеспечения непрерывности управления учреждением при смене руководства или временном отсутствии основного администратора.

**Процесс инициации передачи:**
1. **Инициация** - текущий администратор учреждения инициирует процесс передачи полномочий
2. **Выбор кандидата** - администратор выбирает сотрудника для передачи полномочий
3. **Создание инвайта** - система создает специальный инвайт на передачу полномочий

**Процесс принятия передачи:**
1. **Получение уведомления** - кандидат получает уведомление о предложении полномочий
2. **Подтверждение** - кандидат подтверждает принятие полномочий
3. **Активация** - система активирует передачу полномочий
4. **Уведомления** - отправляются уведомления всем заинтересованным сторонам

**Функциональные требования:**
- **Создание инвайтов передачи** - генерация специальных инвайтов для передачи полномочий
- **Валидация кандидатов** - проверка прав кандидата на получение полномочий
- **Отслеживание статуса** - pending, accepted, rejected, expired, active, completed
- **История передач** - сохранение всех операций передачи полномочий

**Бизнес-правила:**
- Только администратор учреждения может инициировать передачу полномочий
- Кандидат должен быть сотрудником учреждения
- В учреждении должен быть как минимум один активный администратор
- Система предотвращает передачу полномочий неактивным пользователям
- Передача полномочий не влияет на другие роли пользователя в учреждении

**Интеграция:**
- Интеграция с системой ролей и разрешений учреждения
- Интеграция с системой уведомлений
- Интеграция с системой управления учреждениями

#### 1.2.3 Система управления правами и разрешениями

**Общее описание:**
Система должна поддерживать гибкое и управляемое распределение прав доступа для различных ролей пользователей. Права определяются через предопределенные наборы разрешений, что обеспечивает консистентность и упрощает управление.

**Архитектура системы прав:**

**1. Словарь разрешений с описаниями:**
- Централизованный словарь всех доступных разрешений в системе
- Каждое разрешение имеет техническое название и понятное описание
- Примеры: `users.add_user` → "Adding new users", `pets.view_pet` → "Viewing pets"
- Словарь используется для валидации и отображения прав в интерфейсе

**2. Предопределенные наборы прав для ролей:**
- **system_admin** - полный доступ ко всем функциям системы
- **institution_admin** - управление учреждением и его сотрудниками
- **billing_manager** - управление финансовыми операциями
- **booking_manager** - управление бронированиями и разрешение конфликтов
- **employee** - базовые права для работы с клиентами
- **pet_owner** - базовые права владельца питомца
- **pet_sitter** - права для предоставления услуг передержки

**3. Выбор набора прав при создании роли:**
- В админке Django поле "Permission Set" с выбором из предопределенных наборов
- Поле "Custom Permissions" (используется только если выбран "custom")
- Автоматическое заполнение разрешений на основе выбранного набора
- Возможность создания кастомных ролей с индивидуальными правами

**Функциональные требования:**

**Управление ролями:**
- Создание новых ролей через выбор предопределенного набора прав
- Редактирование существующих ролей с сохранением истории изменений
- Валидация прав при создании/изменении ролей
- Проверка конфликтов прав между ролями

**Проверка прав доступа:**
- Автоматическая проверка прав пользователя при доступе к функциям
- Кэширование прав пользователя для оптимизации производительности
- Логирование попыток доступа к запрещенным функциям
- Поддержка множественных ролей у одного пользователя

**Административный интерфейс:**
- Просмотр всех доступных разрешений с описаниями
- Создание и редактирование ролей через выбор наборов прав
- Предварительный просмотр прав роли перед сохранением
- Статистика использования ролей в системе

**Бизнес-правила:**
- Роли `pet_owner` и `pet_sitter` назначаются автоматически при создании соответствующих профилей
- Роли `employee` назначаются администратором учреждения через систему инвайтов
- Роли `institution_admin`, `billing_manager`, `booking_manager`, `system_admin` создаются через системную админку
- Пользователь может иметь несколько ролей одновременно
- При изменении набора прав роли автоматически обновляются права всех пользователей с этой ролью

**Интеграция:**
- Интеграция с системой аутентификации Django
- Связь с системой аудита для отслеживания изменений прав
- Интеграция с API для проверки прав в REST эндпоинтах
- Поддержка декораторов для проверки прав в представлениях

**Безопасность:**
- Валидация всех разрешений при создании ролей
- Защита от создания ролей с несуществующими правами
- Аудит всех изменений в системе прав
- Резервное копирование конфигурации прав

### 1.3 Управление профилем пользователя

**Управление безопасностью:**
- Изменение пароля (стандартная функция Django)
- Выход из системы (завершение сессии)

**Удаление аккаунта:**
Пользователь может самостоятельно удалить свой аккаунт, кроме следующих случаев:

**Ограничения на удаление:**
- **Менеджер учреждения** - не может удалиться, если он последний менеджер в учреждении или есть незавершенная передача прав менеджера
- **Сотрудник учреждения** - не может удалиться вообще (должен быть уволен администратором)
- **Ситтер с активными заявками** - не может удалиться, если есть активные заявки на передержку (статусы: waiting_start, active, waiting_end, waiting_review)
- **Основной владелец питомца** - не может удалиться, если он единственный владелец питомца
- **Пользователь с активным профилем ситтера** - не может удалиться, пока профиль ситтера активен

**Алгоритм удаления:**
1. Пользователь запрашивает удаление аккаунта
2. Система проверяет все ограничения через функцию `can_delete_user()`
3. Если ограничений нет - аккаунт удаляется
4. Если есть ограничения - возвращается сообщение об ошибке с указанием причины
5. Все связанные данные удаляются каскадно (питомцы, записи, документы и т.д.)

**Профиль ситтера (дополнительные поля):**
1. Ситтер указывает адрес для оказания услуг (через связь с моделью Address)
2. Указывает опыт работы с животными (годы)
3. Описывает услуги передержки
4. Указывает типы питомцев и максимальное количество
5. Настраивает период доступности и расстояние

## 2. УПРАВЛЕНИЕ ПИТОМЦАМИ И ВЛАДЕЛЬЦАМИ

### 2.1 Множественные владельцы питомцев
- **Основной владелец (main_owner)**: Один пользователь с полными правами управления питомцем
- **Совладельцы (owners)**: Множественные пользователи с правами доступа к информации о питомце
- **Система инвайтов (PetOwnershipInvite)**: Приглашение совладельцев или передача прав основного владельца через email с токеном
- **Типы инвайтов**: 'invite' (добавление совладельца) и 'transfer' (передача прав основного владельца)
- **QR-коды**: Генерация QR-кодов для быстрого подтверждения инвайтов

### 2.2 Создание профиля питомца

**Алгоритм добавления питомца:**
1. Владелец нажимает "Добавить питомца"
2. Заполняет обязательные поля: имя, тип (PetType), порода (Breed), дата рождения
3. Опционально: вес, описание, особые потребности, медицинские условия, фото
4. Система автоматически устанавливает текущего пользователя как основного владельца (main_owner)
5. Система добавляет основного владельца в список владельцев (owners)
6. Система создает уникальный ID питомца
7. Питомец добавляется в список владельца

**Валидация данных:**
- Проверка корректности даты рождения (не может быть в будущем)
- Валидация веса (должен быть положительным числом)
- Проверка размера загружаемого фото (стандартная валидация Django)
- Обязательное указание основного владельца (main_owner не может быть пустым)
- Проверка наличия хотя бы одного владельца в списке owners
- Проверка, что основной владелец входит в список владельцев

### 2.3 Фильтрация и поиск питомцев

**Текущая реализация:**
- Базовая фильтрация по владельцам (только питомцы текущего пользователя)
- Поиск по имени питомца
- Сортировка по дате создания

**Расширенная фильтрация (PetFilter):**
- **Фильтрация по типу и породе:**
  - `pet_type` - фильтр по типу питомца
  - `pet_type_code` - фильтр по коду типа
  - `breed` - фильтр по породе
  - `breed_code` - фильтр по коду породы

- **Фильтрация по возрасту:**
  - `age_min` - минимальный возраст в годах
  - `age_max` - максимальный возраст в годах
  - `age_range` - диапазон возраста (например, 2-5 лет)

- **Фильтрация по весу:**
  - `weight_min` - минимальный вес в кг
  - `weight_max` - максимальный вес в кг
  - `weight_range` - диапазон веса (например, 5-15 кг)

- **Фильтрация по геолокации:**
  - `location_lat` - широта для поиска
  - `location_lng` - долгота для поиска
  - `radius_km` - радиус поиска в километрах
  - Использует PostGIS для точного расчета расстояний

- **Фильтрация по медицинским условиям:**
  - `has_medical_conditions` - наличие медицинских условий
  - `medical_condition` - поиск по конкретному условию

- **Фильтрация по особым потребностям:**
  - `has_special_needs` - наличие особых потребностей
  - `special_need` - поиск по конкретной потребности

- **Фильтрация по датам:**
  - `created_after/before` - дата создания питомца
  - `updated_after/before` - дата обновления
  - `last_visit_after/before` - дата последнего посещения

- **Фильтрация по владельцам:**
  - `owner` - фильтр по ID владельца
  - `main_owner` - фильтр по основному владельцу

- **Фильтрация по статусу:**
  - `is_active` - активные/неактивные питомцы

**API эндпоинты:**
- `GET /api/pets/?age_min=2&age_max=5&weight_range=5,15` - фильтрация по возрасту и весу
- `GET /api/pets/?location_lat=55.7558&location_lng=37.6176&radius_km=10` - поиск по геолокации
- `GET /api/pets/?has_medical_conditions=true&medical_condition=диабет` - поиск по медицинским условиям

### 2.4 Медицинская карта питомца

**Структура карты:**
- Основная информация о питомце (Pet): имя, тип, порода, дата рождения, вес, описание, особые потребности, медицинские условия, фото
- Медицинские записи (MedicalRecord): заголовок, описание, дата, вложения, дата следующего посещения
- Записи о процедурах (PetRecord): выполненные услуги с привязкой к учреждению, сотруднику, описанием, результатами, рекомендациями, серийным номером
- Файлы с метаданными (PetRecordFile): документы с расширенной информацией:
  - Привязка к питомцу, медицинским записям или записям о процедурах
  - Метаданные: дата выдачи, срок действия, номер документа, орган выдачи
  - Типизация через систему типов документов
  - Валидация обязательных полей согласно типу документа
  - Отслеживание сроков с автоматическим определением истечения
- Типы документов (DocumentType): настройка обязательных полей для разных типов документов

**Доступ к медицинской карте:**
- **Владельцы питомца** (`pet__owners`) имеют полный доступ к медицинской карте (просмотр, создание, редактирование)
- **Временный доступ** предоставляется через модель `PetAccess`:
  - Владелец может дать временный доступ другому пользователю (например, ситтеру во время передержки)
  - Доступ имеет срок действия (`expires_at`)
  - Настраиваемые права доступа (`permissions`): чтение, бронирование, редактирование
- **Сотрудники учреждений** могут создавать записи для питомцев, которым они оказывают услуги
- **Системные администраторы** имеют полный доступ

**Алгоритм ведения карты:**
1. Владелец питомца или специалист учреждения открывает карту питомца
2. Добавляет запись о процедуре с описанием и результатами
3. Прикрепляет документы (файлы) с метаданными
4. Указывает рекомендации и дату следующего посещения
5. Система сохраняет запись с временной меткой

### 2.5 Управление владельцами питомца

**Основной владелец:**
- Создает профиль питомца
- Имеет полные права на управление
- Может приглашать совладельцев через систему инвайтов
- Может передавать права основного владельца
- Получает все уведомления о питомце

**Совладельцы:**
- Приглашаются основным владельцем через систему инвайтов
- Имеют права доступа к информации о питомце
- Могут просматривать медицинскую карту и записи
- Получают уведомления о важных событиях
- НЕ могут изменять основную информацию или удалять питомца

**Алгоритм назначения совладельца:**
1. Основной владелец создает инвайт типа 'invite'
2. Вводит email потенциального совладельца
3. Система отправляет email с токеном для подтверждения
4. Пользователь принимает инвайт через ссылку или QR-код
5. Получает доступ к профилю питомца

**Удаление совладельца:**
1. Основной владелец открывает список совладельцев
2. Выбирает совладельца для удаления
3. Подтверждает действие
4. Совладелец теряет доступ к питомцу
5. Отправляется уведомление об удалении

**Примечание:** Совладелец также может самостоятельно удалить себя из списка владельцев (см. раздел 2.6).

### 2.5.1 Передача питомца другому владельцу

**Алгоритм передачи:**
1. Основной владелец создает инвайт типа 'transfer'
2. Вводит email нового основного владельца
3. Система отправляет email с токеном для подтверждения
4. Новый владелец принимает инвайт
5. Права основного владельца передаются
6. Старый владелец становится совладельцем

### 2.5.2 Система обработки недееспособности владельцев питомцев

**Общее описание:**
Система автоматически отслеживает неактивных **основных владельцев** питомцев и обрабатывает ситуации их недееспособности. При обнаружении проблем система выполняет автоматические действия для обеспечения благополучия питомцев.

**Функциональные требования:**

**Автоматическое обнаружение неактивности основного владельца:**
- Мониторинг последнего входа основного владельца
- Создание записей о недееспособности **основного владельца** при превышении порога неактивности
- Отправка уведомления **основному владельцу** с просьбой подтвердить статус питомца
- Установка дедлайна для подтверждения (настраиваемый параметр, по умолчанию 30 дней)

**Обработка отчетов от владельцев:**
- **Только основной владелец** может сообщить о потере/смерти питомца → **прямое удаление питомца**
- **Только совладельцы** могут сообщить о недееспособности **основного владельца** → отправка уведомления основному владельцу для подтверждения
- Создание записей о недееспособности **основного владельца** с указанием причины

**Система подтверждений и дедлайнов:**
- **При автоматическом обнаружении неактивности:** отправка уведомления основному владельцу о необходимости подтверждения статуса питомца
- **При отчете совладельца о недееспособности:** отправка уведомления основному владельцу для опровержения/подтверждения
- **Только основной владелец** может подтвердить статус питомца:
  - "Питомец в порядке" → закрытие дела о недееспособности **основного владельца**
  - "Питомец потерян/умер" → удаление питомца из системы
- Если основной владелец не подтверждает в течение дедлайна → автоматическое действие

**Автоматические действия по истечении дедлайна:**
- **Если питомец в порядке:** закрытие дела о недееспособности **основного владельца**
- **Если питомец потерян/умер:** автоматическое удаление питомца из системы
- **Если основной владелец недееспособен:** автоматическое назначение совладельца основным владельцем
- **Если нет совладельцев:** автоматическое удаление питомца

**Уведомления:**
- Email-уведомления **основному владельцу** о необходимости подтверждения статуса питомца (только при автоматическом обнаружении или отчете совладельца)
- Уведомления о предупреждении приближающегося дедлайна
- Уведомления о выполненных автоматических действиях
- Уведомления о разрешении ситуации

**Бизнес-правила:**
- **Только основной владелец** может сообщить о потере/смерти питомца → **прямое удаление без подтверждения**
- **Только совладельцы** могут сообщать о недееспособности **основного владельца**
- **Только основной владелец** может подтвердить статус питомца (при автоматическом обнаружении или отчете совладельца)
- Автоматические действия выполняются только после истечения дедлайна
- При назначении нового основного владельца выбирается наиболее подходящий совладелец
- Все действия логируются и отслеживаются

**Интеграция:**
- Периодические задачи Celery для автоматического обнаружения и обработки
- Интеграция с системой уведомлений для отправки email
- Связь с системой блокировок для получения настроек дедлайнов

**Статусы записей о недееспособности основного владельца:**
- `pending_confirmation` - ожидание подтверждения статуса питомца **основным владельцем**
- `confirmed_incapacity` - недееспособность **основного владельца** подтверждена
- `pet_lost` - питомец потерян/умер
- `resolved` - ситуация разрешена
- `auto_deleted` - питомец автоматически удален
- `coowner_assigned` - назначен новый основной владелец

**Типы потоков обработки:**
- `automatic_detection` - автоматическое обнаружение неактивности **основного владельца**
- `coowner_report_pet_lost` - отчет совладельца о потере питомца (**ОШИБКА В КОДЕ**)
- `coowner_report_owner_incapacity` - отчет совладельца о недееспособности **основного владельца**

**Управление совладельцами:**
- Основной владелец может исключить любого совладельца из списка владельцев
- Совладелец может самостоятельно удалить себя из списка владельцев
- При удалении совладельца отправляются уведомления основному владельцу

**Примечание:** В текущей реализации кода есть **критические ошибки**:
1. Любой владелец может сообщить о потере питомца (должен быть только основной владелец)
2. Любой владелец может подтвердить статус питомца (должен быть только основной владелец)

Код требует исправления согласно описанной бизнес-логике.

### 2.6 Самостоятельное снятие обязанностей совладельца

**Алгоритм самостоятельного снятия:**
1. Совладелец открывает профиль питомца
2. Нажимает "Покинуть питомца" или "Удалить себя из совладельцев"
3. Система проверяет, что он не является основным владельцем
4. Если он не основной владелец - совладелец удаляется из списка владельцев
5. Если он основной владелец - система показывает сообщение о необходимости передачи прав
6. Отправляются уведомления основному владельцу и другим совладельцам

**Ограничения самостоятельного снятия:**
- Совладелец может удалить себя только если он не является основным владелецем
- Если совладелец является единственным владельцем, он должен сначала передать права
- При снятии обязанностей отправляются уведомления всем заинтересованным сторонам

**Уведомления:**
- Основной владелец получает уведомление о том, что совладелец покинул питомца
- Другие совладельцы получают уведомление об изменении состава владельцев
- Система ведет историю изменений владельцев для аудита

### 2.7 Удаление питомца

**Алгоритм удаления питомца:**
1. **Только основной владелец (main_owner)** может удалить питомца
2. Основной владелец открывает профиль питомца
3. Нажимает "Удалить питомца"
4. Система запрашивает подтверждение и причину удаления:
   - Смерть питомца
   - Потеря питомца
   - Передача в приют/другому владельцу
   - Другая причина (с описанием)
5. Если питомец имеет нескольких владельцев - система уведомляет всех совладельцев
6. Питомец удаляется из системы с сохранением истории в архиве

**Ограничения:**
- Только основной владелец (main_owner) или системный администратор могут удалить питомца
- Совладельцы НЕ могут удалить питомца
- При попытке удаления совладельцем система возвращает ошибку доступа
- Система требует указания причины удаления
- При удалении отправляются уведомления всем совладельцам

3. Система создает запись `PetOwnerIncapacity` с типом `coowner_report_pet_lost`
4. Отправляются уведомления всем владельцам питомца
5. Устанавливается дедлайн подтверждения (30 дней)
6. Если нет подтверждения в течение дедлайна, питомец автоматически удаляется

#### **ФЛОУ 3: Совладелец сообщает о недееспособности основного владельца**

**Триггер:** Совладелец создает отчет "Основной владелец недееспособен"
**Цель:** Назначить нового основного владельца
**Действие:** Уведомление всех, назначение совладельца основным через месяц

**Алгоритм:**
1. Совладелец использует API эндпоинт `/api/incapacity/report_owner_incapacity/`
2. Указывает ID питомца и причину недееспособности (обязательно)
3. Система создает запись `PetOwnerIncapacity` с типом `coowner_report_owner_incapacity`
4. Отправляются уведомления всем владельцам питомца
5. Устанавливается дедлайн подтверждения (30 дней)
6. Если нет подтверждения в течение дедлайна, система автоматически назначает совладельца основным владельцем

#### **Автоматические действия**

**Настройки автоматических действий (глобальные параметры):**
- `inactive_owner_threshold_days` - порог неактивности владельца (по умолчанию 180 дней)
- `pet_confirmation_deadline_days` - дедлайн подтверждения статуса питомца (по умолчанию 30 дней)
- `auto_delete_unconfirmed_pets` - автоматическое удаление неподтвержденных питомцев (по умолчанию True)
- `auto_assign_coowner_as_main` - автоматическое назначение совладельца основным (по умолчанию True)
- `coowner_assignment_priority` - приоритет назначения совладельца ('oldest', 'newest', 'random')

**Логика автоматических действий:**
1. **Для ФЛОУ 1 и 2** (утрата питомца):
   - Если `auto_delete_unconfirmed_pets = True` → удалить питомца
   - Если `auto_delete_unconfirmed_pets = False` → ничего не делать

2. **Для ФЛОУ 3** (недееспособность владельца):
   - Если `auto_assign_coowner_as_main = True` → назначить совладельца основным владельцем
   - Приоритет назначения определяется параметром `coowner_assignment_priority`

#### **API эндпоинты**

**Основные эндпоинты:**
- `GET /api/incapacity/` - список случаев недееспособности
- `POST /api/incapacity/report_pet_lost/` - сообщить о потере питомца
- `POST /api/incapacity/report_owner_incapacity/` - сообщить о недееспособности владельца
- `POST /api/incapacity/{id}/confirm_pet_status/` - подтвердить статус питомца
- `GET /api/incapacity/my_cases/` - мои случаи недееспособности
- `GET /api/incapacity/{id}/notifications/` - уведомления по случаю

**Эндпоинты уведомлений:**
- `GET /api/incapacity-notifications/` - список уведомлений пользователя
- `POST /api/incapacity-notifications/{id}/mark_as_read/` - отметить как прочитанное

#### **Периодические задачи**

**Автоматические задачи (Celery):**
- `check_inactive_owners_task` - еженедельная проверка неактивных владельцев
- `process_deadline_actions_task` - ежедневная обработка действий по истечении дедлайнов
- `send_incapacity_notifications_task` - отправка уведомлений
- `cleanup_old_incapacity_records_task` - очистка старых записей (ежемесячно)

#### **Модели данных**

**PetOwnerIncapacity:**
- Связь с питомцем и основным владельцем
- Тип флоу (автоматическое обнаружение, отчет о потере, отчет о недееспособности)
- Статус (ожидание подтверждения, подтверждено, разрешено, автоматически удалено, назначен совладелец)
- Дедлайн подтверждения
- Автоматическое действие и новый основной владелец
- История уведомлений

**PetIncapacityNotification:**
- Связь с записью о недееспособности
- Тип уведомления (запрос подтверждения, предупреждение о дедлайне, уведомление о действии)
- Получатель и статус отправки
- Содержание уведомления

#### **Уведомления**

**Типы уведомлений:**
- `confirmation_request` - запрос подтверждения статуса питомца
- `deadline_warning` - предупреждение о приближении дедлайна
- `auto_action_notification` - уведомление о выполненных автоматических действиях
- `resolution_notification` - уведомление о разрешении случая

**Каналы доставки:**
- Email уведомления через Gmail API
- Push-уведомления (планируется)
- Внутренние уведомления в системе

#### **Безопасность и права доступа**

**Проверки прав доступа:**
- Только владельцы питомца могут подтверждать его статус
- Только совладельцы могут сообщать о недееспособности основного владельца
- Любой владелец может сообщить о потере питомца
- Администраторы видят все случаи недееспособности

**Защита от злоупотреблений:**
- Проверка на существование активных случаев недееспособности
- Валидация входных данных
- Логирование всех действий
- Транзакционная обработка критических операций

### 2.8 Система документов питомцев

**DocumentType (Типы документов):**
- `name` - название типа документа
- `code` - уникальный технический код
- `description` - описание типа документа
- `service_categories` - связь с категориями услуг
- `requires_issue_date` - требование даты выдачи
- `requires_expiry_date` - требование даты истечения
- `requires_issuing_authority` - требование органа выдачи
- `is_required` - обязательность документа
- `is_active` - активность типа документа

**Функциональность:**
- **Автоматические требования** - система автоматически определяет, какие документы нужны для конкретных услуг
- **Валидация документов** - проверка корректности заполнения полей
- **Уведомления об истечении** - автоматические напоминания о скором истечении документов
- **Интеграция с услугами** - связь типов документов с категориями услуг

**API эндпоинты:**
- `GET/POST/PUT/DELETE /api/document-types/` - CRUD типов документов
- `GET /api/document-types/required-for-service/<service_id>/` - документы для услуги
- `GET /api/pets/<pet_id>/documents/` - документы питомца

## 3. Система передержки питомцев

### 3.1 Поиск ситтеров

**Алгоритм поиска:**
1. Владелец указывает параметры поиска:
   - Координаты или местоположение (геолокация устройства)
   - Радиус поиска в км
   - Тип питомца
   - Даты передержки
   - Тип компенсации (платная/бесплатная)
   - Минимальный рейтинг ситтера
   - Максимальная цена (для платных услуг)
2. Система фильтрует ситтеров по критериям:
   - Расстояние от указанной точки
   - Типы питомцев, с которыми работает ситтер
   - Доступность в указанные даты
   - Тип компенсации
   - Рейтинг ситтера
   - Цена услуг
3. Возвращает отсортированный список подходящих ситтеров

**Фильтры поиска:**
- По расстоянию от указанной точки
- По типам питомцев
- По датам доступности ситтера
- По типу компенсации (платная/бесплатная)
- По рейтингу ситтера
- По цене услуг
- По расписанию работы ситтера

**Результат поиска:**
- Список ситтеров с информацией о расстоянии, рейтинге, услугах
- Возможность просмотра профиля ситтера
- Возможность создания объявления о передержке для выбранного ситтера

### 3.2 Создание объявления о передержке

**Алгоритм создания объявления:**
1. Владелец питомца создает объявление (PetSittingAd) после поиска ситтеров
2. Указывает питомца, даты передержки, описание
3. Выбирает тип компенсации (платная/бесплатная)
4. Указывает максимальное расстояние для поиска ситтеров
5. Система публикует объявление и уведомляет подходящих ситтеров

**Объявление о передержке (PetSittingAd):**
- Связь с питомцем и владельцем
- Даты начала и окончания передержки
- Описание требований (опционально)
- Статус объявления ('active' / 'closed')
- Структурированный адрес (связь с моделью Address)
- Максимальное расстояние для поиска ситтеров
- Тип компенсации ('paid' / 'unpaid')

### 3.3 Отклики ситтеров

**Алгоритм отклика:**
1. Ситтер просматривает доступные объявления
2. Откликается на подходящее объявление (PetSittingResponse)
3. Добавляет сообщение владельцу (опционально)
4. Система уведомляет владельца о новом отклике
5. Владелец принимает или отклоняет отклик

**Отклик ситтера (PetSittingResponse):**
- Связь с объявлением и ситтером
- Сообщение владельцу (опционально) - текстовое поле для краткого сообщения
- Статус отклика ('pending' / 'accepted' / 'rejected')

**Примечание:** Система диалогов между владельцами и ситтерами реализована и доступна для использования (см. раздел 3.7).

### 3.6 Управление процессом передержки

**Алгоритм управления:**
1. После принятия отклика создается запись PetSitting
2. Система отслеживает статусы подтверждения передачи и возврата
3. По завершении передержки владелец может оставить отзыв
4. Система обновляет рейтинг ситтера

**Статусы передержки:**
- 'waiting_start' - ожидание начала
- 'active' - передержка активна
- 'waiting_end' - ожидание завершения
- 'completed' - завершена
- 'cancelled' - отменена

**Подтверждения:**
- owner_confirmed_start - владелец подтвердил передачу
- sitter_confirmed_start - ситтер подтвердил получение
- owner_confirmed_end - владелец подтвердил возврат
- sitter_confirmed_end - ситтер подтвердил возврат

**Отмена передержки:**
- Передержку может отменить как владелец питомца, так и ситтер, если процесс ещё не завершён или не отменён ранее.
- После отмены обе стороны получают уведомления.

### 3.7 Система диалогов между участниками

**Назначение:** Обеспечивает полноценную коммуникацию между владельцами питомцев и ситтерами для координации процесса передержки.

**Алгоритм работы:**
1. Диалог создается автоматически при первом отклике ситтера на объявление
2. Участники могут обмениваться сообщениями через REST API
3. Система уведомляет о новых сообщениях
4. Сообщения автоматически шифруются при сохранении в базе данных
5. Пользователи могут отмечать сообщения как прочитанные

**Модели данных:**

**Диалог (Conversation):**
- Связь с объявлением о передержке (PetSittingRequest)
- Связь с активной передержкой (PetSitting, опционально)
- Автоматическое создание при первом отклике
- Методы для получения другого участника диалога

**Сообщение (Message):**
- Связь с диалогом (Conversation)
- Отправитель (sender) - пользователь, отправивший сообщение
- Получатель (recipient) - пользователь, которому адресовано сообщение
- Зашифрованный текст сообщения (text)
- Временная метка создания (created_at)
- Статус прочтения (is_read)
- Автоматическое шифрование при сохранении
- Метод для получения расшифрованного текста (decrypted_text)

**API эндпоинты:**
- `GET /api/conversations/` - список диалогов пользователя
- `GET /api/conversations/{id}/` - детали диалога с сообщениями
- `POST /api/conversations/{id}/send_message/` - отправка сообщения
- `POST /api/conversations/{id}/mark_as_read/` - отметка сообщений как прочитанные
- `POST /api/conversations/create/` - создание нового диалога

**Безопасность:**
- Шифрование сообщений с использованием AES-256-GCM
- Ключ шифрования генерируется из SECRET_KEY Django
- Автоматическое шифрование при сохранении и расшифровка при чтении
- Защита от несанкционированного доступа к содержимому сообщений

**Уведомления:**
- Автоматические уведомления о новых сообщениях
- Интеграция с существующей системой уведомлений
- Отображение количества непрочитанных сообщений в списке диалогов

### 3.5 Система отзывов

**Алгоритм отзыва:**
1. После завершения передержки система предлагает владельцу оставить отзыв (опционально)
2. **Только владелец питомца** может оставить отзыв о ситтере
3. **Ситтер НЕ может оценить себя сам** - система предотвращает самооценку
4. Владелец оценивает ситтера (1-5 звезд, опционально)
5. Добавляет текстовый отзыв (опционально)
6. Система обновляет рейтинг ситтера только при наличии оценки

**Отзыв (Review):**
- Связь с записью о передержке и автором отзыва (только владелец)
- Рейтинг (1-5 звезд, опционально)
- Текстовый отзыв (опционально)
- Защита от самооценки ситтера

## 4. ГЛОБАЛЬНАЯ НАСТРОЙКА И СПРАВОЧНИКИ

### 4.1 Глобальный справочник услуг

**Структура:**
- Единая модель Service для категорий и услуг
- Иерархия: категории → подкатегории → услуги (через parent)
- Базовые поля: название, описание, код, иконка, периодичность, обязательность, напоминания
- **Связь с типами животных**: поле `allowed_pet_types` для ограничения доступности услуг

**Связь услуг с типами животных:**
- **Назначение**: Ограничение доступности услуг для определенных типов животных
- **Примеры использования**:
  - Прививка от бешенства: доступна только для собак и кошек, недоступна для змей
  - Стрижка когтей: доступна для собак, кошек, птиц, но не для рыб
  - Ультразвуковая чистка зубов: только для собак и кошек
- **Логика работы**:
  - Если `allowed_pet_types` пустое → услуга доступна для всех типов животных
  - Если указаны типы → услуга доступна только для указанных типов
  - При создании записи о процедуре система проверяет совместимость

**Валидация совместимости:**
- При создании записи о процедуре (PetRecord) система автоматически проверяет совместимость услуги с типом животного
- Если услуга не совместима с типом животного → ошибка валидации
- API предоставляет методы для проверки совместимости перед созданием записи

**Использование:**
- Категории и услуги создаются и редактируются администратором
- Учреждения используют эти категории для создания собственных услуг
- Система автоматически фильтрует доступные услуги по типу животного

**API для работы с совместимостью:**
- `GET /api/services/for_pet_type/?pet_type_id=<id>` - получить услуги для конкретного типа животного
- `POST /api/services/check_compatibility/` - проверить совместимость услуги с типом животного
- `GET /api/services/<id>/` - получить услугу с информацией о доступных типах животных

**Примечание:**
- Связь с типами животных обеспечивает корректность медицинских процедур и ухода
- Периодичность услуг применяется одинаково для всех совместимых типов животных
- Система предотвращает назначение неподходящих процедур (например, прививки змеям)

### 4.2 Справочник пород животных

**Структура справочника:**
- **Типы животных** - собаки, кошки, птицы, грызуны и т.д.
- **Породы** - конкретные породы в рамках типа
- **Базовые поля** - название, код, описание породы

**Алгоритм управления:**
1. Системный администратор добавляет новый тип животного
2. Создает породы для данного типа
3. Указывает название, код и описание породы
4. Справочник используется при создании профилей питомцев

### 4.3 Справочник документов

**Структура справочника:**
- **Типы документов** - паспорт, ветеринарная книжка, родословная и т.д.
- **Настройка обязательных полей** - для каждого типа документа можно указать, какие поля обязательны
- **Связь с категориями услуг** - типы документов могут быть связаны с определенными услугами

**Алгоритм управления:**
1. Системный администратор создает тип документа
2. Настраивает, какие поля обязательны для данного типа (дата выдачи, дата истечения, орган выдачи, номер документа)
3. Связывает тип документа с категориями услуг (опционально)
4. Справочник используется при загрузке документов питомцев

### 4.4 Глобальные настройки системы

**Настройки геолокации:**
- Длительность кэша геокодирования (30 дней)
- Таймаут API запросов (10 секунд)
- Максимальное количество попыток API (3)
- Задержка между попытками (1 секунда)
- Минимальный уровень уверенности геокодирования (0.8)
- Язык по умолчанию для API (en)
- Включение/выключение кэширования
- Период очистки истекшего кэша (7 дней)

**Настройки уведомлений:**
- **Шаблоны email-сообщений** - создание и редактирование текста уведомлений (HTML и текстовые версии)
- **Настройки push-уведомлений** - типы уведомлений, обязательные/необязательные, включение/выключение
- **Время отправки напоминаний** - мгновенно, за 30 мин, за 1 час, за 2 часа, за 6 часов, за 12 часов, за 24 часа
- **Частота уведомлений** - ежедневно, еженедельно, ежемесячно, ежегодно, произвольный интервал
- **Каналы доставки** - email, push, in-app уведомления
- **Настройки пользователей** - предпочтения по типам уведомлений и каналам

**Примечание:** Связь конкретных событий (создание бронирования, отмена, изменение цены и т.д.) с уведомлениями жестко прописана в коде через Django сигналы. Администратор настраивает только содержание, время и каналы доставки уведомлений.

**Примечание 2:** Планируется реализация гибкой системы связей событий с шаблонами уведомлений через админский интерфейс, что позволит администраторам создавать новые правила уведомлений без изменения кода.

**Гибкая система правил уведомлений:**
- **Модель правил** - создание и управление правилами связей событий с уведомлениями
- **Условия срабатывания** - настройка условий для отправки уведомлений (VIP-клиенты, суммы, время)
- **Приоритеты правил** - система приоритизации (critical, high, medium, low)
- **Наследование правил** - глобальные → пользовательские настройки
- **Валидация условий** - проверка корректности правил при создании
- **Тестирование правил** - возможность протестировать правило на тестовых данных
- **Статистика срабатываний** - мониторинг использования правил
- **API управления** - программное управление правилами через API

**Настройки безопасности:**
- Политика паролей
- Настройки сессий
- Ограничения на вход
- Настройки аудита
**ГЭП**

**Настройки бизнес-логики:**

**Время отмены бронирования**: Настраиваемые параметры для определения допустимого времени отмены бронирования без штрафных санкций. Система учитывает различные типы услуг и учреждений, позволяя администратору устанавливать гибкие правила отмены в зависимости от специфики услуг.

**Автоматическое завершение:**
1. Система раз в час (или с другой заданной периодичностью) проверяет все бронирования, которые начались более N дней назад (обычно 1 день = 24 часа), но не были завершены вручную.
2. Такие бронирования автоматически переводятся в статус "завершено".
3. Клиенту отправляется уведомление о завершении.
4. Все отчёты, аналитика, рейтинги и дашборды автоматически учитывают автозавершённые записи (например, количество завершённых бронирований, процент успешных записей, выручка, активность пользователей и т.д.).

**Настройки рейтингов**: Параметры для расчета рейтингов учреждений и сотрудников, включая весовые коэффициенты для отзывов, жалоб и отмен. Система поддерживает модерацию отзывов, обнаружение подозрительной активности и автоматическую фильтрацию недобросовестных оценок.

**Параметры блокировки учреждений**: Шаблоны и настройки для автоматической блокировки учреждений при нарушении правил. Включает различные типы нарушений, сроки блокировки, условия восстановления и систему уведомлений о нарушениях с возможностью обжалования.

## 5. УПРАВЛЕНИЕ УЧРЕЖДЕНИЯМИ

### 5.1 Регистрация учреждения

**Алгоритм регистрации:**
1. Администратор учреждения заполняет заявку
2. Указывает: название, адрес, контакты, специализации
3. Загружает документы (лицензии, сертификаты) в случае, если учреждение предоставляет услуги, которые требуют лицензирования / сертификации
4. Система проверяет корректность данных
5. После модерации учреждение активируется

**Валидация данных:**
- Проверка уникальности названия и адреса
- Валидация контактных данных
- Проверка необходимости документов на основе выбранных специализаций
- Проверка формата загруженных документов (если требуются)
- Геокодирование адреса

### 5.2 Управление услугами учреждения

**Алгоритм добавления услуги:**
1. Администратор выбирает услугу из глобального справочника
2. Указывает стоимость услуги для своего учреждения
3. Назначает специалистов, которые оказывают услугу
4. Устанавливает длительность процедуры
5. Система проверяет уникальность услуги для учреждения
6. Услуга становится доступной для бронирования

### 5.3 Управление персоналом учреждения

**Алгоритм добавления сотрудника:**
1. Администратор приглашает специалиста по email
2. Специалист регистрируется в системе (если еще не зарегистрирован)
3. Администратор подтверждает и назначает услуги сотруднику

**Расписание специалистов:**
- Установка рабочих часов
- Указание перерывов
- Назначение дней отпуска
- Учет больничных

#### 5.3.1 Шаблоны расписаний сотрудников

**Общее описание:**
Система шаблонов расписаний позволяет создавать типовые расписания для сотрудников учреждений, которые можно быстро применять к новым или существующим сотрудникам. Это упрощает процесс настройки рабочих графиков и обеспечивает единообразие расписаний в рамках учреждения.

**Функциональные требования:**

**Создание шаблонов расписаний:**
- Создание шаблона с названием и описанием для конкретного учреждения
- Настройка рабочих часов для каждого дня недели (понедельник-воскресенье)
- Указание времени начала и окончания работы для каждого дня
- Возможность отметить день как выходной
- Сохранение шаблона с привязкой к учреждению

**Структура шаблона:**
- **SchedulePattern** - основной шаблон с названием, описанием и привязкой к учреждению
- **PatternDay** - дни недели в шаблоне с рабочими часами
- Уникальная связь между шаблоном и днем недели
- Поддержка всех 7 дней недели (0=понедельник, 6=воскресенье)

**Применение шаблонов:**
- API эндпоинт для применения шаблона к сотруднику
- Автоматическое создание записей `Schedule` на основе шаблона
- Возможность применения к одному или нескольким сотрудникам
- Перезапись существующих расписаний при применении

**Управление шаблонами:**
- Просмотр списка шаблонов учреждения
- Редактирование существующих шаблонов
- Удаление неиспользуемых шаблонов
- Копирование шаблонов для создания новых

**Бизнес-правила:**
- Шаблоны привязаны к конкретному учреждению
- Только администратор учреждения может создавать/редактировать шаблоны
- При применении шаблона существующие расписания сотрудника перезаписываются
- Валидация времени работы (начало < окончание)
- Поддержка выходных дней (без указания времени работы)

**Интеграция:**
- Связь с моделью `Schedule` для создания индивидуальных расписаний
- API для применения шаблонов (`SchedulePatternApplyAPIView`)
- Административный интерфейс для управления шаблонами
- Автоматическое создание записей расписаний при применении

**Технические особенности:**
- Модели `SchedulePattern` и `PatternDay` в `providers/models.py`
- Уникальные ограничения для предотвращения дублирования
- Автоматическое отслеживание времени создания и обновления
- Индексы для оптимизации запросов

**API эндпоинты:**
- `GET /api/schedule-patterns/` - список шаблонов учреждения
- `POST /api/schedule-patterns/` - создание нового шаблона
- `PUT /api/schedule-patterns/{id}/` - редактирование шаблона
- `DELETE /api/schedule-patterns/{id}/` - удаление шаблона
- `POST /api/schedule-patterns/{id}/apply/` - применение шаблона к сотруднику

**Управление доступом:**
1. Назначение ролей сотрудникам
2. Ограничение доступа к функциям
3. Блокировка/разблокировка аккаунтов

## 6. ГЕОЛОКАЦИЯ И ПОИСК УСЛУГ

### 6.1 Система геолокации

#### 6.1.1 Структурированные адреса

**Общее описание:**
Система должна поддерживать структурированное хранение и валидацию адресов для всех сущностей (пользователи, учреждения, питомцы). Адреса должны быть разбиты на отдельные компоненты для обеспечения точности геолокации и упрощения поиска.

**Компоненты адреса:**
- **Страна** - обязательное поле, код страны по ISO 3166-1 alpha-2
- **Регион/Область** - административная единица первого уровня
- **Город** - обязательное поле, название населенного пункта
- **Район** - административная единица города (опционально)
- **Улица** - название улицы, проспекта, переулка
- **Номер дома** - номер здания
- **Номер квартиры/офиса** - номер помещения (опционально)
- **Почтовый индекс** - код для почтовой доставки
- **Координаты** - географические координаты (широта, долгота)

**Функциональные требования:**
- **Валидация адресов** - проверка корректности введенных данных
- **Геокодирование** - автоматическое определение координат по адресу
- **Обратное геокодирование** - получение адреса по координатам
- **Кэширование** - сохранение результатов геокодирования для оптимизации
- **История изменений** - отслеживание изменений адресов пользователей
- **Поиск по радиусу** - поиск объектов в заданном радиусе от точки

**Интеграция:**
- Интеграция с внешними сервисами геокодирования (Google Maps API, Yandex Maps API)
- Поддержка различных форматов адресов для разных стран
- Автоматическое обновление координат при изменении адреса

**Бизнес-правила:**
- **Множественные пользователи по одному адресу** - несколько владельцев питомцев могут проживать по одному адресу (с точностью до номера помещения)
- **Смешанное использование адресов** - по одному адресу могут находиться как владельцы питомцев, так и поставщики услуг
- **Уникальность на уровне помещения** - адрес с номером квартиры/офиса может быть уникальным, но без номера помещения - общим для нескольких пользователей
- При изменении адреса должны обновляться все связанные записи
- Координаты должны быть обязательными для учреждений
- Поддержка множественных адресов для одного пользователя (основной и дополнительные)

#### 6.1.2 Алгоритм определения местоположения

**Алгоритм определения местоположения:**
1. **Приоритет 1: Геолокация устройства**
   - Пользователь разрешает доступ к геолокации
   - Система получает координаты (широта, долгота) с точностью до 50 метров
   - Координаты сохраняются в профиле пользователя
   - При поиске услуг используется текущее местоположение

2. **Приоритет 2: Выбор района на карте**
   - Если геолокация недоступна или пользователь отказал в доступе
   - Пользователь может выбрать район поиска на интерактивной карте
   - Система получает координаты выбранной точки
   - Координаты сохраняются в профиле пользователя

3. **Приоритет 3: Ручной ввод адреса**
   - Если карта недоступна, пользователь может ввести адрес вручную
   - Система геокодирует адрес через Google Maps API
   - Полученные координаты сохраняются в профиле пользователя

**Кэширование геоданных:**
1. Адреса учреждений геокодируются при добавлении
2. Координаты сохраняются в базе данных
3. Создаются индексы по полям latitude/longitude для быстрого поиска (пространственные индексы PostGIS/GiST не используются, требуется доработка для масштабирования)
4. Кэш обновляется при изменении адреса

#### 6.1.3 Модели данных геолокации

**Address (Структурированные адреса):**
- `country` - страна (код ISO 3166-1 alpha-2)
- `region` - регион/область
- `city` - город (обязательное поле)
- `district` - район города
- `street` - улица
- `house_number` - номер дома
- `building` - корпус/строение
- `apartment` - номер квартиры/офиса
- `postal_code` - почтовый индекс
- `formatted_address` - форматированный адрес
- `point` - географические координаты (PostGIS PointField)
- `validation_status` - статус валидации (pending/valid/invalid/error)
- `is_valid` - флаг валидности адреса
- `is_geocoded` - флаг наличия координат
- `geocoding_accuracy` - точность геокодирования
- `created_at`, `updated_at`, `validated_at` - временные метки

**AddressValidation (Валидация адресов):**
- `address` - связь с моделью Address
- `is_valid` - результат валидации
- `confidence_score` - оценка достоверности (0.00-1.00)
- `validation_errors` - список ошибок валидации (JSON)
- `suggestions` - предложения по исправлению (JSON)
- `api_provider` - провайдер API (google_maps, yandex_maps)
- `api_response` - сырой ответ API (JSON)
- `processing_time` - время обработки запроса
- `created_at` - дата создания

**AddressCache (Кэширование геоданных):**
- `cache_key` - ключ кэша (хеш адреса)
- `address_data` - кэшированные данные адреса (JSON)
- `api_provider` - провайдер API
- `created_at` - дата создания
- `expires_at` - дата истечения кэша
- `hit_count` - количество использований кэша

**LocationHistory (История местоположений):**
- `user` - пользователь
- `point` - координаты (PostGIS PointField)
- `address` - адрес
- `city`, `country`, `postal_code` - компоненты адреса
- `created_at` - дата создания записи

**SearchRadius (Радиусы поиска):**
- `user` - пользователь
- `name` - название радиуса
- `radius` - радиус в метрах
- `is_active` - активность настройки

**UserLocation (Локации пользователей):**
- `user` - пользователь (OneToOne связь)
- `point` - координаты (PostGIS PointField)
- `accuracy` - точность в метрах
- `source` - источник данных (device/map/manual)
- `last_updated` - дата последнего обновления

**Функциональность моделей:**
- **Автоматическое геокодирование** при создании адреса
- **Валидация через внешние API** с кэшированием результатов
- **Пространственные индексы** для быстрого поиска по координатам
- **История изменений** местоположений пользователей
- **Настраиваемые радиусы** поиска для каждого пользователя
- **Множественные источники** данных о местоположении

**API эндпоинты:**
- `GET/POST/PUT/PATCH/DELETE /addresses/` - CRUD адресов
- `GET/POST/PUT/PATCH/DELETE /validations/` - CRUD валидаций
- `GET/POST/PUT/PATCH/DELETE /cache/` - CRUD кэша
- `GET /autocomplete/` - автодополнение адресов
- `GET /geocode/` - геокодирование
- `GET /reverse-geocode/` - обратное геокодирование
- `POST /validate-bulk/` - массовая валидация
- `GET /user-location/` - местоположение пользователя
- `POST /device-location/` - сохранение местоположения устройства
- `POST /map-location/` - сохранение местоположения с карты

### 6.2 Поиск услуг

**Алгоритм поиска:**
1. Пользователь выбирает категорию услуги
2. **Система автоматически фильтрует услуги по типу животного** (если пользователь выбрал питомца)
3. Пользователь выбирает конкретную услугу из доступных для типа животного
4. Дата и время оказания услуги могут быть выбраны, но не являются обязательными для заполнения.
- Если не указано время — система отображает первое доступное время записи в выбранный день.
- Если не указана дата — система отображает первое доступное окно вообще.
- Если указаны дата и/или время как ограничения снизу, для всех учреждений выводятся первые свободные окна начиная с указанного времени.
2. Система определяет текущее местоположение
3. Выполняется поиск учреждений в радиусе 10 км (по умолчанию)
4. Применяются фильтры: рейтинг, цена, доступность
5. Результаты сортируются по релевантности

**Фильтрация результатов:**
- По радиусу (географическому расстоянию)
- По специализации
- По доступности записи
- По цене (диапазон)
- По рейтингу (минимальный рейтинг)

**Сортировка результатов:**
- По расстоянию (ближайшие первыми)
- По рейтингу учреждения
- По цене услуги
- По доступности услуги

**Фильтрация по питомцам (ГЭП):**
- По типу питомца (кошки, собаки, птицы и т.д.)
- По породе питомца
- По возрасту/периоду жизни питомца
- По медицинским условиям питомца
- По особым потребностям питомца
- По весу питомца (для услуг, где это важно)

**Планируемые улучшения поиска:**
- Интеграция с профилями питомцев пользователя
- Персонализированные рекомендации на основе истории питомца
- Фильтрация по совместимости услуг с конкретным питомцем
- Учет медицинских противопоказаний
- Рекомендации по периодическим процедурам

### 6.3 Отображение на карте

**Алгоритм отображения:**
1. Загружается карта с центром в местоположении пользователя
2. Отображаются маркеры учреждений и ситтеров в радиусе поиска
3. При клике на маркер показывается информация об учреждении или ситтере
4. Отображается расстояние и время в пути
5. Показывается доступность записи/услуг (для выбранной услуги и времени, либо ближайшее доступное окно)
- Если не указано время — система отображает первое доступное время записи в выбранный день.
- Если не указана дата — система отображает первое доступное окно вообще.
- Если указаны дата и/или время как ограничения снизу, для всех учреждений выводятся первые свободные окна начиная с указанного времени.

**Что отображается на карте:**
- **Учреждения (Provider)** - ветеринарные клиники, зоомагазины, груминг-салоны
- **Ситтеры (Sitter)** - частные передержчики питомцев
- **Информация о маркерах:**
  - Название учреждения/ситтера
  - Адрес и контакты
  - Рейтинг и отзывы
  - Доступные услуги
  - Расстояние от пользователя
  - Статус доступности (для выбранной услуги и времени, либо ближайшее доступное окно)
  - Если не указано время — система отображает первое доступное время записи в выбранный день.
- Если не указана дата — система отображает первое доступное окно вообще.
- Если указаны дата и/или время как ограничения снизу, для всех учреждений выводятся первые свободные окна начиная с указанного времени.

**Фильтрация на карте:**
- По типу (только учреждения, только ситтеры, все)
- По услугам (конкретные услуги)
- По дате и/или времени оказания услуги
- По рейтингу (минимальный рейтинг)
- По расстоянию (радиус поиска)
- По цене (максимальная цена для ситтеров)

## 7. СИСТЕМА БРОНИРОВАНИЯ

### 7.1 Алгоритм бронирования (целевой)

1. Пользователь выбирает услугу и (опционально) дату/время.
2. Система отображает на карте учреждения в радиусе поиска с ближайшими свободными окнами для выбранной услуги, начиная с указанной даты/времени (если не указано — с 00:00:01 сегодняшнего дня), с ценами.
3. Пользователь фильтрует учреждения по нужным параметрам и выбирает подходящее.
4. При клике на учреждение система показывает ближайшие свободные окна на заданный горизонт (например, 7/14/30 дней) от выбранной даты/времени.
5. Пользователь выбирает окно и инициирует бронирование.
6. Система пытается провести бронирование атомарно. Если окно уже занято — сообщает об ошибке, убирает окно из доступных и предлагает выбрать другое.
7. Процесс повторяется до успешного бронирования или отказа пользователя.
8. Система реализует защиту от злоупотреблений (лимиты, антибот, rate limit и т.д.).

Логика расчёта свободных окон:
1. Система строит расписание на основе рабочих часов учреждения и специалистов.
2. Учитываются уже занятые слоты (существующие записи).
3. Учитывается время на выполнение услуги (длительность процедуры).
4. Учитываются перерывы, выходные, отпуска, больничные.
5. Для каждой услуги и специалиста на лету формируются возможные интервалы для записи ("окна").
6. При поиске система возвращает только те окна, которые не пересекаются с уже существующими записями и соответствуют длительности услуги.

### 7.2 Управление записями

**Алгоритм отмены записи:**
1. Пользователь может отменить только своё бронирование до его начала.
2. Учреждение (админ/сотрудник) может отменить только свои бронирования до их начала.
3. При больничном сотрудника система пытается автоматически перепланировать бронирования на других сотрудников. Если это невозможно — бронирование остаётся без исполнителя, система информирует администратора, и администратор принимает решение о дальнейших действиях (отмена/перенос вручную).
4. Автоматической отмены бронирований при закрытии учреждения или больничном нет.

**Автоматическое завершение бронирований:**
1. **Периодическая проверка** - система автоматически проверяет все активные бронирования с заданной периодичностью (по умолчанию раз в час)
2. **Критерии автозавершения** - бронирования, которые начались более N дней назад (настраиваемый параметр, по умолчанию 1 день = 24 часа), но не были завершены вручную
3. **Автоматическое действие** - такие бронирования переводятся в статус "завершено" без вмешательства пользователей
4. **Уведомления** - клиенту и учреждению отправляются уведомления о автоматическом завершении

**Настройки системы:**
- **Периодичность проверки** - настраиваемый интервал (по умолчанию 1 час)
- **Порог автозавершения** - количество дней после начала бронирования (настраиваемый параметр)
- **Включение/отключение** - возможность отключить автоматическое завершение для отдельных учреждений или глобально
- **Уведомления** - настройка отправки уведомлений о автозавершении

**Бизнес-правила:**
- Применяется только к бронированиям со статусом "активно" или "ожидает завершения"
- Бронирования, которые были отменены или уже завершены вручную, не затрагиваются
- При автозавершении система логирует действие с указанием причины
- Все связанные данные (платежи, комиссии, рейтинги) обрабатываются как при обычном завершении

**Интеграция:**
- Периодические задачи Celery для автоматической проверки
- Интеграция с системой уведомлений
- Логирование всех операций автозавершения для аудита

### 5.5 Заметки к бронированиям

**Модель BookingNote:**
- `booking` - связь с бронированием
- `text` - текст заметки
- `created_by` - пользователь, создавший заметку
- `created_at` - дата создания

**Функциональность:**
- Добавление заметок к бронированиям администраторами и сотрудниками учреждений
- Просмотр истории заметок по бронированию
- Заметки не видны клиентам (внутренняя информация)

**Админский интерфейс:**
- Создание и редактирование заметок
- Просмотр всех заметок по бронированию
- Фильтрация по дате создания и автору

## 8. СИСТЕМА РЕЙТИНГОВ И ОТЗЫВОВ

### 8.1 Оценка услуг

**Алгоритм оценки:**
1. После завершения записи система предлагает (но не требует) оценить услугу.
2. Пользователь может поставить оценку от 1 до 5 звёзд и/или оставить текстовый отзыв (оба действия опциональны, но если создаётся отзыв — рейтинг обязателен).
3. Система рассчитывает средний рейтинг учреждения по всем оставленным оценкам.
4. Отзыв публикуется после модерации.

**Расчет рейтинга:**
- Итоговый рейтинг рассчитывается по формуле:
  rating = reviews_score * reviews_weight + complaints_score * complaints_weight + cancellations_score * cancellations_weight + no_show_score * no_show_weight
- Веса по умолчанию: reviews_weight = 0.6, complaints_weight = 0.25, cancellations_weight = 0.1, no_show_weight = 0.05. Веса можно изменить через админку для каждого учреждения/специалиста.
- Новые отзывы должны иметь больший вес за счёт экспоненциального затухания (чем старше отзыв, тем меньше его влияние на рейтинг). В текущей реализации это не реализовано, все отзывы учитываются одинаково.

### 8.2 Модерация отзывов

**Алгоритм модерации:**
1. Пользователь отправляет отзыв.
2. Система отправляет текст отзыва в Google Perspective API.
3. API возвращает оценки по категориям (токсичность, оскорбления, угроза, спам и др.).
4. Если все оценки ниже установленных порогов — отзыв публикуется автоматически.
5. Если хотя бы по одной категории превышен порог — отзыв отправляется на ручную модерацию или отклоняется автоматически (в зависимости от политики).
6. Пользователь получает уведомление о результате модерации.

**Пороговые значения для категорий** (например, TOXICITY > 0.8, INSULT > 0.7, THREAT > 0.7, SPAM > 0.7) настраиваются в административной панели.

**Ручные фильтры, списки запрещённых слов и локальные проверки не используются.**

**Преимущества:**
- Высокая точность и актуальность фильтрации
- Нет необходимости поддерживать собственные списки слов
- Простота масштабирования

**Опционально:**
- Для спорных случаев (оценки близки к порогам) — ручная модерация администратором.

## 9. СИСТЕМА УВЕДОМЛЕНИЙ

### 9.1 Email-уведомления

**Типы уведомлений:**
- Подтверждение регистрации
- Напоминания о записях
- Уведомления об отменах
- Новые отзывы
- Изменения в расписании

**Алгоритм отправки:**
1. Система определяет событие для уведомления
2. Выбирает шаблон письма
3. Заполняет персональные данные
4. Отправляет email через Gmail API с OAuth2 аутентификацией
5. При недоступности Gmail API автоматически переключается на SMTP
6. Логирует результат отправки

**Технические особенности:**
- **Основной канал:** Gmail API с OAuth2 токенами
- **Резервный канал:** SMTP fallback при ошибках Gmail API
- **Автоматическое управление токенами:** обновление истекших токенов
- **Поддержка форматов:** HTML и текстовые письма
- **Вложения:** поддержка файловых вложений
- **Надежность:** гарантированная доставка через fallback механизм

**Настройки системы:**
- Включение/выключение Gmail API
- Настройки SMTP fallback
- Пути к файлам токенов и учетных данных
- Области доступа OAuth2

### 9.2 Push-уведомления

**Алгоритм push-уведомлений:**
1. Пользователь разрешает push-уведомления в браузере или мобильном приложении (Android/iOS)
2. Система сохраняет токен устройства (Web Push, FCM для Android, APNS для iOS)
3. При наступлении события формируется уведомление
4. Система определяет тип устройства пользователя:
    - для браузера — отправляет через Web Push API
    - для Android — отправляет через Firebase Cloud Messaging (FCM)
    - для iOS — отправляет через Apple Push Notification Service (APNS)
5. Пользователь получает уведомление на соответствующем устройстве (браузер или мобильное приложение)

### 9.3 Напоминания о процедурах

**Алгоритм напоминаний:**
1. Система анализирует медицинские карты питомцев
2. Определяет периодические процедуры (прививки, осмотры)
3. Рассчитывает дату следующей процедуры
4. Отправляет напоминание за 7 дней
5. Повторяет напоминание за 1 день

**Алгоритм напоминаний о процедурах:**
1. При создании напоминания (например, при бронировании или для периодической процедуры) в базе данных создаётся запись с параметрами: питомец, услуга/процедура, описание, частота (ежедневно, еженедельно, ежемесячно, ежегодно, по индивидуальному интервалу), дата начала, дата окончания (опционально), и временем следующего напоминания (`next_notification`).
2. Сервис-планировщик (например, Celery Beat) периодически (раз в N минут/часов) сканирует таблицу напоминаний.
3. Для всех активных напоминаний, у которых наступило время (`next_notification <= now`), система автоматически отправляет уведомление пользователю (email, push, in-app).
4. После отправки система обновляет время последнего уведомления (`last_notified`) и пересчитывает время следующего напоминания (`next_notification`) согласно заданной частоте.
5. Пользователь может настраивать параметры напоминания (частота, канал доставки, отключение), но отправка происходит автоматически.

### 9.4 Гибкая система правил уведомлений

**Модель NotificationRule:**
- `event_type` - тип события (booking_created, booking_cancelled, price_changed, etc.)
- `condition` - условие срабатывания (Python-выражение для оценки)
- `template` - шаблон уведомления
- `priority` - приоритет правила (low, medium, high, critical)
- `channels` - каналы доставки (email, push, in_app)
- `is_active` - активность правила
- `inheritance` - наследование (global, user_specific)
- `created_by` - создатель правила
- `created_at` - дата создания
- `updated_at` - дата обновления

**Админский интерфейс управления правилами:**
1. **Создание правила:**
   - Выбор типа события из списка доступных
   - Настройка условия срабатывания через визуальный редактор
   - Выбор шаблона уведомления
   - Установка приоритета и каналов доставки
   - Настройка наследования (глобальное/пользовательское)

2. **Редактирование правила:**
   - Изменение всех параметров активного правила
   - Временное отключение/включение правила
   - Просмотр статистики срабатываний

3. **Управление шаблонами:**
   - Создание новых шаблонов уведомлений
   - Редактирование существующих шаблонов
   - Предварительный просмотр шаблонов
   - Валидация синтаксиса шаблонов

**Примеры условий срабатывания:**
- `user.is_vip == True` - только для VIP-клиентов
- `booking.total_amount > 1000` - для дорогих бронирований
- `hours_before_start < 24` - за 24 часа до начала
- `price_increase_percent > 10` - повышение цены более чем на 10%
- `user.booking_count > 5` - для постоянных клиентов

**Система приоритетов:**
- **Critical** - критические уведомления (отмены, блокировки)
- **High** - важные уведомления (VIP-клиенты, дорогие услуги)
- **Medium** - стандартные уведомления (подтверждения, напоминания)
- **Low** - информационные уведомления (новости, обновления)

**Наследование правил:**
1. **Глобальные правила** - применяются ко всем пользователям
2. **Пользовательские правила** - переопределяют глобальные для конкретного пользователя
3. **Приоритет пользовательских** - пользовательские правила имеют приоритет над глобальными

**Флоу обработки событий:**
1. **Событие происходит** (создание бронирования, отмена, изменение цены)
2. **Система определяет тип события** и получает все активные правила для этого типа
3. **Правила сортируются по приоритету** (critical → high → medium → low)
4. **Для каждого правила:**
   - Проверяется условие срабатывания
   - Если условие выполняется, отправляется уведомление по шаблону
   - Логируется срабатывание правила
5. **Пользователь получает уведомления** по выбранным каналам

**Валидация и аудит:**
- **Валидация условий** - проверка корректности Python-выражений
- **Тестирование правил** - возможность протестировать правило на тестовых данных
- **Логирование срабатываний** - запись всех срабатываний правил
- **Статистика использования** - количество срабатываний, успешных доставок
- **Мониторинг производительности** - время обработки правил

**API для управления правилами:**
- `GET /api/admin/notification-rules/` - список всех правил
- `POST /api/admin/notification-rules/` - создание нового правила
- `PUT /api/admin/notification-rules/<id>/` - редактирование правила
- `DELETE /api/admin/notification-rules/<id>/` - удаление правила
- `POST /api/admin/notification-rules/<id>/test/` - тестирование правила
- `GET /api/admin/notification-rules/<id>/stats/` - статистика правила

### 9.5 Настройки напоминаний

**Модель ReminderSettings:**
- `user` - пользователь, для которого настроены напоминания
- `reminder_time_before_booking` - время напоминания до бронирования (в минутах, по умолчанию 120)
- `multiple_reminders` - поддержка множественных напоминаний
- `reminder_intervals` - интервалы для множественных напоминаний (JSON массив в минутах)
- `is_active` - активность настроек
- `created_at`, `updated_at` - временные метки

**Функциональность:**
- **Одиночные напоминания:** одно напоминание за заданное время до бронирования
- **Множественные напоминания:** несколько напоминаний с разными интервалами
- **Автоматический расчет:** система автоматически вычисляет время следующего напоминания
- **Валидация интервалов:** проверка корректности временных интервалов

**API эндпоинты:**
- `GET /api/users/reminder-settings/` - получение настроек пользователя
- `PUT /api/users/reminder-settings/` - обновление настроек
- `POST /api/users/reminder-settings/test/` - тестирование настроек на примере бронирования

**Примеры настроек:**
- **Стандартные:** напоминание за 2 часа до бронирования
- **Расширенные:** напоминания за 24 часа, 2 часа и 30 минут до бронирования
- **VIP-клиенты:** множественные напоминания с короткими интервалами

**Интеграция с системой:**
- Автоматическое создание настроек при регистрации пользователя
- Применение настроек при создании бронирований
- Отправка напоминаний через выбранные каналы (email, push, in-app)
- Логирование отправленных напоминаний

## 10. СИСТЕМА ПРАВИЛ ЗЛОУПОТРЕБЛЕНИЙ

### 10.1 Правила злоупотреблений по отмене бронирований

**Модель AbuseRule:**
- `name` - название правила
- `description` - описание правила
- `period` - период для подсчета отмен (день, неделя, месяц, год)
- `max_cancellations` - максимальное количество отмен за период
- `is_active` - активность правила

**Модель BookingCancellation:**
- `booking` - связь с бронированием
- `cancelled_by` - пользователь, отменивший бронирование
- `reason` - причина отмены
- `is_abuse` - флаг злоупотребления
- `abuse_rule` - связь с нарушенным правилом

**Алгоритм проверки злоупотреблений:**
1. При создании отмены бронирования система автоматически проверяет все активные правила
2. Для каждого правила подсчитывается количество отмен пользователя за указанный период
3. Если количество превышает лимит, отмена помечается как злоупотребление
4. Связывается с конкретным правилом, которое было нарушено

### 10.2 Защита от накрутки рейтингов

**Система обнаружения подозрительной активности:**
- **Массовые отзывы** - более 5 отзывов за 24 часа
- **Фальшивые жалобы** - более 80% отклоненных жалоб
- **Манипуляции с рейтингами** - все одинаковые оценки или крайние оценки (1/5)

**Модерация отзывов:**
- Интеграция с Google Perspective API для анализа токсичности
- Автоматическая проверка подозрительных паттернов
- Fallback на локальные правила при недоступности API

**Проверка доступа к отзывам:**
- Только пользователи, которые действительно пользовались услугами, могут оставлять отзывы
- Для сотрудников - проверка через бронирования
- Для учреждений - доступ у всех пользователей

### 10.3 Админский интерфейс

**Управление правилами злоупотреблений:**
- Создание и редактирование правил
- Настройка периодов и лимитов
- Активация/деактивация правил

**Мониторинг нарушений:**
- Просмотр отмен с флагом злоупотреблений
- Анализ подозрительной активности
- Статистика нарушений

### 10.4 Интеграция с системой рейтингов

**Влияние на рейтинг:**
- Отмены влияют на рейтинг через `cancellations_weight`
- Жалобы влияют на рейтинг через `complaints_weight`
- No-show влияет на рейтинг через `no_show_weight`

**История изменений:**
- Отслеживание всех изменений рейтингов
- Причины изменений
- Автор изменений

## 11. БИЛЛИНГ И ПЛАТЕЖИ

### 11.1 Система контрактов

**Алгоритм создания и активации контракта:**
1. **Стандартные условия сотрудничества** (включая комиссии, сроки оплаты и базовые юридические положения) задаются администратором системы через справочник типов контрактов (`ContractType`). Для каждого типа контракта могут быть определены:
   - Стандартные комиссии (процент/фиксированная сумма, периодичность)
   - Стандартные сроки оплаты (отсрочка, период выставления счетов)
   - Общие условия сотрудничества (права, обязанности, ответственность, порядок расторжения и др.)
   - Пороги блокировки (наследуются из глобальных, но могут быть изменены менеджером)
2. **Менеджер по биллингу** может создать новый контракт для учреждения, выбрав тип контракта и, при необходимости, изменив отдельные параметры (комиссии, сроки оплаты, условия).
3. **Если все параметры контракта соответствуют стандартным для выбранного типа** (комиссии, сроки оплаты, условия сотрудничества не изменялись), менеджер может сразу активировать контракт самостоятельно — статус меняется на `'active'`.
4. **Если хотя бы один из параметров отличается от стандартных** (например, индивидуальная комиссия, особый срок оплаты, изменённые условия сотрудничества, блокировок), контракт создаётся в статусе `'draft'` и требует обязательного утверждения администратором системы. Только после утверждения админом статус может быть изменён на `'active'`.
5. **Подписание контракта**:
Для контрактов допускается электронная оферта (акцепт условий через интерфейс, "галочка").
6. **Все действия по созданию, изменению и активации контракта логируются с указанием пользователя, времени и причины.**

### 11.2 Управление менеджерами по биллингу

**Назначение:** Обеспечивает назначение и управление менеджерами по биллингу для учреждений, включая отслеживание их деятельности и автоматическое уведомление о важных событиях.

**Алгоритм работы:**
1. Системный администратор назначает менеджера по биллингу для учреждения
2. Менеджер может управлять несколькими учреждениями одновременно
3. Система отслеживает статус управления (активно, в отпуске, временно, завершено)
4. При блокировке учреждения система автоматически уведомляет назначенного менеджера
5. Поддерживается назначение временных заместителей на период отпуска

**Модели данных:**

**Связь менеджера с учреждением (BillingManagerProvider):**
- Связь с менеджером по биллингу (billing_manager)
- Связь с учреждением (provider)
- Дата начала управления (start_date)
- Статус управления ('active', 'vacation', 'temporary', 'terminated')
- Временный менеджер (temporary_manager) - для периодов отпуска
- Примечания (notes)
- Автоматическое создание событий при изменениях

**События менеджера (BillingManagerEvent):**
- Связь с BillingManagerProvider
- Тип события ('assigned', 'vacation_start', 'vacation_end', 'temporary_assigned', 'terminated')
- Дата вступления в силу (effective_date)
- Создатель события (created_by)
- Примечания (notes)
- Полная история для аудита

**API эндпоинты:**
- `GET /api/billing-managers/` - список менеджеров по биллингу
- `GET /api/billing-managers/{id}/` - детали менеджера
- `POST /api/billing-managers/` - создание связи менеджера с учреждением
- `PUT /api/billing-managers/{id}/` - обновление связи
- `DELETE /api/billing-managers/{id}/` - удаление связи
- `GET /api/billing-managers/{id}/events/` - история событий менеджера
- `POST /api/billing-managers/{id}/start_vacation/` - начало отпуска
- `POST /api/billing-managers/{id}/end_vacation/` - завершение отпуска
- `POST /api/billing-managers/{id}/terminate/` - завершение управления

**Интеграция с системой блокировок:**
- Автоматические уведомления менеджеров о блокировках учреждений
- Настройка уведомлений в BlockingSystemSettings
- Получение списка активных менеджеров для учреждения при блокировке
- Поддержка временных менеджеров в период отпуска

**Управление статусами:**
- **active** - менеджер активно управляет учреждением
- **vacation** - менеджер в отпуске, назначен временный заместитель
- **temporary** - временное управление другим менеджером
- **terminated** - управление завершено

**Безопасность и аудит:**
- Полная история всех изменений через события
- Отслеживание кто, когда и почему принял решение
- Поддержка compliance и аудита
- Автоматическое создание событий при изменениях статуса

### 11.3 Обработка платежей между поставщиками услуг и сервисом

**Алгоритм обработки платежей:**
1. После завершения бронирования система фиксирует оказанную услугу и начисляет комиссию согласно условиям контракта.
2. На основании данных о бронированиях и других операциях формируется счёт (Invoice) для учреждения — с детализацией начисленных комиссий, абонентских плат, штрафов и т.д.
3. Учреждению выставляется счёт на оплату через личный кабинет И по email.
4. После поступления оплаты от учреждения оператор или бухгалтерия вручную подтверждает платёж в системе (изменяет статус платежа/счёта на "оплачен").
5. Система обновляет статус счёта и уведомляет учреждение о зачислении средств.

**Расчёт комиссии:**
- Применяется процент или фиксированная сумма согласно условиям контракта (Contract/ContractType).
- Учитываются скидки, бонусы, штрафы, абонентские платы (если предусмотрено контрактом).
- Формируется отчётность для учреждения и платформы.

### 11.4 Система блокировки

**Алгоритм блокировки:**
1. Система проверяет задолженность учреждения
2. Сравнивает с пороговыми значениями
3. При превышении применяет блокировку
4. Отправляет уведомления ответственным лицам
5. Блокирует доступ к функциям согласно уровню

**Периодика проверки задолженности:**
- Автоматические проверки выполняются по расписанию (по умолчанию ежедневно в 02:00)
- Частота проверок настраивается 
- Поддерживаются различные расписания: почасово, ежедневно, еженедельно, ежемесячно
- Проверки выполняются через Celery Beat задачи

**Уровни блокировки:**
- **Уровень 0:** Нет блокировки
- **Уровень 1:** Информационное уведомление
- **Уровень 2:** Исключение из поиска
- **Уровень 3:** Полная блокировка

**Флоу разблокировки:**
1. **Автоматическая разблокировка при оплате:** При поступлении платежа, покрывающего задолженность, система автоматически снимает блокировку (если включено в настройках)
2. **Ручная разблокировка:** Администратор или менеджер по биллингу может вручную снять блокировку через API или админ-панель
   - При ручном снятии блокировки администратор **обязательно** должен выполнить одно из действий:
     - Изменить индивидуальные пороги блокировки в контракте 
     - Или исключить контракт из автоматических проверок блокировки
   - Это необходимо для предотвращения повторной автоматической блокировки при следующем анализе задолженности
3. **Уведомления о разблокировке:** При снятии блокировки отправляются уведомления учреждению и ответственным лицам

**Пороговые значения:**
- Настраиваются глобально в системе блокировки и наследуются в контракты
- Поддерживаются пороги по сумме задолженности
- Поддерживаются пороги по дням просрочки (3 уровня: информационное уведомление, исключение из поиска, полная блокировка)
- Учитывается отсрочка платежей
- Поддерживается исключение праздников и рабочих дней из расчёта просрочки

**Модели данных:**

**BlockingRule (Правила блокировки):**
- Настройка порогов по сумме и дням просрочки
- Массовая настройка по географии и типу услуг
- Приоритет правил (меньше = выше приоритет)
- Отслеживание активности правил

**ProviderBlocking (Блокировки учреждений):**
- Отслеживание статуса блокировки (active, resolved, manual_override)
- Данные о задолженности на момент блокировки
- История блокировок с датами и причинами
- Привязка к правилу блокировки

**BlockingTemplate (Шаблоны блокировки):**
- Географическая иерархия (страна → область → город)
- Автоматическое применение параметров при создании договоров
- Централизованное управление порогами блокировки
- Интеграция с системой геолокации

**BlockingSystemSettings (Настройки системы):**
- Централизованное управление настройками
- Настройка периодичности проверок
- Управление уведомлениями
- Автоматическое снятие блокировок

**BlockingNotification (Уведомления о блокировках):**
- Отслеживание статуса отправки уведомлений
- Различные типы уведомлений (предупреждение, активация, снятие)
- История уведомлений с деталями

**API эндпоинты:**
- `GET /api/blocking-rules/` - список правил блокировки
- `POST /api/blocking-rules/` - создание правила блокировки
- `PUT /api/blocking-rules/{id}/` - редактирование правила
- `DELETE /api/blocking-rules/{id}/` - удаление правила
- `GET /api/provider-blockings/` - список блокировок учреждений
- `GET /api/provider-blockings/{id}/` - детали блокировки
- `POST /api/provider-blockings/{blocking_id}/resolve/` - снятие блокировки
- `GET /api/providers/{provider_id}/blocking-status/` - статус блокировки учреждения
- `GET /api/providers/{provider_id}/blocking-history/` - история блокировок
- `GET /api/blocking-notifications/` - уведомления о блокировках
- `POST /api/blocking-notifications/{notification_id}/retry/` - повтор уведомления

**Интеграция с системой уведомлений:**
- Автоматические уведомления менеджеров о блокировках учреждений
- Настройка уведомлений в BlockingSystemSettings
- Получение списка активных менеджеров для учреждения при блокировке
- Поддержка временных менеджеров в период отпуска

## 12. АНАЛИТИКА И ОТЧЕТЫ

### 12.1 Статистика учреждений

**Типы отчетов:**
- Количество записей по периодам
- Выручка и комиссия
- Популярные услуги
- Рейтинг и отзывы
- География клиентов
- Дебиторская задолженность

**Общие положения:**
- Все отчеты формируются вручную через административный интерфейс (или по API).
- Экспорт отчетов реализован только в формате Excel (XLSX).
- Автоматическая рассылка и PDF-экспорт не входят в MVP.
- Формирование отчетов доступно администраторам и менеджерам по необходимости.

**Логика формирования отчетов:**

1. **Количество записей по периодам**
   - Считается общее количество бронирований за выбранный период (день/неделя/месяц).
   - Группировка по учреждениям, услугам, сотрудникам учреждений.
   - Формирует администратор или менеджер по необходимости.

2. **Выручка и комиссия**
   - Суммируется стоимость завершённых бронирований за период.
   - Отдельно считается комиссия платформы (по данным биллинга).
   - Группировка по учреждениям, услугам, сотрудникам учреждений.
   - Формирует администратор или менеджер по необходимости.

3. **Популярные услуги**
   - Считается количество бронирований по каждой услуге за период.
   - Сортировка по убыванию популярности.
   - Формирует администратор или менеджер по необходимости.

4. **Рейтинг и отзывы**
   - Средний рейтинг и количество отзывов по учреждениям и услугам.
   - Группировка по учреждениям, услугам, сотрудникам учреждений.
   - Формирует администратор или менеджер по необходимости.

5. **География получателей услуг**
   - Строится распределение получателей услуг по городам/регионам (если есть данные о местоположении).
   - Формирует администратор или менеджер по необходимости.

6. **Дебиторская задолженность**
   - Считается сумма задолженности по каждому учреждению на выбранную дату/период.
   - Учитываются просроченные платежи по контрактам.
   - Формирует администратор или менеджер по необходимости.

### 12.2 Аналитика пользователей

**Цель:** Понимание роста платформы и эффективности привлечения пользователей.

**Метрики, рассчитываемые в системе:**

1. **Рост пользователей**
   - Количество новых получателей услуг за период
   - Количество новых учреждений за период
   - Динамика регистраций по дням/неделям/месяцам
   - Активация новых пользователей (кто зашёл после регистрации)

2. **Активность пользователей**
   - Количество активных получателей услуг за период
   - Количество активных учреждений за период
   - Частота использования (сколько раз пользователь заходил)

3. **Конверсия в бронирования**
   - Процент зарегистрированных, которые совершили хотя бы одно бронирование
   - Время от регистрации до первого бронирования
   - Процент завершённых бронирований (не отменённых)

**Метрики для маркетинга (опционально, через Google Analytics):**
- Источники трафика (поиск, реклама, соцсети)
- География пользователей
- Устройства (мобильные/десктоп)
- Пути пользователя по сайту

**Формирование отчётов:**
- Все метрики рассчитываются на основе данных из моделей Django
- Отчёты формируются вручную через административный интерфейс
- Экспорт в Excel
- Автоматическая рассылка не входит в MVP

## 13. АДМИНИСТРИРОВАНИЕ СИСТЕМЫ

### 13.1 Управление пользователями

**Функции администратора:**
- Просмотр всех пользователей
- Блокировка/разблокировка аккаунтов
- Изменение ролей пользователей
- Просмотр активности пользователей
- Удаление пользователей

### 13.2 Аудит системы

**Система логирования действий:**
- **Автоматическое логирование HTTP запросов:**
  - IP-адрес, User-Agent, HTTP метод, URL
  - Статус код ответа, размер контента
  - Время выполнения запроса
  - Сессия пользователя

- **Логирование действий пользователей:**
  - Создание, изменение, удаление объектов
  - Вход/выход в систему
  - Просмотр данных, экспорт/импорт
  - Блокировка/разблокировка аккаунтов
  - Приглашения, принятие/отклонение
  - Передача прав, платежи, возвраты
  - Бронирования, отмены, отзывы, жалобы
  - Системные операции

- **Логирование изменений в системе:**
  - Автоматическое отслеживание через сигналы Django
  - Изменения пользователей, питомцев, бронирований
  - Изменения контрактов, платежей, приглашений
  - Блокировка учреждений и пользователей

**Детализированное отслеживание изменений в моделях:**
- **Django Signals для автоматического аудита:**
  - `pre_save` и `post_save` сигналы для отслеживания создания и обновления
  - `pre_delete` и `post_delete` сигналы для отслеживания удаления
  - Автоматическое создание записей аудита при любых изменениях

- **Модели аудита:**
  - `AuditLog` - основная модель для хранения истории изменений
  - `ModelChange` - детали изменений конкретных полей
  - `UserAction` - действия пользователей с контекстом

- **Отслеживаемые поля:**
  - Старые и новые значения полей
  - Тип изменения (создание, обновление, удаление)
  - Временная метка изменения
  - Пользователь, выполнивший изменение
  - IP-адрес и User-Agent
  - Причина изменения (опционально)

- **Контекст изменений:**
  - Связанные объекты (foreign keys)
  - Сессия пользователя
  - HTTP запрос (метод, URL, параметры)
  - Бизнес-операция (например, "передача прав владения")

- **Версионирование объектов:**
  - Автоматическое создание снимков состояния объекта
  - Возможность восстановления предыдущих версий
  - Отслеживание цепочки изменений

- **Логирование ошибок и исключений:**
  - Стандартное логирование Django
  - Уровни логирования (DEBUG, INFO, WARNING, ERROR)

**Специализированный аудит безопасности:**
- **Критически важные операции:**
  - Изменения ролей и прав доступа
  - Управление приглашениями
  - Финансовые операции
  - Операции блокировки/разблокировки
  - Передача прав владения питомцами
  - Подозрительная активность
  - Изменения конфигурации системы

- **Отслеживание изменений:**
  - Сохранение старых и новых значений
  - Причина изменения
  - Флаг критичности операции
  - Статус проверки и кто проверил

**Настройки системы аудита:**
- **Глобальные настройки:**
  - Включение/выключение логирования
  - Включение/выключение аудита безопасности
  - Периоды хранения логов (обычные и безопасности)
  - Автоматическая очистка старых логов
  - Уведомления о критических операциях
  - Минимальный уровень логирования

- **Детальные настройки:**
  - Логирование HTTP запросов
  - Логирование изменений в базе данных
  - Логирование бизнес-операций
  - Логирование системных событий

**Инструменты управления логами:**
- **Команды управления:**
  - Просмотр статистики аудита
  - Экспорт данных аудита в файлы
  - Автоматическая очистка старых логов

- **Декораторы для разработчиков:**
  - Логирование действий пользователей
  - Аудит критических операций
  - Логирование бизнес-операций
  - Аудит финансовых операций
  - Логирование изменений в БД
  - Аудит изменений ролей
  - Логирование API запросов
  - Аудит подозрительной активности

**Мониторинг безопасности:**
- Подозрительная активность
- Попытки взлома
- Нарушения политик безопасности
- Аудит доступа к данным



## 14. ИНТЕГРАЦИИ И API

### 14.1 REST API

**Реализованные API эндпоинты:**

**Аутентификация и пользователи (`/api/`):**
- `POST /api/register/` - Регистрация нового пользователя
- `POST /api/login/` - Вход в систему
- `GET /api/profile/` - Профиль пользователя
- `POST /api/google-auth/` - Аутентификация через Google
- `POST /api/token/refresh/` - Обновление JWT токена
- `POST /api/token/blacklist/` - Черный список токенов
- `POST /assign-role/` - Назначение роли пользователю
- `POST /deactivate/<user_id>/` - Деактивация пользователя
- `GET/POST /provider-forms/` - Управление заявками учреждений
- `POST /provider-forms/approve/` - Одобрение заявки учреждения
- `POST /employees/deactivate/<employee_id>/` - Деактивация сотрудника
- `DELETE /me/delete/` - Самоудаление пользователя
- `GET /search/distance/` - Поиск пользователей по расстоянию
- `GET /search/sitters/distance/` - Поиск ситтеров по расстоянию
- `POST /users/bulk-role-assignment/` - Массовое назначение ролей
- `POST /users/bulk-deactivation/` - Массовая деактивация
- `POST /users/bulk-activation/` - Массовая активация
- `GET/POST /role-invites/` - Управление инвайтами ролей
- `GET/PUT/PATCH/DELETE /role-invites/<pk>/` - Детали инвайта
- `POST /role-invites/accept/` - Принятие инвайта
- `POST /role-invites/decline/` - Отклонение инвайта
- `GET /role-invites/token/<token>/` - Инвайт по токену
- `GET /role-invites/<invite_id>/qr-code/` - QR-код инвайта
- `GET /role-invites/pending/` - Ожидающие инвайты
- `POST /role-invites/cleanup/` - Очистка инвайтов
- `POST /role-termination/` - Прекращение роли

**Питомцы (`/api/`):**
- `GET/POST /pets/` - Список и создание питомцев
- `GET/PUT/PATCH/DELETE /pets/<pk>/` - Управление питомцем
- `DELETE /pets/<pk>/delete/` - Удаление питомца
- `GET/POST /medical-records/` - Медицинские записи
- `GET/PUT/PATCH/DELETE /medical-records/<pk>/` - Управление медзаписью
- `GET/POST /records/` - Записи о питомце
- `GET/PUT/PATCH/DELETE /records/<pk>/` - Управление записью
- `POST /records/<record_id>/upload_file/` - Загрузка файла
- `GET/POST /access/` - Доступ к питомцам
- `GET/PUT/PATCH/DELETE /access/<pk>/` - Управление доступом
- `POST /pets/<pet_id>/invite/` - Приглашение к питомцу
- `POST /pets/accept-invite/` - Принятие приглашения
- `GET /pets/invite/<token>/qr/` - QR-код приглашения
- `GET /documents/<document_id>/download/` - Скачивание документа
- `GET /documents/<document_id>/preview/` - Просмотр документа

**Учреждения (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /providers/` - CRUD учреждений
- `GET/POST/PUT/PATCH/DELETE /employees/` - CRUD сотрудников
- `GET/POST/PUT/PATCH/DELETE /schedules/` - CRUD расписаний
- `GET/POST/PUT/PATCH/DELETE /provider-services/` - CRUD услуг учреждения
- `GET /search/` - Поиск учреждений
- `GET /search/distance/` - Поиск по расстоянию
- `GET /search/sitters/advanced/` - Расширенный поиск ситтеров
- `PUT /employees/<employee_id>/update/` - Обновление сотрудника
- `POST /employees/<employee_id>/deactivate/` - Деактивация сотрудника
- `POST /join-requests/` - Заявка на вступление
- `POST /join-requests/approve/` - Одобрение заявки
- `POST /join-requests/confirm/` - Подтверждение заявки
- `POST /employees/delete-notify/` - Уведомление об удалении
- `POST /work-slots/bulk/` - Массовые операции со слотами
- `POST /schedule-patterns/apply/` - Применение шаблона расписания

**Бронирования (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /bookings/` - CRUD бронирований
- `GET/POST/PUT/PATCH/DELETE /booking-statuses/` - CRUD статусов
- `GET/POST/PUT/PATCH/DELETE /booking-reviews/` - CRUD отзывов
- `POST /auto-book-employee/` - Автобронирование сотрудника
- `GET /available-employees/` - Доступные сотрудники
- `POST /bookings/<booking_id>/cancel/` - Отмена бронирования
- `POST /bookings/<booking_id>/complete/` - Завершение бронирования
- `POST /bookings/<booking_id>/no-show/` - Отметка неявки
- `GET /bookings/<booking_id>/time-slots/` - Доступные слоты

**Биллинг (`/`):**
- `GET/POST/PUT/PATCH/DELETE /contract-types/` - CRUD типов контрактов
- `GET/POST/PUT/PATCH/DELETE /payments/` - CRUD платежей
- `GET/POST/PUT/PATCH/DELETE /invoices/` - CRUD счетов
- `GET/POST/PUT/PATCH/DELETE /refunds/` - CRUD возвратов
- `GET/POST/PUT/PATCH/DELETE /contracts/` - CRUD контрактов
- `GET/POST /blocking-rules/` - Правила блокировки
- `GET/PUT/PATCH/DELETE /blocking-rules/<pk>/` - Управление правилом
- `GET /provider-blockings/` - Блокировки учреждений
- `GET /provider-blockings/<pk>/` - Детали блокировки
- `POST /provider-blockings/<blocking_id>/resolve/` - Разрешение блокировки
- `GET /providers/<provider_id>/blocking-status/` - Статус блокировки
- `GET /providers/<provider_id>/blocking-history/` - История блокировок
- `GET /blocking-notifications/` - Уведомления о блокировках
- `POST /blocking-notifications/<notification_id>/retry/` - Повтор уведомления

**Каталог услуг (`/`):**
- `GET/POST/PUT/PATCH/DELETE /services/` - CRUD услуг
- `GET/POST /categories/` - Категории услуг
- `GET/PUT/PATCH/DELETE /categories/<pk>/` - Управление категорией
- `GET/POST /services/` - Список и создание услуг
- `GET/PUT/PATCH/DELETE /services/<pk>/` - Управление услугой
- `POST /services/search/` - Расширенный поиск услуг с фильтрацией (name, category_id, min_price, max_price, sort_by)

**Уведомления (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /notifications/` - CRUD уведомлений
- `GET/POST/PUT/PATCH/DELETE /preferences/` - CRUD предпочтений
- `GET/POST/PUT/PATCH/DELETE /settings/` - CRUD настроек
- `GET /notifications/unread-count/` - Количество непрочитанных
- `POST /notifications/<pk>/mark-as-read/` - Отметить как прочитанное
- `POST /notifications/mark-all-as-read/` - Отметить все как прочитанные
- `GET /notifications/statistics/` - Статистика уведомлений
- `POST /notifications/test/` - Тестовое уведомление
- `GET /preferences/all/` - Все предпочтения
- `POST /preferences/reset/` - Сброс предпочтений
- `POST /settings/bulk-update/` - Массовое обновление настроек
- `GET /settings/available-options/` - Доступные опции
- `GET /notifications/` - Получение уведомлений
- `POST /notifications/<notification_id>/read/` - Отметить как прочитанное
- `POST /notifications/read-all/` - Отметить все как прочитанные
- `DELETE /notifications/<notification_id>/delete/` - Удаление уведомления
- `DELETE /notifications/delete-all/` - Удаление всех уведомлений
- `GET /notifications/stats/` - Статистика
- `POST /notifications/preferences/` - Обновление предпочтений
- `GET /notifications/templates/` - Шаблоны уведомлений
- `POST /notifications/test/` - Тестовое уведомление
- `GET /notifications/history/` - История уведомлений
- `POST /notifications/push-token/` - Обновление push-токена
- `GET /admin/notifications/` - Админские уведомления
- `POST /admin/notifications/send/` - Отправка уведомления
- `POST /admin/notifications/bulk-send/` - Массовая отправка
- `GET /admin/notifications/analytics/` - Аналитика уведомлений

**Рейтинги (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /ratings/` - CRUD рейтингов
- `GET/POST/PUT/PATCH/DELETE /reviews/` - CRUD отзывов
- `GET/POST/PUT/PATCH/DELETE /complaints/` - CRUD жалоб
- `GET/POST/PUT/PATCH/DELETE /complaint-responses/` - CRUD ответов на жалобы
- `GET/POST/PUT/PATCH/DELETE /suspicious-activities/` - CRUD подозрительной активности

**Аудит (`/api/`):**
- `GET /audit/logs/` - Логи аудита
- `GET /audit/logs/export/` - Экспорт логов
- `GET /audit/user-activity/<user_id>/` - Активность пользователя
- `GET /audit/system-events/` - Системные события
- `GET /audit/statistics/` - Статистика аудита
- `GET /audit/logs/filter/` - Фильтрация логов
- `GET /audit/logs/search/` - Поиск в логах
- `POST /audit/logs/cleanup/` - Очистка логов

**Аналитика (`/api/`):**
- `GET /analytics/user-growth/` - Рост пользователей
- `GET /analytics/provider-performance/` - Производительность учреждений
- `GET /analytics/revenue-trends/` - Тренды выручки
- `GET /analytics/behavioral/` - Поведенческая аналитика

**Геолокация (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /addresses/` - CRUD адресов
- `GET/POST/PUT/PATCH/DELETE /validations/` - CRUD валидаций
- `GET/POST/PUT/PATCH/DELETE /cache/` - CRUD кэша
- `GET /autocomplete/` - Автодополнение адресов
- `GET /geocode/` - Геокодирование
- `GET /reverse-geocode/` - Обратное геокодирование
- `POST /validate-bulk/` - Массовая валидация
- `GET /user-location/` - Местоположение пользователя
- `POST /device-location/` - Сохранение местоположения устройства
- `POST /map-location/` - Сохранение местоположения с карты
- `GET /location-info/` - Информация о местоположении
- `POST /clear-location/` - Очистка местоположения
- `GET /check-address-requirement/` - Проверка требований к адресу
- `GET /validate-location-for-role/` - Валидация местоположения для роли

**Системные настройки (`/api/`):**
- `GET/POST /settings/system/` - Системные настройки
- `GET/POST /settings/features/` - Настройки функций
- `GET/POST /settings/security/` - Настройки безопасности
- `GET /settings/health/` - Проверка здоровья системы

**Отчеты (`/api/`):**
- `GET /income/` - Отчет по доходам
- `GET /workload/` - Отчет по загрузке
- `GET /debt/` - Отчет по задолженностям
- `GET /activity/` - Отчет по активности
- `GET /payment/` - Отчет по платежам
- `GET /cancellation/` - Отчет по отменам

**Доступ (`/`):**
- `GET/POST/PUT/PATCH/DELETE /accesses/` - CRUD доступа
- `GET/POST/PUT/PATCH/DELETE /logs/` - CRUD логов доступа

**Передержка (`/`):**
- `GET/POST/PUT/PATCH/DELETE /profiles/` - CRUD профилей передержки
- `GET/POST/PUT/PATCH/DELETE /ads/` - CRUD объявлений
- `GET/POST/PUT/PATCH/DELETE /responses/` - CRUD откликов
- `GET/POST/PUT/PATCH/DELETE /pet-sitting/` - CRUD передержки
- `GET/POST/PUT/PATCH/DELETE /reviews/` - CRUD отзывов

**Аутентификация API:**
- JWT токены
- OAuth 2.0 для внешних приложений
- Ограничение частоты запросов

## 15. ПЕРИОДИЧЕСКИЕ ЗАДАЧИ

### 15.1 Система валют

**Обновление курсов валют:**
- Автоматическое обновление курсов валют через внешний API (exchangeratesapi.io)
- Периодичность: ежедневно в 00:00
- Поддерживаемые валюты: USD (базовая), EUR, RUB
- Обработка ошибок и логирование неудачных попыток обновления
- Fallback на последние известные курсы при недоступности API

### 15.2 Уведомления

**Запланированные уведомления:**
- Обработка запланированных уведомлений: каждую минуту
- Обработка напоминаний: каждый час
- Очистка старых уведомлений: ежедневно в 02:00
- Отправка напоминаний о задолженности: ежедневно в 09:00
- Проверка истечения инвайтов ролей: ежедневно в 08:00
- Статистика уведомлений администраторам: ежедневно в 18:00
- Очистка неактивных push-токенов: еженедельно по воскресеньям в 03:00
- Напоминания о предстоящих бронированиях: каждые 15 минут (индивидуально для каждого пользователя)


**Система напоминаний о бронированиях:**
- **Глобальная настройка:** Время напоминания по умолчанию (например, за 2 часа до бронирования)
- **Индивидуальная настройка:** Пользователь может изменить время напоминания в своих настройках
- **Логика работы:** Система проверяет каждые 15 минут, какие бронирования требуют напоминания
- **Индивидуальное время:** Каждый пользователь получает напоминание за свое настроенное время до бронирования
- **Множественные напоминания:** Поддержка нескольких напоминаний (например, за 1 день и за 2 часа)

### 15.3 Система блокировок

**Проверка блокировок:**
- Автоматическая проверка задолженности учреждений: ежедневно в 02:00 (настраивается)
- Применение правил блокировки согласно настройкам
- Автоматическое снятие блокировок при погашении задолженности
- Отправка уведомлений о блокировке/разблокировке

### 15.4 Задачи питомцев

**Обработка недееспособности владельцев:**
- `check_inactive_owners_task` - еженедельная проверка неактивных владельцев питомцев
  - Находит питомцев с неактивными основными владельцами
  - Создает записи о недееспособности
  - Отправляет уведомления всем владельцам
  - Логирует результаты выполнения

- `process_deadline_actions_task` - ежедневная обработка действий по истечении дедлайнов
  - Находит записи о недееспособности с истекшим дедлайном
  - Выполняет автоматические действия (удаление питомца или назначение совладельца)
  - Отправляет уведомления о выполненных действиях
  - Возвращает статистику выполненных операций

- `send_incapacity_notifications_task` - периодическая отправка уведомлений
  - Находит неотправленные уведомления о недееспособности
  - Отправляет их через email
  - Обновляет статус уведомлений
  - Логирует количество отправленных и неудачных уведомлений

- `cleanup_old_incapacity_records_task` - ежемесячная очистка старых записей
  - Удаляет записи о недееспособности старше 1 года
  - Очищает только завершенные случаи (resolved, auto_deleted, coowner_assigned)
  - Экономит место в базе данных
  - Логирует количество удаленных записей

**Особенности реализации:**
- Все задачи используют транзакционную обработку для обеспечения целостности данных
- Подробное логирование всех операций и ошибок
- Возврат детальной статистики выполнения
- Обработка исключений с сохранением контекста ошибки

## 12. ИНТЕГРАЦИЯ УСЛУГ С ТИПАМИ ЖИВОТНЫХ

### 12.1 Техническая реализация

**Модель Service (catalog/models.py):**
- Добавлено поле `allowed_pet_types` (ManyToManyField к PetType)
- Методы для проверки совместимости:
  - `is_available_for_pet_type(pet_type)` - проверка доступности услуги для типа животного
  - `get_periodic_info_for_pet_type(pet_type)` - получение информации о периодичности для конкретного типа

**Валидация в PetRecord (pets/models.py):**
- Метод `clean()` проверяет совместимость услуги с типом животного перед сохранением
- Автоматическая валидация при создании записей о процедурах
- Ошибка валидации, если услуга не совместима с типом животного

**API endpoints (catalog/api_views.py):**
- `GET /api/services/for_pet_type/?pet_type_id=<id>` - получение услуг для конкретного типа животного
- `POST /api/services/check_compatibility/` - проверка совместимости услуги с типом животного
- Обновленный `ServiceSerializer` с поддержкой `allowed_pet_types`

**Административный интерфейс (catalog/admin.py):**
- Добавлено поле `allowed_pet_types` в форму редактирования услуг
- Отображение разрешенных типов животных в списке услуг
- Фильтрация по типам животных в админке
- **Древовидное отображение услуг** с иконками и отступами:
  - 📁 Корневые категории (уровень 0)
  - 📂 Подкатегории (имеют дочерние элементы)
  - 📄 Услуги (конечные элементы)
- Отображение полного пути к услуге в иерархии
- Цветовое кодирование по уровням иерархии
- Кастомный шаблон для улучшенного отображения дерева

### 12.2 Примеры использования

**Сценарий 1: Прививка от бешенства**
```python
# Создание услуги "Прививка от бешенства"
vaccination_service = Service.objects.create(
    name="Прививка от бешенства",
    code="rabies_vaccination",
    is_periodic=True,
    period_days=365,
    send_reminders=True,
    reminder_days_before=30
)

# Назначение услуги только для собак и кошек
dog_type = PetType.objects.get(code="dog")
cat_type = PetType.objects.get(code="cat")
vaccination_service.allowed_pet_types.add(dog_type, cat_type)

# Проверка совместимости
snake_type = PetType.objects.get(code="snake")
print(vaccination_service.is_available_for_pet_type(dog_type))  # True
print(vaccination_service.is_available_for_pet_type(snake_type))  # False
```

**Сценарий 2: Создание записи о процедуре**
```python
# Попытка создать запись о прививке для змеи
pet_record = PetRecord(
    pet=snake_pet,  # питомец-змея
    service=vaccination_service,  # прививка от бешенства
    provider=vet_clinic,
    employee=vet_doctor,
    date=timezone.now(),
    description="Прививка от бешенства"
)

try:
    pet_record.save()  # Вызовет ValidationError
except ValidationError as e:
    print(e)  # "Услуга 'Прививка от бешенства' недоступна для типа животного 'Змея'"
```

**Сценарий 3: API для фильтрации услуг**
```python
# GET /api/services/for_pet_type/?pet_type_id=1
# Возвращает только услуги, доступные для собак

# POST /api/services/check_compatibility/
{
    "service_id": 1,
    "pet_type_id": 3
}
# Возвращает информацию о совместимости
{
    "service_id": 1,
    "service_name": "Прививка от бешенства",
    "pet_type_id": 3,
    "pet_type_name": "Змея",
    "is_compatible": false,
    "periodic_info": {
        "is_available": false,
        "is_periodic": false,
        "period_days": null,
        "send_reminders": false,
        "reminder_days_before": null
    }
}
```

### 12.3 Миграция данных

**Миграция 0002_service_allowed_pet_types.py:**
- Добавляет поле `allowed_pet_types` в модель Service
- Создает промежуточную таблицу для связи Many-to-Many
- Обеспечивает обратную совместимость (пустое поле = доступно для всех типов)

**Обратная совместимость:**
- Существующие услуги без ограничений остаются доступными для всех типов животных
- Новые услуги могут создаваться с ограничениями по типам животных
- API продолжает работать с существующими клиентами

### 12.4 Преимущества реализации

**Безопасность:**
- Предотвращение назначения неподходящих процедур
- Автоматическая валидация совместимости
- Защита от ошибок пользователей

**Удобство использования:**
- Автоматическая фильтрация услуг по типу животного
- Понятные сообщения об ошибках
- API для проверки совместимости

**Гибкость:**
- Услуги могут быть доступны для всех типов (пустое поле)
- Легкое добавление новых типов животных
- Простое управление через админку

**Производительность:**
- Эффективные запросы с использованием индексов
- Кэширование результатов проверки совместимости
- Минимальное влияние на существующую функциональность
- Интеграция с системой уведомлений для отправки email
