# Функциональный дизайн системы PetCare

## Обзор системы

PetCare - это комплексная система управления ветеринарными услугами, которая объединяет владельцев домашних животных, поставщиков услуг (ветклиники, груминг-салоны) и специалистов в единую экосистему.

**Платформы:**
- Веб-приложение на React для всех пользователей
- Мобильное приложение (React Native) для владельцев питомцев и ситтеров
- Push-уведомления для мгновенного информирования о важных событиях

## 1. УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ И РОЛЯМИ

### 1.1 Регистрация и аутентификация

**Процесс регистрации:**
1. Любой человек может зарегистрироваться в системе, введя email, пароль, имя, телефон
2. Система проверяет уникальность email
3. Отправляется email для подтверждения
4. После подтверждения аккаунт активируется
5. Пользователь получает базовую роль "Владелец питомца"

**Регистрация через Google OAuth:**
1. Пользователь нажимает "Войти через Google"
2. Перенаправляется на страницу авторизации Google
3. Пользователь разрешает доступ к данным профиля
4. Система получает данные: email, имя, фото профиля
5. Создается аккаунт с базовой ролью "Владелец питомца"
6. Пользователь автоматически входит в систему

**Процесс входа:**
1. Пользователь вводит email и пароль
2. Система проверяет учетные данные
3. Генерируется JWT-токен для сессии
4. Пользователь получает доступ к функциям согласно роли

**Вход через Google OAuth:**
1. Пользователь нажимает "Войти через Google"
2. Если аккаунт уже существует - происходит вход
3. Если аккаунта нет - создается новый
4. Генерируется JWT-токен для сессии
5. Пользователь получает доступ к функциям согласно роли

### 1.2 Система ролей и разрешений

**Роли пользователей:**
- **Владелец питомца** - основной пользователь системы (базовая роль)
- **Ситтер** - пользователь или учреждение, оказывающий услугу передержки питомцев
- **Специалист** - ветеринар, грумер, кинолог
- **Администратор учреждения** - управляет услугами и сотрудниками
- **Менеджер по биллингу** - работает с контрактами и платежами
- **Системный администратор** - полный доступ к системе

**Алгоритм назначения дополнительных ролей:**
1. Администратор учреждения приглашает пользователя на роль специалиста
2. Система отправляет email-приглашение с уникальной ссылкой
3. Пользователь принимает приглашение и получает дополнительные права
4. Роль активируется после подтверждения администратором

### 1.3 Управление профилем пользователя

**Редактирование профиля:**
1. Пользователь открывает настройки профиля
2. Изменяет личные данные: имя, фамилия, телефон, дата рождения
3. Загружает аватар (опционально)
4. Система сохраняет изменения

**Профиль пользователя содержит:**
- Username (уникальный)
- Email (уникальный, используется для входа)
- Имя и фамилия
- Дата рождения (опционально)
- Номер телефона (уникальный, опционально)
- Аватар (опционально)
- Адрес (только для ситтеров и учреждений, связь с моделью Address)

**Управление ролями:**
1. Просмотр текущих ролей пользователя
2. Добавление/удаление ролей через систему инвайтов
3. Проверка прав доступа согласно ролям

**Система инвайтов на роли:**
1. Администратор создает инвайт по email
2. Система генерирует уникальный токен и QR-код
3. Отправляется email с ссылкой для подтверждения
4. Отправляется push-уведомление в мобильное приложение
5. Пользователь принимает/отклоняет инвайт через веб-интерфейс или мобильное приложение
6. Роль активируется после подтверждения
7. Отправляется уведомление администратору о принятии/отклонении инвайта

**Управление безопасностью:**
- Изменение пароля (стандартная функция Django)
- Выход из системы (завершение сессии)

**Удаление аккаунта:**
Пользователь может самостоятельно удалить свой аккаунт, кроме следующих случаев:

**Ограничения на удаление:**
- **Менеджер учреждения** - не может удалиться, если он последний менеджер в учреждении или есть незавершенная передача прав менеджера
- **Сотрудник учреждения** - не может удалиться вообще (должен быть уволен администратором)
- **Ситтер с активными заявками** - не может удалиться, если есть активные заявки на передержку (статусы: waiting_start, active, waiting_end, waiting_review)
- **Основной владелец питомца** - не может удалиться, если он единственный владелец питомца
- **Пользователь с активным профилем ситтера** - не может удалиться, пока профиль ситтера активен

**Алгоритм удаления:**
1. Пользователь запрашивает удаление аккаунта
2. Система проверяет все ограничения через функцию `can_delete_user()`
3. Если ограничений нет - аккаунт удаляется
4. Если есть ограничения - возвращается сообщение об ошибке с указанием причины
5. Все связанные данные удаляются каскадно (питомцы, записи, документы и т.д.)

**Профиль ситтера (дополнительные поля):**
1. Ситтер указывает адрес для оказания услуг (через связь с моделью Address)
2. Указывает опыт работы с животными (годы)
3. Описывает услуги передержки
4. Указывает типы питомцев и максимальное количество
5. Настраивает период доступности и расстояние

## 2. УПРАВЛЕНИЕ ПИТОМЦАМИ И ВЛАДЕЛЬЦАМИ

### 2.1 Множественные владельцы питомцев
- **Основной владелец (main_owner)**: Один пользователь с полными правами управления питомцем
- **Совладельцы (owners)**: Множественные пользователи с правами доступа к информации о питомце
- **Система инвайтов (PetOwnershipInvite)**: Приглашение совладельцев или передача прав основного владельца через email с токеном
- **Типы инвайтов**: 'invite' (добавление совладельца) и 'transfer' (передача прав основного владельца)
- **QR-коды**: Генерация QR-кодов для быстрого подтверждения инвайтов

### 2.2 Создание профиля питомца

**Алгоритм добавления питомца:**
1. Владелец нажимает "Добавить питомца"
2. Заполняет обязательные поля: имя, тип (PetType), порода (Breed), дата рождения
3. Опционально: вес, описание, особые потребности, медицинские условия, фото
4. Система автоматически устанавливает текущего пользователя как основного владельца (main_owner)
5. Система добавляет основного владельца в список владельцев (owners)
6. Система создает уникальный ID питомца
7. Питомец добавляется в список владельца

**Валидация данных:**
- Проверка корректности даты рождения (не может быть в будущем)
- Валидация веса (должен быть положительным числом)
- Проверка размера загружаемого фото (стандартная валидация Django)
- Обязательное указание основного владельца (main_owner не может быть пустым)
- Проверка наличия хотя бы одного владельца в списке owners
- Проверка, что основной владелец входит в список владельцев

### 2.3 Фильтрация и поиск питомцев

**Текущая реализация:**
- Базовая фильтрация по владельцам (только питомцы текущего пользователя)
- Поиск по имени питомца
- Сортировка по дате создания

**Отсутствующий функционал (ГЭП):**
- Фильтрация по типу питомца (кошки, собаки, птицы и т.д.)
- Фильтрация по породе
- Фильтрация по возрасту/периоду
- Фильтрация по геолокации (близость к определенной точке)
- Фильтрация по медицинским условиям
- Фильтрация по статусу (активные, архивные)
- Расширенный поиск с множественными критериями
- Сортировка по различным параметрам (возраст, вес, дата последнего посещения)

**Планируемые улучшения:**
- API эндпоинт для расширенного поиска питомцев
- Фильтры по типу, породе, возрасту, геолокации
- Поиск по медицинским условиям и особым потребностям
- Сортировка по различным критериям
- Пагинация результатов поиска

### 2.4 Медицинская карта питомца

**Структура карты:**
- Основная информация о питомце (Pet): имя, тип, порода, дата рождения, вес, описание, особые потребности, медицинские условия, фото
- Медицинские записи (MedicalRecord): заголовок, описание, дата, вложения, дата следующего посещения
- Записи о процедурах (PetRecord): выполненные услуги с привязкой к учреждению, сотруднику, описанием, результатами, рекомендациями, серийным номером
- Документы (PetRecordFile): файлы с метаданными (даты выдачи/истечения, номер, орган выдачи), привязанные к записям или питомцу
- Типы документов (DocumentType): настройка обязательных полей для разных типов документов

**Доступ к медицинской карте:**
- **Владельцы питомца** (`pet__owners`) имеют полный доступ к медицинской карте (просмотр, создание, редактирование)
- **Временный доступ** предоставляется через модель `PetAccess`:
  - Владелец может дать временный доступ другому пользователю (например, ситтеру во время передержки)
  - Доступ имеет срок действия (`expires_at`)
  - Настраиваемые права доступа (`permissions`): чтение, бронирование, редактирование
- **Сотрудники учреждений** могут создавать записи для питомцев, которым они оказывают услуги
- **Системные администраторы** имеют полный доступ

**Алгоритм ведения карты:**
1. Владелец питомца или специалист учреждения открывает карту питомца
2. Добавляет запись о процедуре с описанием и результатами
3. Прикрепляет документы (файлы) с метаданными
4. Указывает рекомендации и дату следующего посещения
5. Система сохраняет запись с временной меткой

### 2.5 Управление владельцами питомца

**Основной владелец:**
- Создает профиль питомца
- Имеет полные права на управление
- Может приглашать совладельцев через систему инвайтов
- Может передавать права основного владельца
- Получает все уведомления о питомце

**Совладельцы:**
- Приглашаются основным владельцем через систему инвайтов
- Имеют права доступа к информации о питомце
- Могут просматривать медицинскую карту и записи
- Получают уведомления о важных событиях
- НЕ могут изменять основную информацию или удалять питомца

**Алгоритм назначения совладельца:**
1. Основной владелец создает инвайт типа 'invite'
2. Вводит email потенциального совладельца
3. Система отправляет email с токеном для подтверждения
4. Пользователь принимает инвайт через ссылку или QR-код
5. Получает доступ к профилю питомца

**Удаление совладельца:**
1. Основной владелец открывает список совладельцев
2. Выбирает совладельца для удаления
3. Подтверждает действие
4. Совладелец теряет доступ к питомцу
5. Отправляется уведомление об удалении

**Примечание:** Совладелец также может самостоятельно удалить себя из списка владельцев (см. раздел 2.6).

### 2.5 Передача питомца другому владельцу

**Алгоритм передачи:**
1. Основной владелец создает инвайт типа 'transfer'
2. Вводит email нового основного владельца
3. Система отправляет email с токеном для подтверждения
4. Новый владелец принимает инвайт
5. Права основного владельца передаются
6. Старый владелец становится совладельцем

### 2.6 Самостоятельное снятие обязанностей совладельца

**Алгоритм самостоятельного снятия:**
1. Совладелец открывает профиль питомца
2. Нажимает "Покинуть питомца" или "Удалить себя из совладельцев"
3. Система проверяет, что он не является основным владельцем
4. Если он не основной владелец - совладелец удаляется из списка владельцев
5. Если он основной владелец - система показывает сообщение о необходимости передачи прав
6. Отправляются уведомления основному владельцу и другим совладельцам

**Ограничения самостоятельного снятия:**
- Совладелец может удалить себя только если он не является основным владелецем
- Если совладелец является единственным владельцем, он должен сначала передать права
- При снятии обязанностей отправляются уведомления всем заинтересованным сторонам

**Уведомления:**
- Основной владелец получает уведомление о том, что совладелец покинул питомца
- Другие совладельцы получают уведомление об изменении состава владельцев
- Система ведет историю изменений владельцев для аудита

### 2.7 Удаление питомца

**Алгоритм удаления питомца:**
1. **Только основной владелец (main_owner)** может удалить питомца
2. Основной владелец открывает профиль питомца
3. Нажимает "Удалить питомца"
4. Система запрашивает подтверждение и причину удаления:
   - Смерть питомца
   - Потеря питомца
   - Передача в приют/другому владельцу
   - Другая причина (с описанием)
5. Если питомец имеет нескольких владельцев - система уведомляет всех совладельцев
6. Питомец удаляется из системы с сохранением истории в архиве

**Ограничения:**
- Только основной владелец (main_owner) или системный администратор могут удалить питомца
- Совладельцы НЕ могут удалить питомца
- При попытке удаления совладельцем система возвращает ошибку доступа
- Система требует указания причины удаления
- При удалении отправляются уведомления всем совладельцам

### 2.8 Обработка недееспособности владельца

**Система автоматической обработки недееспособности владельцев питомцев**

Система реализует три основных флоу для обработки различных сценариев недееспособности:

#### **ФЛОУ 1: Автоматическое обнаружение неактивности основного владельца**

**Триггер:** Еженедельная проверка неактивных основных владельцев
**Цель:** Определить статус питомца и владельца
**Действие:** Уведомление всех владельцев с вопросом о подтверждении

**Алгоритм:**
1. Система еженедельно проверяет всех питомцев с неактивными основными владельцами
2. Критерий неактивности: отсутствие входа в систему более 6 месяцев (настраиваемый параметр)
3. Для каждого неактивного владельца создается запись `PetOwnerIncapacity` со статусом `pending_confirmation`
4. Система автоматически отправляет уведомления всем владельцам питомца (основному и совладельцам)
5. Устанавливается дедлайн подтверждения (по умолчанию 30 дней, настраиваемый параметр)
6. Если в течение дедлайна нет подтверждения, система выполняет автоматическое действие

#### **ФЛОУ 2: Совладелец сообщает об утрате питомца**

**Триггер:** Совладелец создает отчет "Питомец утрачен/умер"
**Цель:** Подтвердить утрату питомца
**Действие:** Уведомление всех владельцев, автоудаление через месяц

**Алгоритм:**
1. Совладелец использует API эндпоинт `/api/incapacity/report_pet_lost/`
2. Указывает ID питомца и причину утраты (опционально)
3. Система создает запись `PetOwnerIncapacity` с типом `coowner_report_pet_lost`
4. Отправляются уведомления всем владельцам питомца
5. Устанавливается дедлайн подтверждения (30 дней)
6. Если нет подтверждения в течение дедлайна, питомец автоматически удаляется

#### **ФЛОУ 3: Совладелец сообщает о недееспособности основного владельца**

**Триггер:** Совладелец создает отчет "Основной владелец недееспособен"
**Цель:** Назначить нового основного владельца
**Действие:** Уведомление всех, назначение совладельца основным через месяц

**Алгоритм:**
1. Совладелец использует API эндпоинт `/api/incapacity/report_owner_incapacity/`
2. Указывает ID питомца и причину недееспособности (обязательно)
3. Система создает запись `PetOwnerIncapacity` с типом `coowner_report_owner_incapacity`
4. Отправляются уведомления всем владельцам питомца
5. Устанавливается дедлайн подтверждения (30 дней)
6. Если нет подтверждения в течение дедлайна, система автоматически назначает совладельца основным владельцем

#### **Автоматические действия**

**Настройки автоматических действий (глобальные параметры):**
- `inactive_owner_threshold_days` - порог неактивности владельца (по умолчанию 180 дней)
- `pet_confirmation_deadline_days` - дедлайн подтверждения статуса питомца (по умолчанию 30 дней)
- `auto_delete_unconfirmed_pets` - автоматическое удаление неподтвержденных питомцев (по умолчанию True)
- `auto_assign_coowner_as_main` - автоматическое назначение совладельца основным (по умолчанию True)
- `coowner_assignment_priority` - приоритет назначения совладельца ('oldest', 'newest', 'random')

**Логика автоматических действий:**
1. **Для ФЛОУ 1 и 2** (утрата питомца):
   - Если `auto_delete_unconfirmed_pets = True` → удалить питомца
   - Если `auto_delete_unconfirmed_pets = False` → ничего не делать

2. **Для ФЛОУ 3** (недееспособность владельца):
   - Если `auto_assign_coowner_as_main = True` → назначить совладельца основным владельцем
   - Приоритет назначения определяется параметром `coowner_assignment_priority`

#### **API эндпоинты**

**Основные эндпоинты:**
- `GET /api/incapacity/` - список случаев недееспособности
- `POST /api/incapacity/report_pet_lost/` - сообщить о потере питомца
- `POST /api/incapacity/report_owner_incapacity/` - сообщить о недееспособности владельца
- `POST /api/incapacity/{id}/confirm_pet_status/` - подтвердить статус питомца
- `GET /api/incapacity/my_cases/` - мои случаи недееспособности
- `GET /api/incapacity/{id}/notifications/` - уведомления по случаю

**Эндпоинты уведомлений:**
- `GET /api/incapacity-notifications/` - список уведомлений пользователя
- `POST /api/incapacity-notifications/{id}/mark_as_read/` - отметить как прочитанное

#### **Периодические задачи**

**Автоматические задачи (Celery):**
- `check_inactive_owners_task` - еженедельная проверка неактивных владельцев
- `process_deadline_actions_task` - ежедневная обработка действий по истечении дедлайнов
- `send_incapacity_notifications_task` - отправка уведомлений
- `cleanup_old_incapacity_records_task` - очистка старых записей (ежемесячно)

#### **Модели данных**

**PetOwnerIncapacity:**
- Связь с питомцем и основным владельцем
- Тип флоу (автоматическое обнаружение, отчет о потере, отчет о недееспособности)
- Статус (ожидание подтверждения, подтверждено, разрешено, автоматически удалено, назначен совладелец)
- Дедлайн подтверждения
- Автоматическое действие и новый основной владелец
- История уведомлений

**PetIncapacityNotification:**
- Связь с записью о недееспособности
- Тип уведомления (запрос подтверждения, предупреждение о дедлайне, уведомление о действии)
- Получатель и статус отправки
- Содержание уведомления

#### **Уведомления**

**Типы уведомлений:**
- `confirmation_request` - запрос подтверждения статуса питомца
- `deadline_warning` - предупреждение о приближении дедлайна
- `auto_action_notification` - уведомление о выполненных автоматических действиях
- `resolution_notification` - уведомление о разрешении случая

**Каналы доставки:**
- Email уведомления через Gmail API
- Push-уведомления (планируется)
- Внутренние уведомления в системе

#### **Безопасность и права доступа**

**Проверки прав доступа:**
- Только владельцы питомца могут подтверждать его статус
- Только совладельцы могут сообщать о недееспособности основного владельца
- Любой владелец может сообщить о потере питомца
- Администраторы видят все случаи недееспособности

**Защита от злоупотреблений:**
- Проверка на существование активных случаев недееспособности
- Валидация входных данных
- Логирование всех действий
- Транзакционная обработка критических операций

## 3. Система передержки питомцев

### 3.1 Поиск ситтеров

**Алгоритм поиска:**
1. Владелец указывает параметры поиска:
   - Координаты или местоположение (геолокация устройства)
   - Радиус поиска в км
   - Тип питомца
   - Даты передержки
   - Тип компенсации (платная/бесплатная)
   - Минимальный рейтинг ситтера
   - Максимальная цена (для платных услуг)
2. Система фильтрует ситтеров по критериям:
   - Расстояние от указанной точки
   - Типы питомцев, с которыми работает ситтер
   - Доступность в указанные даты
   - Тип компенсации
   - Рейтинг ситтера
   - Цена услуг
3. Возвращает отсортированный список подходящих ситтеров

**Фильтры поиска:**
- По расстоянию от указанной точки
- По типам питомцев
- По датам доступности ситтера
- По типу компенсации (платная/бесплатная)
- По рейтингу ситтера
- По цене услуг
- По расписанию работы ситтера

**Результат поиска:**
- Список ситтеров с информацией о расстоянии, рейтинге, услугах
- Возможность просмотра профиля ситтера
- Возможность создания объявления о передержке для выбранного ситтера

### 3.2 Создание объявления о передержке

**Алгоритм создания объявления:**
1. Владелец питомца создает объявление (PetSittingAd) после поиска ситтеров
2. Указывает питомца, даты передержки, описание
3. Выбирает тип компенсации (платная/бесплатная)
4. Указывает максимальное расстояние для поиска ситтеров
5. Система публикует объявление и уведомляет подходящих ситтеров

**Объявление о передержке (PetSittingAd):**
- Связь с питомцем и владельцем
- Даты начала и окончания передержки
- Описание требований (опционально)
- Статус объявления ('active' / 'closed')
- Структурированный адрес (связь с моделью Address)
- Максимальное расстояние для поиска ситтеров
- Тип компенсации ('paid' / 'unpaid')

### 3.3 Отклики ситтеров

**Алгоритм отклика:**
1. Ситтер просматривает доступные объявления
2. Откликается на подходящее объявление (PetSittingResponse)
3. Добавляет сообщение владельцу (опционально)
4. Система уведомляет владельца о новом отклике
5. Владелец принимает или отклоняет отклик

**Отклик ситтера (PetSittingResponse):**
- Связь с объявлением и ситтером
- Сообщение владельцу (опционально) - текстовое поле для краткого сообщения
- Статус отклика ('pending' / 'accepted' / 'rejected')

**Примечание:** Полноценная система чата между владельцами и ситтерами планируется к реализации в будущих версиях (Chat Module с WebSocket/REST API, моделями Message и Conversation).

### 3.6 Управление процессом передержки

**Алгоритм управления:**
1. После принятия отклика создается запись PetSitting
2. Система отслеживает статусы подтверждения передачи и возврата
3. По завершении передержки владелец может оставить отзыв
4. Система обновляет рейтинг ситтера

**Статусы передержки:**
- 'waiting_start' - ожидание начала
- 'active' - передержка активна
- 'waiting_end' - ожидание завершения
- 'completed' - завершена
- 'cancelled' - отменена

**Подтверждения:**
- owner_confirmed_start - владелец подтвердил передачу
- sitter_confirmed_start - ситтер подтвердил получение
- owner_confirmed_end - владелец подтвердил возврат
- sitter_confirmed_end - ситтер подтвердил возврат

**Отмена передержки:**
- Передержку может отменить как владелец питомца, так и ситтер, если процесс ещё не завершён или не отменён ранее.
- После отмены обе стороны получают уведомления.

### 3.5 Система отзывов

**Алгоритм отзыва:**
1. После завершения передержки система предлагает владельцу оставить отзыв (опционально)
2. **Только владелец питомца** может оставить отзыв о ситтере
3. **Ситтер НЕ может оценить себя сам** - система предотвращает самооценку
4. Владелец оценивает ситтера (1-5 звезд, опционально)
5. Добавляет текстовый отзыв (опционально)
6. Система обновляет рейтинг ситтера только при наличии оценки

**Отзыв (Review):**
- Связь с записью о передержке и автором отзыва (только владелец)
- Рейтинг (1-5 звезд, опционально)
- Текстовый отзыв (опционально)
- Защита от самооценки ситтера

## 4. ГЛОБАЛЬНАЯ НАСТРОЙКА И СПРАВОЧНИКИ

### 4.1 Глобальный справочник услуг

**Структура:**
- Единая модель Service для категорий и услуг
- Иерархия: категории → подкатегории → услуги (через parent)
- Базовые поля: название, описание, код, иконка, периодичность, обязательность, напоминания

**Использование:**
- Категории и услуги создаются и редактируются администратором
- Учреждения используют эти категории для создания собственных услуг

**Примечание:**
- Нет стандартных параметров или сложной валидации на уровне справочника — только базовые поля и иерархия

### 4.2 Справочник пород животных

**Структура справочника:**
- **Типы животных** - собаки, кошки, птицы, грызуны и т.д.
- **Породы** - конкретные породы в рамках типа
- **Базовые поля** - название, код, описание породы

**Алгоритм управления:**
1. Системный администратор добавляет новый тип животного
2. Создает породы для данного типа
3. Указывает название, код и описание породы
4. Справочник используется при создании профилей питомцев

### 4.3 Справочник документов

**Структура справочника:**
- **Типы документов** - паспорт, ветеринарная книжка, родословная и т.д.
- **Настройка обязательных полей** - для каждого типа документа можно указать, какие поля обязательны
- **Связь с категориями услуг** - типы документов могут быть связаны с определенными услугами

**Алгоритм управления:**
1. Системный администратор создает тип документа
2. Настраивает, какие поля обязательны для данного типа (дата выдачи, дата истечения, орган выдачи, номер документа)
3. Связывает тип документа с категориями услуг (опционально)
4. Справочник используется при загрузке документов питомцев

### 4.4 Глобальные настройки системы

**Настройки геолокации:**
- Длительность кэша геокодирования (30 дней)
- Таймаут API запросов (10 секунд)
- Максимальное количество попыток API (3)
- Задержка между попытками (1 секунда)
- Минимальный уровень уверенности геокодирования (0.8)
- Язык по умолчанию для API (en)
- Включение/выключение кэширования
- Период очистки истекшего кэша (7 дней)

**Настройки уведомлений:**
- **Шаблоны email-сообщений** - создание и редактирование текста уведомлений (HTML и текстовые версии)
- **Настройки push-уведомлений** - типы уведомлений, обязательные/необязательные, включение/выключение
- **Время отправки напоминаний** - мгновенно, за 30 мин, за 1 час, за 2 часа, за 6 часов, за 12 часов, за 24 часа
- **Частота уведомлений** - ежедневно, еженедельно, ежемесячно, ежегодно, произвольный интервал
- **Каналы доставки** - email, push, in-app уведомления
- **Настройки пользователей** - предпочтения по типам уведомлений и каналам

**Примечание:** Связь конкретных событий (создание бронирования, отмена, изменение цены и т.д.) с уведомлениями жестко прописана в коде через Django сигналы. Администратор настраивает только содержание, время и каналы доставки уведомлений.

**Примечание 2:** Планируется реализация гибкой системы связей событий с шаблонами уведомлений через админский интерфейс, что позволит администраторам создавать новые правила уведомлений без изменения кода.

**Гибкая система правил уведомлений:**
- **Модель правил** - создание и управление правилами связей событий с уведомлениями
- **Условия срабатывания** - настройка условий для отправки уведомлений (VIP-клиенты, суммы, время)
- **Приоритеты правил** - система приоритизации (critical, high, medium, low)
- **Наследование правил** - глобальные → пользовательские настройки
- **Валидация условий** - проверка корректности правил при создании
- **Тестирование правил** - возможность протестировать правило на тестовых данных
- **Статистика срабатываний** - мониторинг использования правил
- **API управления** - программное управление правилами через API

**Настройки безопасности:**
- Политика паролей
- Настройки сессий
- Ограничения на вход
- Настройки аудита
**ГЭП**

**Настройки бизнес-логики:**

**Время отмены бронирования**: Настраиваемые параметры для определения допустимого времени отмены бронирования без штрафных санкций. Система учитывает различные типы услуг и учреждений, позволяя администратору устанавливать гибкие правила отмены в зависимости от специфики услуг.

**Автоматическое завершение:**
1. Система раз в час (или с другой заданной периодичностью) проверяет все бронирования, которые начались более N дней назад (обычно 1 день = 24 часа), но не были завершены вручную.
2. Такие бронирования автоматически переводятся в статус "завершено".
3. Клиенту отправляется уведомление о завершении.
4. Все отчёты, аналитика, рейтинги и дашборды автоматически учитывают автозавершённые записи (например, количество завершённых бронирований, процент успешных записей, выручка, активность пользователей и т.д.).

**Настройки рейтингов**: Параметры для расчета рейтингов учреждений и сотрудников, включая весовые коэффициенты для отзывов, жалоб и отмен. Система поддерживает модерацию отзывов, обнаружение подозрительной активности и автоматическую фильтрацию недобросовестных оценок.

**Параметры блокировки учреждений**: Шаблоны и настройки для автоматической блокировки учреждений при нарушении правил. Включает различные типы нарушений, сроки блокировки, условия восстановления и систему уведомлений о нарушениях с возможностью обжалования.

## 5. УПРАВЛЕНИЕ УЧРЕЖДЕНИЯМИ

### 5.1 Регистрация учреждения

**Алгоритм регистрации:**
1. Администратор учреждения заполняет заявку
2. Указывает: название, адрес, контакты, специализации
3. Загружает документы (лицензии, сертификаты) в случае, если учреждение предоставляет услуги, которые требуют лицензирования / сертификации
4. Система проверяет корректность данных
5. После модерации учреждение активируется

**Валидация данных:**
- Проверка уникальности названия и адреса
- Валидация контактных данных
- Проверка необходимости документов на основе выбранных специализаций
- Проверка формата загруженных документов (если требуются)
- Геокодирование адреса

### 5.2 Управление услугами учреждения

**Алгоритм добавления услуги:**
1. Администратор выбирает услугу из глобального справочника
2. Указывает стоимость услуги для своего учреждения
3. Назначает специалистов, которые оказывают услугу
4. Устанавливает длительность процедуры
5. Система проверяет уникальность услуги для учреждения
6. Услуга становится доступной для бронирования

### 5.3 Управление персоналом учреждения

**Алгоритм добавления сотрудника:**
1. Администратор приглашает специалиста по email
2. Специалист регистрируется в системе (если еще не зарегистрирован)
3. Администратор подтверждает и назначает услуги сотруднику

**Расписание специалистов:**
- Установка рабочих часов
- Указание перерывов
- Назначение дней отпуска
- Учет больничных
- Создание шаблонов расписания (типовые графики)
- Массовое применение шаблонов к сотрудникам или на период

**Управление доступом:**
1. Назначение ролей сотрудникам
2. Ограничение доступа к функциям
3. Блокировка/разблокировка аккаунтов

## 6. ГЕОЛОКАЦИЯ И ПОИСК УСЛУГ

### 6.1 Система геолокации

**Алгоритм определения местоположения:**
1. **Приоритет 1: Геолокация устройства**
   - Пользователь разрешает доступ к геолокации
   - Система получает координаты (широта, долгота) с точностью до 50 метров
   - Координаты сохраняются в профиле пользователя
   - При поиске услуг используется текущее местоположение

2. **Приоритет 2: Выбор района на карте**
   - Если геолокация недоступна или пользователь отказал в доступе
   - Пользователь может выбрать район поиска на интерактивной карте
   - Система получает координаты выбранной точки
   - Координаты сохраняются в профиле пользователя

3. **Приоритет 3: Ручной ввод адреса**
   - Если карта недоступна, пользователь может ввести адрес вручную
   - Система геокодирует адрес через Google Maps API
   - Полученные координаты сохраняются в профиле пользователя

**Кэширование геоданных:**
1. Адреса учреждений геокодируются при добавлении
2. Координаты сохраняются в базе данных
3. Создаются индексы по полям latitude/longitude для быстрого поиска (пространственные индексы PostGIS/GiST не используются, требуется доработка для масштабирования)
4. Кэш обновляется при изменении адреса

### 6.2 Поиск услуг

**Алгоритм поиска:**
1. Пользователь выбирает категорию услуги
Пользователь выбирает конкретную услугу. Дата и время оказания услуги могут быть выбраны, но не являются обязательными для заполнения.
- Если не указано время — система отображает первое доступное время записи в выбранный день.
- Если не указана дата — система отображает первое доступное окно вообще.
- Если указаны дата и/или время как ограничения снизу, для всех учреждений выводятся первые свободные окна начиная с указанного времени.
2. Система определяет текущее местоположение
3. Выполняется поиск учреждений в радиусе 10 км (по умолчанию)
4. Применяются фильтры: рейтинг, цена, доступность
5. Результаты сортируются по релевантности

**Фильтрация результатов:**
- По радиусу (географическому расстоянию)
- По специализации
- По доступности записи
- По цене (диапазон)
- По рейтингу (минимальный рейтинг)

**Сортировка результатов:**
- По расстоянию (ближайшие первыми)
- По рейтингу учреждения
- По цене услуги
- По доступности услуги

**Фильтрация по питомцам (ГЭП):**
- По типу питомца (кошки, собаки, птицы и т.д.)
- По породе питомца
- По возрасту/периоду жизни питомца
- По медицинским условиям питомца
- По особым потребностям питомца
- По весу питомца (для услуг, где это важно)

**Планируемые улучшения поиска:**
- Интеграция с профилями питомцев пользователя
- Персонализированные рекомендации на основе истории питомца
- Фильтрация по совместимости услуг с конкретным питомцем
- Учет медицинских противопоказаний
- Рекомендации по периодическим процедурам

### 6.3 Отображение на карте

**Алгоритм отображения:**
1. Загружается карта с центром в местоположении пользователя
2. Отображаются маркеры учреждений и ситтеров в радиусе поиска
3. При клике на маркер показывается информация об учреждении или ситтере
4. Отображается расстояние и время в пути
5. Показывается доступность записи/услуг (для выбранной услуги и времени, либо ближайшее доступное окно)
- Если не указано время — система отображает первое доступное время записи в выбранный день.
- Если не указана дата — система отображает первое доступное окно вообще.
- Если указаны дата и/или время как ограничения снизу, для всех учреждений выводятся первые свободные окна начиная с указанного времени.

**Что отображается на карте:**
- **Учреждения (Provider)** - ветеринарные клиники, зоомагазины, груминг-салоны
- **Ситтеры (Sitter)** - частные передержчики питомцев
- **Информация о маркерах:**
  - Название учреждения/ситтера
  - Адрес и контакты
  - Рейтинг и отзывы
  - Доступные услуги
  - Расстояние от пользователя
  - Статус доступности (для выбранной услуги и времени, либо ближайшее доступное окно)
  - Если не указано время — система отображает первое доступное время записи в выбранный день.
- Если не указана дата — система отображает первое доступное окно вообще.
- Если указаны дата и/или время как ограничения снизу, для всех учреждений выводятся первые свободные окна начиная с указанного времени.

**Фильтрация на карте:**
- По типу (только учреждения, только ситтеры, все)
- По услугам (конкретные услуги)
- По дате и/или времени оказания услуги
- По рейтингу (минимальный рейтинг)
- По расстоянию (радиус поиска)
- По цене (максимальная цена для ситтеров)

## 7. СИСТЕМА БРОНИРОВАНИЯ

### 7.1 Алгоритм бронирования (целевой)

1. Пользователь выбирает услугу и (опционально) дату/время.
2. Система отображает на карте учреждения в радиусе поиска с ближайшими свободными окнами для выбранной услуги, начиная с указанной даты/времени (если не указано — с 00:00:01 сегодняшнего дня), с ценами.
3. Пользователь фильтрует учреждения по нужным параметрам и выбирает подходящее.
4. При клике на учреждение система показывает ближайшие свободные окна на заданный горизонт (например, 7/14/30 дней) от выбранной даты/времени.
5. Пользователь выбирает окно и инициирует бронирование.
6. Система пытается провести бронирование атомарно. Если окно уже занято — сообщает об ошибке, убирает окно из доступных и предлагает выбрать другое.
7. Процесс повторяется до успешного бронирования или отказа пользователя.
8. Система реализует защиту от злоупотреблений (лимиты, антибот, rate limit и т.д.).

Логика расчёта свободных окон:
1. Система строит расписание на основе рабочих часов учреждения и специалистов.
2. Учитываются уже занятые слоты (существующие записи).
3. Учитывается время на выполнение услуги (длительность процедуры).
4. Учитываются перерывы, выходные, отпуска, больничные.
5. Для каждой услуги и специалиста на лету формируются возможные интервалы для записи ("окна").
6. При поиске система возвращает только те окна, которые не пересекаются с уже существующими записями и соответствуют длительности услуги.

### 7.2 Управление записями

**Алгоритм отмены записи:**
1. Пользователь может отменить только своё бронирование до его начала.
2. Учреждение (админ/сотрудник) может отменить только свои бронирования до их начала.
3. При больничном сотрудника система пытается автоматически перепланировать бронирования на других сотрудников. Если это невозможно — бронирование остаётся без исполнителя, система информирует администратора, и администратор принимает решение о дальнейших действиях (отмена/перенос вручную).
4. Автоматической отмены бронирований при закрытии учреждения или больничном нет.

**Автоматическое завершение:**
1. Система раз в час (или с другой заданной периодичностью) проверяет все бронирования, которые начались более N дней назад (обычно 1 день = 24 часа), но не были завершены вручную.
2. Такие бронирования автоматически переводятся в статус "завершено".
3. Клиенту отправляется уведомление о завершении.
4. Статистика обновляется автоматически. То есть, все отчёты, аналитика, рейтинги и дашборды автоматически учитывают автозавершённые записи (например, количество завершённых бронирований, процент успешных записей, выручка, активность пользователей и т.д.).

## 8. СИСТЕМА РЕЙТИНГОВ И ОТЗЫВОВ

### 8.1 Оценка услуг

**Алгоритм оценки:**
1. После завершения записи система предлагает (но не требует) оценить услугу.
2. Пользователь может поставить оценку от 1 до 5 звёзд и/или оставить текстовый отзыв (оба действия опциональны, но если создаётся отзыв — рейтинг обязателен).
3. Система рассчитывает средний рейтинг учреждения по всем оставленным оценкам.
4. Отзыв публикуется после модерации.

**Расчет рейтинга:**
- Итоговый рейтинг рассчитывается по формуле:
  rating = reviews_score * reviews_weight + complaints_score * complaints_weight + cancellations_score * cancellations_weight + no_show_score * no_show_weight
- Веса по умолчанию: reviews_weight = 0.6, complaints_weight = 0.25, cancellations_weight = 0.1, no_show_weight = 0.05. Веса можно изменить через админку для каждого учреждения/специалиста.
- Новые отзывы должны иметь больший вес за счёт экспоненциального затухания (чем старше отзыв, тем меньше его влияние на рейтинг). В текущей реализации это не реализовано, все отзывы учитываются одинаково.

### 8.2 Модерация отзывов

**Алгоритм модерации:**
1. Пользователь отправляет отзыв.
2. Система отправляет текст отзыва в Google Perspective API.
3. API возвращает оценки по категориям (токсичность, оскорбления, угроза, спам и др.).
4. Если все оценки ниже установленных порогов — отзыв публикуется автоматически.
5. Если хотя бы по одной категории превышен порог — отзыв отправляется на ручную модерацию или отклоняется автоматически (в зависимости от политики).
6. Пользователь получает уведомление о результате модерации.

**Пороговые значения для категорий** (например, TOXICITY > 0.8, INSULT > 0.7, THREAT > 0.7, SPAM > 0.7) настраиваются в административной панели.

**Ручные фильтры, списки запрещённых слов и локальные проверки не используются.**

**Преимущества:**
- Высокая точность и актуальность фильтрации
- Нет необходимости поддерживать собственные списки слов
- Простота масштабирования

**Опционально:**
- Для спорных случаев (оценки близки к порогам) — ручная модерация администратором.

## 9. СИСТЕМА УВЕДОМЛЕНИЙ

### 9.1 Email-уведомления

**Типы уведомлений:**
- Подтверждение регистрации
- Напоминания о записях
- Уведомления об отменах
- Новые отзывы
- Изменения в расписании

**Алгоритм отправки:**
1. Система определяет событие для уведомления
2. Выбирает шаблон письма
3. Заполняет персональные данные
4. Отправляет email через Gmail API (Google API) с использованием OAuth2 (SMTP не используется)
5. Логирует результат отправки

### 9.2 Push-уведомления

**Алгоритм push-уведомлений:**
1. Пользователь разрешает push-уведомления в браузере или мобильном приложении (Android/iOS)
2. Система сохраняет токен устройства (Web Push, FCM для Android, APNS для iOS)
3. При наступлении события формируется уведомление
4. Система определяет тип устройства пользователя:
    - для браузера — отправляет через Web Push API
    - для Android — отправляет через Firebase Cloud Messaging (FCM)
    - для iOS — отправляет через Apple Push Notification Service (APNS)
5. Пользователь получает уведомление на соответствующем устройстве (браузер или мобильное приложение)

### 9.3 Напоминания о процедурах

**Алгоритм напоминаний:**
1. Система анализирует медицинские карты питомцев
2. Определяет периодические процедуры (прививки, осмотры)
3. Рассчитывает дату следующей процедуры
4. Отправляет напоминание за 7 дней
5. Повторяет напоминание за 1 день

**Алгоритм напоминаний о процедурах:**
1. При создании напоминания (например, при бронировании или для периодической процедуры) в базе данных создаётся запись с параметрами: питомец, услуга/процедура, описание, частота (ежедневно, еженедельно, ежемесячно, ежегодно, по индивидуальному интервалу), дата начала, дата окончания (опционально), и временем следующего напоминания (`next_notification`).
2. Сервис-планировщик (например, Celery Beat) периодически (раз в N минут/часов) сканирует таблицу напоминаний.
3. Для всех активных напоминаний, у которых наступило время (`next_notification <= now`), система автоматически отправляет уведомление пользователю (email, push, in-app).
4. После отправки система обновляет время последнего уведомления (`last_notified`) и пересчитывает время следующего напоминания (`next_notification`) согласно заданной частоте.
5. Пользователь может настраивать параметры напоминания (частота, канал доставки, отключение), но отправка происходит автоматически.

### 9.4 Гибкая система правил уведомлений

**Модель NotificationRule:**
- `event_type` - тип события (booking_created, booking_cancelled, price_changed, etc.)
- `condition` - условие срабатывания (Python-выражение для оценки)
- `template` - шаблон уведомления
- `priority` - приоритет правила (low, medium, high, critical)
- `channels` - каналы доставки (email, push, in_app)
- `is_active` - активность правила
- `inheritance` - наследование (global, user_specific)
- `created_by` - создатель правила
- `created_at` - дата создания
- `updated_at` - дата обновления

**Админский интерфейс управления правилами:**
1. **Создание правила:**
   - Выбор типа события из списка доступных
   - Настройка условия срабатывания через визуальный редактор
   - Выбор шаблона уведомления
   - Установка приоритета и каналов доставки
   - Настройка наследования (глобальное/пользовательское)

2. **Редактирование правила:**
   - Изменение всех параметров активного правила
   - Временное отключение/включение правила
   - Просмотр статистики срабатываний

3. **Управление шаблонами:**
   - Создание новых шаблонов уведомлений
   - Редактирование существующих шаблонов
   - Предварительный просмотр шаблонов
   - Валидация синтаксиса шаблонов

**Примеры условий срабатывания:**
- `user.is_vip == True` - только для VIP-клиентов
- `booking.total_amount > 1000` - для дорогих бронирований
- `hours_before_start < 24` - за 24 часа до начала
- `price_increase_percent > 10` - повышение цены более чем на 10%
- `user.booking_count > 5` - для постоянных клиентов

**Система приоритетов:**
- **Critical** - критические уведомления (отмены, блокировки)
- **High** - важные уведомления (VIP-клиенты, дорогие услуги)
- **Medium** - стандартные уведомления (подтверждения, напоминания)
- **Low** - информационные уведомления (новости, обновления)

**Наследование правил:**
1. **Глобальные правила** - применяются ко всем пользователям
2. **Пользовательские правила** - переопределяют глобальные для конкретного пользователя
3. **Приоритет пользовательских** - пользовательские правила имеют приоритет над глобальными

**Флоу обработки событий:**
1. **Событие происходит** (создание бронирования, отмена, изменение цены)
2. **Система определяет тип события** и получает все активные правила для этого типа
3. **Правила сортируются по приоритету** (critical → high → medium → low)
4. **Для каждого правила:**
   - Проверяется условие срабатывания
   - Если условие выполняется, отправляется уведомление по шаблону
   - Логируется срабатывание правила
5. **Пользователь получает уведомления** по выбранным каналам

**Валидация и аудит:**
- **Валидация условий** - проверка корректности Python-выражений
- **Тестирование правил** - возможность протестировать правило на тестовых данных
- **Логирование срабатываний** - запись всех срабатываний правил
- **Статистика использования** - количество срабатываний, успешных доставок
- **Мониторинг производительности** - время обработки правил

**API для управления правилами:**
- `GET /api/admin/notification-rules/` - список всех правил
- `POST /api/admin/notification-rules/` - создание нового правила
- `PUT /api/admin/notification-rules/<id>/` - редактирование правила
- `DELETE /api/admin/notification-rules/<id>/` - удаление правила
- `POST /api/admin/notification-rules/<id>/test/` - тестирование правила
- `GET /api/admin/notification-rules/<id>/stats/` - статистика правила

## 10. БИЛЛИНГ И ПЛАТЕЖИ

### 10.1 Система контрактов

**Алгоритм создания и активации контракта:**
1. **Стандартные условия сотрудничества** (включая комиссии, сроки оплаты и базовые юридические положения) задаются администратором системы через справочник типов контрактов (`ContractType`). Для каждого типа контракта могут быть определены:
   - Стандартные комиссии (процент/фиксированная сумма, периодичность)
   - Стандартные сроки оплаты (отсрочка, период выставления счетов)
   - Общие условия сотрудничества (права, обязанности, ответственность, порядок расторжения и др.)
   - Пороги блокировки (наследуются из глобальных, но могут быть изменены менеджером)
2. **Менеджер по биллингу** может создать новый контракт для учреждения, выбрав тип контракта и, при необходимости, изменив отдельные параметры (комиссии, сроки оплаты, условия).
3. **Если все параметры контракта соответствуют стандартным для выбранного типа** (комиссии, сроки оплаты, условия сотрудничества не изменялись), менеджер может сразу активировать контракт самостоятельно — статус меняется на `'active'`.
4. **Если хотя бы один из параметров отличается от стандартных** (например, индивидуальная комиссия, особый срок оплаты, изменённые условия сотрудничества, блокировок), контракт создаётся в статусе `'draft'` и требует обязательного утверждения администратором системы. Только после утверждения админом статус может быть изменён на `'active'`.
5. **Подписание контракта**:
Для контрактов допускается электронная оферта (акцепт условий через интерфейс, "галочка").
6. **Все действия по созданию, изменению и активации контракта логируются с указанием пользователя, времени и причины.**

### 10.2 Обработка платежей между поставщиками услуг и сервисом

**Алгоритм обработки платежей:**
1. После завершения бронирования система фиксирует оказанную услугу и начисляет комиссию согласно условиям контракта.
2. На основании данных о бронированиях и других операциях формируется счёт (Invoice) для учреждения — с детализацией начисленных комиссий, абонентских плат, штрафов и т.д.
3. Учреждению выставляется счёт на оплату через личный кабинет И по email.
4. После поступления оплаты от учреждения оператор или бухгалтерия вручную подтверждает платёж в системе (изменяет статус платежа/счёта на "оплачен").
5. Система обновляет статус счёта и уведомляет учреждение о зачислении средств.

**Расчёт комиссии:**
- Применяется процент или фиксированная сумма согласно условиям контракта (Contract/ContractType).
- Учитываются скидки, бонусы, штрафы, абонентские платы (если предусмотрено контрактом).
- Формируется отчётность для учреждения и платформы.

### 10.3 Система блокировки

**Алгоритм блокировки:**
1. Система проверяет задолженность учреждения
2. Сравнивает с пороговыми значениями
3. При превышении применяет блокировку
4. Отправляет уведомления ответственным лицам
5. Блокирует доступ к функциям согласно уровню

**Периодика проверки задолженности:**
- Автоматические проверки выполняются по расписанию (по умолчанию ежедневно в 02:00)
- Частота проверок настраивается 
- Поддерживаются различные расписания: почасово, ежедневно, еженедельно, ежемесячно
- Проверки выполняются через Celery Beat задачи

**Уровни блокировки:**
- **Уровень 0:** Нет блокировки
- **Уровень 1:** Информационное уведомление
- **Уровень 2:** Исключение из поиска
- **Уровень 3:** Полная блокировка

**Флоу разблокировки:**
1. **Автоматическая разблокировка при оплате:** При поступлении платежа, покрывающего задолженность, система автоматически снимает блокировку (если включено в настройках)
2. **Ручная разблокировка:** Администратор или менеджер по биллингу может вручную снять блокировку через API или админ-панель
   - При ручном снятии блокировки администратор **обязательно** должен выполнить одно из действий:
     - Изменить индивидуальные пороги блокировки в контракте 
     - Или исключить контракт из автоматических проверок блокировки
   - Это необходимо для предотвращения повторной автоматической блокировки при следующем анализе задолженности
3. **Уведомления о разблокировке:** При снятии блокировки отправляются уведомления учреждению и ответственным лицам

**Пороговые значения:**
- Настраиваются глобально в системе блокировки и наследуются в контракты
- Поддерживаются пороги по сумме задолженности
- Поддерживаются пороги по дням просрочки (3 уровня: информационное уведомление, исключение из поиска, полная блокировка)
- Учитывается отсрочка платежей
- Поддерживается исключение праздников и рабочих дней из расчёта просрочки

## 11. АНАЛИТИКА И ОТЧЕТЫ

### 11.1 Статистика учреждений

**Типы отчетов:**
- Количество записей по периодам
- Выручка и комиссия
- Популярные услуги
- Рейтинг и отзывы
- География клиентов
- Дебиторская задолженность

**Общие положения:**
- Все отчеты формируются вручную через административный интерфейс (или по API).
- Экспорт отчетов реализован только в формате Excel (XLSX).
- Автоматическая рассылка и PDF-экспорт не входят в MVP.
- Формирование отчетов доступно администраторам и менеджерам по необходимости.

**Логика формирования отчетов:**

1. **Количество записей по периодам**
   - Считается общее количество бронирований за выбранный период (день/неделя/месяц).
   - Группировка по учреждениям, услугам, сотрудникам учреждений.
   - Формирует администратор или менеджер по необходимости.

2. **Выручка и комиссия**
   - Суммируется стоимость завершённых бронирований за период.
   - Отдельно считается комиссия платформы (по данным биллинга).
   - Группировка по учреждениям, услугам, сотрудникам учреждений.
   - Формирует администратор или менеджер по необходимости.

3. **Популярные услуги**
   - Считается количество бронирований по каждой услуге за период.
   - Сортировка по убыванию популярности.
   - Формирует администратор или менеджер по необходимости.

4. **Рейтинг и отзывы**
   - Средний рейтинг и количество отзывов по учреждениям и услугам.
   - Группировка по учреждениям, услугам, сотрудникам учреждений.
   - Формирует администратор или менеджер по необходимости.

5. **География получателей услуг**
   - Строится распределение получателей услуг по городам/регионам (если есть данные о местоположении).
   - Формирует администратор или менеджер по необходимости.

6. **Дебиторская задолженность**
   - Считается сумма задолженности по каждому учреждению на выбранную дату/период.
   - Учитываются просроченные платежи по контрактам.
   - Формирует администратор или менеджер по необходимости.

### 11.2 Аналитика пользователей

**Цель:** Понимание роста платформы и эффективности привлечения пользователей.

**Метрики, рассчитываемые в системе:**

1. **Рост пользователей**
   - Количество новых получателей услуг за период
   - Количество новых учреждений за период
   - Динамика регистраций по дням/неделям/месяцам
   - Активация новых пользователей (кто зашёл после регистрации)

2. **Активность пользователей**
   - Количество активных получателей услуг за период
   - Количество активных учреждений за период
   - Частота использования (сколько раз пользователь заходил)

3. **Конверсия в бронирования**
   - Процент зарегистрированных, которые совершили хотя бы одно бронирование
   - Время от регистрации до первого бронирования
   - Процент завершённых бронирований (не отменённых)

**Метрики для маркетинга (опционально, через Google Analytics):**
- Источники трафика (поиск, реклама, соцсети)
- География пользователей
- Устройства (мобильные/десктоп)
- Пути пользователя по сайту

**Формирование отчётов:**
- Все метрики рассчитываются на основе данных из моделей Django
- Отчёты формируются вручную через административный интерфейс
- Экспорт в Excel
- Автоматическая рассылка не входит в MVP

## 12. АДМИНИСТРИРОВАНИЕ СИСТЕМЫ

### 12.1 Управление пользователями

**Функции администратора:**
- Просмотр всех пользователей
- Блокировка/разблокировка аккаунтов
- Изменение ролей пользователей
- Просмотр активности пользователей
- Удаление пользователей

### 12.2 Аудит системы

**Система логирования действий:**
- **Автоматическое логирование HTTP запросов:**
  - IP-адрес, User-Agent, HTTP метод, URL
  - Статус код ответа, размер контента
  - Время выполнения запроса
  - Сессия пользователя

- **Логирование действий пользователей:**
  - Создание, изменение, удаление объектов
  - Вход/выход в систему
  - Просмотр данных, экспорт/импорт
  - Блокировка/разблокировка аккаунтов
  - Приглашения, принятие/отклонение
  - Передача прав, платежи, возвраты
  - Бронирования, отмены, отзывы, жалобы
  - Системные операции

- **Логирование изменений в системе:**
  - Автоматическое отслеживание через сигналы Django
  - Изменения пользователей, питомцев, бронирований
  - Изменения контрактов, платежей, приглашений
  - Блокировка учреждений и пользователей

- **Логирование ошибок и исключений:**
  - Стандартное логирование Django
  - Уровни логирования (DEBUG, INFO, WARNING, ERROR)

**Специализированный аудит безопасности:**
- **Критически важные операции:**
  - Изменения ролей и прав доступа
  - Управление приглашениями
  - Финансовые операции
  - Операции блокировки/разблокировки
  - Передача прав владения питомцами
  - Подозрительная активность
  - Изменения конфигурации системы

- **Отслеживание изменений:**
  - Сохранение старых и новых значений
  - Причина изменения
  - Флаг критичности операции
  - Статус проверки и кто проверил

**Настройки системы аудита:**
- **Глобальные настройки:**
  - Включение/выключение логирования
  - Включение/выключение аудита безопасности
  - Периоды хранения логов (обычные и безопасности)
  - Автоматическая очистка старых логов
  - Уведомления о критических операциях
  - Минимальный уровень логирования

- **Детальные настройки:**
  - Логирование HTTP запросов
  - Логирование изменений в базе данных
  - Логирование бизнес-операций
  - Логирование системных событий

**Инструменты управления логами:**
- **Команды управления:**
  - Просмотр статистики аудита
  - Экспорт данных аудита в файлы
  - Автоматическая очистка старых логов

- **Декораторы для разработчиков:**
  - Логирование действий пользователей
  - Аудит критических операций
  - Логирование бизнес-операций
  - Аудит финансовых операций
  - Логирование изменений в БД
  - Аудит изменений ролей
  - Логирование API запросов
  - Аудит подозрительной активности

**Мониторинг безопасности:**
- Подозрительная активность
- Попытки взлома
- Нарушения политик безопасности
- Аудит доступа к данным



## 13. ИНТЕГРАЦИИ И API

### 13.1 REST API

**Реализованные API эндпоинты:**

**Аутентификация и пользователи (`/api/`):**
- `POST /api/register/` - Регистрация нового пользователя
- `POST /api/login/` - Вход в систему
- `GET /api/profile/` - Профиль пользователя
- `POST /api/google-auth/` - Аутентификация через Google
- `POST /api/token/refresh/` - Обновление JWT токена
- `POST /api/token/blacklist/` - Черный список токенов
- `POST /assign-role/` - Назначение роли пользователю
- `POST /deactivate/<user_id>/` - Деактивация пользователя
- `GET/POST /provider-forms/` - Управление заявками учреждений
- `POST /provider-forms/approve/` - Одобрение заявки учреждения
- `POST /employees/deactivate/<employee_id>/` - Деактивация сотрудника
- `DELETE /me/delete/` - Самоудаление пользователя
- `GET /search/distance/` - Поиск пользователей по расстоянию
- `GET /search/sitters/distance/` - Поиск ситтеров по расстоянию
- `POST /users/bulk-role-assignment/` - Массовое назначение ролей
- `POST /users/bulk-deactivation/` - Массовая деактивация
- `POST /users/bulk-activation/` - Массовая активация
- `GET/POST /role-invites/` - Управление инвайтами ролей
- `GET/PUT/PATCH/DELETE /role-invites/<pk>/` - Детали инвайта
- `POST /role-invites/accept/` - Принятие инвайта
- `POST /role-invites/decline/` - Отклонение инвайта
- `GET /role-invites/token/<token>/` - Инвайт по токену
- `GET /role-invites/<invite_id>/qr-code/` - QR-код инвайта
- `GET /role-invites/pending/` - Ожидающие инвайты
- `POST /role-invites/cleanup/` - Очистка инвайтов
- `POST /role-termination/` - Прекращение роли

**Питомцы (`/api/`):**
- `GET/POST /pets/` - Список и создание питомцев
- `GET/PUT/PATCH/DELETE /pets/<pk>/` - Управление питомцем
- `DELETE /pets/<pk>/delete/` - Удаление питомца
- `GET/POST /medical-records/` - Медицинские записи
- `GET/PUT/PATCH/DELETE /medical-records/<pk>/` - Управление медзаписью
- `GET/POST /records/` - Записи о питомце
- `GET/PUT/PATCH/DELETE /records/<pk>/` - Управление записью
- `POST /records/<record_id>/upload_file/` - Загрузка файла
- `GET/POST /access/` - Доступ к питомцам
- `GET/PUT/PATCH/DELETE /access/<pk>/` - Управление доступом
- `POST /pets/<pet_id>/invite/` - Приглашение к питомцу
- `POST /pets/accept-invite/` - Принятие приглашения
- `GET /pets/invite/<token>/qr/` - QR-код приглашения
- `GET /documents/<document_id>/download/` - Скачивание документа
- `GET /documents/<document_id>/preview/` - Просмотр документа

**Учреждения (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /providers/` - CRUD учреждений
- `GET/POST/PUT/PATCH/DELETE /employees/` - CRUD сотрудников
- `GET/POST/PUT/PATCH/DELETE /schedules/` - CRUD расписаний
- `GET/POST/PUT/PATCH/DELETE /provider-services/` - CRUD услуг учреждения
- `GET /search/` - Поиск учреждений
- `GET /search/distance/` - Поиск по расстоянию
- `GET /search/sitters/advanced/` - Расширенный поиск ситтеров
- `PUT /employees/<employee_id>/update/` - Обновление сотрудника
- `POST /employees/<employee_id>/deactivate/` - Деактивация сотрудника
- `POST /join-requests/` - Заявка на вступление
- `POST /join-requests/approve/` - Одобрение заявки
- `POST /join-requests/confirm/` - Подтверждение заявки
- `POST /employees/delete-notify/` - Уведомление об удалении
- `POST /work-slots/bulk/` - Массовые операции со слотами
- `POST /schedule-patterns/apply/` - Применение шаблона расписания

**Бронирования (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /bookings/` - CRUD бронирований
- `GET/POST/PUT/PATCH/DELETE /booking-statuses/` - CRUD статусов
- `GET/POST/PUT/PATCH/DELETE /booking-reviews/` - CRUD отзывов
- `POST /auto-book-employee/` - Автобронирование сотрудника
- `GET /available-employees/` - Доступные сотрудники
- `POST /bookings/<booking_id>/cancel/` - Отмена бронирования
- `POST /bookings/<booking_id>/complete/` - Завершение бронирования
- `POST /bookings/<booking_id>/no-show/` - Отметка неявки
- `GET /bookings/<booking_id>/time-slots/` - Доступные слоты

**Биллинг (`/`):**
- `GET/POST/PUT/PATCH/DELETE /contract-types/` - CRUD типов контрактов
- `GET/POST/PUT/PATCH/DELETE /payments/` - CRUD платежей
- `GET/POST/PUT/PATCH/DELETE /invoices/` - CRUD счетов
- `GET/POST/PUT/PATCH/DELETE /refunds/` - CRUD возвратов
- `GET/POST/PUT/PATCH/DELETE /contracts/` - CRUD контрактов
- `GET/POST /blocking-rules/` - Правила блокировки
- `GET/PUT/PATCH/DELETE /blocking-rules/<pk>/` - Управление правилом
- `GET /provider-blockings/` - Блокировки учреждений
- `GET /provider-blockings/<pk>/` - Детали блокировки
- `POST /provider-blockings/<blocking_id>/resolve/` - Разрешение блокировки
- `GET /providers/<provider_id>/blocking-status/` - Статус блокировки
- `GET /providers/<provider_id>/blocking-history/` - История блокировок
- `GET /blocking-notifications/` - Уведомления о блокировках
- `POST /blocking-notifications/<notification_id>/retry/` - Повтор уведомления

**Каталог услуг (`/`):**
- `GET/POST/PUT/PATCH/DELETE /services/` - CRUD услуг
- `GET/POST /categories/` - Категории услуг
- `GET/PUT/PATCH/DELETE /categories/<pk>/` - Управление категорией
- `GET/POST /services/` - Список и создание услуг
- `GET/PUT/PATCH/DELETE /services/<pk>/` - Управление услугой
- `POST /services/search/` - Расширенный поиск услуг с фильтрацией (name, category_id, min_price, max_price, sort_by)

**Уведомления (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /notifications/` - CRUD уведомлений
- `GET/POST/PUT/PATCH/DELETE /preferences/` - CRUD предпочтений
- `GET/POST/PUT/PATCH/DELETE /settings/` - CRUD настроек
- `GET /notifications/unread-count/` - Количество непрочитанных
- `POST /notifications/<pk>/mark-as-read/` - Отметить как прочитанное
- `POST /notifications/mark-all-as-read/` - Отметить все как прочитанные
- `GET /notifications/statistics/` - Статистика уведомлений
- `POST /notifications/test/` - Тестовое уведомление
- `GET /preferences/all/` - Все предпочтения
- `POST /preferences/reset/` - Сброс предпочтений
- `POST /settings/bulk-update/` - Массовое обновление настроек
- `GET /settings/available-options/` - Доступные опции
- `GET /notifications/` - Получение уведомлений
- `POST /notifications/<notification_id>/read/` - Отметить как прочитанное
- `POST /notifications/read-all/` - Отметить все как прочитанные
- `DELETE /notifications/<notification_id>/delete/` - Удаление уведомления
- `DELETE /notifications/delete-all/` - Удаление всех уведомлений
- `GET /notifications/stats/` - Статистика
- `POST /notifications/preferences/` - Обновление предпочтений
- `GET /notifications/templates/` - Шаблоны уведомлений
- `POST /notifications/test/` - Тестовое уведомление
- `GET /notifications/history/` - История уведомлений
- `POST /notifications/push-token/` - Обновление push-токена
- `GET /admin/notifications/` - Админские уведомления
- `POST /admin/notifications/send/` - Отправка уведомления
- `POST /admin/notifications/bulk-send/` - Массовая отправка
- `GET /admin/notifications/analytics/` - Аналитика уведомлений

**Рейтинги (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /ratings/` - CRUD рейтингов
- `GET/POST/PUT/PATCH/DELETE /reviews/` - CRUD отзывов
- `GET/POST/PUT/PATCH/DELETE /complaints/` - CRUD жалоб
- `GET/POST/PUT/PATCH/DELETE /complaint-responses/` - CRUD ответов на жалобы
- `GET/POST/PUT/PATCH/DELETE /suspicious-activities/` - CRUD подозрительной активности

**Аудит (`/api/`):**
- `GET /audit/logs/` - Логи аудита
- `GET /audit/logs/export/` - Экспорт логов
- `GET /audit/user-activity/<user_id>/` - Активность пользователя
- `GET /audit/system-events/` - Системные события
- `GET /audit/statistics/` - Статистика аудита
- `GET /audit/logs/filter/` - Фильтрация логов
- `GET /audit/logs/search/` - Поиск в логах
- `POST /audit/logs/cleanup/` - Очистка логов

**Аналитика (`/api/`):**
- `GET /analytics/user-growth/` - Рост пользователей
- `GET /analytics/provider-performance/` - Производительность учреждений
- `GET /analytics/revenue-trends/` - Тренды выручки
- `GET /analytics/behavioral/` - Поведенческая аналитика

**Геолокация (`/api/`):**
- `GET/POST/PUT/PATCH/DELETE /addresses/` - CRUD адресов
- `GET/POST/PUT/PATCH/DELETE /validations/` - CRUD валидаций
- `GET/POST/PUT/PATCH/DELETE /cache/` - CRUD кэша
- `GET /autocomplete/` - Автодополнение адресов
- `GET /geocode/` - Геокодирование
- `GET /reverse-geocode/` - Обратное геокодирование
- `POST /validate-bulk/` - Массовая валидация
- `GET /user-location/` - Местоположение пользователя
- `POST /device-location/` - Сохранение местоположения устройства
- `POST /map-location/` - Сохранение местоположения с карты
- `GET /location-info/` - Информация о местоположении
- `POST /clear-location/` - Очистка местоположения
- `GET /check-address-requirement/` - Проверка требований к адресу
- `GET /validate-location-for-role/` - Валидация местоположения для роли

**Системные настройки (`/api/`):**
- `GET/POST /settings/system/` - Системные настройки
- `GET/POST /settings/features/` - Настройки функций
- `GET/POST /settings/security/` - Настройки безопасности
- `GET /settings/health/` - Проверка здоровья системы

**Отчеты (`/api/`):**
- `GET /income/` - Отчет по доходам
- `GET /workload/` - Отчет по загрузке
- `GET /debt/` - Отчет по задолженностям
- `GET /activity/` - Отчет по активности
- `GET /payment/` - Отчет по платежам
- `GET /cancellation/` - Отчет по отменам

**Доступ (`/`):**
- `GET/POST/PUT/PATCH/DELETE /accesses/` - CRUD доступа
- `GET/POST/PUT/PATCH/DELETE /logs/` - CRUD логов доступа

**Передержка (`/`):**
- `GET/POST/PUT/PATCH/DELETE /profiles/` - CRUD профилей передержки
- `GET/POST/PUT/PATCH/DELETE /ads/` - CRUD объявлений
- `GET/POST/PUT/PATCH/DELETE /responses/` - CRUD откликов
- `GET/POST/PUT/PATCH/DELETE /pet-sitting/` - CRUD передержки
- `GET/POST/PUT/PATCH/DELETE /reviews/` - CRUD отзывов

**Аутентификация API:**
- JWT токены
- OAuth 2.0 для внешних приложений
- Ограничение частоты запросов

## 14. ПЕРИОДИЧЕСКИЕ ЗАДАЧИ

### 14.1 Система валют

**Обновление курсов валют:**
- Автоматическое обновление курсов валют через внешний API (exchangeratesapi.io)
- Периодичность: ежедневно в 00:00
- Поддерживаемые валюты: USD (базовая), EUR, RUB
- Обработка ошибок и логирование неудачных попыток обновления
- Fallback на последние известные курсы при недоступности API

### 14.2 Уведомления

**Запланированные уведомления:**
- Обработка запланированных уведомлений: каждую минуту
- Обработка напоминаний: каждый час
- Очистка старых уведомлений: ежедневно в 02:00
- Отправка напоминаний о задолженности: ежедневно в 09:00
- Проверка истечения инвайтов ролей: ежедневно в 08:00
- Статистика уведомлений администраторам: ежедневно в 18:00
- Очистка неактивных push-токенов: еженедельно по воскресеньям в 03:00
- Напоминания о предстоящих бронированиях: каждые 15 минут (индивидуально для каждого пользователя)


**Система напоминаний о бронированиях:**
- **Глобальная настройка:** Время напоминания по умолчанию (например, за 2 часа до бронирования)
- **Индивидуальная настройка:** Пользователь может изменить время напоминания в своих настройках
- **Логика работы:** Система проверяет каждые 15 минут, какие бронирования требуют напоминания
- **Индивидуальное время:** Каждый пользователь получает напоминание за свое настроенное время до бронирования
- **Множественные напоминания:** Поддержка нескольких напоминаний (например, за 1 день и за 2 часа)

### 14.3 Система блокировок

**Проверка блокировок:**
- Автоматическая проверка задолженности учреждений: ежедневно в 02:00 (настраивается)
- Применение правил блокировки согласно настройкам
- Автоматическое снятие блокировок при погашении задолженности
- Отправка уведомлений о блокировке/разблокировке
